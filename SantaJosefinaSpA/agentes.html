<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>CRM - Gestión de Agentes</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#1a2b48" />
    <link rel="apple-touch-icon" href="assets/img/icon-192.png" />

    <script src="assets/js/app.js"></script>
    <script>
      requireAuth();
    </script>

    
      <link rel="stylesheet" href="assets/css/pages/agentes.inline.css">
</head>
  <body>
    <div id="header"></div>

    <main>
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 30px;
        "
      >
        <h1
          style="margin: 0; font-size: 24px; font-weight: 800; color: #0f172a"
        >
          Equipo de Agentes
        </h1>
        <div style="display: flex; gap: 10px">
          <button class="btn-primary btn-outline" onclick="cargarTodo()">
            <i class="fa-solid fa-rotate"></i> Actualizar
          </button>
          <button class="btn-primary" onclick="abrirModalAgente()">
            <i class="fa-solid fa-plus"></i> Nuevo Agente
          </button>
        </div>
      </div>

      <div class="kpi-row">
        <div class="kpi-card">
          <div class="kpi-icon kpi-green">
            <i class="fa-solid fa-sack-dollar"></i>
          </div>
          <div class="kpi-data">
            <h3 id="kpiTotalComision">$0</h3>
            <p>Comisiones (Mes)</p>
          </div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon kpi-blue">
            <i class="fa-solid fa-list-check"></i>
          </div>
          <div class="kpi-data">
            <h3 id="kpiTotalTareas">0</h3>
            <p>Tareas Pendientes</p>
          </div>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th style="width: 50px">Avatar</th>
              <th>Agente</th>
              <th>Rol / Contacto</th>
              <th>Calificación</th>
              <th style="text-align: center">Negocios</th>
              <th style="text-align: center">Tareas</th>
              <th style="text-align: right">A Pagar</th>
              <th style="text-align: right">Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaAgentes">
            <tr>
              <td colspan="8" style="text-align: center; padding: 30px">
                Cargando...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>

    <div id="modalAgente" class="modal">
      <div
        class="modal-content"
        style="
          max-width: 500px !important;
          height: auto !important;
          flex-direction: column;
        "
      >
        <div style="padding: 25px">
          <h2 id="modalTitleAgente" style="margin-top: 0; margin-bottom: 20px">
            Datos Agente
          </h2>
          <form id="formAgente">
            <input type="hidden" id="agenteID" />

            <div style="text-align: center; margin-bottom: 20px">
              <div class="big-avatar">
                <img
                  id="previewAvatar"
                  src="assets/img/default_avatar.png"
                  onerror="this.style.display='none'"
                />
                <div
                  id="avatarInitials"
                  style="
                    display: flex;
                    width: 100%;
                    height: 100%;
                    align-items: center;
                    justify-content: center;
                    font-size: 30px;
                    color: #cbd5e1;
                    background: #f1f5f9;
                  "
                >
                  <i class="fa-solid fa-user"></i>
                </div>
              </div>
              <div class="upload-btn-wrapper">
                <button class="btn-upload" type="button">
                  <i class="fa-solid fa-camera"></i> Subir Foto
                </button>
                <input
                  type="file"
                  id="inpAvatarFile"
                  accept="image/*"
                  onchange="previewFile()"
                />
              </div>
            </div>

            <div style="display: grid; gap: 15px">
              <div>
                <label class="label">Nombre Completo</label>
                <input
                  type="text"
                  id="agenteNombre"
                  class="input-std"
                  required
                />
              </div>
              <div
                style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px"
              >
                <div>
                  <label class="label">Email</label>
                  <input
                    type="email"
                    id="agenteEmail"
                    class="input-std"
                    required
                  />
                </div>
                <div>
                  <label class="label">Teléfono</label>
                  <input type="text" id="agenteTelefono" class="input-std" />
                </div>
              </div>
              <div>
                <label class="label">Rol</label>
                <select id="agenteRol" class="input-std">
                  <option value="Agente">Agente Inmobiliario</option>
                  <option value="Supervisor">Supervisor</option>
                  <option value="Administrativo">Administrativo</option>
                </select>
              </div>
            </div>

            <div
              style="
                text-align: right;
                margin-top: 25px;
                display: flex;
                justify-content: end;
                gap: 10px;
              "
            >
              <button
                type="button"
                class="btn-primary btn-outline"
                onclick="cerrarModal('modalAgente')"
              >
                Cancelar
              </button>
              <button type="submit" class="btn-primary">Guardar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div id="modalTareas" class="modal">
      <div
        class="modal-content"
        style="max-width: 800px !important; height: 80vh !important"
      >
        <div class="modal-sidebar" style="width: 250px">
          <h3 style="margin-top: 0">Nueva Tarea</h3>
          <form id="formTarea">
            <input type="hidden" id="tareaAgenteID" />
            <div style="margin-bottom: 10px">
              <label class="label">Título</label>
              <input
                id="tareaTitulo"
                class="input-std"
                required
                placeholder="Ej: Llamar cliente..."
              />
            </div>
            <div style="margin-bottom: 10px">
              <label class="label">Prioridad</label>
              <select id="tareaPrioridad" class="input-std">
                <option value="Alta">Alta</option>
                <option value="Media" selected>Media</option>
                <option value="Baja">Baja</option>
              </select>
            </div>
            <div style="margin-bottom: 10px">
              <label class="label">Vencimiento</label>
              <input type="date" id="tareaFecha" class="input-std" required />
            </div>
            <div style="margin-bottom: 15px">
              <label class="label">Detalle</label>
              <textarea id="tareaDesc" class="input-std" rows="3"></textarea>
            </div>
            <button type="submit" class="btn-primary" style="width: 100%">
              Asignar Tarea
            </button>
          </form>
        </div>
        <div class="modal-main">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
            "
          >
            <h2 style="margin: 0">Lista de Tareas</h2>
            <button
              class="btn-primary btn-outline"
              onclick="cerrarModal('modalTareas')"
            >
              Cerrar
            </button>
          </div>
          <div id="listaTareasContainer"></div>
        </div>
      </div>
    </div>

    <div id="modalGestion" class="modal">
      <div
        class="modal-content"
        style="
          width: 95% !important;
          max-width: 1300px !important;
          height: 90vh !important;
        "
      >
        <div
          class="modal-sidebar"
          style="
            width: 300px;
            flex-shrink: 0;
            background: #f8fafc;
            border-right: 1px solid #e2e8f0;
          "
        >
          <div style="text-align: center; margin-bottom: 30px">
            <div class="big-avatar" id="mdlGestionAvatar"></div>
            <h3 id="mdlNombre" style="margin: 0; font-size: 18px">Nombre</h3>
            <p
              id="mdlEmail"
              style="color: #64748b; font-size: 12px; word-break: break-all"
            >
              email
            </p>
            <div
              class="stars"
              id="mdlStars"
              style="margin-top: 10px; color: #f59e0b; letter-spacing: 2px"
            >
              ★★★★★
            </div>
          </div>

          <form id="formPerfil">
            <input type="hidden" id="gestionAgenteID" />
            <div style="margin-bottom: 15px">
              <label class="label">Calificación (1-5)</label>
              <input
                type="number"
                id="inpRating"
                class="input-std"
                min="1"
                max="5"
              />
            </div>
            <button
              type="submit"
              class="btn-primary"
              style="width: 100%; justify-content: center"
            >
              Actualizar Calificación
            </button>
          </form>
        </div>

        <div
          class="modal-main"
          style="flex: 1; padding: 30px; overflow-y: auto"
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              margin-bottom: 20px;
              align-items: center;
            "
          >
            <h2 style="margin: 0; font-size: 22px; color: #1e293b">
              Registrar Negocio
            </h2>
            <button
              class="btn-primary btn-outline"
              onclick="cerrarModal('modalGestion')"
            >
              <i class="fa-solid fa-xmark"></i> Cerrar
            </button>
          </div>

          <div
            style="
              border: 1px solid #e2e8f0;
              border-radius: 12px;
              padding: 25px;
              box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
              background: white;
            "
          >
            <form id="formTransaccion">
              <div class="row-flex" style="gap: 20px">
                <div class="col-flex" style="max-width: 250px">
                  <label class="label">Tipo de Negocio</label>
                  <select
                    id="tTipo"
                    class="input-std"
                    onchange="toggleCalculadora()"
                    style="font-weight: bold; color: #0f172a"
                  >
                    <option value="Venta">Venta Propiedad</option>
                    <option value="Arriendo">Arriendo</option>
                    <option value="Captacion">
                      Captación Edificio (Admin)
                    </option>
                  </select>
                </div>

                <div
                  id="divSelectEdificios"
                  class="col-flex"
                  style="display: none; flex: 2"
                >
                  <label class="label">Seleccionar Edificio</label>
                  <select
                    id="selEdificio"
                    class="input-std"
                    onchange="seleccionarEdificio()"
                  >
                    <option value="">-- Elige un edificio --</option>
                  </select>
                </div>

                <div id="divInputManual" class="col-flex" style="flex: 2">
                  <label class="label">Propiedad / Detalle</label>
                  <input
                    type="text"
                    id="tPropiedad"
                    class="input-std"
                    placeholder="Ej: Depto 301, Calle..."
                    required
                  />
                </div>
              </div>

              <div
                id="calcAdmin"
                style="
                  background: #f0fdf4;
                  border: 1px solid #bbf7d0;
                  padding: 20px;
                  border-radius: 8px;
                  margin-top: 20px;
                  display: none;
                "
              >
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 15px;
                    border-bottom: 1px solid #bbf7d0;
                    padding-bottom: 10px;
                  "
                >
                  <strong style="color: #166534; font-size: 15px"
                    ><i class="fa-solid fa-calculator"></i> Honorarios
                    Administración</strong
                  >
                  <span
                    style="
                      font-size: 12px;
                      background: #fff;
                      padding: 4px 10px;
                      border-radius: 6px;
                      border: 1px solid #bbf7d0;
                    "
                    >UTM Hoy: <b><span id="lblUTM">--</span></b></span
                  >
                </div>
                <div class="row-flex" style="gap: 20px">
                  <div class="col-flex">
                    <label class="label">N° Unidades</label>
                    <input
                      type="number"
                      id="cUnidades"
                      class="input-std"
                      placeholder="0"
                      oninput="calcularAuto()"
                    />
                  </div>
                  <div class="col-flex">
                    <label class="label">Factor</label>
                    <input
                      type="number"
                      id="cFactor"
                      class="input-std"
                      value="1.0"
                      step="0.1"
                      oninput="calcularAuto()"
                    />
                  </div>
                  <div class="col-flex" style="text-align: right">
                    <label class="label">Total Comunidad Mensual</label>
                    <div
                      id="lblHonorarioTotal"
                      style="font-weight: 800; font-size: 18px; color: #1e293b"
                    >
                      $0
                    </div>
                  </div>
                </div>
                <div
                  style="
                    text-align: right;
                    font-size: 13px;
                    color: #166534;
                    margin-top: 10px;
                  "
                >
                  Comisión Sugerida (50% del primer mes):
                  <span
                    id="lblPagoAgente"
                    style="font-size: 18px; font-weight: 800; margin-left: 5px"
                    >$0</span
                  >
                </div>
              </div>

              <div
                id="calcVenta"
                style="
                  background: #f0fdf4;
                  border: 1px solid #bbf7d0;
                  padding: 20px;
                  border-radius: 8px;
                  margin-top: 20px;
                  display: block;
                "
              >
                <div class="row-flex" style="gap: 20px">
                  <div class="col-flex">
                    <label class="label">Valor Propiedad</label>
                    <input
                      type="number"
                      id="vMonto"
                      class="input-std"
                      placeholder="$"
                      oninput="calcularVenta()"
                    />
                  </div>
                  <div class="col-flex">
                    <label class="label">% Comisión Empresa</label>
                    <input
                      type="number"
                      id="vPctEmpresa"
                      class="input-std"
                      value="2"
                      placeholder="2%"
                      oninput="calcularVenta()"
                    />
                  </div>
                  <div class="col-flex">
                    <label class="label">% Punta Agente</label>
                    <input
                      type="number"
                      id="vPctAgente"
                      class="input-std"
                      value="50"
                      placeholder="50%"
                      oninput="calcularVenta()"
                    />
                  </div>
                  <div class="col-flex" style="text-align: right">
                    <label class="label">A Pagar al Agente</label>
                    <div
                      id="lblPagoVenta"
                      style="font-size: 20px; font-weight: 800; color: #166534"
                    >
                      $0
                    </div>
                  </div>
                </div>
              </div>

              <div
                class="row-flex"
                style="
                  margin-top: 25px;
                  border-top: 1px solid #e2e8f0;
                  padding-top: 20px;
                  align-items: center;
                "
              >
                <div class="col-flex" style="flex: 2">
                  <label class="label" style="color: #0f172a; font-size: 12px"
                    >Monto Final a Registrar (Confirmar)</label
                  >
                  <input
                    type="number"
                    id="tPagoFinal"
                    class="input-std"
                    style="
                      font-weight: 800;
                      background: #f1f5f9;
                      font-size: 18px;
                      border-color: #94a3b8;
                      height: 50px;
                      color: #0f172a;
                    "
                    required
                  />
                </div>
                <div class="col-flex" style="flex: 0 0 auto">
                  <button
                    type="submit"
                    class="btn-primary"
                    style="height: 50px; padding: 0 40px; font-size: 15px"
                  >
                    <i class="fa-solid fa-check"></i> Registrar Negocio
                  </button>
                </div>
              </div>
            </form>
          </div>

          <h4
            style="
              margin: 30px 0 15px 0;
              color: #64748b;
              font-size: 12px;
              text-transform: uppercase;
              font-weight: 800;
              letter-spacing: 0.5px;
            "
          >
            Historial de Negocios
          </h4>
          <div id="listaTransacciones"></div>
        </div>
      </div>
    </div>

    <div id="spinner" class="spinner-overlay"><div class="spinner"></div></div>
    <div id="footer"></div>

    <script src="assets/js/pages/agentes.inline.js"></script>
  </body>
</html>
