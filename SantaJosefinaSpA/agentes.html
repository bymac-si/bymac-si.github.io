<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>CRM - Gestión de Agentes</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <script src="assets/js/app.js"></script>
    <script>
      requireAuth();
    </script>

    <style>
      /* ESTILOS BASE */
      body {
        max-width: 1400px;
        margin: 0 auto;
        color: #1e293b;
        background: #f1f5f9;
        font-family: sans-serif;
      }
      main {
        padding: 40px;
      }

      /* TARJETAS KPI */
      .kpi-row {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
      }
      .kpi-card {
        flex: 1;
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .kpi-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
      }
      .kpi-green {
        background: #dcfce7;
        color: #166534;
      }
      .kpi-data h3 {
        margin: 0;
        font-size: 24px;
        color: #0f172a;
      }
      .kpi-data p {
        margin: 0;
        font-size: 12px;
        color: #64748b;
        text-transform: uppercase;
        font-weight: 700;
      }

      /* TABLA */
      .table-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        border: 1px solid #e2e8f0;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th {
        background: #f8fafc;
        color: #64748b;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 11px;
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
      }
      td {
        padding: 15px;
        border-bottom: 1px solid #f1f5f9;
        font-size: 14px;
        vertical-align: middle;
      }

      /* MODAL */
      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }
      .modal.active {
        display: flex;
      }

      /* MODAL RESPONSIVE */
      .modal-content {
        background: white;
        width: 95% !important;
        max-width: 1400px !important;
        height: 90vh;
        border-radius: 16px;
        display: flex;
        overflow: hidden;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      }

      .modal-sidebar {
        width: 280px;
        background: #f8fafc;
        padding: 30px;
        border-right: 1px solid #e2e8f0;
        overflow-y: auto;
      }
      .modal-main {
        flex: 1;
        padding: 30px;
        overflow-y: auto;
        background: white;
      }

      /* FORMULARIO FLEXIBLE */
      .row-flex {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        margin-bottom: 15px;
        align-items: flex-end;
      }
      .col-flex {
        flex: 1;
        min-width: 200px;
      }

      .calc-box {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        display: none;
      }
      .calc-result {
        font-size: 18px;
        font-weight: 800;
        color: #166534;
        text-align: right;
      }

      .input-std {
        width: 100%;
        padding: 10px;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        box-sizing: border-box;
      }
      .label {
        display: block;
        font-size: 11px;
        font-weight: 700;
        color: #64748b;
        text-transform: uppercase;
        margin-bottom: 5px;
      }

      .btn-primary {
        background: #0f172a;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
      }
      .badge-money {
        background: #ecfdf5;
        color: #065f46;
        padding: 4px 10px;
        border-radius: 20px;
        font-weight: 700;
      }

      /* AVATAR Y UPLOAD */
      .avatar {
        width: 40px;
        height: 40px;
        background: #e2e8f0;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #64748b;
        overflow: hidden;
      }
      .avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .big-avatar {
        width: 100px;
        height: 100px;
        background: #e2e8f0;
        border-radius: 50%;
        margin: 0 auto 15px;
        overflow: hidden;
        position: relative;
        border: 3px solid white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .big-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      /* Botón de cámara flotante para subir foto */
      .upload-btn-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
        cursor: pointer;
      }
      .btn-upload {
        border: 1px solid #cbd5e1;
        color: #64748b;
        background-color: white;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 700;
        cursor: pointer;
      }
      .upload-btn-wrapper input[type="file"] {
        font-size: 100px;
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        cursor: pointer;
      }

      .stars {
        color: #f59e0b;
        letter-spacing: 2px;
      }

      .spinner-overlay {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        place-items: center;
        z-index: 2000;
      }
      .spinner {
        width: 30px;
        height: 30px;
        border: 4px solid #e2e8f0;
        border-top-color: #0f172a;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div id="header"></div>

    <main>
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 30px;
        "
      >
        <h1
          style="margin: 0; font-size: 24px; font-weight: 800; color: #0f172a"
        >
          Equipo de Agentes
        </h1>
        <div style="display: flex; gap: 10px">
          <button class="btn-primary" onclick="cargarTodo()">
            <i class="fa-solid fa-rotate"></i> Actualizar
          </button>
          <button class="btn-primary" onclick="abrirModalNuevo()">
            <i class="fa-solid fa-plus"></i> Nuevo Agente
          </button>
        </div>
      </div>

      <div class="kpi-row">
        <div class="kpi-card">
          <div class="kpi-icon kpi-green">
            <i class="fa-solid fa-sack-dollar"></i>
          </div>
          <div class="kpi-data">
            <h3 id="kpiTotalComision">$0</h3>
            <p>Comisiones Totales (Mes)</p>
          </div>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th style="width: 50px">Avatar</th>
              <th>Agente</th>
              <th>Calificación</th>
              <th style="text-align: center">Negocios</th>
              <th style="text-align: right">A Pagar</th>
              <th style="text-align: right">Gestión</th>
            </tr>
          </thead>
          <tbody id="tablaAgentes">
            <tr>
              <td colspan="6" style="text-align: center; padding: 30px">
                Cargando...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>

    <div id="modalAgente" class="modal">
      <div
        class="modal-content"
        style="
          max-width: 500px !important;
          height: auto !important;
          flex-direction: column;
        "
      >
        <div style="padding: 25px">
          <h2 id="modalTitleAgente" style="margin-top: 0; margin-bottom: 20px">
            Datos Agente
          </h2>
          <form id="formAgente">
            <input type="hidden" id="agenteID" />

            <div style="text-align: center; margin-bottom: 20px">
              <div class="big-avatar">
                <img
                  id="previewAvatar"
                  src="assets/img/default_avatar.png"
                  onerror="this.style.display='none'"
                />
                <div
                  id="avatarInitials"
                  style="
                    display: flex;
                    width: 100%;
                    height: 100%;
                    align-items: center;
                    justify-content: center;
                    font-size: 30px;
                    color: #cbd5e1;
                    background: #f1f5f9;
                  "
                >
                  <i class="fa-solid fa-user"></i>
                </div>
              </div>
              <div class="upload-btn-wrapper">
                <button class="btn-upload" type="button">
                  <i class="fa-solid fa-camera"></i> Subir Foto
                </button>
                <input
                  type="file"
                  id="inpAvatarFile"
                  accept="image/*"
                  onchange="previewFile()"
                />
              </div>
            </div>

            <div style="display: grid; gap: 15px">
              <div>
                <label class="label">Nombre Completo</label>
                <input
                  type="text"
                  id="agenteNombre"
                  class="input-std"
                  required
                />
              </div>
              <div
                style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px"
              >
                <div>
                  <label class="label">Email</label>
                  <input
                    type="email"
                    id="agenteEmail"
                    class="input-std"
                    required
                  />
                </div>
                <div>
                  <label class="label">Teléfono</label>
                  <input type="text" id="agenteTelefono" class="input-std" />
                </div>
              </div>
            </div>

            <div
              style="
                text-align: right;
                margin-top: 25px;
                display: flex;
                justify-content: end;
                gap: 10px;
              "
            >
              <button
                type="button"
                class="btn-primary"
                style="background: #fff; color: #333; border: 1px solid #ccc"
                onclick="cerrarFormAgente()"
              >
                Cancelar
              </button>
              <button type="submit" class="btn-primary">Guardar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div id="modalGestion" class="modal">
      <div class="modal-content">
        <div class="modal-sidebar">
          <div style="text-align: center; margin-bottom: 30px">
            <div class="big-avatar" id="mdlGestionAvatar"></div>
            <h3 id="mdlNombre" style="margin: 0">Nombre</h3>
            <p id="mdlEmail" style="color: #64748b; font-size: 13px">email</p>
            <div class="stars" id="mdlStars" style="margin-top: 10px">
              ★★★★★
            </div>
          </div>

          <form id="formPerfil">
            <input type="hidden" id="gestionAgenteID" />
            <div style="margin-bottom: 15px">
              <label class="label">Calificación (1-5)</label>
              <input
                type="number"
                id="inpRating"
                class="input-std"
                min="1"
                max="5"
              />
            </div>
            <button type="submit" class="btn-primary" style="width: 100%">
              Actualizar Calificación
            </button>
          </form>

          <button
            class="btn-primary"
            style="
              width: 100%;
              margin-top: 10px;
              background: #fff;
              color: #333;
              border: 1px solid #ccc;
            "
            onclick="editarDatosPersonales()"
          >
            Editar Datos / Foto
          </button>
        </div>

        <div class="modal-main">
          <div
            style="
              display: flex;
              justify-content: space-between;
              margin-bottom: 20px;
            "
          >
            <h2 style="margin: 0">Registrar Negocio</h2>
            <button
              class="btn-primary"
              style="background: #fff; color: #333; border: 1px solid #ccc"
              onclick="cerrarModalGestion()"
            >
              Cerrar
            </button>
          </div>

          <div
            class="smart-form"
            style="
              border: 1px solid #e2e8f0;
              border-radius: 8px;
              padding: 20px;
              box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            "
          >
            <form id="formTransaccion">
              <div class="row-flex">
                <div class="col-flex">
                  <label class="label">Tipo de Negocio</label>
                  <select
                    id="tTipo"
                    class="input-std"
                    onchange="toggleCalculadora()"
                  >
                    <option value="Venta">Venta Propiedad</option>
                    <option value="Arriendo">Arriendo</option>
                    <option value="Captacion">
                      Captación Edificio (Admin)
                    </option>
                  </select>
                </div>

                <div
                  id="divSelectEdificios"
                  class="col-flex"
                  style="display: none"
                >
                  <label class="label">Seleccionar Edificio</label>
                  <select
                    id="selEdificio"
                    class="input-std"
                    onchange="seleccionarEdificio()"
                  >
                    <option value="">-- Elige un edificio --</option>
                  </select>
                </div>

                <div id="divInputManual" class="col-flex" style="flex: 2">
                  <label class="label">Propiedad / Detalle</label>
                  <input
                    type="text"
                    id="tPropiedad"
                    class="input-std"
                    placeholder="Ej: Depto 301, Calle..."
                    required
                  />
                </div>
              </div>

              <div id="calcAdmin" class="calc-box">
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 10px;
                    border-bottom: 1px solid #bbf7d0;
                    padding-bottom: 5px;
                  "
                >
                  <strong style="color: #166534"
                    ><i class="fa-solid fa-calculator"></i> Honorarios
                    Admin</strong
                  >
                  <span
                    style="
                      font-size: 11px;
                      background: #fff;
                      padding: 2px 6px;
                      border-radius: 4px;
                    "
                    >UTM: <span id="lblUTM">--</span></span
                  >
                </div>

                <div class="row-flex">
                  <div class="col-flex">
                    <label class="label">N° Unidades</label>
                    <input
                      type="number"
                      id="cUnidades"
                      class="input-std"
                      placeholder="0"
                      oninput="calcularAuto()"
                    />
                  </div>
                  <div class="col-flex">
                    <label class="label">Factor</label>
                    <input
                      type="number"
                      id="cFactor"
                      class="input-std"
                      value="1.0"
                      step="0.1"
                      oninput="calcularAuto()"
                    />
                  </div>
                  <div class="col-flex" style="text-align: right">
                    <label class="label">Total Comunidad</label>
                    <div
                      id="lblHonorarioTotal"
                      style="font-weight: 700; font-size: 14px; color: #1e293b"
                    >
                      $0
                    </div>
                  </div>
                </div>

                <div style="text-align: right; font-size: 12px; color: #166534">
                  Comisión Sugerida (50%):
                  <span
                    id="lblPagoAgente"
                    class="calc-result"
                    style="font-size: 16px"
                    >$0</span
                  >
                </div>
              </div>

              <div id="calcVenta" class="calc-box" style="display: block">
                <div class="row-flex">
                  <div class="col-flex">
                    <label class="label">Valor Propiedad / Canon</label>
                    <input
                      type="number"
                      id="vMonto"
                      class="input-std"
                      placeholder="$"
                      oninput="calcularVenta()"
                    />
                  </div>
                  <div class="col-flex">
                    <label class="label">% Comisión Empresa</label>
                    <input
                      type="number"
                      id="vPctEmpresa"
                      class="input-std"
                      value="2"
                      placeholder="2%"
                      oninput="calcularVenta()"
                    />
                  </div>
                  <div class="col-flex">
                    <label class="label">% Punta Vendedor</label>
                    <input
                      type="number"
                      id="vPctAgente"
                      class="input-std"
                      value="50"
                      placeholder="50%"
                      oninput="calcularVenta()"
                    />
                  </div>
                  <div class="col-flex" style="text-align: right">
                    <label class="label">Pago Agente</label>
                    <div
                      id="lblPagoVenta"
                      class="calc-result"
                      style="font-size: 16px"
                    >
                      $0
                    </div>
                  </div>
                </div>
              </div>

              <div
                class="row-flex"
                style="
                  margin-top: 20px;
                  border-top: 1px solid #e2e8f0;
                  padding-top: 15px;
                "
              >
                <div class="col-flex" style="flex: 2">
                  <label class="label" style="color: #0f172a"
                    >Monto Final a Pagar (Confirmar)</label
                  >
                  <input
                    type="number"
                    id="tPagoFinal"
                    class="input-std"
                    style="
                      font-weight: 700;
                      background: #f8fafc;
                      font-size: 16px;
                      border-color: #94a3b8;
                    "
                    required
                  />
                </div>
                <div class="col-flex" style="flex: 0 0 auto">
                  <button
                    type="submit"
                    class="btn-primary"
                    style="height: 42px; padding: 0 30px"
                  >
                    Registrar
                  </button>
                </div>
              </div>
            </form>
          </div>

          <h4
            style="
              margin: 0 0 15px 0;
              color: #64748b;
              font-size: 12px;
              text-transform: uppercase;
            "
          >
            Historial Reciente
          </h4>
          <div id="listaTransacciones"></div>
        </div>
      </div>
    </div>

    <div id="spinner" class="spinner-overlay"><div class="spinner"></div></div>
    <div id="footer"></div>

    <script>
    /* ===== CONFIGURACIÓN ===== */
    // Reemplaza con tu API Key real de https://api.imgbb.com/
    const IMGBB_API_KEY = "d096ade1d65ede2aa12f00d94094a854"; 

    /* ===== ESTADO GLOBAL ===== */
    let AGENTES = [], TRANSACCIONES = [], EDIFICIOS = [];
    let AGENTE_ACTUAL = null;
    let VALOR_UTM = 64000; 
    let AVATAR_URL_NUEVO = ""; // Almacena URL de ImgBB

    /* INICIO */
    document.addEventListener("DOMContentLoaded", async () => {
        try { 
    document.getElementById("header").innerHTML = await (await fetch("header.html")).text(); 
    // AGREGAR ESTA LÍNEA CLAVE:
    if (typeof initHeader === "function") initHeader(); 
} catch(e){}

        try { document.getElementById("footer").innerHTML = await (await fetch("footer.html")).text(); } catch(e){}
        
        await cargarUTM();
        await cargarTodo();
    });

    /* CARGAR UTM DESDE API */
    async function cargarUTM() {
        try {
            const res = await fetch('https://mindicador.cl/api/utm');
            const data = await res.json();
            if(data.serie && data.serie.length > 0) {
                VALOR_UTM = parseInt(data.serie[0].valor);
                const lbl = document.getElementById("lblUTM");
                if(lbl) lbl.textContent = clp(VALOR_UTM);
            }
        } catch(e) { console.warn("UTM Offline, usando valor por defecto."); }
    }

    /* CARGAR DATOS GENERALES */
    async function cargarTodo() {
        showSpinner();
        try {
            const [agentes, trans, copros] = await Promise.all([
                fetchData("Agentes").catch(()=>[]),
                fetchData("Transacciones").catch(()=>[]),
                fetchData("Copropiedades").catch(()=>[]) 
            ]);
            AGENTES = agentes || [];
            TRANSACCIONES = trans || [];
            EDIFICIOS = copros || [];
            
            poblarSelectEdificios();
            renderTabla();
            calcularTotalMes();
        } catch(e) { console.error(e); } finally { hideSpinner(); }
    }

    /* LLENAR SELECTOR DE EDIFICIOS */
    function poblarSelectEdificios() {
        const sel = document.getElementById("selEdificio");
        if(!sel) return;
        sel.innerHTML = '<option value="">-- Elige un edificio --</option>';
        EDIFICIOS.forEach(e => {
            const u = e.Unidades || e.CantidadUnidades || 0;
            // Guardamos datos en atributos data- para acceso rápido
            sel.innerHTML += `<option value="${e.ID}" data-unidades="${u}" data-nombre="${e.Nombre}">${e.Nombre}</option>`;
        });
    }

    /* --- SUBIDA DE IMAGEN (IMGBB) --- */
    async function previewFile() {
        const fileInput = document.getElementById("inpAvatarFile");
        const file = fileInput.files[0];
        if (!file) return;

        if(IMGBB_API_KEY === "TU_API_KEY_AQUI" || !IMGBB_API_KEY) {
            alert("Error: Configura la API Key de ImgBB en el código.");
            return;
        }

        showSpinner(); 

        const formData = new FormData();
        formData.append("image", file);

        try {
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                method: "POST",
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                AVATAR_URL_NUEVO = data.data.url; 
                
                // Mostrar preview
                const preview = document.getElementById("previewAvatar");
                const init = document.getElementById("avatarInitials");
                preview.src = AVATAR_URL_NUEVO;
                preview.style.display = "block";
                init.style.display = "none";
            } else {
                throw new Error("ImgBB rechazó la imagen.");
            }
        } catch (error) {
            console.error(error);
            alert("Error al subir imagen.");
        } finally {
            hideSpinner();
        }
    }

    /* RENDER TABLA PRINCIPAL */
    function renderTabla() {
        const tb = document.getElementById("tablaAgentes");
        tb.innerHTML = "";
        
        AGENTES.forEach(a => {
            const negocios = TRANSACCIONES.filter(t => String(t.AgenteID) === String(a.ID));
            const total = negocios.reduce((s, t) => s + (parseInt(t.PagoAgente)||0), 0);
            
            const r = parseInt(a.Calificacion) || 3;
            let stars = "";
            for(let i=1;i<=5;i++) stars += i<=r ? '<i class="fa-solid fa-star" style="color:#f59e0b"></i>' : '<i class="fa-regular fa-star" style="color:#cbd5e1"></i>';

            // Lógica de Avatar
            let avatarHTML = `<div class="avatar">${a.Nombre.charAt(0).toUpperCase()}</div>`;
            if(a.Avatar && a.Avatar.startsWith("http")) { 
                avatarHTML = `<div class="avatar"><img src="${a.Avatar}" onerror="this.style.display='none'"></div>`;
            }

            tb.innerHTML += `
            <tr>
                <td>${avatarHTML}</td>
                <td><div style="font-weight:600;">${a.Nombre}</div><div style="font-size:12px; color:#64748b;">${a.Email}</div></td>
                <td>${stars}</td>
                <td style="text-align:center; font-weight:700;">${negocios.length}</td>
                <td style="text-align:right;"><span class="badge-money">${clp(total)}</span></td>
                <td style="text-align:right;">
                    <button class="btn-primary" style="padding:6px 12px; font-size:12px;" onclick='abrirModalGestion("${a.ID}")'><i class="fa-solid fa-pen-to-square"></i></button>
                </td>
            </tr>`;
        });
        
        if(AGENTES.length === 0) tb.innerHTML = `<tr><td colspan="6" style="text-align:center;">Sin datos.</td></tr>`;
    }

    function calcularTotalMes() {
        const total = TRANSACCIONES.reduce((s, t) => s + (parseInt(t.PagoAgente)||0), 0);
        document.getElementById("kpiTotalComision").innerText = clp(total);
    }

    /* --- MODALES Y NAVEGACIÓN --- */
    
    function abrirModalNuevo() {
        AGENTE_ACTUAL = null;
        document.getElementById("formAgente").reset();
        document.getElementById("agenteID").value = "";
        document.getElementById("modalTitleAgente").textContent = "Nuevo Agente";
        
        // Reset Avatar
        AVATAR_URL_NUEVO = "";
        document.getElementById("previewAvatar").style.display = "none";
        document.getElementById("avatarInitials").style.display = "flex";
        
        document.getElementById("modalAgente").style.display = "flex";
    }

    function editarDatosPersonales() {
        if(!AGENTE_ACTUAL) return;
        
        document.getElementById("modalTitleAgente").textContent = "Editar Agente";
        document.getElementById("agenteID").value = AGENTE_ACTUAL.ID;
        document.getElementById("agenteNombre").value = AGENTE_ACTUAL.Nombre;
        document.getElementById("agenteEmail").value = AGENTE_ACTUAL.Email;
        document.getElementById("agenteTelefono").value = AGENTE_ACTUAL.Telefono;
        
        const prev = document.getElementById("previewAvatar");
        const init = document.getElementById("avatarInitials");
        AVATAR_URL_NUEVO = ""; 

        if(AGENTE_ACTUAL.Avatar && AGENTE_ACTUAL.Avatar.startsWith("http")) {
            prev.src = AGENTE_ACTUAL.Avatar;
            prev.style.display = "block";
            init.style.display = "none";
        } else {
            prev.style.display = "none";
            init.style.display = "flex";
        }

        cerrarModalGestion();
        document.getElementById("modalAgente").style.display = "flex";
    }

    function cerrarFormAgente() { document.getElementById("modalAgente").style.display = "none"; }

    function abrirModalGestion(id) {
        const a = AGENTES.find(x => String(x.ID) === String(id));
        if(!a) return;
        AGENTE_ACTUAL = a;

        document.getElementById("mdlNombre").textContent = a.Nombre;
        document.getElementById("mdlEmail").textContent = a.Email;
        document.getElementById("gestionAgenteID").value = a.ID;
        document.getElementById("inpRating").value = a.Calificacion || 3;
        
        // Avatar Sidebar
        const avatarContainer = document.getElementById("mdlGestionAvatar");
        if(a.Avatar && a.Avatar.startsWith("http")) {
            avatarContainer.innerHTML = `<img src="${a.Avatar}" style="width:100%; height:100%; object-fit:cover;">`;
        } else {
            avatarContainer.innerHTML = `<div style="display:flex; width:100%; height:100%; align-items:center; justify-content:center; font-size:30px; color:#cbd5e1;"><i class="fa-solid fa-user"></i></div>`;
        }

        document.getElementById("formTransaccion").reset();
        toggleCalculadora();
        renderHistorial();

        document.getElementById("modalGestion").style.display = "flex";
    }
    
    function cerrarModalGestion() { document.getElementById("modalGestion").style.display = "none"; }

    /* --- INTERFAZ DINÁMICA --- */
    
    function toggleCalculadora() {
        const tipo = document.getElementById("tTipo").value;
        const boxAdmin = document.getElementById("calcAdmin");
        const boxVenta = document.getElementById("calcVenta");
        const divSelect = document.getElementById("divSelectEdificios");
        const divManual = document.getElementById("divInputManual");
        
        // Reset valores
        document.getElementById("tPagoFinal").value = "";

        if(tipo === 'Captacion') {
            boxAdmin.style.display = 'block';
            boxVenta.style.display = 'none';
            divSelect.style.display = 'block'; 
            divManual.style.display = 'none';  
        } else {
            boxAdmin.style.display = 'none';
            boxVenta.style.display = 'block';
            divSelect.style.display = 'none';
            divManual.style.display = 'block';
            
            // Ajustar defaults
            if(tipo === 'Arriendo') {
                document.getElementById("vPctEmpresa").value = 50; 
                document.getElementById("vPctAgente").value = 50; 
            } else { // Venta
                document.getElementById("vPctEmpresa").value = 2; 
                document.getElementById("vPctAgente").value = 50;
            }
        }
    }

    function seleccionarEdificio() {
        const sel = document.getElementById("selEdificio");
        const opt = sel.options[sel.selectedIndex];
        if(opt.value) {
            document.getElementById("tPropiedad").value = opt.getAttribute("data-nombre");
            document.getElementById("cUnidades").value = opt.getAttribute("data-unidades") || 0;
            calcularAuto();
        }
    }

    /* --- LÓGICA DE CÁLCULO FINANCIERO (NETO) --- */

    function calcularAuto() {
        // ADMIN (Captación)
        const unid = parseInt(document.getElementById("cUnidades").value) || 0;
        const fac = parseFloat(document.getElementById("cFactor").value) || 0;
        
        if(unid > 0 && fac > 0) {
            const base = VALOR_UTM * 2.15;
            let netoTeorico = 0;
            
            // Fórmula base
            if(unid < 20) {
                netoTeorico = base * fac;
            } else {
                const extra = unid - 20;
                const valExtra = base * 0.013;
                const suma = base + (extra * valExtra);
                netoTeorico = suma * fac;
            }
            
            // 1. Honorario Neto (Redondeado a 1000)
            const honorarioNeto = Math.round(netoTeorico / 1000) * 1000;
            
            // 2. Honorario Total (con IVA) para mostrar al cliente
            const honorarioTotal = Math.round(honorarioNeto * 1.19);
            
            // 3. Comisión Agente (50% del NETO)
            const comisionAgente = Math.round(honorarioNeto * 0.5); 

            document.getElementById("lblHonorarioTotal").innerText = clp(honorarioTotal);
            document.getElementById("lblPagoAgente").innerText = clp(comisionAgente);
            document.getElementById("tPagoFinal").value = comisionAgente;
        }
    }

    function calcularVenta() {
        // VENTA / ARRIENDO
        const monto = parseInt(document.getElementById("vMonto").value) || 0;
        const pctEmpresa = parseFloat(document.getElementById("vPctEmpresa").value) / 100;
        const pctAgente = parseFloat(document.getElementById("vPctAgente").value) / 100;

        if(monto > 0) {
            // 1. Ingreso Bruto de la Empresa (Con IVA)
            const ingresoBruto = monto * pctEmpresa;
            
            // 2. Descontar IVA para obtener Base Comisionable (Neto)
            const ingresoNeto = Math.round(ingresoBruto / 1.19);
            
            // 3. Calcular Pago Agente sobre el Neto
            const pagoAgente = Math.round(ingresoNeto * pctAgente);
            
            document.getElementById("lblPagoVenta").innerText = clp(pagoAgente);
            document.getElementById("tPagoFinal").value = pagoAgente;
        }
    }

    /* --- CRUD OPERATIONS --- */

    // 1. Guardar Agente
    document.getElementById("formAgente").onsubmit = async (e) => {
        e.preventDefault();
        showSpinner();
        
        const id = document.getElementById("agenteID").value;
        const payload = {
            "Nombre": document.getElementById("agenteNombre").value,
            "Email": document.getElementById("agenteEmail").value,
            "Telefono": document.getElementById("agenteTelefono").value,
            "Activo": true
        };

        if(AVATAR_URL_NUEVO) payload["Avatar"] = AVATAR_URL_NUEVO;

        if(id) payload["ID"] = id;
        else payload["ID"] = "AGE_" + Date.now();

        try {
            const action = id ? "Edit" : "Add";
            await appSheetCRUD("Agentes", action, [payload]);
            cerrarFormAgente();
            await cargarTodo(); 
        } catch(err) { alert(err.message); } finally { hideSpinner(); }
    };

    // 2. Guardar Transacción (Coincide con tabla Transacciones)
    document.getElementById("formTransaccion").onsubmit = async (e) => {
        e.preventDefault();
        showSpinner();

        const tipoNegocio = document.getElementById("tTipo").value;
        let propiedad = document.getElementById("tPropiedad").value;
        
        // Si es captación y usó el select de edificios
        if(!propiedad && tipoNegocio === 'Captacion') {
             const sel = document.getElementById("selEdificio");
             if(sel.selectedIndex > 0) propiedad = sel.options[sel.selectedIndex].text;
        }

        // --- CÁLCULO DE DATOS FINANCIEROS PARA LA TABLA ---
        let montoOperacion = 0;
        let comisionTotal = 0;
        let pctAgente = 0;
        let pagoAgente = parseInt(document.getElementById("tPagoFinal").value) || 0;

        if (tipoNegocio === 'Captacion') {
            // En Administración, el "Monto Operación" es el total comunidad mensual
            const strTotal = document.getElementById("lblHonorarioTotal").innerText.replace(/\$|\./g, '').trim();
            montoOperacion = parseInt(strTotal) || 0;
            comisionTotal = montoOperacion; // En admin, la "comisión" base es el honorario completo
            pctAgente = 50; // Regla de negocio: 50% en captación
        } else {
            // En Venta/Arriendo
            montoOperacion = parseInt(document.getElementById("vMonto").value) || 0;
            const pctEmpresa = parseFloat(document.getElementById("vPctEmpresa").value) || 0;
            pctAgente = parseFloat(document.getElementById("vPctAgente").value) || 0;
            
            // Calculamos la comisión bruta de la empresa
            // Fórmula inversa: Si pagoAgente es el X% de la ComisiónTotal neta...
            // Pero más fácil: MontoOperacion * %Empresa = ComisionTotal Bruta
            comisionTotal = Math.round(montoOperacion * (pctEmpresa / 100));
        }

        const payload = {
            "ID": "TRX_" + Date.now(),
            "AgenteID": AGENTE_ACTUAL.ID,
            "Tipo": tipoNegocio,
            "Propiedad": propiedad || "Sin nombre",
            "MontoOperacion": montoOperacion,     // Valor Propiedad / Honorario Comunidad
            "ComisionTotal": comisionTotal,       // Ingreso Empresa
            "PorcentajeAgente": pctAgente,        // % del Agente
            "PagoAgente": pagoAgente,             // $ a Pagar al Agente
            "Fecha": new Date().toISOString().split('T')[0],
            "Estado": "Cerrado"
        };

        try {
            await appSheetCRUD("Transacciones", "Add", [payload]);
            
            // Actualizar UI
            TRANSACCIONES.push(payload);
            renderHistorial();
            renderTabla();
            calcularTotalMes();
            
            // Reset y cerrar
            document.getElementById("formTransaccion").reset();
            toggleCalculadora();
            alert("Negocio registrado correctamente.");
            cerrarModalGestion();
            
        } catch(err) { 
            console.error(err);
            alert("Error al guardar: " + err.message); 
        } finally { 
            hideSpinner(); 
        }
    };

    // 3. Actualizar Calificación
    document.getElementById("formPerfil").onsubmit = async (e) => {
        e.preventDefault();
        showSpinner();
        const cal = document.getElementById("inpRating").value;
        try {
            await appSheetCRUD("Agentes", "Edit", [{ "ID": AGENTE_ACTUAL.ID, "Calificacion": cal }]);
            AGENTE_ACTUAL.Calificacion = cal;
            renderTabla();
            alert("Calificación actualizada.");
        } catch(err) { alert(err.message); } finally { hideSpinner(); }
    };

    /* UTILS */
    function renderHistorial() {
        const div = document.getElementById("listaTransacciones");
        const list = TRANSACCIONES.filter(t => String(t.AgenteID) === String(AGENTE_ACTUAL.ID)).reverse();
        if(list.length === 0) { div.innerHTML = '<div style="color:#94a3b8; font-size:13px; text-align:center;">Sin negocios.</div>'; return; }

        div.innerHTML = list.map(t => `
            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #f1f5f9; padding:10px 0; font-size:13px;">
                <div><span style="font-weight:700; color:#475569;">[${t.Tipo}]</span> ${t.Propiedad} <div style="font-size:11px; color:#cbd5e1;">${t.Fecha}</div></div>
                <div style="font-weight:700; color:#166534;">${clp(t.PagoAgente)}</div>
            </div>
        `).join("");
    }

    function showSpinner() { document.getElementById("spinner").style.display = "flex"; }
    function hideSpinner() { document.getElementById("spinner").style.display = "none"; }
    function clp(n) { return "$" + new Intl.NumberFormat("es-CL").format(Math.round(n)||0); }
</script>
  </body>
</html>
