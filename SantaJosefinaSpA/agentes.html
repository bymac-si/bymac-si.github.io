<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>CRM - Gestión de Agentes</title>
   <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#1a2b48" />
    <script src="assets/js/app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
      (function () {
        emailjs.init("7Il4AhmGHchP7qfxu");
      })();
      if (typeof requireAuth === "function") requireAuth();
    </script>

    <style>
      /* ESTILOS BASE */
      body {
        max-width: 1400px;
        margin: 0 auto;
        color: #1e293b;
        background: #f1f5f9;
        font-family: sans-serif;
      }
      main {
        padding: 40px;
      }

      /* TARJETAS KPI */
      .kpi-row {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
      }
      .kpi-card {
        flex: 1;
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .kpi-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
      }
      .kpi-green {
        background: #dcfce7;
        color: #166534;
      }
      .kpi-blue {
        background: #e0f2fe;
        color: #0369a1;
      }
      .kpi-data h3 {
        margin: 0;
        font-size: 24px;
        color: #0f172a;
      }
      .kpi-data p {
        margin: 0;
        font-size: 12px;
        color: #64748b;
        text-transform: uppercase;
        font-weight: 700;
      }

      /* TABLA */
      .table-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        border: 1px solid #e2e8f0;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th {
        background: #f8fafc;
        color: #64748b;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 11px;
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
      }
      td {
        padding: 15px;
        border-bottom: 1px solid #f1f5f9;
        font-size: 14px;
        vertical-align: middle;
      }

      /* MODAL */
      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }
      .modal.active {
        display: flex;
      }
      .modal-content {
        background: white;
        width: 95%;
        max-width: 1400px;
        height: 90vh;
        border-radius: 16px;
        display: flex;
        overflow: hidden;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      }

      /* Sidebar Modal */
      .modal-sidebar {
        width: 280px;
        background: #f8fafc;
        padding: 30px;
        border-right: 1px solid #e2e8f0;
        overflow-y: auto;
      }
      .modal-main {
        flex: 1;
        padding: 30px;
        overflow-y: auto;
        background: white;
      }

      /* Inputs y Forms */
      .row-flex {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        margin-bottom: 15px;
        align-items: flex-end;
      }
      .col-flex {
        flex: 1;
        min-width: 200px;
      }
      .input-std {
        width: 100%;
        padding: 10px;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        box-sizing: border-box;
      }
      .label {
        display: block;
        font-size: 11px;
        font-weight: 700;
        color: #64748b;
        text-transform: uppercase;
        margin-bottom: 5px;
      }

      .btn-primary {
        background: #0f172a;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 13px;
      }
      .btn-sm {
        padding: 6px 10px;
        font-size: 12px;
      }
      .btn-outline {
        background: white;
        color: #333;
        border: 1px solid #cbd5e1;
      }
      .btn-outline:hover {
        background: #f1f5f9;
      }

      /* Tareas */
      .task-item {
        background: #fff;
        border: 1px solid #e2e8f0;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s;
      }
      .task-item:hover {
        border-color: #cbd5e1;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }
      .task-meta {
        font-size: 11px;
        color: #94a3b8;
        display: flex;
        gap: 10px;
        margin-top: 4px;
      }
      .badge-priority {
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: bold;
        text-transform: uppercase;
      }
      .p-Alta {
        background: #fee2e2;
        color: #991b1b;
      }
      .p-Media {
        background: #fef3c7;
        color: #92400e;
      }
      .p-Baja {
        background: #f1f5f9;
        color: #475569;
      }

      /* Avatar */
      .avatar {
        width: 40px;
        height: 40px;
        background: #e2e8f0;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #64748b;
        overflow: hidden;
      }
      .avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .big-avatar {
        width: 100px;
        height: 100px;
        background: #e2e8f0;
        border-radius: 50%;
        margin: 0 auto 15px;
        overflow: hidden;
        position: relative;
        border: 3px solid white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .big-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      /* Upload Button */
      .upload-btn-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
        cursor: pointer;
      }
      .btn-upload {
        border: 1px solid #cbd5e1;
        color: #64748b;
        background-color: white;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 700;
        cursor: pointer;
      }
      .upload-btn-wrapper input[type="file"] {
        font-size: 100px;
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        cursor: pointer;
      }

      /* Spinner */
      .spinner-overlay {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        place-items: center;
        z-index: 2000;
      }
      .spinner {
        width: 30px;
        height: 30px;
        border: 4px solid #e2e8f0;
        border-top-color: #0f172a;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div id="header"></div>
    <main>
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 30px;
        "
      >
        <h1
          style="margin: 0; font-size: 24px; font-weight: 800; color: #0f172a"
        >
          Equipo de Agentes
        </h1>
        <div style="display: flex; gap: 10px">
          <button class="btn-primary btn-outline" onclick="cargarTodo()">
            <i class="fa-solid fa-rotate"></i> Actualizar
          </button>
          <button class="btn-primary" onclick="abrirModalAgente()">
            <i class="fa-solid fa-plus"></i> Nuevo Agente
          </button>
        </div>
      </div>

      <div class="kpi-row">
        <div class="kpi-card">
          <div class="kpi-icon kpi-green">
            <i class="fa-solid fa-sack-dollar"></i>
          </div>
          <div class="kpi-data">
            <h3 id="kpiTotalComision">$0</h3>
            <p>Comisiones (Mes)</p>
          </div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon kpi-blue">
            <i class="fa-solid fa-list-check"></i>
          </div>
          <div class="kpi-data">
            <h3 id="kpiTotalTareas">0</h3>
            <p>Tareas Pendientes</p>
          </div>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th style="width: 50px">Avatar</th>
              <th>Agente</th>
              <th>Rol / Contacto</th>
              <th>Calificación</th>
              <th style="text-align: center">Negocios</th>
              <th style="text-align: center">Tareas</th>
              <th style="text-align: right">A Pagar</th>
              <th style="text-align: right">Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaAgentes">
            <tr>
              <td colspan="8" style="text-align: center; padding: 30px">
                Cargando...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>

    <div id="modalAgente" class="modal">
      <div
        class="modal-content"
        style="
          max-width: 500px !important;
          height: auto !important;
          flex-direction: column;
        "
      >
        <div style="padding: 25px">
          <h2 id="modalTitleAgente" style="margin-top: 0; margin-bottom: 20px">
            Datos Agente
          </h2>
          <form id="formAgente">
            <input type="hidden" id="agenteID" />

            <div style="text-align: center; margin-bottom: 20px">
              <div class="big-avatar">
                <img
                  id="previewAvatar"
                  src="assets/img/default_avatar.png"
                  onerror="this.style.display='none'"
                />
                <div
                  id="avatarInitials"
                  style="
                    display: flex;
                    width: 100%;
                    height: 100%;
                    align-items: center;
                    justify-content: center;
                    font-size: 30px;
                    color: #cbd5e1;
                    background: #f1f5f9;
                  "
                >
                  <i class="fa-solid fa-user"></i>
                </div>
              </div>
              <div class="upload-btn-wrapper">
                <button class="btn-upload" type="button">
                  <i class="fa-solid fa-camera"></i> Subir Foto
                </button>
                <input
                  type="file"
                  id="inpAvatarFile"
                  accept="image/*"
                  onchange="previewFile()"
                />
              </div>
            </div>

            <div style="display: grid; gap: 15px">
              <div>
                <label class="label">Nombre Completo</label>
                <input
                  type="text"
                  id="agenteNombre"
                  class="input-std"
                  required
                />
              </div>
              <div
                style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px"
              >
                <div>
                  <label class="label">Email</label>
                  <input
                    type="email"
                    id="agenteEmail"
                    class="input-std"
                    required
                  />
                </div>
                <div>
                  <label class="label">Teléfono</label>
                  <input type="text" id="agenteTelefono" class="input-std" />
                </div>
              </div>
              <div>
                <label class="label">Rol</label>
                <select id="agenteRol" class="input-std">
                  <option value="Agente">Agente Inmobiliario</option>
                  <option value="Supervisor">Supervisor</option>
                  <option value="Administrativo">Administrativo</option>
                </select>
              </div>
            </div>

            <div
              style="
                text-align: right;
                margin-top: 25px;
                display: flex;
                justify-content: end;
                gap: 10px;
              "
            >
              <button
                type="button"
                class="btn-primary btn-outline"
                onclick="cerrarModal('modalAgente')"
              >
                Cancelar
              </button>
              <button type="submit" class="btn-primary">Guardar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div id="modalTareas" class="modal">
      <div
        class="modal-content"
        style="max-width: 800px !important; height: 80vh !important"
      >
        <div class="modal-sidebar" style="width: 250px">
          <h3 style="margin-top: 0">Nueva Tarea</h3>
          
          <form id="formTarea">
            <input type="hidden" id="tareaAgenteID" />
            <input type="hidden" id="tareaEditID" /> <div style="margin-bottom: 10px">
              <label class="label">Título</label>
              <input
                id="tareaTitulo"
                class="input-std"
                required
                placeholder="Ej: Llamar cliente..."
              />
            </div>
            <div style="margin-bottom: 10px">
              <label class="label">Prioridad</label>
              <select id="tareaPrioridad" class="input-std">
                <option value="Alta">Alta</option>
                <option value="Media" selected>Media</option>
                <option value="Baja">Baja</option>
              </select>
            </div>
            <div style="margin-bottom: 10px">
              <label class="label">Vencimiento</label>
              <input type="date" id="tareaFecha" class="input-std" required />
            </div>
            <div style="margin-bottom: 15px">
              <label class="label">Detalle</label>
              <textarea id="tareaDesc" class="input-std" rows="3"></textarea>
            </div>
            
            <div style="display: flex; gap: 5px">
                <button
                  type="button"
                  id="btnCancelEdit"
                  class="btn-primary btn-outline"
                  style="display: none; flex: 1"
                  onclick="resetFormTarea()"
                >
                  Cancelar
                </button>
                <button
                  type="submit"
                  id="btnSubmitTarea"
                  class="btn-primary"
                  style="flex: 2; justify-content: center"
                >
                  Asignar Tarea
                </button>
              </div>
          </form>
        </div>

        <div class="modal-main">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
            "
          >
            <h2 style="margin: 0">Lista de Tareas</h2>
            <button
              class="btn-primary btn-outline"
              onclick="cerrarModal('modalTareas')"
            >
              Cerrar
            </button>
          </div>
          <div id="listaTareasContainer"></div>
        </div>
      </div>
    </div>

    <div id="modalGestion" class="modal">
      <div
        class="modal-content"
        style="
          width: 95% !important;
          max-width: 1300px !important;
          height: 90vh !important;
        "
      >
        <div
          class="modal-sidebar"
          style="
            width: 300px;
            flex-shrink: 0;
            background: #f8fafc;
            border-right: 1px solid #e2e8f0;
          "
        >
          <div style="text-align: center; margin-bottom: 30px">
            <div class="big-avatar" id="mdlGestionAvatar"></div>
            <h3 id="mdlNombre" style="margin: 0; font-size: 18px">Nombre</h3>
            <p
              id="mdlEmail"
              style="color: #64748b; font-size: 12px; word-break: break-all"
            >
              email
            </p>
            <div
              class="stars"
              id="mdlStars"
              style="margin-top: 10px; color: #f59e0b; letter-spacing: 2px"
            >
              ★★★★★
            </div>
          </div>

          <form id="formPerfil">
            <input type="hidden" id="gestionAgenteID" />
            <div style="margin-bottom: 15px">
              <label class="label">Calificación (1-5)</label>
              <input
                type="number"
                id="inpRating"
                class="input-std"
                min="1"
                max="5"
              />
            </div>
            <button
              type="submit"
              class="btn-primary"
              style="width: 100%; justify-content: center"
            >
              Actualizar Calificación
            </button>
          </form>
        </div>

        <div
          class="modal-main"
          style="flex: 1; padding: 30px; overflow-y: auto"
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              margin-bottom: 20px;
              align-items: center;
            "
          >
            <h2 style="margin: 0; font-size: 22px; color: #1e293b">
              Registrar Negocio
            </h2>
            <button
              class="btn-primary btn-outline"
              onclick="cerrarModal('modalGestion')"
            >
              <i class="fa-solid fa-xmark"></i> Cerrar
            </button>
          </div>

          <div
            style="
              border: 1px solid #e2e8f0;
              border-radius: 12px;
              padding: 25px;
              box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
              background: white;
            "
          >
            <form id="formTransaccion">
              <div class="row-flex" style="gap: 20px">
                <div class="col-flex" style="max-width: 250px">
                  <label class="label">Tipo de Negocio</label>
                  <select
                    id="tTipo"
                    class="input-std"
                    onchange="toggleCalculadora()"
                    style="font-weight: bold; color: #0f172a"
                  >
                    <option value="Venta">Venta Propiedad</option>
                    <option value="Arriendo">Arriendo</option>
                    <option value="Captacion">
                      Captación Edificio (Admin)
                    </option>
                  </select>
                </div>

                <div
                  id="divSelectEdificios"
                  class="col-flex"
                  style="display: none; flex: 2"
                >
                  <label class="label">Seleccionar Edificio</label>
                  <select
                    id="selEdificio"
                    class="input-std"
                    onchange="seleccionarEdificio()"
                  >
                    <option value="">-- Elige un edificio --</option>
                  </select>
                </div>

                <div id="divInputManual" class="col-flex" style="flex: 2">
                  <label class="label">Propiedad / Detalle</label>
                  <input
                    type="text"
                    id="tPropiedad"
                    class="input-std"
                    placeholder="Ej: Depto 301, Calle..."
                    required
                  />
                </div>
              </div>

              <div
                id="calcAdmin"
                style="
                  background: #f0fdf4;
                  border: 1px solid #bbf7d0;
                  padding: 20px;
                  border-radius: 8px;
                  margin-top: 20px;
                  display: none;
                "
              >
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 15px;
                    border-bottom: 1px solid #bbf7d0;
                    padding-bottom: 10px;
                  "
                >
                  <strong style="color: #166534; font-size: 15px"
                    ><i class="fa-solid fa-calculator"></i> Honorarios
                    Administración</strong
                  >
                  <span
                    style="
                      font-size: 12px;
                      background: #fff;
                      padding: 4px 10px;
                      border-radius: 6px;
                      border: 1px solid #bbf7d0;
                    "
                    >UTM Hoy: <b><span id="lblUTM">--</span></b></span
                  >
                </div>
                <div class="row-flex" style="gap: 20px">
                  <div class="col-flex">
                    <label class="label">N° Unidades</label>
                    <input
                      type="number"
                      id="cUnidades"
                      class="input-std"
                      placeholder="0"
                      oninput="calcularAuto()"
                    />
                  </div>
                  <div class="col-flex">
                    <label class="label">Factor</label>
                    <input
                      type="number"
                      id="cFactor"
                      class="input-std"
                      value="1.0"
                      step="0.1"
                      oninput="calcularAuto()"
                    />
                  </div>
                  <div class="col-flex" style="text-align: right">
                    <label class="label">Total Comunidad Mensual</label>
                    <div
                      id="lblHonorarioTotal"
                      style="font-weight: 800; font-size: 18px; color: #1e293b"
                    >
                      $0
                    </div>
                  </div>
                </div>
                <div
                  style="
                    text-align: right;
                    font-size: 13px;
                    color: #166534;
                    margin-top: 10px;
                  "
                >
                  Comisión Sugerida (50% del primer mes):
                  <span
                    id="lblPagoAgente"
                    style="font-size: 18px; font-weight: 800; margin-left: 5px"
                    >$0</span
                  >
                </div>
              </div>

              <div
                id="calcVenta"
                style="
                  background: #f0fdf4;
                  border: 1px solid #bbf7d0;
                  padding: 20px;
                  border-radius: 8px;
                  margin-top: 20px;
                  display: block;
                "
              >
                <div class="row-flex" style="gap: 20px">
                  <div class="col-flex">
                    <label class="label">Valor Propiedad</label>
                    <input
                      type="number"
                      id="vMonto"
                      class="input-std"
                      placeholder="$"
                      oninput="calcularVenta()"
                    />
                  </div>
                  <div class="col-flex">
                    <label class="label">% Comisión Empresa</label>
                    <input
                      type="number"
                      id="vPctEmpresa"
                      class="input-std"
                      value="2"
                      placeholder="2%"
                      oninput="calcularVenta()"
                    />
                  </div>
                  <div class="col-flex">
                    <label class="label">% Punta Agente</label>
                    <input
                      type="number"
                      id="vPctAgente"
                      class="input-std"
                      value="50"
                      placeholder="50%"
                      oninput="calcularVenta()"
                    />
                  </div>
                  <div class="col-flex" style="text-align: right">
                    <label class="label">A Pagar al Agente</label>
                    <div
                      id="lblPagoVenta"
                      style="font-size: 20px; font-weight: 800; color: #166534"
                    >
                      $0
                    </div>
                  </div>
                </div>
              </div>

              <div
                class="row-flex"
                style="
                  margin-top: 25px;
                  border-top: 1px solid #e2e8f0;
                  padding-top: 20px;
                  align-items: center;
                "
              >
                <div class="col-flex" style="flex: 2">
                  <label class="label" style="color: #0f172a; font-size: 12px"
                    >Monto Final a Registrar (Confirmar)</label
                  >
                  <input
                    type="number"
                    id="tPagoFinal"
                    class="input-std"
                    style="
                      font-weight: 800;
                      background: #f1f5f9;
                      font-size: 18px;
                      border-color: #94a3b8;
                      height: 50px;
                      color: #0f172a;
                    "
                    required
                  />
                </div>
                <div class="col-flex" style="flex: 0 0 auto">
                  <button
                    type="submit"
                    class="btn-primary"
                    style="height: 50px; padding: 0 40px; font-size: 15px"
                  >
                    <i class="fa-solid fa-check"></i> Registrar Negocio
                  </button>
                </div>
              </div>
            </form>
          </div>

          <h4
            style="
              margin: 30px 0 15px 0;
              color: #64748b;
              font-size: 12px;
              text-transform: uppercase;
              font-weight: 800;
              letter-spacing: 0.5px;
            "
          >
            Historial de Negocios
          </h4>
          <div id="listaTransacciones"></div>
        </div>
      </div>
    </div>

    <div id="spinner" class="spinner-overlay"><div class="spinner"></div></div>
    <div id="footer"></div>

    <script>
      const IMGBB_API_KEY = "d096ade1d65ede2aa12f00d94094a854";
      let AGENTES = [],
        TRANSACCIONES = [],
        EDIFICIOS = [],
        TAREAS = [];
      let AGENTE_ACTUAL = null;
      let VALOR_UTM = 64000;
      let AVATAR_URL_NUEVO = "";

      document.addEventListener("DOMContentLoaded", async () => {
        try {
          document.getElementById("header").innerHTML = await (
            await fetch("header.html")
          ).text();
          if (typeof initHeader === "function") initHeader();
        } catch (e) {}
        try {
          document.getElementById("footer").innerHTML = await (
            await fetch("footer.html")
          ).text();
        } catch (e) {}
        await cargarUTM();
        await cargarTodo();
      });

      async function cargarUTM() {
        try {
          const res = await fetch("https://mindicador.cl/api/utm");
          const data = await res.json();
          if (data.serie && data.serie.length > 0) {
            VALOR_UTM = parseInt(data.serie[0].valor);
            const lbl = document.getElementById("lblUTM");
            if (lbl) lbl.textContent = clp(VALOR_UTM);
          }
        } catch (e) {
          console.warn("UTM Offline.");
        }
      }

      async function cargarTodo() {
        showSpinner();
        try {
          const [agentes, trans, copros, tareas] = await Promise.all([
            fetchData("Agentes").catch(() => []),
            fetchData("Transacciones").catch(() => []),
            fetchData("Copropiedades").catch(() => []),
            fetchData("Tareas").catch(() => []),
          ]);
          AGENTES = agentes || [];
          TRANSACCIONES = trans || [];
          EDIFICIOS = copros || [];
          TAREAS = tareas || [];
          poblarSelectEdificios();
          renderTabla();
          calcularTotalMes();
        } catch (e) {
          console.error(e);
        } finally {
          hideSpinner();
        }
      }

      function poblarSelectEdificios() {
        const sel = document.getElementById("selEdificio");
        if (!sel) return;
        sel.innerHTML = '<option value="">-- Elige un edificio --</option>';
        EDIFICIOS.forEach((e) => {
          const u = e.Unidades || e.CantidadUnidades || 0;
          sel.innerHTML += `<option value="${e.ID}" data-unidades="${u}" data-nombre="${e.Nombre}">${e.Nombre}</option>`;
        });
      }

      /* RENDER TABLA PRINCIPAL */
      function renderTabla() {
        const tb = document.getElementById("tablaAgentes");
        tb.innerHTML = "";
        const tareasTotales = TAREAS.filter(
          (t) => t.Estado !== "Completada"
        ).length;
        document.getElementById("kpiTotalTareas").innerText = tareasTotales;

        AGENTES.forEach((a) => {
          const negocios = TRANSACCIONES.filter(
            (t) => String(t.AgenteID) === String(a.ID)
          );
          const total = negocios.reduce(
            (s, t) => s + (parseInt(t.PagoAgente) || 0),
            0
          );
          const misTareas = TAREAS.filter(
            (t) =>
              String(t.AgenteID) === String(a.ID) && t.Estado !== "Completada"
          );

          // Estrellas
          const r = parseInt(a.Calificacion) || 3;
          let stars = "";
          for (let i = 1; i <= 5; i++) {
            stars +=
              i <= r
                ? '<i class="fa-solid fa-star" style="color:#f59e0b"></i>'
                : '<i class="fa-regular fa-star" style="color:#cbd5e1"></i>';
          }

          let avatarHTML = `<div class="avatar">${a.Nombre.charAt(
            0
          ).toUpperCase()}</div>`;
          if (a.Avatar && a.Avatar.startsWith("http"))
            avatarHTML = `<div class="avatar"><img src="${a.Avatar}"></div>`;

          tb.innerHTML += `
            <tr>
                <td>${avatarHTML}</td>
                <td><div style="font-weight:600;">${a.Nombre}</div></td>
                <td><div style="font-size:12px; color:#64748b;">${
                  a.Rol || "Agente"
                }<br>${a.Email}</div></td>
                <td style="color:#f59e0b; letter-spacing:1px; font-size:12px;">${stars}</td> <td style="text-align:center; font-weight:700;">${
            negocios.length
          }</td>
                <td style="text-align:center;"><span class="badge-priority p-Media">${
                  misTareas.length
                } Pen.</span></td>
                <td style="text-align:right;"><span style="background:#ecfdf5; color:#065f46; padding:4px 10px; border-radius:20px; font-weight:700;">${clp(
                  total
                )}</span></td>
                <td style="text-align:right;">
                    <button class="btn-primary btn-sm" onclick='abrirModalAgente("${
                      a.ID
                    }")' title="Editar Datos"><i class="fa-solid fa-user-pen"></i></button>
                    <button class="btn-primary btn-sm" style="background:#0f766e;" onclick='abrirModalTareas("${
                      a.ID
                    }")' title="Tareas"><i class="fa-solid fa-list-check"></i></button>
                    <button class="btn-primary btn-sm" style="background:#3b82f6;" onclick='abrirModalGestion("${
                      a.ID
                    }")' title="Negocios"><i class="fa-solid fa-briefcase"></i></button>
                </td>
            </tr>`;
        });

        if (AGENTES.length === 0)
          tb.innerHTML = `<tr><td colspan="8" style="text-align:center;">Sin datos.</td></tr>`;
      }

      function calcularTotalMes() {
        const total = TRANSACCIONES.reduce(
          (s, t) => s + (parseInt(t.PagoAgente) || 0),
          0
        );
        document.getElementById("kpiTotalComision").innerText = clp(total);
      }

      /* LOGICA AGENTES */
      function abrirModalAgente(id) {
        document.getElementById("formAgente").reset();
        document.getElementById("agenteID").value = "";
        AVATAR_URL_NUEVO = "";
        document.getElementById("previewAvatar").style.display = "none";
        document.getElementById("avatarInitials").style.display = "flex";
        document.getElementById("modalTitleAgente").textContent =
          "Nuevo Agente";

        if (id) {
          const a = AGENTES.find((x) => String(x.ID) === String(id));
          if (a) {
            document.getElementById("modalTitleAgente").textContent =
              "Editar Agente";
            document.getElementById("agenteID").value = a.ID;
            document.getElementById("agenteNombre").value = a.Nombre;
            document.getElementById("agenteEmail").value = a.Email;
            document.getElementById("agenteTelefono").value = a.Telefono;
            document.getElementById("agenteRol").value = a.Rol || "Agente";
            if (a.Avatar && a.Avatar.startsWith("http")) {
              document.getElementById("previewAvatar").src = a.Avatar;
              document.getElementById("previewAvatar").style.display = "block";
              document.getElementById("avatarInitials").style.display = "none";
            }
          }
        }
        document.getElementById("modalAgente").style.display = "flex";
      }

      document.getElementById("formAgente").onsubmit = async (e) => {
        e.preventDefault();
        showSpinner();
        const id = document.getElementById("agenteID").value;
        const payload = {
          Nombre: document.getElementById("agenteNombre").value,
          Email: document.getElementById("agenteEmail").value,
          Telefono: document.getElementById("agenteTelefono").value,
          Rol: document.getElementById("agenteRol").value,
          Activo: true,
        };
        if (AVATAR_URL_NUEVO) payload["Avatar"] = AVATAR_URL_NUEVO;
        if (id) payload["ID"] = id;
        else payload["ID"] = "AGE_" + Date.now();

        try {
          const action = id ? "Edit" : "Add";
          await appSheetCRUD("Agentes", action, [payload]);
          cerrarModal("modalAgente");
          await cargarTodo();
        } catch (err) {
          alert(err.message);
        } finally {
          hideSpinner();
        }
      };

      /* LOGICA TAREAS (MODIFICADA) */
      function abrirModalTareas(id) {
        const a = AGENTES.find((x) => String(x.ID) === String(id));
        if (!a) return;
        document.getElementById("tareaAgenteID").value = a.ID;
        
        // Siempre limpiar al abrir
        resetFormTarea();
        
        renderTareasAgente(a.ID);
        document.getElementById("modalTareas").style.display = "flex";
      }

      function resetFormTarea() {
        document.getElementById("tareaEditID").value = ""; 
        document.getElementById("tareaTitulo").value = "";
        document.getElementById("tareaDesc").value = "";
        document.getElementById("tareaPrioridad").value = "Media";
        document.getElementById("tareaFecha").valueAsDate = new Date();
        
        document.getElementById("btnSubmitTarea").innerText = "Asignar Tarea";
        document.getElementById("btnCancelEdit").style.display = "none";
      }

      function cargarDatosTarea(idTarea) {
        const t = TAREAS.find(x => String(x.ID) === String(idTarea));
        if(!t) return;

        document.getElementById("tareaEditID").value = t.ID;
        document.getElementById("tareaTitulo").value = t["Título"];
        document.getElementById("tareaDesc").value = t["Descripción"] || "";
        document.getElementById("tareaPrioridad").value = t.Prioridad;
        document.getElementById("tareaFecha").value = t.FechaLimite;

        document.getElementById("btnSubmitTarea").innerText = "Guardar Cambios";
        document.getElementById("btnCancelEdit").style.display = "block";
      }

      function renderTareasAgente(id) {
        const lista = document.getElementById("listaTareasContainer");
        const misTareas = TAREAS.filter(
          (t) => String(t.AgenteID) === String(id)
        );
        misTareas.sort(
          (a, b) => (a.Estado === "Completada") - (b.Estado === "Completada")
        );

        if (misTareas.length === 0) {
          lista.innerHTML =
            '<div style="text-align:center; color:#94a3b8; padding:20px;">Sin tareas asignadas.</div>';
          return;
        }

        lista.innerHTML = misTareas
          .map((t) => {
            const done = t.Estado === "Completada";
            const style = done
              ? "opacity:0.6; text-decoration:line-through;"
              : "";
              
            const btnState = done
              ? `<button class="btn-primary btn-sm btn-outline" onclick="cambiarEstadoTarea('${t.ID}', 'Pendiente')" title="Reabrir"><i class="fa-solid fa-rotate-left"></i></button>`
              : `<button class="btn-primary btn-sm" style="background:#166534;" onclick="cambiarEstadoTarea('${t.ID}', 'Completada')" title="Completar"><i class="fa-solid fa-check"></i></button>`;

            const btnEdit = !done 
                ? `<button class="btn-primary btn-sm btn-outline" onclick="cargarDatosTarea('${t.ID}')" title="Editar"><i class="fa-solid fa-pen"></i></button>`
                : '';

            return `
            <div class="task-item">
                <div style="${style}; flex:1;">
                    <div style="font-weight:bold; color:#334155;">${
                      t["Título"]
                    }</div>
                    <div style="font-size:12px; color:#64748b;">${
                      t["Descripción"] || ""
                    }</div>
                    <div class="task-meta">
                        <span class="badge-priority p-${t.Prioridad}">${
              t.Prioridad
            }</span>
                        <span><i class="fa-regular fa-clock"></i> ${
                          t.FechaLimite || "-"
                        }</span>
                    </div>
                </div>
                <div style="display:flex; gap:5px; margin-left:10px;">
                    ${btnEdit}
                    ${btnState}
                </div>
            </div>`;
          })
          .join("");
      }

      document.getElementById("formTarea").onsubmit = async (e) => {
        e.preventDefault();
        showSpinner();
        const agenteID = document.getElementById("tareaAgenteID").value;
        const editID = document.getElementById("tareaEditID").value;
        
        const payload = {
          AgenteID: agenteID,
          Título: document.getElementById("tareaTitulo").value,
          Descripción: document.getElementById("tareaDesc").value,
          Prioridad: document.getElementById("tareaPrioridad").value,
          FechaLimite: document.getElementById("tareaFecha").value,
        };

        try {
          if (editID) {
            // EDITAR
            payload.ID = editID;
            await appSheetCRUD("Tareas", "Edit", [payload]);
            // Actualizar local
            const idx = TAREAS.findIndex(t => t.ID === editID);
            if(idx !== -1) {
                TAREAS[idx] = { ...TAREAS[idx], ...payload };
            }
          } else {
            // CREAR
            payload.ID = "TSK_" + Date.now();
            payload.Estado = "Pendiente";
            payload.FechaCreación = new Date().toISOString().split("T")[0];
            await appSheetCRUD("Tareas", "Add", [payload]);
            TAREAS.push(payload);
          }
          
          resetFormTarea();
          renderTareasAgente(agenteID);
          renderTabla();
        } catch (e) {
          alert(e.message);
        } finally {
          hideSpinner();
        }
      };

      async function cambiarEstadoTarea(id, nuevoEstado) {
        showSpinner();
        try {
          await appSheetCRUD("Tareas", "Edit", [
            { ID: id, Estado: nuevoEstado },
          ]);
          const t = TAREAS.find((x) => x.ID === id);
          if (t) t.Estado = nuevoEstado;
          const agenteID = document.getElementById("tareaAgenteID").value;
          renderTareasAgente(agenteID);
          renderTabla();
        } catch (e) {
          alert(e.message);
        } finally {
          hideSpinner();
        }
      }

      /* LOGICA NEGOCIOS (CALIFICACION & TRANSACCIONES) */
      function abrirModalGestion(id) {
        const a = AGENTES.find((x) => String(x.ID) === String(id));
        if (!a) return;
        AGENTE_ACTUAL = a;
        document.getElementById("mdlNombre").textContent = a.Nombre;
        document.getElementById("mdlEmail").textContent = a.Email;
        document.getElementById("gestionAgenteID").value = a.ID;
        document.getElementById("inpRating").value = a.Calificacion || 3;

        const avatarContainer = document.getElementById("mdlGestionAvatar");
        if (a.Avatar && a.Avatar.startsWith("http"))
          avatarContainer.innerHTML = `<img src="${a.Avatar}">`;
        else
          avatarContainer.innerHTML = `<div style="display:flex; width:100%; height:100%; align-items:center; justify-content:center; font-size:30px; color:#cbd5e1;"><i class="fa-solid fa-user"></i></div>`;

        document.getElementById("formTransaccion").reset();
        toggleCalculadora();
        renderHistorial();
        document.getElementById("modalGestion").style.display = "flex";
      }

      document.getElementById("formPerfil").onsubmit = async (e) => {
        e.preventDefault();
        showSpinner();

        const id = document.getElementById("gestionAgenteID").value;
        const cal = document.getElementById("inpRating").value;

        if (!id) {
          hideSpinner();
          return alert("Error: Agente no identificado.");
        }

        try {
          await appSheetCRUD("Agentes", "Edit", [
            { ID: id, Calificacion: cal },
          ]);

          const index = AGENTES.findIndex((a) => String(a.ID) === String(id));
          if (index !== -1) {
            AGENTES[index].Calificacion = cal;
            AGENTE_ACTUAL = AGENTES[index];
          }

          let stars = "";
          for (let i = 1; i <= 5; i++) {
            stars += i <= parseInt(cal) ? "★" : "☆";
          }
          document.getElementById("mdlStars").innerHTML = stars;
          renderTabla();
          alert("Calificación actualizada.");
        } catch (err) {
          console.error(err);
          alert("Error al actualizar: " + err.message);
        } finally {
          hideSpinner();
        }
      };

      /* UTILS & HELPERS */
      function toggleCalculadora() {
        const tipo = document.getElementById("tTipo").value;
        document.getElementById("calcAdmin").style.display =
          tipo === "Captacion" ? "block" : "none";
        document.getElementById("calcVenta").style.display =
          tipo !== "Captacion" ? "block" : "none";
        document.getElementById("divSelectEdificios").style.display =
          tipo === "Captacion" ? "block" : "none";
        document.getElementById("divInputManual").style.display =
          tipo !== "Captacion" ? "block" : "none";
      }

      function seleccionarEdificio() {
        const sel = document.getElementById("selEdificio");
        const opt = sel.options[sel.selectedIndex];
        if (opt.value) {
          document.getElementById("tPropiedad").value =
            opt.getAttribute("data-nombre");
          document.getElementById("cUnidades").value =
            opt.getAttribute("data-unidades") || 0;
          calcularAuto();
        }
      }

      function calcularAuto() {
        const unid = parseInt(document.getElementById("cUnidades").value) || 0;
        const fac = parseFloat(document.getElementById("cFactor").value) || 0;
        if (unid > 0 && fac > 0) {
          const base = VALOR_UTM * 2.15;
          let netoTeorico =
            unid < 20
              ? base * fac
              : (base + (unid - 20) * (base * 0.013)) * fac;
          const honorarioNeto = Math.round(netoTeorico / 1000) * 1000;
          document.getElementById("lblHonorarioTotal").innerText = clp(
            Math.round(honorarioNeto * 1.19)
          );
          const comision = Math.round(honorarioNeto * 0.5);
          document.getElementById("lblPagoAgente").innerText = clp(comision);
          document.getElementById("tPagoFinal").value = comision;
        }
      }

      function calcularVenta() {
        const monto = parseInt(document.getElementById("vMonto").value) || 0;
        const pctEmpresa =
          parseFloat(document.getElementById("vPctEmpresa").value) / 100;
        const pctAgente =
          parseFloat(document.getElementById("vPctAgente").value) / 100;
        if (monto > 0) {
          const ingresoNeto = Math.round((monto * pctEmpresa) / 1.19);
          const pago = Math.round(ingresoNeto * pctAgente);
          document.getElementById("lblPagoVenta").innerText = clp(pago);
          document.getElementById("tPagoFinal").value = pago;
        }
      }

      function renderHistorial() {
        const div = document.getElementById("listaTransacciones");
        const list = TRANSACCIONES.filter(
          (t) => String(t.AgenteID) === String(AGENTE_ACTUAL.ID)
        ).reverse();
        if (list.length === 0) {
          div.innerHTML =
            '<div style="color:#94a3b8; font-size:13px; text-align:center;">Sin negocios.</div>';
          return;
        }
        div.innerHTML = list
          .map(
            (t) => `
            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #f1f5f9; padding:10px 0; font-size:13px;">
                <div><span style="font-weight:700; color:#475569;">[${
                  t.Tipo
                }]</span> ${
              t.Propiedad
            } <div style="font-size:11px; color:#cbd5e1;">${t.Fecha}</div></div>
                <div style="font-weight:700; color:#166534;">${clp(
                  t.PagoAgente
                )}</div>
            </div>`
          )
          .join("");
      }

      async function previewFile() {
        const file = document.getElementById("inpAvatarFile").files[0];
        if (!file || !IMGBB_API_KEY) return;
        showSpinner();
        const formData = new FormData();
        formData.append("image", file);
        try {
          const res = await fetch(
            `https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,
            { method: "POST", body: formData }
          );
          const data = await res.json();
          if (data.success) {
            AVATAR_URL_NUEVO = data.data.url;
            document.getElementById("previewAvatar").src = AVATAR_URL_NUEVO;
            document.getElementById("previewAvatar").style.display = "block";
            document.getElementById("avatarInitials").style.display = "none";
          }
        } catch (e) {
          console.error(e);
        } finally {
          hideSpinner();
        }
      }

      function showSpinner() {
        document.getElementById("spinner").style.display = "flex";
      }
      function hideSpinner() {
        document.getElementById("spinner").style.display = "none";
      }
      function clp(n) {
        return "$" + new Intl.NumberFormat("es-CL").format(Math.round(n) || 0);
      }
      function cerrarModal(id) {
        document.getElementById(id).style.display = "none";
      }
    </script>
  </body>
</html>