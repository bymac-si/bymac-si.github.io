<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>CRM - Gestión de Unidades</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="assets/css/styles.css">
  <script src="assets/js/app.js"></script>
  <script>requireAuth();</script>

  
    <link rel="stylesheet" href="assets/css/pages/unidades.inline.css">
</head>
<body>

<div id="header"></div>

<main>
  <div class="dashboard-header">
    <div class="header-top">
      <div>
        <h1 class="page-title">Gestión de Unidades</h1>
        <p style="margin:5px 0 0; color:#64748b; font-size:14px;">Configura departamentos, casas, bodegas y estacionamientos.</p>
      </div>
      <div style="display:flex; gap:10px;">
        <button class="btn-sec" onclick="cargarDatos()" title="Recargar"><i class="fa-solid fa-rotate-right"></i></button>
        <button class="btn-green" onclick="abrirImportar()">
            <i class="fa-solid fa-file-excel"></i> Importar Masivo
        </button>
        <button class="btn-main" onclick="abrirModal()">
            <i class="fa-solid fa-plus"></i> Nueva Unidad
        </button>
      </div>
    </div>

    <div class="header-filters">
      <div class="filter-group" style="flex: 2;">
        <label class="label">Comunidad / Condominio</label>
        <select id="filtroCopropiedad" class="input-modern" onchange="aplicarFiltros()">
            <option value="">(Cargando...)</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="label">Buscar Unidad</label>
        <input id="filtroBuscar" class="input-modern" placeholder="Ej: 105, A-20..." onkeyup="aplicarFiltros()">
      </div>

      <div class="filter-group">
        <label class="label">Torre / Sector</label>
        <select id="filtroTorre" class="input-modern" onchange="aplicarFiltros()">
            <option value="">(Todas)</option>
        </select>
      </div>
    </div>
  </div>

  <div style="background:white; border-radius:12px; border:1px solid #e2e8f0; overflow:hidden;">
    <table>
        <thead>
            <tr>
                <th>Unidad</th>
                <th>Torre</th>
                <th>Piso</th>
                <th>Alicuota %</th>
                <th>Estado</th>
                <th style="text-align:right;">Acciones</th>
            </tr>
        </thead>
        <tbody id="tablaUnidades">
            <tr><td colspan="6" style="text-align:center; padding:30px; color:#94a3b8;">Selecciona una Comunidad para ver sus unidades.</td></tr>
        </tbody>
    </table>
  </div>
</main>

<div id="modalUnidad" class="modal">
    <div class="modal-content">
        <h2 id="modalTitle" style="margin-top:0;">Nueva Unidad</h2>
        <form id="formUnidad">
            <input type="hidden" id="uID">
            
            <label class="label" style="margin-top:10px;">Comunidad</label>
            <input id="uCopropiedadNombre" class="input-modern" style="background:#f1f5f9;" readonly>
            <input type="hidden" id="uCopropiedadID">

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:15px;">
                <div>
                    <label class="label">Número Unidad</label>
                    <input id="uNumero" class="input-modern" required placeholder="Ej: 101">
                </div>
                <div>
                    <label class="label">Torre / Bloque</label>
                    <input id="uTorre" class="input-modern" placeholder="Ej: A">
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:15px;">
                <div>
                    <label class="label">Piso</label>
                    <input id="uPiso" class="input-modern" type="number">
                </div>
                <div>
                    <label class="label">Alicuota (%)</label>
                    <input id="uAlicuota" class="input-modern" type="number" step="0.01" placeholder="0.00">
                </div>
            </div>

            <label class="label" style="margin-top:15px;">Estado</label>
            <select id="uEstado" class="input-modern">
                <option value="Disponible">Disponible</option>
                <option value="Ocupada">Ocupada</option>
                <option value="Arrendada">Arrendada</option>
                <option value="En Mantención">En Mantención</option>
            </select>

            <div style="text-align:right; margin-top:25px;">
                <button type="button" class="btn-sec" onclick="cerrarModal()">Cancelar</button>
                <button type="submit" class="btn-main">Guardar</button>
            </div>
        </form>
    </div>
</div>

<div id="modalImportar" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <h2 style="margin-top:0;"><i class="fa-solid fa-file-excel" style="color:#10b981;"></i> Carga Masiva de Unidades</h2>
        <p style="color:#64748b; font-size:13px; margin-bottom:15px;">
            Copia desde Excel y pega abajo. El orden de columnas debe ser: <br>
            <b>1. Número | 2. Torre | 3. Piso | 4. Alicuota</b> (Sin encabezados)
        </p>
        
        <textarea id="txtPaste" class="paste-area" placeholder="Ejemplo:
101	A	1	1.5
102	A	1	1.5
201	A	2	1.6"></textarea>

        <div style="display:flex; justify-content:space-between; align-items:center;">
            <button type="button" class="btn-sec" onclick="procesarPegado()"><i class="fa-solid fa-eye"></i> Previsualizar</button>
            <span id="importStats" style="font-size:12px; font-weight:700;"></span>
        </div>

        <div style="max-height:250px; overflow-y:auto; border:1px solid #e2e8f0; border-radius:6px; margin-top:10px;">
            <table class="preview-table">
                <thead>
                    <tr><th>#</th><th>N° Unidad</th><th>Torre</th><th>Piso</th><th>Alicuota</th></tr>
                </thead>
                <tbody id="tblPreview">
                    <tr><td colspan="5" style="text-align:center; color:#ccc;">Nada para mostrar aún...</td></tr>
                </tbody>
            </table>
        </div>

        <div style="text-align:right; margin-top:20px; border-top:1px solid #f1f5f9; padding-top:15px;">
            <button type="button" class="btn-sec" onclick="document.getElementById('modalImportar').style.display='none'">Cerrar</button>
            <button type="button" class="btn-green" onclick="enviarCargaMasiva()" id="btnConfirmarCarga" disabled>Confirmar Carga</button>
        </div>
    </div>
</div>

<div id="pageSpinner" class="spinner-overlay">
    <div style="text-align:center;">
        <div class="spinner"></div>
        <div id="spinnerText" style="margin-top:10px; font-weight:600; color:#1A2B48;">Cargando...</div>
    </div>
</div>

<div id="footer"></div>

<script src="assets/js/pages/unidades.inline.js"></script>

</body>
</html>