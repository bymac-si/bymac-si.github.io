<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>CRM - Gestión de Unidades</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="assets/css/styles.css">
  <script src="assets/js/app.js"></script>
  <script>requireAuth();</script>

  <style>
    /* Estilos Base */
    body { max-width: 1200px; margin: 0 auto; color: #1a2b48; background-color: #f8fafc; }
    main { padding: 40px; }
    
    /* Header y Filtros */
    .dashboard-header { background: #fff; padding: 20px 25px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 25px; }
    .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .page-title { font-size: 24px; font-weight: 700; margin: 0; color: #1e293b; }
    
    .header-filters { display: flex; gap: 15px; flex-wrap: wrap; align-items: end; }
    .filter-group { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 200px; }
    .label { font-size: 12px; font-weight: 700; color: #64748b; text-transform: uppercase; }
    .input-modern { height: 42px; padding: 0 12px; border: 1px solid #cbd5e1; border-radius: 8px; background: #fff; width: 100%; box-sizing: border-box; }

    /* Botones */
    .btn-main { background: #1A2B48; color: white; border: none; padding: 0 20px; height: 42px; border-radius: 8px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
    .btn-sec { background: #fff; color: #1A2B48; border: 1px solid #cbd5e1; padding: 0 15px; height: 42px; border-radius: 8px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
    .btn-green { background: #10b981; color: white; border: none; padding: 0 20px; height: 42px; border-radius: 8px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
    .btn-icon { width: 32px; height: 32px; border-radius: 6px; border: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; color: #64748b; background: #f1f5f9; }
    .btn-icon:hover { background: #e2e8f0; color: #1e293b; }

    /* Tabla */
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
    th { background: #f8fafc; font-weight: 600; color: #475569; text-transform: uppercase; font-size: 11px; }

    /* Modales */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; width: 100%; max-width: 600px; padding: 30px; border-radius: 12px; max-height: 90vh; overflow-y: auto; }

    /* Spinner */
    .spinner-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: none; place-items: center; z-index: 2000; }
    .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: #1A2B48; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Área de Pegado Excel */
    .paste-area {
        width: 100%; height: 150px; padding: 10px; font-family: monospace; font-size: 12px;
        border: 2px dashed #cbd5e1; border-radius: 8px; background: #f8fafc;
        margin-bottom: 15px; resize: vertical;
    }
    .paste-area:focus { border-color: #1A2B48; outline: none; background: #fff; }
    .preview-table { width: 100%; font-size: 12px; border: 1px solid #e2e8f0; margin-top: 10px; }
    .preview-table th { background: #f1f5f9; padding: 5px; }
    .preview-table td { padding: 5px; border-top: 1px solid #e2e8f0; }
  </style>
</head>
<body>

<div id="header"></div>

<main>
  <div class="dashboard-header">
    <div class="header-top">
      <div>
        <h1 class="page-title">Gestión de Unidades</h1>
        <p style="margin:5px 0 0; color:#64748b; font-size:14px;">Configura departamentos, casas, bodegas y estacionamientos.</p>
      </div>
      <div style="display:flex; gap:10px;">
        <button class="btn-sec" onclick="cargarDatos()" title="Recargar"><i class="fa-solid fa-rotate-right"></i></button>
        <button class="btn-green" onclick="abrirImportar()">
            <i class="fa-solid fa-file-excel"></i> Importar Masivo
        </button>
        <button class="btn-main" onclick="abrirModal()">
            <i class="fa-solid fa-plus"></i> Nueva Unidad
        </button>
      </div>
    </div>

    <div class="header-filters">
      <div class="filter-group" style="flex: 2;">
        <label class="label">Comunidad / Condominio</label>
        <select id="filtroCopropiedad" class="input-modern" onchange="aplicarFiltros()">
            <option value="">(Cargando...)</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="label">Buscar Unidad</label>
        <input id="filtroBuscar" class="input-modern" placeholder="Ej: 105, A-20..." onkeyup="aplicarFiltros()">
      </div>

      <div class="filter-group">
        <label class="label">Torre / Sector</label>
        <select id="filtroTorre" class="input-modern" onchange="aplicarFiltros()">
            <option value="">(Todas)</option>
        </select>
      </div>
    </div>
  </div>

  <div style="background:white; border-radius:12px; border:1px solid #e2e8f0; overflow:hidden;">
    <table>
        <thead>
            <tr>
                <th>Unidad</th>
                <th>Torre</th>
                <th>Piso</th>
                <th>Prorrateo %</th>
                <th>Estado</th>
                <th style="text-align:right;">Acciones</th>
            </tr>
        </thead>
        <tbody id="tablaUnidades">
            <tr><td colspan="6" style="text-align:center; padding:30px; color:#94a3b8;">Selecciona una Comunidad para ver sus unidades.</td></tr>
        </tbody>
    </table>
  </div>
</main>

<div id="modalUnidad" class="modal">
    <div class="modal-content">
        <h2 id="modalTitle" style="margin-top:0;">Nueva Unidad</h2>
        <form id="formUnidad">
            <input type="hidden" id="uID">
            
            <label class="label" style="margin-top:10px;">Comunidad</label>
            <input id="uCopropiedadNombre" class="input-modern" style="background:#f1f5f9;" readonly>
            <input type="hidden" id="uCopropiedadID">

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:15px;">
                <div>
                    <label class="label">Número Unidad</label>
                    <input id="uNumero" class="input-modern" required placeholder="Ej: 101">
                </div>
                <div>
                    <label class="label">Torre / Bloque</label>
                    <input id="uTorre" class="input-modern" placeholder="Ej: A">
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:15px;">
                <div>
                    <label class="label">Piso</label>
                    <input id="uPiso" class="input-modern" type="number">
                </div>
                <div>
                    <label class="label">Prorrateo (%)</label>
                    <input id="uProrrateo" class="input-modern" type="number" step="0.01" placeholder="0.00">
                </div>
            </div>

            <label class="label" style="margin-top:15px;">Estado</label>
            <select id="uEstado" class="input-modern">
                <option value="Disponible">Disponible</option>
                <option value="Ocupada">Ocupada</option>
                <option value="Arrendada">Arrendada</option>
                <option value="En Mantención">En Mantención</option>
            </select>

            <div style="text-align:right; margin-top:25px;">
                <button type="button" class="btn-sec" onclick="cerrarModal()">Cancelar</button>
                <button type="submit" class="btn-main">Guardar</button>
            </div>
        </form>
    </div>
</div>

<div id="modalImportar" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <h2 style="margin-top:0;"><i class="fa-solid fa-file-excel" style="color:#10b981;"></i> Carga Masiva de Unidades</h2>
        <p style="color:#64748b; font-size:13px; margin-bottom:15px;">
            Copia desde Excel y pega abajo. El orden de columnas debe ser: <br>
            <b>1. Número | 2. Torre | 3. Piso | 4. Prorrateo</b> (Sin encabezados)
        </p>
        
        <textarea id="txtPaste" class="paste-area" placeholder="Ejemplo:
101	A	1	1.5
102	A	1	1.5
201	A	2	1.6"></textarea>

        <div style="display:flex; justify-content:space-between; align-items:center;">
            <button type="button" class="btn-sec" onclick="procesarPegado()"><i class="fa-solid fa-eye"></i> Previsualizar</button>
            <span id="importStats" style="font-size:12px; font-weight:700;"></span>
        </div>

        <div style="max-height:250px; overflow-y:auto; border:1px solid #e2e8f0; border-radius:6px; margin-top:10px;">
            <table class="preview-table">
                <thead>
                    <tr><th>#</th><th>N° Unidad</th><th>Torre</th><th>Piso</th><th>Prorrateo</th></tr>
                </thead>
                <tbody id="tblPreview">
                    <tr><td colspan="5" style="text-align:center; color:#ccc;">Nada para mostrar aún...</td></tr>
                </tbody>
            </table>
        </div>

        <div style="text-align:right; margin-top:20px; border-top:1px solid #f1f5f9; padding-top:15px;">
            <button type="button" class="btn-sec" onclick="document.getElementById('modalImportar').style.display='none'">Cerrar</button>
            <button type="button" class="btn-green" onclick="enviarCargaMasiva()" id="btnConfirmarCarga" disabled>Confirmar Carga</button>
        </div>
    </div>
</div>

<div id="pageSpinner" class="spinner-overlay">
    <div style="text-align:center;">
        <div class="spinner"></div>
        <div id="spinnerText" style="margin-top:10px; font-weight:600; color:#1A2B48;">Cargando...</div>
    </div>
</div>

<div id="footer"></div>

<script>
    let UNIDADES = [], COPROPIEDADES = [], VIEW = [];
    let DATA_TO_IMPORT = []; // Buffer para la carga masiva

    document.addEventListener("DOMContentLoaded", async () => {
        try { document.getElementById("header").innerHTML = await (await fetch("header.html")).text(); } catch(e){}
        try { document.getElementById("footer").innerHTML = await (await fetch("footer.html")).text(); } catch(e){}
        
        await cargarDatos();
        
        // Auto-seleccionar si viene por URL (ej: unidades.html?id=COPRO_123)
        const params = new URLSearchParams(window.location.search);
        const coproID = params.get('id');
        if(coproID) {
            document.getElementById("filtroCopropiedad").value = coproID;
            aplicarFiltros();
        }
    });

    async function cargarDatos() {
        showSpinner("Cargando base de datos...");
        try {
            const [u, c] = await Promise.all([
                fetchData("Unidades").catch(()=>[]),
                fetchData("Copropiedades").catch(()=>[])
            ]);
            
            UNIDADES = u || [];
            COPROPIEDADES = c || [];

            // Llenar Select Condominios
            const sel = document.getElementById("filtroCopropiedad");
            sel.innerHTML = '<option value="">-- Selecciona Comunidad --</option>' + 
                COPROPIEDADES.map(c => `<option value="${c.ID}">${c.Nombre}</option>`).join("");

        } catch(e) {
            console.error(e);
            alert("Error cargando datos: " + e.message);
        } finally {
            hideSpinner();
        }
    }

    function aplicarFiltros() {
        const idCopro = document.getElementById("filtroCopropiedad").value;
        const q = document.getElementById("filtroBuscar").value.toLowerCase();
        const torre = document.getElementById("filtroTorre").value;

        if(!idCopro) {
            document.getElementById("tablaUnidades").innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:#64748b;"><i class="fa-solid fa-arrow-up"></i><br>Por favor selecciona una Comunidad arriba.</td></tr>';
            return;
        }

        VIEW = UNIDADES.filter(u => String(u.CopropiedadID) === String(idCopro));
        
        // Llenar filtro de torres dinámicamente según la comunidad seleccionada
        const torresUnicas = [...new Set(VIEW.map(u => u.Torre).filter(Boolean))].sort();
        const selTorre = document.getElementById("filtroTorre");
        // Preservar selección si existe
        const prevTorre = selTorre.value;
        selTorre.innerHTML = '<option value="">(Todas)</option>' + torresUnicas.map(t => `<option value="${t}">${t}</option>`).join("");
        if(torresUnicas.includes(prevTorre)) selTorre.value = prevTorre;

        // Filtrar
        if(torre) VIEW = VIEW.filter(u => u.Torre === torre);
        if(q) VIEW = VIEW.filter(u => 
            (u.Numero||"").toLowerCase().includes(q) || 
            (u.Torre||"").toLowerCase().includes(q)
        );

        renderTabla();
    }

    function renderTabla() {
        const tb = document.getElementById("tablaUnidades");
        if(VIEW.length === 0) {
            tb.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No hay unidades registradas en esta comunidad.</td></tr>';
            return;
        }

        tb.innerHTML = VIEW.map(u => `
            <tr>
                <td style="font-weight:700;">${u.Numero}</td>
                <td>${u.Torre || '-'}</td>
                <td>${u.Piso || '-'}</td>
                <td>${u.Prorrateo ? u.Prorrateo + '%' : '-'}</td>
                <td><span style="font-size:11px; padding:3px 8px; border-radius:10px; background:${getColorEstado(u.Estado)}; color:#fff;">${u.Estado}</span></td>
                <td style="text-align:right;">
                    <button class="btn-icon" onclick="editar('${u.ID}')"><i class="fa-solid fa-pen"></i></button>
                    <button class="btn-icon" onclick="eliminar('${u.ID}')"><i class="fa-solid fa-trash"></i></button>
                </td>
            </tr>
        `).join("");
    }

    function getColorEstado(e) {
        if(e === 'Ocupada') return '#ef4444';
        if(e === 'Arrendada') return '#f59e0b';
        return '#10b981'; // Disponible
    }

    /* --- CRUD INDIVIDUAL --- */
    function abrirModal() {
        const idCopro = document.getElementById("filtroCopropiedad").value;
        if(!idCopro) return alert("Primero selecciona una comunidad en el filtro.");

        const copro = COPROPIEDADES.find(c => String(c.ID) === String(idCopro));

        document.getElementById("formUnidad").reset();
        document.getElementById("uID").value = "";
        document.getElementById("modalTitle").innerText = "Nueva Unidad";
        
        // Pre-llenar comunidad
        document.getElementById("uCopropiedadID").value = idCopro;
        document.getElementById("uCopropiedadNombre").value = copro ? copro.Nombre : "Error";
        
        document.getElementById("modalUnidad").style.display = "flex";
    }

    function editar(id) {
        const u = UNIDADES.find(x => x.ID === id);
        if(!u) return;
        
        const copro = COPROPIEDADES.find(c => String(c.ID) === String(u.CopropiedadID));

        document.getElementById("uID").value = u.ID;
        document.getElementById("uCopropiedadID").value = u.CopropiedadID;
        document.getElementById("uCopropiedadNombre").value = copro ? copro.Nombre : "";
        document.getElementById("uNumero").value = u.Numero;
        document.getElementById("uTorre").value = u.Torre || "";
        document.getElementById("uPiso").value = u.Piso || "";
        document.getElementById("uProrrateo").value = u.Prorrateo || "";
        document.getElementById("uEstado").value = u.Estado || "Disponible";

        document.getElementById("modalTitle").innerText = "Editar Unidad";
        document.getElementById("modalUnidad").style.display = "flex";
    }

    function cerrarModal() { document.getElementById("modalUnidad").style.display = "none"; }

    document.getElementById("formUnidad").onsubmit = async (e) => {
        e.preventDefault();
        showSpinner("Guardando...");
        
        const id = document.getElementById("uID").value;
        const payload = {
            "ID": id || ("UNI_" + Date.now()),
            "CopropiedadID": document.getElementById("uCopropiedadID").value,
            "Numero": document.getElementById("uNumero").value,
            "Torre": document.getElementById("uTorre").value,
            "Piso": document.getElementById("uPiso").value,
            "Prorrateo": document.getElementById("uProrrateo").value,
            "Estado": document.getElementById("uEstado").value
        };

        try {
            const action = id ? "Edit" : "Add";
            if(typeof appSheetCRUD === 'function') await appSheetCRUD("Unidades", action, [payload]);
            cerrarModal();
            await cargarDatos();
            aplicarFiltros();
        } catch(err) {
            alert("Error: " + err.message);
        } finally {
            hideSpinner();
        }
    };

    async function eliminar(id) {
        if(!confirm("¿Eliminar unidad?")) return;
        showSpinner("Eliminando...");
        try {
            if(typeof appSheetCRUD === 'function') await appSheetCRUD("Unidades", "Delete", [{"ID": id}]);
            await cargarDatos();
            aplicarFiltros();
        } catch(e) { alert(e.message); } finally { hideSpinner(); }
    }

    /* --- LÓGICA IMPORTACIÓN MASIVA --- */
    function abrirImportar() {
        const idCopro = document.getElementById("filtroCopropiedad").value;
        if(!idCopro) return alert("Selecciona la Comunidad destino en el filtro antes de importar.");
        
        document.getElementById("txtPaste").value = "";
        document.getElementById("tblPreview").innerHTML = '<tr><td colspan="5" style="text-align:center;">Pega tus datos arriba y pulsa Previsualizar.</td></tr>';
        document.getElementById("btnConfirmarCarga").disabled = true;
        document.getElementById("importStats").innerText = "";
        document.getElementById("modalImportar").style.display = "flex";
    }

    function procesarPegado() {
        const texto = document.getElementById("txtPaste").value.trim();
        if(!texto) return;

        const lineas = texto.split("\n");
        const idCopro = document.getElementById("filtroCopropiedad").value;
        
        DATA_TO_IMPORT = [];

        let html = "";
        lineas.forEach((linea, index) => {
            // Separar por Tabulación (Excel default)
            let cols = linea.split("\t");
            // Si solo hay 1 columna, quizás el usuario copió solo números, asumimos orden
            
            // Mapeo: 0:Numero, 1:Torre, 2:Piso, 3:Prorrateo
            const obj = {
                "ID": "UNI_" + Date.now() + "_" + index, // ID temporal único
                "CopropiedadID": idCopro,
                "Numero": (cols[0] || "").trim(),
                "Torre": (cols[1] || "").trim(),
                "Piso": (cols[2] || "").trim(),
                "Prorrateo": (cols[3] || "0").replace(",", ".").trim(),
                "Estado": "Disponible"
            };

            if(obj.Numero) { // Solo si hay número
                DATA_TO_IMPORT.push(obj);
                html += `<tr>
                    <td>${index + 1}</td>
                    <td><b>${obj.Numero}</b></td>
                    <td>${obj.Torre}</td>
                    <td>${obj.Piso}</td>
                    <td>${obj.Prorrateo}%</td>
                </tr>`;
            }
        });

        document.getElementById("tblPreview").innerHTML = html || '<tr><td colspan="5">No se detectaron datos válidos.</td></tr>';
        
        if(DATA_TO_IMPORT.length > 0) {
            document.getElementById("btnConfirmarCarga").disabled = false;
            document.getElementById("importStats").innerText = `${DATA_TO_IMPORT.length} registros detectados.`;
        }
    }

    async function enviarCargaMasiva() {
        if(DATA_TO_IMPORT.length === 0) return;
        
        if(!confirm(`Estás a punto de crear ${DATA_TO_IMPORT.length} unidades. ¿Confirmar?`)) return;

        showSpinner(`Creando ${DATA_TO_IMPORT.length} unidades...`);
        try {
            // AppSheet soporta Batch Add (enviar array)
            if(typeof appSheetCRUD === 'function') {
                await appSheetCRUD("Unidades", "Add", DATA_TO_IMPORT);
            }
            
            document.getElementById("modalImportar").style.display = "none";
            alert("✅ Carga masiva exitosa.");
            await cargarDatos();
            aplicarFiltros(); // Refrescar vista
            
        } catch(e) {
            console.error(e);
            alert("Error en la carga: " + e.message);
        } finally {
            hideSpinner();
        }
    }

    /* Utilidades Visuales */
    function showSpinner(msg) { 
        document.getElementById("spinnerText").innerText = msg;
        document.getElementById("pageSpinner").style.display = "grid"; 
    }
    function hideSpinner() { document.getElementById("pageSpinner").style.display = "none"; }
</script>

</body>
</html>