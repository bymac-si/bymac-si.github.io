<style>
  /* 1. Contenedor Principal */
  .main-header {
    background-color: #ffffff;
    border-bottom: 1px solid #e2e8f0;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    padding: 0 25px;
    height: 70px;
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    position: sticky;
    top: 0;
    z-index: 1000;
    width: 100%;
    box-sizing: border-box;
    flex-wrap: nowrap !important; /* Vital para que no se rompa la línea */
  }

  /* 2. Logo */
  .logo-img {
    height: 100px;
    width: auto;
    transition: transform 0.2s;
    display: block; /* Asegura que la imagen se comporte como bloque */
  }
  .logo-img:hover { transform: scale(1.05); }

  /* 3. Navegación (Menú Central) */
  .nav-container {
    display: flex;
    gap: 10px; /* Espacio optimizado */
    height: 100%;
    align-items: center;
    margin-left: auto; /* Empuja el menú a la derecha si sobra espacio */
  }

  /* Links */
  .nav-link {
    text-decoration: none;
    color: #64748b;
    font-weight: 600;
    font-size: 13px;
    padding: 8px 12px;
    border-radius: 6px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap; /* Evita que los textos largos bajen de línea */
  }

  .nav-link:hover {
    color: #0f172a;
    background-color: #f1f5f9;
  }

  .nav-link.active {
    color: #3b82f6;
    background-color: #eff6ff;
  }

  /* Dropdowns */
  .nav-dropdown {
    position: relative;
    height: 100%;
    display: flex;
    align-items: center;
  }

  .dropdown-menu {
    display: none;
    position: absolute;
    top: 60px;
    left: 0;
    background: white;
    min-width: 220px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    padding: 8px 0;
    list-style: none;
    z-index: 1001;
    animation: fadeIn 0.2s ease;
  }

  .nav-dropdown:hover .dropdown-menu { display: block; }

  .dropdown-menu li { margin: 0; }

  .dropdown-menu li a {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 20px; color: #475569; text-decoration: none;
    font-size: 13px; transition: background 0.2s;
  }
  .dropdown-menu li a:hover { background-color: #f8fafc; color: #0f172a; padding-left: 25px; }
  .dropdown-menu li a i { width: 16px; text-align: center; color: #94a3b8; }
  .dropdown-menu li a:hover i { color: #3b82f6; }

  /* Submenús (Hover lateral) */
  .dropdown-submenu { position: relative; }
  .dropdown-submenu .submenu {
    display: none;
    position: absolute;
    top: -5px;
    left: 100%;
    margin-left: 5px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border: 1px solid #e2e8f0;
    min-width: 180px;
    padding: 5px 0;
    list-style: none;
    z-index: 1002;
  }
  .dropdown-submenu:hover > .submenu { display: block; }
  .dropdown-submenu .submenu li a:hover { background-color: #f1f5f9; }

  /* 4. Sección Usuario (PROTEGIDA) */
  .user-actions {
    display: flex; 
    align-items: center; 
    gap: 15px;
    margin-left: 15px; 
    padding-left: 15px; 
    border-left: 1px solid #e2e8f0;
    
    /* ESTO ES LO IMPORTANTE PARA QUE NO SE OCULTE EL LOGOUT */
    flex-shrink: 0 !important; 
    min-width: max-content;
  }
  
  .user-info { text-align: right; line-height: 1.2; }
  .user-name { font-weight: 700; font-size: 13px; color: #1e293b; display: block; }
  .user-role { font-size: 11px; color: #94a3b8; text-transform: uppercase; }
  
  .btn-logout {
    color: #ef4444; border: 1px solid #fee2e2; background: #fef2f2;
    padding: 0; width: 36px; height: 36px; /* Botón cuadrado fijo */
    border-radius: 6px; font-size: 14px;
    cursor: pointer; text-decoration: none; transition: all 0.2s;
    display: flex; align-items: center; justify-content: center;
  }
  .btn-logout:hover { background: #fee2e2; transform: translateY(-1px); }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
  
  /* Mobile Toggle */
  .mobile-toggle { display: none; background: none; border: none; font-size: 24px; cursor: pointer; color: #1e293b; padding: 10px; }

  /* Responsive Mobile */
  @media (max-width: 1100px) { /* Aumenté el punto de quiebre para laptops pequeñas */
    .mobile-toggle { display: block; }
    
    .nav-container {
      display: none; 
      position: absolute; top: 70px; left: 0; width: 100%;
      background: white; flex-direction: column; align-items: flex-start;
      padding: 0; box-shadow: 0 15px 30px rgba(0,0,0,0.1);
      border-top: 1px solid #e2e8f0;
      max-height: calc(100vh - 70px); overflow-y: auto;
    }
    .nav-container.active { display: flex; }

    .nav-link, .nav-dropdown { width: 100%; box-sizing: border-box; }
    .nav-link { padding: 15px 20px; border-bottom: 1px solid #f8fafc; font-size: 14px; }
    
    .nav-dropdown { flex-direction: column; align-items: flex-start; height: auto; }
    .dropdown-menu {
      position: static; box-shadow: none; border: none; 
      width: 100%; padding: 0; display: none; background-color: #f8fafc;
    }
    .nav-dropdown:hover .dropdown-menu { display: block; } /* En móvil hover a veces no es ideal, pero funcional */
    .dropdown-menu li a { padding-left: 40px; border-bottom: 1px solid #eee; }

    /* En móvil, el usuario va arriba o abajo del menú desplegado */
    .user-actions {
      width: 100%; margin: 0; padding: 15px 20px; border-left: none;
      border-top: 2px solid #f1f5f9; justify-content: space-between;
      flex-direction: row-reverse; background: #fdfdfd;
    }
    .user-info { text-align: left; }
  }
</style>

<header class="main-header no-print">
  
  <a href="index.html" style="display:flex; align-items:center; text-decoration:none;">
    <img src="assets/img/logo_santajosefina.png" alt="Santa Josefina" class="logo-img">
  </a>

  <button class="mobile-toggle" onclick="toggleMenu()">
    <i class="fa-solid fa-bars"></i>
  </button>

  <nav class="nav-container" id="navMenu">
    
    <div class="nav-dropdown">
      <a href="#" class="nav-link dropdown-toggle">
        <i class="fa-solid fa-handshake"></i> <span>Corretaje</span> <i class="fa-solid fa-chevron-down" style="font-size:10px; margin-left:4px;"></i>
      </a>
      <ul class="dropdown-menu">
        <li><a href="dashboard.html"><i class="fa-solid fa-chart-line"></i> KPIs Generales</a></li>
        <li><a href="clientes.html"><i class="fa-solid fa-users"></i> Clientes</a></li>
        <li><a href="propiedades.html"><i class="fa-solid fa-house"></i> Propiedades</a></li>
      </ul>
    </div>

    <div class="nav-dropdown">
      <a href="#" class="nav-link dropdown-toggle">
        <i class="fa-solid fa-building"></i> <span>Condominios</span> 
        <i class="fa-solid fa-chevron-down" style="font-size:10px; margin-left:4px;"></i>
      </a>
      <ul class="dropdown-menu">
        <li><a href="dashboardcopropiedades.html"><i class="fa-solid fa-chart-pie"></i> KPIs Condominios</a></li>
        <li style="border-top:1px solid #f1f5f9; margin:4px 0;"></li>
        <li><a href="copropiedades.html"><i class="fa-solid fa-city"></i> Comunidades</a></li>
        <li><a href="unidades.html"><i class="fa-solid fa-door-closed"></i> Unidades</a></li>
        <li><a href="copropietarios.html"><i class="fa-solid fa-user-group"></i> Copropietarios</a></li>
        
        <li class="dropdown-submenu">
            <a href="#" style="display:flex; justify-content:space-between; align-items:center;">
                <span><i class="fa-solid fa-user-plus"></i> Gestión Prospectos</span>
                <i class="fa-solid fa-chevron-right" style="font-size:10px;"></i>
            </a>
            <ul class="dropdown-menu submenu">
                <li><a href="prospectos.html"><i class="fa-solid fa-list-ul"></i> Listado</a></li>
                <li><a href="mapa.html"><i class="fa-solid fa-map-location-dot"></i> Mapa Geo</a></li>
            </ul>
        </li>
      </ul>
    </div>

    <div class="nav-dropdown">
      <a href="#" class="nav-link dropdown-toggle">
        <i class="fa-solid fa-coins"></i> <span>Finanzas</span> <i class="fa-solid fa-chevron-down" style="font-size:10px; margin-left:4px;"></i>
      </a>
      <ul class="dropdown-menu">
        <li><a href="conciliacion.html"><i class="fa-solid fa-check-double"></i> Conciliación</a></li>
        <li><a href="gastos.html"><i class="fa-solid fa-file-invoice-dollar"></i> Gastos Comunes</a></li>
        <li><a href="proveedores.html"><i class="fa-solid fa-truck-field"></i> Proveedores</a></li>
        <li><a href="reportes.html"><i class="fa-solid fa-file-pdf"></i> Reportes</a></li>
      </ul>
    </div>

    <div class="nav-dropdown">
      <a href="#" class="nav-link dropdown-toggle">
        <i class="fa-solid fa-tree"></i> <span>Espacios/Reclamos</span> <i class="fa-solid fa-chevron-down" style="font-size:10px; margin-left:4px;"></i>
      </a>
      <ul class="dropdown-menu">
        <li><a href="gestion_reservas.html"><i class="fa-regular fa-calendar-check"></i> Gestionar Reservas</a></li>
        <li><a href="admin-espacios.html"><i class="fa-solid fa-pen-ruler"></i> Configurar Espacios</a></li>
        <li><a href="gestion_reclamos.html"><i class="fa-solid fa-pen-ruler"></i> Gestionar Reclamos</a></li>
      </ul>
    </div>

    <a href="marketing.html" class="nav-link">
      <i class="fa-solid fa-bullhorn"></i> <span>MKT</span>
    </a>

    <a id="linkAgentes" href="agentes.html" class="nav-link">
      <i class="fa-solid fa-user-tie"></i> <span>Agentes</span>
    </a>

    <div class="user-actions">
      <div class="user-info">
        <span class="user-name" id="headerUserName">Usuario</span>
        <span class="user-role" id="headerUserRole">Agente</span>
      </div>
      <a href="#" class="btn-logout" onclick="logout()" title="Cerrar Sesión">
        <i class="fa-solid fa-power-off"></i>
      </a>
    </div>

  </nav>
</header>

<script>
window.toggleMenu = function() {
  document.getElementById('navMenu').classList.toggle('active');
};

document.addEventListener('DOMContentLoaded', () => {
  // 1. Cargar Usuario
  const au = typeof getAuthUser === 'function' ? getAuthUser() : null;
  if (au) {
    const nameEl = document.getElementById('headerUserName');
    const roleEl = document.getElementById('headerUserRole');
    if(nameEl) nameEl.textContent = (au.Nombre || au.email || "Usuario").split(' ')[0];
    if(roleEl) roleEl.textContent = au.rol || "Agente";
  }

  // 2. Lógica Link Activo
  const path = window.location.pathname.split("/").pop();
  
  document.querySelectorAll('.nav-link, .dropdown-menu a').forEach(link => {
      const href = link.getAttribute('href');
      
      // Si coincide la URL
      if(href && href.split('?')[0] === path) {
          
          // Si es un item de dropdown
          if(link.closest('.dropdown-menu')) {
              link.style.fontWeight = "bold";
              link.style.color = "#3b82f6";
              link.style.backgroundColor = "#f1f5f9";
              
              // Activar el padre
              const parent = link.closest('.nav-dropdown');
              if(parent) parent.querySelector('.dropdown-toggle').classList.add('active');
          } 
          // Si es un link directo
          else {
              link.classList.add('active');
          }
      }
  });
});

// Logout Global
if(typeof window.logout !== 'function') {
    window.logout = function() {
        if(confirm("¿Cerrar sesión?")) {
            localStorage.removeItem("admin_token"); 
            localStorage.removeItem("sesion_residente");
            window.location.href = "login.html"; 
        }
    }
}
</script>