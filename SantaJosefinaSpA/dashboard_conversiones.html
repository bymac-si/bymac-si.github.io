<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard Conversiones | CRM Santa Josefina</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="manifest" href="manifest.json" />

    <script src="assets/js/app.js"></script>

    <script>
      if (typeof requireAuth === "function") {
        requireAuth();
      } else {
        console.warn("Auth no cargado");
      }
    </script>

    <style>
      body {
        max-width: 1300px;
        margin: auto;
        background: #f8f9fa;
        color: #1a2b48;
      }

      main {
        padding: 40px;
      }

      .dashboard-header {
        background: #fff;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        margin-bottom: 30px;
      }

      .page-title {
        font-size: 28px;
        font-weight: 800;
      }

      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 24px;
        margin-bottom: 30px;
      }

      .kpi-card {
        background: #fff;
        padding: 24px;
        border-radius: 10px;
        border-left: 5px solid #ccc;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }

      .kpi-title {
        font-size: 0.75rem;
        font-weight: 800;
        text-transform: uppercase;
        color: #6c757d;
      }

      .kpi-value {
        font-size: 2.2rem;
        font-weight: 800;
      }

      .card {
        background: #fff;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }

      .badge.A {
        background: #2ecc71;
      }
      .badge.B {
        background: #f1c40f;
        color: #000;
      }
      .badge.C {
        background: #e74c3c;
      }

      .status-fresh {
        color: #16a34a;
        font-weight: 700;
      }

      .status-stale {
        color: #dc2626;
        font-weight: 700;
      }

      .tabla-leads {
        width: 100%;
        border-collapse: collapse;
      }

      .tabla-leads th,
      .tabla-leads td {
        padding: 8px;
        border-bottom: 1px solid #ddd;
      }

      .tabla-leads th {
        background: #f5f5f5;
      }

      .btn-wa {
        background: #25d366;
        color: #fff;
        padding: 6px 10px;
        border-radius: 4px;
        text-decoration: none;
        font-weight: bold;
      }
    </style>
  </head>

  <body>
    <div id="header"></div>

    <main>
      <div class="dashboard-header">
        <h1 class="page-title">
          <i class="fa-solid fa-chart-line"></i> Dashboard de Conversiones
        </h1>
        <div id="estadoDatos" class="status-fresh">‚óè Datos actualizados</div>
      </div>

      <div
        id="alertaVencidos"
        style="
          display: none;
          background: #dc2626;
          color: white;
          padding: 15px;
          border-radius: 8px;
          font-weight: 700;
          text-align: center;
          margin-bottom: 20px;
        "
      >
        ‚ö†Ô∏è Hay <span id="cantVencidos"></span> Leads A vencidos sin contactar
      </div>
      <br />
      <div class="kpi-grid">
        <div class="kpi-card" style="border-left-color: #0dcaf0">
          <span class="kpi-title">Total Leads</span>
          <div id="totalLeads" class="kpi-value">‚Äì</div>
        </div>

        <div class="kpi-card" style="border-left-color: #2ecc71">
          <span class="kpi-title">Leads A</span>
          <div id="leadsA" class="kpi-value">‚Äì</div>
          <span class="badge A">Alta intenci√≥n</span>
        </div>

        <div class="kpi-card" style="border-left-color: #f1c40f">
          <span class="kpi-title">Leads B</span>
          <div id="leadsB" class="kpi-value">‚Äì</div>
        </div>

        <div class="kpi-card" style="border-left-color: #e74c3c">
          <span class="kpi-title">Leads C</span>
          <div id="leadsC" class="kpi-value">‚Äì</div>
        </div>

        <div class="kpi-card" style="border-left-color: #6610f2">
          <span class="kpi-title">Conversi√≥n A</span>
          <div id="conversion" class="kpi-value">‚Äì%</div>
        </div>

        <div class="kpi-card" style="border-left-color: #0f172a">
          <span class="kpi-title">‚è± Tiempo Medio Primer Contacto</span>
          <div id="sla_promedio" class="kpi-value">‚Äì min</div>
        </div>
      </div>

      <h3>‚ö†Ô∏è Leads A vencidos</h3>

      <table class="tabla-leads">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Atraso (hrs)</th>
            <th>Contacto</th>
          </tr>
        </thead>
        <tbody id="tablaLeadsVencidos">
          <tr>
            <td colspan="3">Cargando...</td>
          </tr>
        </tbody>
      </table>

      <br />

      <div class="card text-center mb-4">
        <button
          id="btnWA"
          class="btn btn-success btn-lg"
          onclick="enviarWhatsAppLeadsA()"
        >
          <i class="fa-brands fa-whatsapp"></i> Contactar Leads A
        </button>

        <button class="btn btn-success btn-lg" onclick="forzarAutoAsignacion()">
          <i class="fa-solid fa-bolt-lightning"></i> Auto-Asignar Leads A
        </button>
        <p id="msgWA" class="text-muted mt-2"></p>
      </div>
      <div
        id="modalGestion"
        style="
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.6);
          z-index: 10000;
          align-items: center;
          justify-content: center;
        "
      >
        <div
          style="
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
          "
        >
          <h2 id="modalNombre" style="margin-top: 0; color: #0f172a">
            Gestionar Lead
          </h2>
          <p id="modalEmail" class="text-muted" style="margin-bottom: 20px"></p>

          <label style="font-weight: bold; display: block; margin-bottom: 5px"
            >Nueva Nota / Avance:</label
          >
          <textarea
            id="txtNota"
            style="
              width: 100%;
              height: 100px;
              padding: 10px;
              border-radius: 8px;
              border: 1px solid #ccc;
              margin-bottom: 20px;
              font-family: inherit;
            "
            placeholder="Ej: Llamada realizada, enviar√° documentos el viernes..."
          ></textarea>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px">
            <button
              onclick="ejecutarAccionLead('CONVERTIR')"
              style="
                background: #2ecc71;
                color: white;
                border: none;
                padding: 12px;
                border-radius: 8px;
                font-weight: bold;
                cursor: pointer;
              "
            >
              <i class="fa-solid fa-trophy"></i> Convertir a Cliente
            </button>
            <button
              onclick="ejecutarAccionLead('DESCARTAR')"
              style="
                background: #e74c3c;
                color: white;
                border: none;
                padding: 12px;
                border-radius: 8px;
                font-weight: bold;
                cursor: pointer;
              "
            >
              <i class="fa-solid fa-trash"></i> Descartar Lead
            </button>
            <button
              onclick="ejecutarAccionLead('SOLO_NOTA')"
              style="
                grid-column: span 2;
                background: #3498db;
                color: white;
                border: none;
                padding: 12px;
                border-radius: 8px;
                font-weight: bold;
                cursor: pointer;
              "
            >
              Guardar Nota y Seguir
            </button>
            <button
              onclick="cerrarModalGestion()"
              style="
                grid-column: span 2;
                background: #f8f9fa;
                color: #666;
                border: 1px solid #ccc;
                padding: 8px;
                border-radius: 8px;
                cursor: pointer;
                margin-top: 10px;
              "
            >
              Cancelar
            </button>
          </div>
        </div>
      </div>
    </main>

    <div id="footer"></div>

    <script>
      const API_URL =
        "https://script.google.com/macros/s/AKfycbzXAuOSwm59jCVMrPwqJ_MymZLXN5g9wsR_DODH76nCk6eVPAep0ER-wHADhDFfijz8/exec";

      let ultimaCarga = Date.now();

      let agentesCache = [];

      /* ===============================
   INIT
================================ */

      document.addEventListener("DOMContentLoaded", initDashboard);

      async function initDashboard() {
        try {
          header.innerHTML = await (await fetch("header.html")).text();
          footer.innerHTML = await (await fetch("footer.html")).text();
        } catch {
          console.warn("Header/Footer no cargado");
        }

        await cargarAgentes();

        await cargarDashboard();
        await cargarLeadsAVencidos();

        setInterval(cargarDashboard, 300000);
      }

      /* ===============================
   AGENTES
================================ */

      async function cargarAgentes() {
        try {
          const r = await fetch(API_URL + "?action=getAgentes");
          agentesCache = await r.json();
        } catch (e) {
          console.error("Error agentes:", e);
        }
      }

      /* ===============================
   DASHBOARD
================================ */

      async function cargarDashboard() {
        try {
          const r = await fetch(
            `${API_URL}?action=getDashboardData&t=${Date.now()}`,
          );
          const d = await r.json();

          ultimaCarga = Date.now();

          totalLeads.innerText = d.total || 0;
          leadsA.innerText = d.A || 0;
          leadsB.innerText = d.B || 0;
          leadsC.innerText = d.C || 0;

          conversion.innerText = d.total
            ? Math.round((d.A / d.total) * 100) + "%"
            : "0%";

          sla_promedio.innerText = d.sla?.PROMEDIO || "--";

          btnWA.disabled = d.A === 0;

          msgWA.innerText =
            d.A === 0 ? "No hay Leads A listos" : "Leads listos para cierre";
        } catch (e) {
          console.error("Error dashboard:", e);
        }
      }

      /* ===============================
   LEADS A VENCIDOS (Corregido)
================================ */
      async function cargarLeadsAVencidos() {
        const banner = document.getElementById("alertaVencidos");
        const contador = document.getElementById("cantVencidos");

        try {
          const r = await fetch(API_URL + "?action=leadsAVencidos");
          const data = await r.json();
          const tbody = document.getElementById("tablaLeadsVencidos");
          tbody.innerHTML = "";

          if (!data.length) {
            banner.style.display = "none";
            tbody.innerHTML =
              "<tr><td colspan='3'>‚úÖ No hay vencidos</td></tr>";
            return;
          }

          banner.style.display = "block";
          contador.innerText = data.length;

          data.forEach((l) => {
            const wa = l.telefono.replace(/\D/g, "");
            const msg = encodeURIComponent(
              `Hola ${l.nombre}, te escribo de Santa Josefina.`,
            );

            tbody.innerHTML += `
        <tr>
          <td>${l.nombre}</td>
          <td>${l.horas} hrs</td>
          <td>
            <a class="btn-wa" target="_blank" href="https://wa.me/${wa}?text=${msg}">WhatsApp</a>
            <button 
  style="margin-left:5px; background:#0f172a; color:white; border:none; padding:6px 10px; border-radius:4px; cursor:pointer;"
  onclick="abrirGestion('${l.email}', '${l.nombre}')">
  <i class="fa-solid fa-pen-to-square"></i> Gestionar
</button>
          </td>
        </tr>`;
          });
        } catch (e) {
          console.error("Leads vencidos:", e);
        }
      }

      /* ===============================
   CONFIRMAR ASIGNACI√ìN (Corregido)
================================ */
      async function confirmarAsignacion(email) {
        const agente = document.getElementById("selectAgente").value;
        if (!agente) return;

        try {
          // Usamos el mismo m√©todo que el env√≠o de correos para evitar bloqueos
          await fetch(API_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify({
              action: "asignarEjecutivo",
              email: email,
              ejecutivo: agente,
            }),
          });

          alert("üìå Petici√≥n enviada. La hoja se actualizar√° en segundos.");
          cerrarModal();
          setTimeout(cargarLeadsAVencidos, 2000); // Recarga despu√©s de 2 seg
        } catch (e) {
          alert("‚ùå Error en la conexi√≥n");
          console.error(e);
        }
      }

      /* ===============================
   ASIGNACION
================================ */

      function mostrarSelectorAgente(email) {
        let html = `
    <div id="modalAgente"
      style="
        position:fixed;
        top:0;left:0;
        width:100%;
        height:100%;
        background:rgba(0,0,0,.5);
        display:flex;
        align-items:center;
        justify-content:center;
        z-index:9999;
      ">
      <div style="
        background:white;
        padding:25px;
        border-radius:10px;
        width:300px;
        text-align:center;
      ">

        <h3>Asignar Ejecutivo</h3>

        <select id="selectAgente"
          style="width:100%;padding:8px;margin:15px 0">
          ${agentesCache
            .map(
              (a) =>
                `<option value="${a.nombre}">
              ${a.nombre}
            </option>`,
            )
            .join("")}
        </select>

        <button onclick="confirmarAsignacion('${email}')">
          Asignar
        </button>

        <button
          style="margin-left:10px"
          onclick="cerrarModal()">
          Cancelar
        </button>

      </div>
    </div>
  `;

        document.body.insertAdjacentHTML("beforeend", html);
      }

      function cerrarModal() {
        const m = document.getElementById("modalAgente");

        if (m) m.remove();
      }

      async function confirmarAsignacion(email) {
        const agente = document.getElementById("selectAgente").value;

        if (!agente) return;

        try {
          await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
              action: "asignarEjecutivo",
              email,
              ejecutivo: agente,
            }),
          });

          alert("‚úÖ Asignado correctamente");

          cerrarModal();

          cargarLeadsAVencidos();
        } catch (e) {
          alert("‚ùå Error asignando");
        }
      }
      async function forzarAutoAsignacion() {
        if (!confirm("Asignar Leads A autom√°ticamente?")) return;

        const r = await fetch(API_URL + "?action=autoAsignar");

        const d = await r.json();

        alert("Asignados: " + d.asignados);

        cargarDashboard();
      }
      let leadActual = null;

      // Funci√≥n para abrir el modal con los datos del lead
      function abrirGestion(email, nombre) {
        leadActual = email;
        document.getElementById("modalNombre").innerText = nombre;
        document.getElementById("modalEmail").innerText = email;
        document.getElementById("txtNota").value = "";
        document.getElementById("modalGestion").style.display = "flex";
      }

      function cerrarModalGestion() {
        document.getElementById("modalGestion").style.display = "none";
      }

      // L√≥gica para enviar la gesti√≥n al servidor (Apps Script)
      async function ejecutarAccionLead(accion) {
        const nota = document.getElementById("txtNota").value;

        if (accion === "SOLO_NOTA" && !nota) {
          alert("Por favor escribe una nota.");
          return;
        }

        // Desactivar botones para evitar doble clic
        const btn = event.target;
        btn.disabled = true;
        btn.innerText = "Procesando...";

        try {
          await fetch(API_URL, {
            method: "POST",
            mode: "no-cors", // Para evitar problemas de permisos de Google
            body: JSON.stringify({
              action: "gestionarLead",
              email: leadActual,
              tipoAccion: accion,
              comentario: nota,
            }),
          });

          alert("‚úÖ Gesti√≥n guardada correctamente.");
          cerrarModalGestion();
          cargarLeadsAVencidos(); // Recarga la tabla
          cargarDashboard(); // Recarga los KPIs
        } catch (e) {
          alert("‚ùå Error al guardar la gesti√≥n.");
          console.error(e);
        }
      }
    </script>
  </body>
</html>
