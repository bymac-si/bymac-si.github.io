<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Conversiones | CRM Santa Josefina</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

     <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#1a2b48" />
    <link rel="apple-touch-icon" href="assets/img/icon-192.png" />

    <script src="assets/js/app.js"></script>

    <script>
      requireAuth();
    </script>
  <style>
    body {
      max-width: 1300px;
      margin: 0 auto;
      background: #f8f9fa;
      color: #1a2b48;
    }
    main {
      padding: 40px;
    }
    .dashboard-header {
      background: #fff;
      padding: 20px 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,.05);
      margin-bottom: 30px;
      border: 1px solid #f0f0f0;
    }
    .page-title {
      font-size: 28px;
      font-weight: 700;
    }
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 24px;
      margin-bottom: 30px;
    }
    .kpi-card {
      background: #fff;
      padding: 24px;
      border-radius: 8px;
      border-left: 5px solid #ccc;
      box-shadow: 0 4px 12px rgba(0,0,0,.05);
      border: 1px solid #f0f0f0;
    }
    .kpi-title {
      font-size: .8rem;
      font-weight: 700;
      text-transform: uppercase;
      color: #6c757d;
    }
    .kpi-value {
      font-size: 2.2rem;
      font-weight: 700;
    }
    .card {
      border-radius: 12px;
      border: 1px solid #f0f0f0;
      box-shadow: 0 4px 12px rgba(0,0,0,.05);
      background: #fff;
    }
    table th {
      background: #f8fafc;
      font-weight: 600;
    }
    .badge.A { background:#2ecc71; }
    .badge.B { background:#f1c40f; color:#000; }
    .badge.C { background:#e74c3c; }
  </style>
</head>

<body>


<!-- HEADER DINÃMICO -->
<div id="header"></div>

<main>

  <!-- HEADER -->
  <div class="dashboard-header">
    <h1 class="page-title">
      <i class="fa-solid fa-chart-line"></i> Dashboard de Conversiones
    </h1>
    <div class="text-muted">CRM Â· Santa Josefina SpA</div>
  </div>

  <!-- KPIs -->
  <div class="kpi-grid">
    <div class="kpi-card" style="border-left-color:#0dcaf0">
      <span class="kpi-title">Total Leads</span>
      <div class="kpi-value" id="totalLeads">â€“</div>
    </div>
    <div class="kpi-card" style="border-left-color:#2ecc71">
      <span class="kpi-title">Leads A</span>
      <div class="kpi-value" id="leadsA">â€“</div>
      <span class="badge A mt-2">Alta intenciÃ³n</span>
    </div>
    <div class="kpi-card" style="border-left-color:#f1c40f">
      <span class="kpi-title">Leads B</span>
      <div class="kpi-value" id="leadsB">â€“</div>
      <span class="badge B mt-2">Nutrir</span>
    </div>
    <div class="kpi-card" style="border-left-color:#e74c3c">
      <span class="kpi-title">Leads C</span>
      <div class="kpi-value" id="leadsC">â€“</div>
      <span class="badge C mt-2">AutomÃ¡tico</span>
    </div>
    <div class="kpi-card" style="border-left-color:#6610f2">
      <span class="kpi-title">ConversiÃ³n</span>
      <div class="kpi-value" id="conversion">â€“%</div>
    </div>
  </div>

  <!-- TABLAS -->
  <div class="row g-4 mb-4">
    <div class="col-12 col-lg-6">
      <div class="card p-4 h-100">
        <h5>ðŸ“Œ Leads por Fuente</h5>
        <table class="table table-sm" id="tablaFuente">
          <thead>
            <tr><th>Fuente</th><th>Cantidad</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card p-4 h-100">
        <h5>ðŸ“Œ Estado del Funnel</h5>
        <table class="table table-sm" id="tablaEstado">
          <thead>
            <tr><th>Estado</th><th>Cantidad</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- SLA -->
  <div class="row g-4 mb-4 text-center">
    <div class="col-md-4">
      <div class="card p-4 border-success">
        <h5 class="text-success">ðŸŸ¢ En SLA</h5>
        <h2 id="sla_ok">0</h2>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-4 border-warning">
        <h5 class="text-warning">ðŸŸ¡ Por vencer</h5>
        <h2 id="sla_alerta">0</h2>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-4 border-danger">
        <h5 class="text-danger">ðŸ”´ SLA vencido</h5>
        <h2 id="sla_vencido">0</h2>
      </div>
    </div>
  </div>

  <!-- WHATSAPP -->
  <div class="card p-4 text-center mb-4">
    <button class="btn btn-success btn-lg" onclick="enviarWhatsAppLeadsA()">
      <i class="fa-brands fa-whatsapp"></i> Enviar WhatsApp a Leads A
    </button>
  </div>

  <div class="text-muted text-center">
    ðŸ”¥ RecomendaciÃ³n: solo los <b>Leads A</b> deben pasar a contacto directo.
  </div>

</main>
<div id="footer"></div>
<script>
  // URL de tu implementaciÃ³n (AsegÃºrate de que sea la Ãºltima versiÃ³n publicada)
  const API_URL = "https://script.google.com/macros/s/AKfycbyGAyUXWvCHli2rZ1Eh1NfxqZm2rXAT7BRgunBjtZv_iU5CDEk7ewwWWG2La3PYKa5G/exec";

  document.addEventListener("DOMContentLoaded", async () => {
    // 1. Cargar componentes visuales
    try {
      const h = await fetch("header.html"); if (h.ok) document.getElementById("header").innerHTML = await h.text();
      const f = await fetch("footer.html"); if (f.ok) document.getElementById("footer").innerHTML = await f.text();
    } catch (e) { console.error("Error cargando componentes", e); }
    
    // 2. Iniciar carga de datos
    cargarTodoElDashboard();
  });

  async function cargarTodoElDashboard() {
    const statusEl = document.getElementById("conversion");
    const originalText = statusEl.innerText;
    statusEl.innerText = "Cargando...";

    try {
      // Cache Buster para evitar que el navegador use datos viejos
      const response = await fetch(`${API_URL}?action=getDashboardData&t=${Date.now()}`);
      
      if (!response.ok) throw new Error("Fallo en red");
      
      const data = await response.json();
      
      // Renderizado de KPIs
      document.getElementById("totalLeads").innerText = data.total || 0;
      document.getElementById("leadsA").innerText = data.A || 0;
      document.getElementById("leadsB").innerText = data.B || 0;
      document.getElementById("leadsC").innerText = data.C || 0;
      
      const porc = data.total ? Math.round((data.A / data.total) * 100) : 0;
      document.getElementById("conversion").innerText = porc + "%";
      
      // Renderizado de Tablas
      renderTable("tablaFuente", data.fuentes);
      renderTable("tablaEstado", data.estados);

      // Renderizado de SLA
      document.getElementById("sla_ok").innerText = data.sla?.OK || 0;
      document.getElementById("sla_alerta").innerText = data.sla?.ALERTA || 0;
      document.getElementById("sla_vencido").innerText = data.sla?.VENCIDO || 0;

    } catch (err) {
      console.error("Error en Dashboard:", err);
      statusEl.innerText = "Error";
      alert("Error de conexiÃ³n con la base de datos de Santa Josefina.");
    }
  }

  function renderTable(id, obj) {
    const tb = document.querySelector(`#${id} tbody`);
    if(!tb || !obj) return;
    tb.innerHTML = "";
    for (let k in obj) {
      tb.innerHTML += `<tr><td>${k}</td><td><span class="badge bg-secondary" style="background:#64748b; color:white; padding:4px 8px; border-radius:4px;">${obj[k]}</span></td></tr>`;
    }
  }

  async function enviarWhatsAppLeadsA() {
  const btn = document.querySelector(".btn-cta-wa") || document.querySelector(".btn-success");
  const originalText = btn.innerHTML;
  
  try {
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Obteniendo Leads...';

    // 1. Pedir a la API solo los Leads A
    const response = await fetch(`${API_URL}?action=getLeadsA`);
    const leads = await response.json();

    if (!leads || leads.length === 0) {
      alert("No hay Leads CategorÃ­a A pendientes de contacto hoy.");
      return;
    }

    if (!confirm(`Se abrirÃ¡n ${leads.length} pestaÃ±as de WhatsApp. Â¿Deseas continuar?`)) return;

    // 2. Abrir WhatsApp para cada Lead
    leads.forEach(l => {
      const msg = encodeURIComponent(
        `Hola ${l.nombre}, soy Marcos de Santa Josefina SpA.\n\nVi que realizaste el diagnÃ³stico de seguridad para ${l.comunidad}. Â¿Te parece si agendamos una breve llamada de 10 min para revisar los puntos rojos?`
      );
      
      // Formatear telÃ©fono (asegurar que tenga el 569)
      let tlf = l.telefono.replace(/\D/g, '');
      if (tlf.startsWith('9')) tlf = '56' + tlf;
      if (tlf.startsWith('562')) tlf = tlf.replace('562', '569'); // CorrecciÃ³n comÃºn

      window.open(`https://wa.me/${tlf}?text=${msg}`, '_blank');
    });

  } catch (err) {
    console.error("Error al obtener leads:", err);
    alert("Error al conectar con la base de datos.");
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
} 

</script>
</body>
</html>
