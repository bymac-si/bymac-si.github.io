<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mi Propiedad - Santa Josefina</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/styles.css">
    <script src="assets/js/app.js"></script>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a2b48">

    <style>
        body { background: #f8fafc; padding-bottom: 80px; }
        .hero-prop { background: #1a2b48; color: white; padding: 30px 20px 60px; border-radius: 0 0 20px 20px; }
        .card-stat { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-top: -40px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 90%; margin-left: auto; margin-right: auto; text-align: center; }
        .stat-num { font-size: 24px; font-weight: 800; color: #e74e35; }
        .stat-label { font-size: 11px; color: #64748b; text-transform: uppercase; font-weight: 700; }
        
        .section-title { font-size: 16px; font-weight: 700; color: #1e293b; margin: 25px 20px 10px; }
        
        .feedback-card { background: white; padding: 15px; margin: 0 20px 15px; border-radius: 10px; border-left: 4px solid #3b82f6; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .feedback-date { font-size: 11px; color: #94a3b8; font-weight: 600; margin-bottom: 5px; }
        .feedback-text { font-size: 14px; color: #334155; line-height: 1.4; }
        
        .empty-state { text-align: center; color: #94a3b8; padding: 40px; }
    </style>
</head>
<body>

    <div class="hero-prop">
        <h2 style="margin: 0; font-size: 20px;">Hola, <span id="lblNombre">Propietario</span></h2>
        <p style="opacity: 0.8; font-size: 13px; margin: 5px 0 0;">Estado de su propiedad en gestión</p>
        <div style="margin-top: 15px; font-weight: bold; font-size: 18px;" id="lblPropiedad">Cargando...</div>
    </div>

    <div class="card-stat">
        <div>
            <div class="stat-num" id="valVisitas">0</div>
            <div class="stat-label">Visitas Realizadas</div>
        </div>
        <div style="border-left: 1px solid #eee;">
            <div class="stat-num" id="valInteresados">0</div>
            <div class="stat-label">Interesados Reales</div>
        </div>
    </div>

    <div class="section-title">Bitácora de Visitas & Feedback</div>
    <div id="listaFeedback">
        <div class="spinner" style="margin-top: 20px;"></div>
    </div>

    <script>
        // Simulamos login simple (En producción usar localStorage real)
        // const USER_RUT = localStorage.getItem('cliente_rut'); 
        
        // MODO DEMO:
        const USER_RUT = "11111111-1"; 

        document.addEventListener("DOMContentLoaded", async () => {
            if(!USER_RUT) { alert("Debe iniciar sesión"); window.location.href="login_residente.html"; return; }
            await cargarDatosVendedor();
        });

        async function cargarDatosVendedor() {
            try {
                // 1. Buscar Propiedad del usuario
                const props = await fetchData("Propiedades");
                const miPropiedad = props.find(p => p["RUT Propietario"] === USER_RUT);

                if(!miPropiedad) {
                    document.getElementById("lblPropiedad").innerText = "No tienes propiedades activas.";
                    document.getElementById("listaFeedback").innerHTML = "";
                    return;
                }

                document.getElementById("lblPropiedad").innerText = miPropiedad.Direccion || miPropiedad.Titulo;
                document.getElementById("lblNombre").innerText = (miPropiedad["Propietario"] || "Cliente").split(" ")[0];

                // 2. Buscar Visitas realizadas a esa propiedad
                // Asumimos tabla 'Visitas' con columna 'PropiedadID' y 'Comentarios'
                const visitas = await fetchData("Visitas");
                const misVisitas = visitas.filter(v => v.PropiedadID === miPropiedad.ID && v.Estado === "Realizada");

                // KPIs
                document.getElementById("valVisitas").innerText = misVisitas.length;
                document.getElementById("valInteresados").innerText = misVisitas.filter(v => v.Interes === "Alto").length;

                // Render Feedback
                const contenedor = document.getElementById("listaFeedback");
                if(misVisitas.length === 0) {
                    contenedor.innerHTML = '<div class="empty-state"><i class="fa-regular fa-calendar-xmark" style="font-size:30px; margin-bottom:10px;"></i><br>Aún no hay visitas registradas.</div>';
                } else {
                    contenedor.innerHTML = misVisitas.map(v => `
                        <div class="feedback-card">
                            <div class="feedback-date"><i class="fa-regular fa-calendar"></i> ${v.Fecha}</div>
                            <div class="feedback-text">"${v.Comentarios || "Sin comentarios registrados."}"</div>
                            ${v.Interes === 'Alto' ? '<span style="font-size:10px; background:#dcfce7; color:#166534; padding:2px 6px; border-radius:4px; margin-top:5px; display:inline-block;">Muy Interesado</span>' : ''}
                        </div>
                    `).join("");
                }

            } catch(e) {
                console.error(e);
            }
        }
    </script>
</body>
</html>