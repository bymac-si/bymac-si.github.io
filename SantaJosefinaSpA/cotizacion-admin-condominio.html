<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Propuesta Comercial ‚Äî Administraci√≥n de Condominios</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  
  <link rel="stylesheet" href="assets/css/styles.css">
  <script src="assets/js/app.js"></script>
  <script>/* requireAuth(); */</script>

  <style>
    /* =========================================
       AJUSTES T√âCNICOS PARA PDF (INVISIBLE)
       ========================================= */
    
    /* 1. Limpieza: Ocultar controles y mostrar lo imprimible */
    body.generating-pdf .no-print { display: none !important; }
    body.generating-pdf .print-only { display: block !important; }
    body.generating-pdf { background: white !important; }
    
    /* 2. Estructura: Usar todo el ancho disponible */
    body.generating-pdf .container { 
        width: 98% !important; 
        max-width: none !important; 
        margin: 0 !important; 
        padding: 0 !important; 
    }

    /* 3. LOGO: Tama√±o controlado (Igual que en impresi√≥n) */
    body.generating-pdf .brand-logo {
        width: 60mm !important; 
        height: auto !important; 
        /* Mantiene la posici√≥n absoluta original */
    }

    /* 4. PORTADA: Forzar salto de p√°gina despu√©s de la car√°tula */
    body.generating-pdf .print-cover {
        position: relative;
        min-height: 260mm; /* Ocupa casi toda la hoja */
        width: 100%;
        page-break-after: always; /* SALTO DE P√ÅGINA OBLIGATORIO */
    }

    /* 5. M√°rgenes laterales para que el texto no toque el borde */
    body.generating-pdf .print-section {
        padding-left: 15mm !important;
        padding-right: 15mm !important;
    }
  </style>
</head>
<body>
<div id="header" class="no-print"></div>
<main class="container" id="contentToPrint">
  <h1 class="page-title no-print">Propuesta Comercial ‚Äî Comunidad <span id="printNombre">‚Äî</span></h1>

  <div class="card no-print">
    <div class="row">
      <div>
        <label class="label">Origen de datos</label>
        <select id="selOrigen" style="line-height: 1.5; height: 40px; font-size: 14px;">
          <option value="prospecto">Prospectos (recomendado)</option>
          <option value="copro">Copropiedades</option>
        </select>
      </div>
      <div>
        <label class="label">Comunidad / Condominio</label>
        <select id="selEntidad" style="line-height: 1.5; height: 40px; font-size: 14px;"></select>
      </div>
      <div>
        <label class="label">Comuna</label>
        <input id="inpComuna" readonly style="font-size: 14px; width: 90%;">
      </div>
      <div>
        <label class="label">Direcci√≥n</label>
        <input id="inpDireccion" readonly style="font-size: 14px; width: 90%;">
      </div>
      <div>
        <label class="label">RUT</label>
        <input id="inpRUT" readonly style="font-size: 14px; width: 90%;">
        <div id="rutMsg" class="text-error">RUT inv√°lido</div>
      </div>
      <div>
        <label class="label">N¬∞ Unidades</label>
        <input id="inpUnidades" class="mono" 
               type="number" 
               placeholder="Ingresar..." 
               oninput="actualizarUnidadesManual(this.value)" 
               style="font-size: 14px; width: 90%;">
      </div>
      <div>
        <label class="label">Factor Comuna</label>
        <input id="inpFactor" class="mono" readonly style="font-size: 14px; width: 90%;">
      </div>
      <div>
        <label class="label">UTM (CLP)</label>
        <input id="inpUTM" class="mono" placeholder="Ej: 67.000" inputmode="decimal" style="font-size: 14px; width: 90%;">
      </div>
    </div>

    <div class="btns" style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
      <button class="btn-primary" onclick="window.location.reload()" style="background-color: #6c757d;">‚ü≥ Reiniciar</button>
      <button class="btn-primary" onclick="window.print()">üñ® Imprimir</button>
      <button class="btn-primary" onclick="compartirPDF('whatsapp')" style="background-color: #25D366; border-color: #25D366;">üì± PDF a WhatsApp</button>
      <button class="btn-primary" onclick="compartirPDF('email')" style="background-color: #007bff; border-color: #007bff;">üìß PDF por Correo</button>
    </div>
  </div>

  <div class="grid">
    <div class="card no-print">
      <h2 class="section-title">Resumen del Prospecto</h2>
      <p><b>Comunidad:</b> <span id="cxNombre">‚Äî</span></p>
      <p><b>Direcci√≥n:</b> <span id="cxDir">‚Äî</span></p>
      <p><b>RUT:</b> <span id="cxRUT">‚Äî</span></p>
      <p><b>Comuna:</b> <span id="cxComuna">‚Äî</span> <span class="badge">Factor: <span id="cxFactor">‚Äî</span></span></p>
      <p><b>N¬∞ Unidades:</b> <span id="cxUnidades">‚Äî</span></p>
      <p><b>UTM:</b> <span id="cxUTM">‚Äî</span></p>
    </div>

    <div id="secHonorarios" class="card no-print">
      <h2 class="section-title">Honorarios estimados</h2>
      <p class="muted">F√≥rmula Ley N¬∞21.442</p>
      <table>
        <thead>
          <tr>
            <th>Escenario</th>
            <th>F√≥rmula</th>
            <th style="text-align:right;">Neto</th>
            <th style="text-align:right;">IVA (19%)</th>
            <th style="text-align:right;">Total</th>
            <th style="text-align:right;">Prorrateo /unidad (con IVA)</th>
          </tr>
        </thead>
        <tbody id="tbodyHonorarios"></tbody>
      </table>
    </div>
  </div>

  <section class="print-only print-cover">
    <img class="brand-logo" src="assets/img/logo_santajosefina.png" alt="Santa Josefina SpA" style="position: absolute; top: 10mm; left: 10mm;">
    
    <span style="position: relative; top: 60mm; left: 10mm;">
      <h1>Propuesta Comercial</h1>
      <h2 id="coverSub">Condominio ‚Äî</h2>
    </span>
  </section>

  <section class="print-only print-section">
    <h2 class="title">Nuestro Servicio</h2>

    <h3 class="stitle">¬øPor qu√© nace la Administraci√≥n de Edificios y Condominios?</h3>
    <p>Para mantener funcionando en forma √≥ptima un condominio se requiere tiempo, gastos, contrataci√≥n de personal, planificaci√≥n y control de mantenciones peri√≥dicas para la maquinaria e infraestructura de la comunidad. Son funciones que pocas personas dentro del condominio est√°n capacitadas y/o dispuestas a desarrollar. La <b>Ley N¬∞21.442 de Copropiedad Inmobiliaria</b> establece que estas funciones pueden ser desempe√±adas por un copropietario o por una persona natural o empresa especializada contratada por acuerdo de la Asamblea de Copropietarios.</p>

    <h3 class="stitle">¬øCu√°les son las funciones de un Administrador de Edificios y Condominios?</h3>
    <p>El Administrador tendr√° las funciones que se establezcan en el Reglamento de Copropiedad y las que expresamente le confiera la Asamblea de Copropietarios. Conforme a la <b>Ley N¬∞21.442</b>, el Administrador se mantiene en sus funciones mientras cuente con la confianza de la Asamblea, pudiendo ser removido por acuerdo de √©sta.</p>

    <h3 class="stitle">Nuestro Compromiso</h3>
    <ul>
      <li style="list-style-type: none;"><b>Transparencia:</b> √≠tems de cobro accesibles y detallados en informes mensuales.</li>
      <li style="list-style-type: none;"><b>Disponibilidad:</b> respuesta oportuna a las necesidades de la comunidad.</li>
      <li style="list-style-type: none;"><b>Cordialidad:</b> trato respetuoso y colaborativo.</li>
      <li style="list-style-type: none;"><b>Visitas peri√≥dicas:</b> supervisi√≥n semanal en distintos horarios.</li>
      <li style="list-style-type: none;"><b>Informes peri√≥dicos:</b> reportes de avance de gastos y presupuestos, adem√°s del informe mensual.</li>
    </ul>

    <h3 class="stitle">Su Unidad, su Palacio</h3>
    <p>Cuidamos los bienes comunes con la misma dedicaci√≥n con que usted cuida su unidad (departamento, bodega y estacionamiento).</p>

    <h3 class="stitle">Gastos Comunes</h3>
    <p>Corresponden al funcionamiento normal del condominio. Cada comunidad presenta un nivel de gasto propio seg√∫n sus caracter√≠sticas y consumo. Optimizamos costos sin comprometer la integridad de los bienes comunes.</p>

    <h3 class="stitle">Informaci√≥n Clara y Detallada</h3>
    <p>Cada copropietario puede acceder a la informaci√≥n relevante de su comunidad. Mensualmente recibir√° un informe de gastos comunes y, cuando corresponda, alertas sobre variaciones proyectadas para la toma de decisiones.</p>

    <h3 class="stitle salto">Nuestros Beneficios</h3>
    <ul>
      <li style="list-style-type: none;">Experiencia aplicando la <b>Ley N¬∞21.442 de Copropiedad Inmobiliaria</b>.</li>
      <li style="list-style-type: none;">Reportes e informes administrativos incluidos en nuestros honorarios.</li>
      <li style="list-style-type: none;">Gesti√≥n transparente y proyecci√≥n presupuestaria (semestral, anual o bianual).</li>
      <li style="list-style-type: none;"><b>Marcos Castro Abarca</b>, Director de Santa Josefina SpA, fue socio fundador y Secretario General por cuatro per√≠odos del Colegio Inmobiliario de Chile A.G.N.</li>
    </ul>
  </section>

  <section class="print-only print-section">
    <h2 class="title">Honorarios</h2>
    <table class="print-table" style="text-align:center;">
      <thead>
        <tr>
          <th style="text-align:center;">Unidades</th>
          <th style="text-align:center;">Precio Neto</th>
          <th style="text-align:center;">Precio IVA inc.</th>
          <th style="text-align:center;">Costo aproximado por Unidad (*)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td id="p_unidades" class="mono" style="text-align:center;">‚Äî</td>
          <td id="p_neto" class="mono" style="text-align:center;">‚Äî</td>
          <td id="p_total" class="mono" style="text-align:center;">‚Äî</td>
          <td id="p_unit" class="mono" style="text-align:center;">‚Äî</td>
        </tr>
      </tbody>
    </table>
    <p class="muted" style="font-size:12px;margin-top:6px;">(*) El costo aproximado por unidad se calcula con el <b>Total con IVA</b> y se ajusta al prorrateo de cada unidad.</p>
    <p class="muted" style="font-size:12px;margin-top:4px;">
      <b>Desglose por unidad:</b>
      Neto: <span id="p_unit_neto" class="mono">‚Äî</span> ¬∑
      IVA: <span id="p_unit_iva" class="mono">‚Äî</span> ¬∑
      Total: <span id="p_unit_total" class="mono">‚Äî</span>
    </p>
  
    <div style="margin-top: 50px; page-break-inside: avoid;">
      <p style="text-align: left;">Atentamente,</p><br>
      <p style="font-weight: bold; text-align: center;">Marcos Castro Abarca</p>
      <p style="text-align: center;">Director de Santa Josefina SpA</p>
    </div>
  </section>

</main>

<div id="pageSpinner" class="spinner-backdrop no-print" aria-hidden="true">
  <div class="spinner-card"><div class="spinner"></div><div id="spinnerText">Cargando datos...</div></div>
</div>
<div id="footer" class="no-print"></div>

<script>
/* ===== Utilidades ===== */
function showSpinner(msg){ document.getElementById('pageSpinner').style.display='flex'; if(msg) document.getElementById('spinnerText').textContent=msg; }
function hideSpinner(){ document.getElementById('pageSpinner').style.display='none'; }
function clp(v){ return "$" + new Intl.NumberFormat("es-CL",{maximumFractionDigits:0}).format(Number(v||0)); }
function norm(s){ return (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim(); }
function cleanRut(r){ return (r||'').toString().replace(/[^0-9kK]/g,'').toUpperCase(); }
function rutDv(num){ let M=0,S=1; for(; num; num=Math.floor(num/10)) S=(S+num%10*(9-M++%6))%11; return S ? String(S-1) : 'K'; }
function isRutValid(rut){ const s=cleanRut(rut); if(s.length<2) return false; const body=s.slice(0,-1), dv=s.slice(-1); const calc=rutDv(parseInt(body,10)||0); return String(calc)===String(dv); }
function formatRut(r){ const s=cleanRut(r); if(s.length<2) return r||''; const body=s.slice(0,-1), dv=s.slice(-1); const withDots=body.replace(/\B(?=(\d{3})+(?!\d))/g,'.'); return withDots+'-'+dv; }

/* Read / Boot / Fetch Logic */
function readIncoming(){
  let data=null; try{ data=JSON.parse(sessionStorage.getItem('cotizacionProspecto')||'null');}catch(e){}
  const qs=new URLSearchParams(location.search);
  return {
    prospectoId: (data?.prospectoId)||qs.get('prospectoId')||null,
    nombre: (data?.nombre)||qs.get('nombre')||'',
    comuna: (data?.comuna)||qs.get('comuna')||'',
    unidades: (data?.unidades)||Number(qs.get('unidades')||0),
    direccion: (data?.direccion)||qs.get('direccion')||'',
    rut: (data?.rut)||qs.get('rut')||'',
    factor: (data?.factor??(qs.get('factor')?Number(qs.get('factor')):null)),
    utm: (data?.utm??(qs.get('utm')?Number(qs.get('utm')):null)),
  };
}

let TARIFAS=[], PROSPECTOS=[], COPROS=[];
let origen='prospecto', entidadSel=null, factor=0, nUnidades=0, utmCLP=0;

function calcularNeto(unidades, factor, utm){
  if(!(factor>0 && utm>0)) return 0;
  const base = factor*1.75*utm;
  if(unidades<=20) return base;
  return base + ((unidades-20)*factor*1.75*utm*0.013);
}

function updatePrintResumen(neto, iva, total){ /* Compatibilidad */ }
window.updatePrintResume = updatePrintResumen; 
async function safeFetch(table){ try{ return await fetchData(table); }catch(e){ return []; } }

async function boot(){
  showSpinner('Cargando...');
  try{
    [TARIFAS, PROSPECTOS, COPROS] = await Promise.all([safeFetch('TablaTarifas'), safeFetch('ProspectosCopro'), safeFetch('Copropiedades')]);
    
    const selOrigen=document.getElementById('selOrigen');
    const selEntidad=document.getElementById('selEntidad');
    selOrigen.onchange=()=>{ origen=selOrigen.value; renderEntidadOptions(); onEntidadChange(); };
    selEntidad.onchange=()=>onEntidadChange();

    renderEntidadOptions();
    const it=readIncoming();
    if(it.prospectoId){
       const idx=[...selEntidad.options].findIndex(o=>String(o.value)===String(it.prospectoId));
       if(idx>=0) selEntidad.selectedIndex=idx;
    }
    onEntidadChange(it);

    document.getElementById('inpUTM').addEventListener('input', ()=>{
      const raw=(document.getElementById('inpUTM').value||'').replaceAll('.','').replace(',','.');
      utmCLP=parseFloat(raw)||0;
      document.getElementById('cxUTM').textContent=utmCLP>0?clp(utmCLP):'‚Äî';
      renderHonorarios();
    });
  }catch(e){ alert('Error: '+e.message); }finally{ hideSpinner(); }
}

document.addEventListener('DOMContentLoaded', async ()=>{
  try{ document.getElementById('header').innerHTML = await (await fetch('header.html')).text(); }catch(e){}
  try{ document.getElementById('footer').innerHTML = await (await fetch('footer.html')).text(); }catch(e){}
  boot();
});

function renderEntidadOptions(){
  const sel=document.getElementById('selEntidad');
  let items=(origen==='prospecto'&&PROSPECTOS.length)?PROSPECTOS:COPROS;
  sel.innerHTML=items.map(x=>`<option value="${getKeyVal(x)}">${x.Nombre||x.RazonSocial||'‚Äî'}</option>`).join('');
}

function onEntidadChange(prefill){
  const sel=document.getElementById('selEntidad');
  const list=(origen==='prospecto'&&PROSPECTOS.length)?PROSPECTOS:COPROS;
  entidadSel=list.find(x=>String(getKeyVal(x))===String(sel.value))||null;

  const nombre = prefill?.nombre ?? entidadSel?.Nombre ?? entidadSel?.RazonSocial ?? '‚Äî';
  const comuna = prefill?.comuna ?? entidadSel?.Comuna ?? '‚Äî';
  const dir    = prefill?.direccion ?? entidadSel?.Direccion ?? entidadSel?.Direcci√≥n ?? '‚Äî';
  const rutRaw = prefill?.rut ?? entidadSel?.RUT ?? '‚Äî';
  const rutFmt = (rutRaw && rutRaw!=='‚Äî') ? formatRut(rutRaw) : '‚Äî';
  
  const rawUnidades = prefill?.unidades ?? entidadSel?.Unidades ?? entidadSel?.NUnidades ?? entidadSel?.CantidadUnidades;
  nUnidades = Number(rawUnidades || 0);

  let f=null;
  if(prefill?.factor!=null) f = Number(prefill.factor);
  if(f==null){
    const t = TARIFAS.find(tt => norm(tt.Comuna)===norm(comuna));
    f = t ? Number(t.Factor||0) : 0;
  }
  factor = f;
  if(prefill?.utm!=null){ utmCLP = Number(prefill.utm)||0; if(utmCLP>0) document.getElementById('inpUTM').value=utmCLP; }

  document.getElementById('inpComuna').value = comuna;
  document.getElementById('inpDireccion').value = dir;
  document.getElementById('inpRUT').value = rutFmt;
  document.getElementById('inpFactor').value = factor || '';
  
  // L√≥gica de desbloqueo input
  const inpU = document.getElementById('inpUnidades');
  inpU.value = nUnidades || ''; 
  if(nUnidades > 0) {
      inpU.readOnly = true; inpU.style.backgroundColor = ''; inpU.style.border = ''; 
  } else {
      inpU.readOnly = false; inpU.style.backgroundColor = '#fffbeb'; inpU.style.border = '1px solid #aaa';
  }

  // UI Updates
  document.getElementById('cxNombre').textContent = nombre;
  document.getElementById('cxDir').textContent    = dir;
  document.getElementById('cxComuna').textContent = comuna;
  document.getElementById('cxFactor').textContent = factor || '‚Äî';
  document.getElementById('cxUnidades').textContent = nUnidades || '‚Äî';

  const printNameEl = document.getElementById('printNombre'); if(printNameEl) printNameEl.textContent = nombre;
  const coverSub = document.getElementById('coverSub'); if(coverSub) coverSub.textContent = nombre ? ('Condominio ' + nombre) : 'Condominio';
  
  renderHonorarios();
}

function renderHonorarios(){
  const tb = document.getElementById('tbodyHonorarios');
  const raw = (document.getElementById('inpUTM').value||'').replaceAll('.','').replace(',','.');
  if(raw) utmCLP = parseFloat(raw)||0;

  if(!(factor>0) || !(utmCLP>0) || !(nUnidades>=0)){
    tb.innerHTML = `<tr><td colspan="6" class="muted">Ingresa UTM...</td></tr>`;
    document.getElementById('cxUTM').textContent = utmCLP>0 ? clp(utmCLP) : '‚Äî';
    setPrintTable(0,0,0,nUnidades||0);
    return;
  }
  document.getElementById('cxUTM').textContent = clp(utmCLP);

  const escenarios = [
    { nombre:'Seg√∫n datos', unidades:nUnidades },
    { nombre:'Simulaci√≥n 20', unidades:20 },
    { nombre:'Simulaci√≥n 40', unidades:40 }
  ];

  tb.innerHTML = escenarios.map(sc=>{
    const neto = Math.round(calcularNeto(sc.unidades, factor, utmCLP));
    const iva  = Math.round(neto * 0.19);
    const tot  = neto + iva;
    const unit = sc.unidades>0 ? Math.round(tot / sc.unidades) : 0;
    const formula = sc.unidades<=20 ? `F x 1.75 x UTM` : `F x 1.75 x UTM + extra`;
    return `<tr>
      <td>${sc.nombre}</td>
      <td class="mono">${formula}</td>
      <td class="mono" style="text-align:right;">${clp(neto)}</td>
      <td class="mono" style="text-align:right;">${clp(iva)}</td>
      <td class="mono" style="text-align:right;">${clp(tot)}</td>
      <td class="mono" style="text-align:right;">${clp(unit)}</td>
    </tr>`;
  }).join('');

  const neto0 = Math.round(calcularNeto(nUnidades, factor, utmCLP));
  const iva0 = Math.round(neto0*0.19);
  setPrintTable(neto0, iva0, neto0+iva0, nUnidades||0);
}

function setPrintTable(neto, iva, total, unidades){
  document.getElementById('p_unidades').textContent = unidades>0 ? unidades : '‚Äî';
  document.getElementById('p_neto').textContent = clp(neto);
  document.getElementById('p_total').textContent = clp(total);
  const unitTotal = (unidades>0) ? Math.round(total / unidades) : 0;
  const unitNeto  = (unidades>0) ? Math.round(neto  / unidades) : 0;
  const unitIva   = (unidades>0) ? Math.round(iva   / unidades) : 0;
  document.getElementById('p_unit').textContent = unitTotal>0 ? clp(unitTotal) : '‚Äî';
  document.getElementById('p_unit_neto').textContent = unitNeto>0 ? clp(unitNeto) : '‚Äî';
  document.getElementById('p_unit_iva').textContent  = unitIva>0 ? clp(unitIva) : '‚Äî';
  document.getElementById('p_unit_total').textContent = unitTotal>0 ? clp(unitTotal) : '‚Äî';
}

function actualizarUnidadesManual(val){ nUnidades=Number(val)||0; document.getElementById('cxUnidades').textContent=nUnidades||'‚Äî'; renderHonorarios(); }

/* ================== GENERACI√ìN DE PDF ================== */
async function compartirPDF(tipo) {
    showSpinner('Generando PDF...');
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    document.body.classList.add('generating-pdf');
    
    const element = document.body; 
    const nombreEntidad = entidadSel?.Nombre || entidadSel?.RazonSocial || 'Comunidad';
    const filename = `Propuesta_${nombreEntidad.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;

    // CONFIGURACI√ìN: M√°rgenes est√°ndar para replicar "Vista Previa de Impresi√≥n"
    const opt = {
        margin:       10, /* 10mm de margen, similar al navegador */
        filename:     filename,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2, useCORS: true, scrollY: 0 },
        jsPDF:        { unit: 'mm', format: 'letter', orientation: 'portrait' },
        pagebreak:    { mode: ['css', 'legacy'] } /* Respeta nuestros saltos CSS */
    };

    try {
        if (isMobile && navigator.canShare) {
            const pdfBlob = await html2pdf().set(opt).from(element).output('blob');
            const file = new File([pdfBlob], filename, { type: "application/pdf" });
            if (navigator.canShare({ files: [file] })) {
                await navigator.share({ title: 'Propuesta', text: `Propuesta para ${nombreEntidad}`, files: [file] });
            } else { throw new Error("No sharing support"); }
        } else {
            await html2pdf().set(opt).from(element).save();
            setTimeout(() => {
                alert(`‚úÖ PDF Descargado.\n\nEl archivo se ha guardado como "${filename}".\nArrastralo a tu correo o WhatsApp.`);
                if(tipo === 'whatsapp') window.open(`https://wa.me/`, '_blank');
                else window.location.href = `mailto:?subject=Propuesta ${nombreEntidad}`;
            }, 1000);
        }
    } catch (err) {
        if(isMobile) { alert("Descargando archivo (share fall√≥)..."); html2pdf().set(opt).from(element).save(); }
        else { console.error(err); alert("Error PDF: " + err.message); }
    } finally {
        document.body.classList.remove('generating-pdf');
        hideSpinner();
    }
}
</script>
</body>
</html>