<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>CRM - Reporte Gastos Comunes</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/css/styles.css" />
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1a2b48">
<link rel="apple-touch-icon" href="assets/img/icon-192.png">

    <script src="assets/js/app.js"></script>
    <script>
      requireAuth();
    </script>

    <style>
      /* ===== ESTILOS DASHBOARD UNIFICADOS ===== */
      body {
        max-width: 1200px;
        margin: 0 auto;
        color: #1a2b48;
      }
      main {
        padding: 40px;
      }
      .page-title {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 16px;
      }

      /* Tablas */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }
      th,
      td {
        padding: 10px 8px;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
        vertical-align: middle;
      }
      th {
        background: #fafafa;
        font-weight: 600;
        color: #4b5563;
        border-bottom: 2px solid #e5e7eb;
      }

      /* Inputs y Layout */
      select {
        width: 100%;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-family: inherit;
      }
      .label {
        display: block;
        font-weight: 600;
        margin-bottom: 4px;
        font-size: 13px;
        color: #374151;
      }

      /* SPINNER */
      .spinner-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.85);
        display: none;
        place-items: center;
        z-index: 12000;
      }
      .spinner-card {
        background: #fff;
        padding: 18px 22px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
        text-align: center;
        min-width: 260px;
        color: #1a2b48;
        font-weight: 600;
      }
      .spinner {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 3px solid #eee;
        border-top-color: #b46a55;
        margin: 0 auto 10px;
        animation: spin 0.9s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Courier New",
          monospace;
      }
      .muted {
        color: #666;
        font-size: 0.9em;
      }

      /* DASHBOARD HEADER */
      .dashboard-header {
        background-color: #fff;
        padding: 20px 25px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        margin-bottom: 25px;
        border: 1px solid #f0f0f0;
      }
      .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
      }
      .header-actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .header-filters {
        display: flex;
        gap: 15px;
        align-items: flex-end;
        flex-wrap: wrap;
        padding-top: 20px;
        border-top: 1px solid #e2e8f0;
      }
      .filter-item {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .input-modern {
        height: 44px;
        padding: 0 12px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        font-size: 14px;
        background-color: #f8fafc;
      }

      /* BOTONES CABECERA */
      .btn-head {
        height: 44px;
        padding: 0 20px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.2s;
      }
      .btn-head:hover {
        transform: translateY(-2px);
      }
      .btn-primary {
        background-color: #0f172a;
        color: white;
      }
      .btn-secondary {
        background-color: #fff;
        color: #475569;
        border: 1px solid #cbd5e1;
      }
      .btn-secondary:hover {
        background-color: #f8fafc;
        border-color: #94a3b8;
      }

      /* TARJETAS RESUMEN */
      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .summary-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .summary-label {
        font-size: 12px;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 5px;
      }
      .summary-value {
        font-size: 24px;
        font-weight: 700;
        color: #0f172a;
      }
      .summary-total {
        color: #059669;
      } /* Verde para el total final */

      /* SEPARADOR */
      .categoria-separador {
        border-top: 1px solid #e2e8f0;
        margin: 30px 0 15px;
        padding-top: 10px;
      }
      .cat-title {
        font-size: 16px;
        font-weight: 700;
        color: #334155;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f8fafc;
        padding: 10px;
        border-radius: 6px;
      }

      /* PRINT FRIENDLY */
      #printArea {
        display: none;
      }
      @media print {
        page {
          size: letter;
        }
        body * {
          visibility: hidden;
        }
        #printArea,
        #printArea * {
          visibility: visible;
        }
        #printArea {
          display: block;
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          padding: 20px;
          background: white;
          color: black;
        }
        .no-print {
          display: none !important;
        }

        /* Ajustes tabla impresión */
        table {
          width: 97%;
          border-collapse: collapse;
          font-size: 10pt;
        }
        th,
        td {
          border: 1px solid #ddd;
          padding: 5px;
        }
        th {
          background-color: #eee !important;
          -webkit-print-color-adjust: exact;
        }

        .cat-title {
          background-color: #eee !important;
          -webkit-print-color-adjust: exact;
          border: 1px solid #ddd;
        }
      }
    </style>
  </head>
  <body>
    <div id="header"></div>

    <main>
      <div class="dashboard-header no-print">
        <div class="header-top">
          <h1 class="page-title">Reporte de Gastos Comunes</h1>

          <div class="header-actions">
            <button
              class="btn-head btn-secondary"
              onclick="window.location.reload()"
              title="Recargar datos"
            >
              <i class="fa-solid fa-rotate-right"></i>
              <span class="btn-text">Recargar</span>
            </button>

            <button
              class="btn-head btn-primary"
              onclick="window.print()"
              title="Imprimir Reporte"
            >
              <i class="fa-solid fa-print"></i>
              <span class="btn-text">Imprimir</span>
            </button>
          </div>
        </div>

        <div class="header-filters">
          <div class="filter-item" style="flex-grow: 1">
            <label class="label">Copropiedad</label>
            <select id="reporteCopro" class="input-modern"></select>
          </div>

          <div class="filter-item" style="flex-grow: 1">
            <label class="label">Mes</label>
            <select id="reporteMes" class="input-modern"></select>
          </div>
        </div>
      </div>

      <div id="contenidoWeb">
        <div style="margin-bottom: 20px">
          <h2 id="webCopro" style="margin: 0; color: #1e293b">—</h2>
          <div style="color: #64748b; font-size: 14px">
            <span id="webDir">—</span> • RUT: <span id="webRUT">—</span>
          </div>
          <div style="margin-top: 5px; font-weight: 600; color: #3b82f6">
            Período: <span id="webMes">—</span>
          </div>
        </div>

        <div class="summary-grid">
          <div class="summary-card">
            <div class="summary-label">Total Gastos del Mes</div>
            <div class="summary-value" id="totalGastos">$0</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Fondo de Reserva (+%)</div>
            <div class="summary-value" id="aporteFR">$0</div>
          </div>
          <div class="summary-card" style="border-color: #059669">
            <div class="summary-label" style="color: #059669">
              Total a Prorratear
            </div>
            <div class="summary-value summary-total" id="totalFinal">$0</div>
          </div>
        </div>

        <h3
          style="
            margin-top: 30px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
          "
        >
          Prorrateo por Unidad
        </h3>
        <table>
          <thead>
            <tr>
              <th>Unidad</th>
              <th>Propietario</th>
              <th style="text-align: center">Alicuota (%)</th>
              <th style="text-align: right">Gasto Común</th>
              <th style="text-align: right">Fondo Reserva</th>
              <th style="text-align: right">Total a Pagar</th>
            </tr>
          </thead>
          <tbody id="tablaReporte"></tbody>
        </table>

        <div id="desgloseWrapper" style="margin-top: 40px"></div>
      </div>
    </main>

    <div id="printArea">
      <div style="text-align: center; margin-bottom: 20px">
        <img
          src="assets/img/logo_santajosefina.png"
          alt="Logo"
          style="width: 120px"
        />
        <div style="font-size: 10pt">
          Administración de Edificios y Condominios
        </div>
      </div>

      <div style="text-align: center; margin-bottom: 20px">
        <h2 style="margin: 0; text-transform: uppercase">
          Informe de Gastos Comunes
        </h2>
        <h3 id="printCopro" style="margin: 5px 0"></h3>
        <div style="font-size: 10pt">
          <span id="printDir"></span> • RUT: <span id="printRUT"></span>
        </div>
        <h4 style="margin: 10px 0">Período: <span id="printMes"></span></h4>
      </div>

      <table style="width: 100%; border: none; margin-bottom: 20px">
        <tr>
          <td style="border: none; text-align: center">
            <strong>Total Gastos:</strong>
            <span id="totalGastosPrint" style="font-size: 12pt">$0</span>
          </td>
          <td style="border: none; text-align: center">
            <strong>Fondo Reserva:</strong>
            <span id="aporteFRPrint" style="font-size: 12pt">$0</span>
          </td>
          <td style="border: none; text-align: center">
            <strong>TOTAL A PAGAR:</strong>
            <span
              id="totalFinalPrint"
              style="font-size: 14pt; font-weight: bold"
              >$0</span
            >
          </td>
        </tr>
      </table>

      <h4>Prorrateo por Unidad</h4>
      <table>
        <thead>
          <tr>
            <th>Unidad</th>
            <th>Propietario</th>
            <th>Alicuota</th>
            <th style="text-align: right">Gasto Común</th>
            <th style="text-align: right">Fondo Reserva</th>
            <th style="text-align: right">Total</th>
          </tr>
        </thead>
        <tbody id="tablaReportePrint"></tbody>
      </table>

      <div id="desgloseWrapperPrint" style="margin-top: 20px"></div>

      <div style="margin-top: 40px; text-align: center; font-size: 10pt">
        <p>
          Este informe ha sido generado automáticamente por el sistema de
          administración.
        </p>
      </div>
    </div>

    <div id="pageSpinner" class="spinner-backdrop" aria-hidden="true">
      <div class="spinner-card">
        <div class="spinner"></div>
        <div id="spinnerText">Cargando datos...</div>
      </div>
    </div>

    <div id="footer"></div>

    <script>
      /* ===== Utilidades ===== */
      function showSpinner(msg) {
        const sp = document.getElementById("pageSpinner");
        const txt = document.getElementById("spinnerText");
        if (msg) txt.textContent = msg;
        sp.style.display = "grid";
      }
      function hideSpinner() {
        document.getElementById("pageSpinner").style.display = "none";
      }
      function formatoEntero(v) {
        return (
          "$" +
          new Intl.NumberFormat("es-CL", { maximumFractionDigits: 0 }).format(
            v || 0
          )
        );
      }
      function getKeyVal(o) {
        return o._id || o.ID || o.Id || o.id || "";
      }

      function formatMesLargo(mes) {
        if (!mes) return "";
        const [mm, yyyy] = mes.split("-");
        const fecha = new Date(Number(yyyy), Number(mm) - 1, 1);
        return fecha.toLocaleDateString("es-CL", {
          month: "long",
          year: "numeric",
        });
      }
      function formatFechaDDMMYYYY(fechaISO) {
        if (!fechaISO) return "—";
        const d = new Date(fechaISO);
        // Ajuste UTC para evitar desfase de día
        return d.toLocaleDateString("es-CL", { timeZone: "UTC" });
      }

      /* ===== Inicialización ===== */
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          document.getElementById("header").innerHTML = await (
            await fetch("header.html")
          ).text();
        } catch (e) {}
        try {
          document.getElementById("footer").innerHTML = await (
            await fetch("footer.html")
          ).text();
        } catch (e) {}

        await cargarReporte();
      });

      let copros = [],
        unidades = [],
        gastosComunes = [],
        copropietarios = [],
        gastos = [],
        provs = [];

      async function cargarReporte() {
        try {
          showSpinner("Cargando reporte...");

          [copros, unidades, gastosComunes, copropietarios, gastos, provs] =
            await Promise.all([
              fetchData("Copropiedades"),
              fetchData("Unidades"),
              fetchData("GastosComunes").catch(() => []), // Puede estar vacía
              fetchData("Copropietarios"),
              fetchData("Gastos"),
              fetchData("Proveedores"),
            ]);

          const selCopro = document.getElementById("reporteCopro");
          selCopro.innerHTML = copros
            .map(
              (c) =>
                `<option value="${getKeyVal(c)}">${
                  c.Nombre || c.RazonSocial
                }</option>`
            )
            .join("");
          selCopro.onchange = () => cargarMeses();

          // Auto-selección si hay datos
          if (copros.length > 0) cargarMeses();
          else hideSpinner();
        } catch (err) {
          console.error(err);
          alert("Error cargando datos: " + err.message);
          hideSpinner();
        }
      }

      function cargarMeses() {
        const coproID = document.getElementById("reporteCopro").value;

        // Buscar meses disponibles en la tabla de GastosComunes o Gastos individuales
        // (Aquí usaremos GastosComunes si existe, o inferiremos de Gastos)
        let meses = [];

        // 1. Intentar desde GastosComunes (Resúmenes guardados)
        if (gastosComunes.length > 0) {
          meses = gastosComunes
            .filter((gc) => String(gc.CopropiedadID) === String(coproID))
            .map((gc) => gc.Mes);
        }

        // 2. Si no hay resúmenes, buscar en Gastos individuales
        if (meses.length === 0 && gastos.length > 0) {
          const gastosCopro = gastos.filter(
            (g) => String(g.CopropiedadID) === String(coproID)
          );
          meses = gastosCopro
            .map((g) => {
              if (!g.Fecha) return null;
              const d = new Date(g.Fecha);
              return `${String(d.getMonth() + 1).padStart(
                2,
                "0"
              )}-${d.getFullYear()}`;
            })
            .filter(Boolean);
        }

        const mesesUnicos = [...new Set(meses)].sort((a, b) => {
          const [ma, ya] = (a || "").split("-").map(Number);
          const [mb, yb] = (b || "").split("-").map(Number);
          return yb - ya || mb - ma; // Orden descendente (más nuevo primero)
        });

        const selMes = document.getElementById("reporteMes");
        if (mesesUnicos.length === 0) {
          selMes.innerHTML = '<option value="">Sin datos</option>';
        } else {
          selMes.innerHTML = mesesUnicos
            .map((m) => `<option value="${m}">${formatMesLargo(m)}</option>`)
            .join("");
        }

        selMes.onchange = renderReporte;
        renderReporte();
      }

      function renderReporte() {
        const coproID = document.getElementById("reporteCopro").value;
        const mesSel = document.getElementById("reporteMes").value;

        if (!coproID || !mesSel) {
          hideSpinner();
          return;
        }

        const mesTexto = formatMesLargo(mesSel);
        const provMap = {};
        provs.forEach((p) => (provMap[getKeyVal(p)] = p.Nombre));

        // Datos Copropiedad
        const copro = copros.find(
          (c) => String(getKeyVal(c)) === String(coproID)
        );
        const fondoReservaPct = parseFloat(copro?.FondoReserva || 0) / 100;

        // Calcular Totales (Desde Gastos Reales)
        // Filtramos los gastos de ese mes para esa copropiedad
        // Nota: Asumimos que el mes "MM-YYYY" coincide con la fecha del gasto
        const gastosMes = gastos.filter((g) => {
          if (String(g.CopropiedadID) !== String(coproID)) return false;
          if (!g.Fecha) return false;
          const d = new Date(g.Fecha);
          // Ajuste UTC
          const m = String(d.getUTCMonth() + 1).padStart(2, "0");
          const y = d.getUTCFullYear();
          return `${m}-${y}` === mesSel;
        });

        // Sumar total gastos
        const totalG = gastosMes.reduce(
          (sum, g) => sum + (parseFloat(g.Monto) || 0),
          0
        );

        const aporteFR = Math.round(totalG * fondoReservaPct);
        const totalFinal = totalG + aporteFR;

        // Actualizar UI
        const setTxt = (id, val) => {
          const el = document.getElementById(id);
          if (el) el.textContent = val;
        };

        setTxt("webCopro", copro?.Nombre || "");
        setTxt("webDir", copro?.Direccion || "");
        setTxt("webRUT", copro?.RUT || "");
        setTxt("webMes", mesTexto);

        setTxt("printCopro", copro?.Nombre || "");
        setTxt("printDir", copro?.Direccion || "");
        setTxt("printRUT", copro?.RUT || "");
        setTxt("printMes", mesTexto);

        const fmtTotalG = formatoEntero(totalG);
        const fmtFR =
          formatoEntero(aporteFR) + ` (${copro?.FondoReserva || 0}%)`;
        const fmtFinal = formatoEntero(totalFinal);

        setTxt("totalGastos", fmtTotalG);
        setTxt("aporteFR", fmtFR);
        setTxt("totalFinal", fmtFinal);

        setTxt("totalGastosPrint", fmtTotalG);
        setTxt("aporteFRPrint", fmtFR);
        setTxt("totalFinalPrint", fmtFinal);

        // Generar Tabla Prorrateo
        const unidadesC = unidades.filter(
          (u) => String(u.CopropiedadID) === String(coproID)
        );
        const propietarioNombre = (id) =>
          copropietarios.find((p) => getKeyVal(p) === id)?.Nombre || "—";

        const rows = unidadesC
          .map((u) => {
            const alicuota = parseFloat(u.Alicuota) || 0;
            // Cálculo proporcional
            const cuotaGasto = Math.round((alicuota / 100) * totalG);
            const cuotaFR = Math.round((alicuota / 100) * aporteFR);
            const cuotaTotal = cuotaGasto + cuotaFR;

            return `<tr>
      <td style="font-weight:bold;">${u.Numero}</td>
      <td>${propietarioNombre(u.PropietarioID)}</td>
      <td style="text-align:center;">${alicuota.toFixed(3)}%</td>
      <td style="text-align:right;">${formatoEntero(cuotaGasto)}</td>
      <td style="text-align:right;">${formatoEntero(cuotaFR)}</td>
      <td style="text-align:right; font-weight:bold;">${formatoEntero(
        cuotaTotal
      )}</td>
    </tr>`;
          })
          .join("");

        document.getElementById("tablaReporte").innerHTML =
          rows ||
          '<tr><td colspan="6" class="muted">No hay unidades registradas.</td></tr>';
        document.getElementById("tablaReportePrint").innerHTML =
          rows || '<tr><td colspan="6">No hay unidades registradas.</td></tr>';

        // Generar Desglose por Categoría
        const desglose = {};
        gastosMes.forEach((g) => {
          const t = g.TipoGasto || "Otros";
          if (!desglose[t]) desglose[t] = { total: 0, items: [] };
          desglose[t].total += parseFloat(g.Monto) || 0;
          desglose[t].items.push(g);
        });

        const renderDesgloseHTML = (isPrint) => {
          if (Object.keys(desglose).length === 0)
            return '<p class="muted">No hay gastos registrados en este mes.</p>';

          return `
        <h3 class="no-print" style="margin-top:0;">Detalle de Gastos</h3>
        ${Object.entries(desglose)
          .map(
            ([tipo, data]) => `
            <div class="cat-title" style="width:94%; margin-top:30px; margin-bottom:15px;">
                <span>${tipo}</span>
                <span>${formatoEntero(data.total)}</span>
            </div>
            <table style="width:97%; margin-bottom:15px; border-collapse:collapse;">
                <thead>
                    <tr>
                        <th style="width:30%;">Proveedor</th>
                        <th style="width:15%;">Fecha</th>
                        <th style="width:15%;">Doc.</th>
                        <th>Detalle</th>
                        <th style="width:15%; text-align:right;">Monto</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.items
                      .map(
                        (it) => `
                        <tr>
                            <td>${provMap[it.ProveedorID] || "—"}</td>
                            <td>${formatFechaDDMMYYYY(it.Fecha)}</td>
                            <td>${it.Documento || ""}</td>
                            <td style="font-size:0.9em;">${
                              it.Observaciones || ""
                            }</td>
                            <td style="text-align:right;">${formatoEntero(
                              it.Monto
                            )}</td>
                        </tr>
                    `
                      )
                      .join("")}
                </tbody>
            </table>
        `
          )
          .join("")}
      `;
        };

        document.getElementById("desgloseWrapper").innerHTML =
          renderDesgloseHTML(false);
        document.getElementById("desgloseWrapperPrint").innerHTML =
          renderDesgloseHTML(true);

        hideSpinner();
      }
    </script>
  </body>
</html>
