<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Reservas - Santa Josefina</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="assets/css/styles.css">
  <script src="assets/js/app.js"></script>
  
  <style>
    /* Estilos App Mobile */
    body { background-color: #f8fafc; padding-bottom: 40px; }
    
    /* Header */
    .app-header-simple {
      background: #1A2B48; padding: 20px; color: white;
      display: flex; align-items: center; gap: 15px;
      box-shadow: 0 4px 15px rgba(26, 43, 72, 0.2);
      border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
      position: sticky; top: 0; z-index: 100;
    }
    .page-title { font-size: 18px; font-weight: 700; margin: 0; color: white; }
    .btn-back { color: white; font-size: 20px; text-decoration: none; opacity: 0.9; }

    /* Carrusel de Espacios */
    .spaces-scroller {
      display: flex; gap: 12px; overflow-x: auto; padding: 20px 15px 10px;
      scrollbar-width: none;
    }
    .spaces-scroller::-webkit-scrollbar { display: none; }

    .space-card {
      min-width: 110px; background: white; border-radius: 16px;
      border: 2px solid transparent; box-shadow: 0 4px 6px rgba(0,0,0,0.04);
      padding: 15px 10px; cursor: pointer; transition: all 0.2s; text-align: center;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .space-card.active { border-color: #1A2B48; background: #e0f2fe; transform: translateY(-2px); }
    .space-icon { font-size: 24px; color: #64748b; margin-bottom: 8px; }
    .space-card.active .space-icon { color: #1A2B48; }
    .space-name { font-size: 11px; font-weight: 700; color: #334155; line-height: 1.2; }

    /* --- NUEVA BARRA DE ACCIÓN (ARRIBA) --- */
    .action-panel {
      background: white; margin: 10px 15px 20px; padding: 15px;
      border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      display: flex; justify-content: space-between; align-items: center;
      border: 1px solid #e2e8f0;
    }
    .price-group { display: flex; flex-direction: column; }
    .price-label { font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase; }
    .price-value { font-size: 20px; font-weight: 800; color: #1A2B48; }
    
    .btn-reserve {
      background: #1A2B48; color: white; border: none;
      padding: 10px 24px; border-radius: 8px; font-weight: 700;
      font-size: 14px; cursor: pointer; transition: opacity 0.2s;
      box-shadow: 0 4px 10px rgba(26, 43, 72, 0.2);
    }
    .btn-reserve:disabled { background: #cbd5e1; cursor: not-allowed; box-shadow: none; }

    /* Selector de Fecha */
    .date-selector {
      margin: 0 15px 20px; background: white; padding: 15px;
      border-radius: 16px; display: flex; align-items: center; justify-content: space-between;
      border: 1px solid #e2e8f0;
    }
    .date-input { border: none; font-family: inherit; font-size: 16px; font-weight: 700; color: #1A2B48; outline: none; text-align: right; background: transparent;}

    /* Grilla de Horarios */
    .slots-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 10px; margin: 0 15px;
    }
    .time-slot {
      background: white; border: 1px solid #e2e8f0; border-radius: 12px;
      padding: 12px 5px; text-align: center; cursor: pointer; position: relative;
      transition: all 0.2s;
    }
    .time-slot.available { border-color: #10b981; color: #065f46; background: #ecfdf5; }
    .time-slot.occupied { background: #f1f5f9; color: #94a3b8; border-color: #e2e8f0; cursor: not-allowed; text-decoration: line-through; }
    .time-slot.selected { background: #1A2B48; color: white; border-color: #1A2B48; transform: scale(1.05); box-shadow: 0 4px 12px rgba(26, 43, 72, 0.3); }
    
    .slot-time { font-weight: 800; font-size: 14px; margin-bottom: 2px; }
    .slot-label { font-size: 10px; font-weight: 600; display: block; }

    /* Reglas y Mis Reservas */
    .rules-card { margin: 0 15px 20px; padding: 15px; background: #fff7ed; border-radius: 12px; border-left: 4px solid #f97316; font-size: 13px; color: #9a3412; display: flex; gap: 10px; align-items: start; }
    
    .my-bookings { margin: 30px 15px; }
    .booking-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #10b981; box-shadow: 0 2px 6px rgba(0,0,0,0.03); }

    /* Spinner */
    .spinner-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }
  </style>
</head>
<body>

  <div class="app-header-simple">
    <a href="portal.html" class="btn-back"><i class="fa-solid fa-arrow-left"></i></a>
    <h1 class="page-title">Reservar Espacio</h1>
  </div>

  <div class="spaces-scroller" id="listaEspacios">
    <div class="space-card active" style="width: 100%;">
       <div style="font-size:12px; color:#64748b;">Cargando...</div>
    </div>
  </div>

  <div class="action-panel">
    <div class="price-group">
      <span class="price-label">Total a Pagar</span>
      <span class="price-value" id="totalPrice">$0</span>
    </div>
    <button class="btn-reserve" id="btnConfirmar" disabled onclick="confirmarReserva()">
      Confirmar
    </button>
  </div>

  <div class="date-selector">
    <label style="font-size:13px; color:#64748b; font-weight:600;"><i class="fa-regular fa-calendar"></i> Fecha:</label>
    <input type="date" id="inputFecha" class="date-input">
  </div>

  <div id="rulesContainer" class="rules-card" style="display:none;">
    <i class="fa-solid fa-circle-info" style="margin-top:2px;"></i> 
    <span id="rulesText"></span>
  </div>

  <h3 style="margin: 0 15px 15px; font-size:14px; font-weight:700; color:#334155; text-transform:uppercase; letter-spacing:0.5px;">Horarios Disponibles</h3>
  <div class="slots-grid" id="slotsContainer">
    <div style="grid-column: 1/-1; text-align:center; color:#94a3b8; padding:30px; font-size:13px;">
      Selecciona un espacio y fecha.
    </div>
  </div>

  <div class="my-bookings">
    <h3 style="font-size:14px; font-weight:700; color:#334155; margin-bottom:15px; text-transform:uppercase; letter-spacing:0.5px;">Mis Reservas Activas</h3>
    <div id="listaMisReservas">
        <div style="text-align:center; color:#94a3b8; font-size:13px;">Cargando historial...</div>
    </div>
  </div>

  <div id="spinner" class="spinner-overlay" style="display:none;">
    <div style="width:40px; height:40px; border-radius:50%; border:4px solid #eee; border-top-color:#1A2B48; animation:spin 1s linear infinite;"></div>
    <div style="margin-top:15px; font-size:13px; font-weight:600; color:#1A2B48;">Procesando...</div>
  </div>

  <script>
    let USUARIO = null;
    let ESPACIOS = [];
    let RESERVAS = []; 
    let BLOQUES_DB = []; // Nueva variable para almacenar los horarios reales
    
    let espacioSeleccionado = null;
    let bloqueSeleccionado = null;

    document.addEventListener("DOMContentLoaded", async () => {
        try {
            const sesion = localStorage.getItem("sesion_residente");
            if(!sesion) throw new Error("No session");
            USUARIO = JSON.parse(sesion);
        } catch(e) {
            window.location.href = "login_residente.html";
            return;
        }

        // Fecha por defecto: Hoy
        const hoy = new Date().toISOString().split('T')[0];
        const inputFecha = document.getElementById("inputFecha");
        inputFecha.value = hoy;
        inputFecha.min = hoy;
        inputFecha.addEventListener("change", renderSlots);

        await cargarDatos();
    });

    async function cargarDatos() {
        try {
            // Carga de 3 tablas
            const [espacios, reservas, bloques] = await Promise.all([
                fetchData('Espacios'),
                fetchData('Reservas').catch(()=>[]),
                fetchData('Bloques').catch(()=>[])
            ]);

            // --- FILTRO DE SEGURIDAD ---
            // Solo mostramos los espacios de MI condominio
            // Asumimos que USUARIO.CopropiedadID viene del login
            const todosLosEspacios = espacios || [];
            
            if(USUARIO.CopropiedadID) {
                ESPACIOS = todosLosEspacios.filter(e => String(e.CopropiedadID) === String(USUARIO.CopropiedadID));
            } else {
                // Fallback por si el usuario es Admin o hay error de datos, mostramos todo o nada
                // console.warn("Usuario sin CopropiedadID");
                ESPACIOS = todosLosEspacios; 
            }

            RESERVAS = reservas || [];
            BLOQUES_DB = bloques || [];

            renderEspacios();
            renderMisReservas();

            if(ESPACIOS.length > 0) seleccionarEspacio(ESPACIOS[0]);
            else document.getElementById("listaEspacios").innerHTML = '<div style="padding:20px; color:#64748b; width:100%;">No hay espacios habilitados para tu comunidad.</div>';

        } catch(e) {
            console.error(e);
            alert("Error cargando datos: " + e.message);
        }
    }

    function renderEspacios() {
        const container = document.getElementById("listaEspacios");
        if(ESPACIOS.length === 0) {
            container.innerHTML = '<div style="padding:10px; color:#666;">No hay espacios configurados.</div>';
            return;
        }

        container.innerHTML = ESPACIOS.map(e => `
            <div class="space-card" id="card_${getKeyVal(e)}" onclick='seleccionarEspacio(${JSON.stringify(e)})'>
                <i class="fa-solid ${e.Icono || 'fa-building'} space-icon"></i>
                <div class="space-name">${e.Nombre}</div>
            </div>
        `).join("");
    }

    function seleccionarEspacio(espacio) {
        espacioSeleccionado = espacio;
        bloqueSeleccionado = null;
        actualizarPanelAccion();

        // UI
        document.querySelectorAll(".space-card").forEach(c => c.classList.remove("active"));
        const card = document.getElementById(`card_${getKeyVal(espacio)}`);
        if(card) card.classList.add("active");

        // Reglas
        const rulesDiv = document.getElementById("rulesContainer");
        if(espacio.Reglas) {
            rulesDiv.style.display = "flex";
            document.getElementById("rulesText").textContent = espacio.Reglas;
        } else {
            rulesDiv.style.display = "none";
        }

        renderSlots();
    }

    function renderSlots() {
        if(!espacioSeleccionado) return;
        
        const fecha = document.getElementById("inputFecha").value;
        const container = document.getElementById("slotsContainer");
        const espacioID = String(getKeyVal(espacioSeleccionado));

        // 1. Filtrar bloques configurados para ESTE espacio
        // Nota: Asegúrate de que la columna en Bloques se llame EspacioID
        let bloquesDelEspacio = BLOQUES_DB.filter(b => String(b.EspacioID) === espacioID && b.Activo !== false);

        // Ordenar por hora de inicio
        bloquesDelEspacio.sort((a,b) => (a.HoraInicio || "").localeCompare(b.HoraInicio || ""));

        // Si no hay bloques configurados, mostrar mensaje
        if(bloquesDelEspacio.length === 0) {
            container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px; color:#94a3b8;">No hay horarios disponibles para este espacio.</div>';
            return;
        }

        container.innerHTML = bloquesDelEspacio.map(bloque => {
            // Nombre visual del bloque (ej: "12:00 - 16:00" o "Mañana")
            const nombreBloque = bloque.Nombre || `${bloque.HoraInicio} - ${bloque.HoraFin}`;
            
            // Verificar si ya está reservado
            const ocupado = RESERVAS.some(r => 
                String(r.EspacioID) === espacioID && 
                r.Fecha === fecha && 
                r.Bloque === nombreBloque && // Comparamos por nombre del bloque
                r.Estado !== 'Rechazada'
            );

            const estadoClass = ocupado ? "occupied" : "available";
            // Pasamos el nombreBloque como identificador único del horario
            const estadoClick = ocupado ? "" : `onclick="seleccionarBloque('${nombreBloque}', this)"`;
            
            const costo = parseFloat(espacioSeleccionado.Costo) || 0;
            const precioTxt = costo > 0 ? clp(costo) : "GRATIS";

            return `
                <div class="time-slot ${estadoClass}" ${estadoClick}>
                    <div class="slot-time">${nombreBloque}</div>
                    <span class="slot-label">${ocupado ? "OCUPADO" : precioTxt}</span>
                </div>
            `;
        }).join("");
    }

    function seleccionarBloque(nombreBloque, el) {
        document.querySelectorAll(".time-slot.selected").forEach(d => d.classList.remove("selected"));
        
        bloqueSeleccionado = nombreBloque;
        el.classList.add("selected");
        
        actualizarPanelAccion();
    }

    function actualizarPanelAccion() {
        const btn = document.getElementById("btnConfirmar");
        const priceEl = document.getElementById("totalPrice");
        
        if(bloqueSeleccionado && espacioSeleccionado) {
            const costo = parseFloat(espacioSeleccionado.Costo) || 0;
            priceEl.textContent = clp(costo);
            btn.disabled = false;
        } else {
            priceEl.textContent = "$0";
            btn.disabled = true;
        }
    }

    async function confirmarReserva() {
        const fecha = document.getElementById("inputFecha").value;
        
        if(!confirm(`¿Confirmar Reserva?\n\nEspacio: ${espacioSeleccionado.Nombre}\nFecha: ${fecha}\nHorario: ${bloqueSeleccionado}`)) return;

        document.getElementById("spinner").style.display = "flex";

        const payload = {
            "ID": "RES_" + Date.now(),
            "UnidadID": String(USUARIO.UnidadID),
            "EspacioID": String(getKeyVal(espacioSeleccionado)),
            "EspacioNombre": espacioSeleccionado.Nombre, // Opcional, útil para reportes
            "Fecha": fecha,
            "Bloque": bloqueSeleccionado,
            "Estado": "Pendiente",
            "Costo": parseFloat(espacioSeleccionado.Costo) || 0,
            "FechaCreacion": new Date().toISOString()
        };

        try {
            if(typeof appSheetCRUD === 'function') {
                await appSheetCRUD("Reservas", "Add", [payload]);
            } else {
                await new Promise(r => setTimeout(r, 1000));
            }
            
            alert("✅ Solicitud enviada con éxito.");
            location.reload(); 

        } catch(e) {
            alert("Error al reservar: " + e.message);
        } finally {
            document.getElementById("spinner").style.display = "none";
        }
    }

    function renderMisReservas() {
        const container = document.getElementById("listaMisReservas");
        const misReservas = RESERVAS.filter(r => String(r.UnidadID) === String(USUARIO.UnidadID));
        
        // Ordenar por fecha desc
        misReservas.sort((a,b) => new Date(b.Fecha) - new Date(a.Fecha));

        if(misReservas.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#94a3b8; font-size:13px;">No tienes reservas registradas.</div>';
            return;
        }

        container.innerHTML = misReservas.map(r => {
            const espacio = ESPACIOS.find(e => String(getKeyVal(e)) === String(r.EspacioID));
            const nombreEspacio = espacio ? espacio.Nombre : (r.EspacioNombre || "Espacio");
            
            let colorBorde = "#c2410c";
            if(r.Estado === 'Confirmada') colorBorde = "#15803d";
            if(r.Estado === 'Rechazada') colorBorde = "#b91c1c";

            // Formato Fecha
            const [y,m,d] = (r.Fecha||"").split("-");
            const fechaFmt = d ? `${d}/${m}` : r.Fecha;

            return `
            <div class="booking-item" style="border-left-color: ${colorBorde};">
                <div>
                    <div style="font-weight:700; color:#1e293b;">${nombreEspacio}</div>
                    <div style="color:#64748b;">${fechaFmt} <span style="margin:0 5px;">•</span> ${r.Bloque}</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:11px; font-weight:700; text-transform:uppercase; color:${colorBorde};">${r.Estado}</div>
                </div>
            </div>`;
        }).join("");
    }

    function clp(v) { return "$" + new Intl.NumberFormat("es-CL").format(v); }
    function getKeyVal(o) { return o.ID || o.id || ""; }
</script>
</body>
</html>