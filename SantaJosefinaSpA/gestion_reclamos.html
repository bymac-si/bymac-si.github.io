<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>CRM - Gestión de Reclamos</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="assets/css/styles.css">
  
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>
     (function(){
        // emailjs.init("TU_PUBLIC_KEY"); 
     })();
  </script>

  <script src="assets/js/app.js"></script>
  <script>requireAuth();</script>

  <style>
    /* Estilos Base */
    body { max-width: 1400px; margin: 0 auto; color: #1a2b48; background: #f8fafc; }
    main { padding: 40px; }

    /* Header */
    .dashboard-header { background: #fff; padding: 20px 25px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 25px; }
    .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .page-title { font-size: 24px; font-weight: 700; margin: 0; color: #1e293b; }
    
    .header-filters { display: flex; gap: 15px; align-items: end; flex-wrap: wrap; }
    .filter-group { display: flex; flex-direction: column; gap: 5px; min-width: 200px; }
    .label { font-size: 12px; font-weight: 700; color: #64748b; text-transform: uppercase; }
    .input-modern { height: 42px; padding: 0 12px; border: 1px solid #cbd5e1; border-radius: 8px; background: #fff; width: 100%; box-sizing: border-box; }

    /* Grid de Tickets */
    .ticket-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
    
    .ticket-card { 
        background: white; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; 
        transition: transform 0.2s; position: relative; border-left: 5px solid #cbd5e1;
    }
    .ticket-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    
    /* Colores por Estado */
    .border-Pendiente { border-left-color: #f59e0b; }
    .border-Proceso { border-left-color: #3b82f6; }
    .border-Resuelto { border-left-color: #10b981; }

    .ticket-body { padding: 20px; }
    .t-meta { display: flex; justify-content: space-between; font-size: 12px; color: #64748b; margin-bottom: 10px; }
    .t-cat { font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    
    .t-title { font-weight: 700; color: #1e293b; margin-bottom: 5px; font-size: 15px; }
    .t-desc { font-size: 14px; color: #475569; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    
    .t-footer { padding: 15px 20px; background: #f8fafc; border-top: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
    
    .badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
    .bg-Pendiente { background: #fff7ed; color: #c2410c; }
    .bg-Proceso { background: #eff6ff; color: #1e40af; }
    .bg-Resuelto { background: #ecfdf5; color: #047857; }

    /* Modal */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; width: 100%; max-width: 800px; height: 85vh; border-radius: 12px; display: flex; overflow: hidden; }
    
    .modal-left { flex: 1; background: #f1f5f9; padding: 30px; overflow-y: auto; border-right: 1px solid #e2e8f0; }
    .modal-right { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }

    .btn-main { background: #1A2B48; color: white; border: none; padding: 0 20px; height: 40px; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .btn-sec { background: white; border: 1px solid #cbd5e1; color: #1e293b; padding: 0 15px; height: 40px; border-radius: 8px; font-weight: 600; cursor: pointer; }

    .chat-box { flex: 1; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f8fafc; overflow-y: auto; }
    .spinner-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); display: none; place-items: center; z-index: 2000; }
  </style>
</head>
<body>

<div id="header"></div>

<main>
  <div class="dashboard-header">
    <div class="header-top">
      <div>
        <h1 class="page-title">Gestión de Reclamos</h1>
        <p style="margin:5px 0 0; color:#64748b; font-size:14px;">Atención de tickets y solicitudes de residentes.</p>
      </div>
      <button class="btn-sec" onclick="cargarDatos()"><i class="fa-solid fa-rotate"></i> Actualizar</button>
    </div>

    <div class="header-filters">
      <div class="filter-group" style="flex:2;">
        <label class="label">Comunidad</label>
        <select id="filtroCopropiedad" class="input-modern" onchange="cargarDatos()">
            <option value="">Cargando...</option>
        </select>
      </div>
      <div class="filter-group">
        <label class="label">Estado</label>
        <select id="filtroEstado" class="input-modern" onchange="aplicarFiltros()">
            <option value="">(Todos)</option>
            <option value="Pendiente">Pendientes</option>
            <option value="En Proceso">En Proceso</option>
            <option value="Resuelto">Resueltos</option>
        </select>
      </div>
    </div>
  </div>

  <div id="gridTickets" class="ticket-grid">
    </div>
</main>

<div id="modalTicket" class="modal">
    <div class="modal-content">
        <div class="modal-left">
            <h3 style="margin-top:0; color:#64748b;">Detalle del Caso #<span id="mID"></span></h3>
            <h2 id="mCat" style="margin:10px 0; color:#1A2B48;">Categoría</h2>
            
            <div style="background:white; padding:15px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:20px;">
                <div style="font-weight:700; color:#1e293b; margin-bottom:5px;">Residente:</div>
                <div id="mUser">Nombre (Unidad)</div>
                <div style="font-weight:700; color:#1e293b; margin-top:10px; margin-bottom:5px;">Descripción:</div>
                <div id="mDesc" style="color:#475569; line-height:1.5;">...</div>
            </div>

            <div style="font-weight:700; color:#64748b; margin-bottom:10px;">Evidencia Adjunta:</div>
            <img id="mFoto" src="" style="width:100%; border-radius:8px; border:1px solid #cbd5e1; min-height:150px; object-fit:contain; background:white;">
        </div>

        <div class="modal-right">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0;">Gestión</h2>
                <button class="btn-sec" onclick="cerrarModal()" style="height:30px; font-size:12px;"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <form id="formRespuesta" style="display:flex; flex-direction:column; height:100%;">
                <input type="hidden" id="ticketID">
                <input type="hidden" id="ticketEmail">
                <input type="hidden" id="ticketNombre">
                <input type="hidden" id="ticketUnidad">
                
                <label class="label">Respuesta Anterior (Historial)</label>
                <div id="mHistorial" class="chat-box" style="height:150px; color:#64748b; font-size:13px;"></div>

                <label class="label">Nueva Respuesta / Acción</label>
                <textarea id="mRespuesta" class="input-modern" style="height:120px; padding:10px; margin-bottom:15px;" placeholder="Escribe la respuesta oficial para el residente..."></textarea>

                <label class="label">Cambiar Estado</label>
                <select id="mNuevoEstado" class="input-modern" style="margin-bottom:20px;">
                    <option value="Pendiente">Mantenir Pendiente</option>
                    <option value="En Proceso">En Proceso (Investigando)</option>
                    <option value="Resuelto">Resuelto (Cerrar Caso)</option>
                </select>

                <div style="margin-top:auto; text-align:right;">
                    <button type="button" class="btn-sec" onclick="cerrarModal()">Cancelar</button>
                    <button type="submit" class="btn-main">Guardar y Notificar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="spinner" class="spinner-overlay">
    <div style="width:40px; height:40px; border-radius:50%; border:4px solid #eee; border-top-color:#1A2B48; animation:spin 1s linear infinite;"></div>
</div>

<div id="footer"></div>

<script>
    let DB = { Tickets:[], Unidades:[], Copropiedades:[], Usuarios:[] };
    let VIEW = [];

    document.addEventListener("DOMContentLoaded", async () => {
        try { document.getElementById("header").innerHTML = await (await fetch("header.html")).text(); } catch(e){}
        try { document.getElementById("footer").innerHTML = await (await fetch("footer.html")).text(); } catch(e){}
        await cargarFiltrosIniciales();
    });

    async function cargarFiltrosIniciales() {
        document.getElementById("spinner").style.display = "grid";
        try {
            DB.Copropiedades = await fetchData("Copropiedades").catch(()=>[]) || [];
            const sel = document.getElementById("filtroCopropiedad");
            sel.innerHTML = DB.Copropiedades.length ? "" : "<option>No hay comunidades</option>";
            
            DB.Copropiedades.forEach(c => {
                const opt = document.createElement("option");
                opt.value = c.ID;
                opt.textContent = c.Nombre;
                sel.appendChild(opt);
            });

            if(DB.Copropiedades.length > 0) {
                sel.value = DB.Copropiedades[0].ID; 
                await cargarDatos(); 
            }
        } catch(e) { console.error(e); } finally { document.getElementById("spinner").style.display = "none"; }
    }

    async function cargarDatos() {
        const idCopro = document.getElementById("filtroCopropiedad").value;
        if(!idCopro) return;

        document.getElementById("spinner").style.display = "grid";
        try {
            const [tickets, unidades, usuarios] = await Promise.all([
                fetchData("Reclamos").catch(()=>[]),
                fetchData("Unidades").catch(()=>[]),
                fetchData("Copropietarios").catch(()=>[])
            ]);

            // Filtrar por CopropiedadID
            DB.Tickets = (tickets || []).filter(t => String(t.CopropiedadID) === String(idCopro));
            DB.Unidades = (unidades || []).filter(u => String(u.CopropiedadID) === String(idCopro));
            DB.Usuarios = (usuarios || []).filter(u => String(u.CopropiedadID) === String(idCopro));

            aplicarFiltros();

        } catch(e) {
            console.error(e);
            alert("Error cargando datos: " + e.message);
        } finally { document.getElementById("spinner").style.display = "none"; }
    }

    function aplicarFiltros() {
        const estado = document.getElementById("filtroEstado").value;
        VIEW = DB.Tickets;

        if(estado) {
            // Manejo de "En Proceso" que a veces viene con espacio o sin él
            VIEW = VIEW.filter(t => t.Estado === estado || (estado === 'En Proceso' && t.Estado === 'EnProceso'));
        }

        // Ordenar: Pendientes primero, luego fecha
        VIEW.sort((a,b) => {
            if(a.Estado === 'Pendiente' && b.Estado !== 'Pendiente') return -1;
            if(a.Estado !== 'Pendiente' && b.Estado === 'Pendiente') return 1;
            return new Date(b.Fecha) - new Date(a.Fecha);
        });

        renderGrid();
    }

    function renderGrid() {
        const container = document.getElementById("gridTickets");
        if(VIEW.length === 0) {
            container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:#94a3b8;">No hay tickets con este filtro.</div>';
            return;
        }

        container.innerHTML = VIEW.map(t => {
            const unidad = DB.Unidades.find(u => String(u.ID) === String(t.UnidadID));
            const nombreUnidad = unidad ? unidad.Numero : "U. Desconocida";
            const usuario = DB.Usuarios.find(u => String(u.ID) === String(t.UsuarioID));
            const nombreUsuario = usuario ? usuario.Nombre : "Residente";

            // Limpieza de estado para clases CSS
            let estadoClean = (t.Estado || "Pendiente").replace(" ", ""); 
            if(estadoClean === 'EnProceso') estadoClean = 'Proceso';

            return `
            <div class="ticket-card border-${estadoClean}">
                <div class="ticket-body">
                    <div class="t-meta">
                        <span class="t-cat">${t.Categoria}</span>
                        <span>${formatearFecha(t.Fecha)}</span>
                    </div>
                    <div class="t-title">${nombreUnidad} - ${nombreUsuario}</div>
                    <div class="t-desc">${t.Descripcion}</div>
                </div>
                <div class="t-footer">
                    <span class="badge bg-${estadoClean}">${t.Estado || 'Pendiente'}</span>
                    <button class="btn-sec" style="height:30px; font-size:12px; padding:0 10px;" onclick='abrirTicket("${t.ID}")'>Gestión</button>
                </div>
            </div>
            `;
        }).join("");
    }

    /* --- GESTIÓN MODAL --- */
    function abrirTicket(id) {
        const t = DB.Tickets.find(x => x.ID === id);
        if(!t) return;

        // Datos básicos
        document.getElementById("mID").innerText = id.replace("REQ_", "");
        document.getElementById("mCat").innerText = t.Categoria;
        document.getElementById("mDesc").innerText = t.Descripcion;
        
        // Resolver nombres
        const unidad = DB.Unidades.find(u => String(u.ID) === String(t.UnidadID));
        const usuario = DB.Usuarios.find(u => String(u.ID) === String(t.UsuarioID));
        document.getElementById("mUser").innerText = `${usuario ? usuario.Nombre : "Usuario"} (Unidad ${unidad ? unidad.Numero : "?"})`;

        // Foto
        const img = document.getElementById("mFoto");
        if(t.Foto && t.Foto.length > 10) {
            img.src = t.Foto;
            img.style.display = "block";
        } else {
            img.style.display = "none";
        }

        // Formulario
        document.getElementById("ticketID").value = t.ID;
        document.getElementById("ticketEmail").value = usuario ? usuario.Email : "";
        document.getElementById("ticketNombre").value = usuario ? usuario.Nombre : "Residente";
        document.getElementById("ticketUnidad").value = unidad ? unidad.Numero : "";
        
        document.getElementById("mRespuesta").value = ""; // Limpiar nueva respuesta
        document.getElementById("mNuevoEstado").value = t.Estado || "Pendiente";
        
        // Historial (Simulado con RespuestaAdmin actual)
        const historialDiv = document.getElementById("mHistorial");
        if(t.RespuestaAdmin) {
            historialDiv.innerHTML = `<strong>Admin:</strong> ${t.RespuestaAdmin}`;
        } else {
            historialDiv.innerHTML = "<em>Sin respuestas previas.</em>";
        }

        document.getElementById("modalTicket").style.display = "flex";
    }

    function cerrarModal() {
        document.getElementById("modalTicket").style.display = "none";
    }

    /* --- GUARDAR Y RESPONDER --- */
    document.getElementById("formRespuesta").onsubmit = async (e) => {
        e.preventDefault();
        
        if(!confirm("¿Enviar respuesta y actualizar estado?")) return;
        document.getElementById("spinner").style.display = "grid";

        const id = document.getElementById("ticketID").value;
        const nuevaRespuesta = document.getElementById("mRespuesta").value;
        const nuevoEstado = document.getElementById("mNuevoEstado").value;
        const emailUser = document.getElementById("ticketEmail").value;

        try {
            // 1. Guardar en AppSheet
            // Concatenamos respuesta si quieres historial o reemplazamos
            // Aquí reemplazaremos para simplificar, o podrías hacer: old + "\n" + new
            const ticketActual = DB.Tickets.find(t => t.ID === id);
            const respuestaFinal = nuevaRespuesta ? nuevaRespuesta : ticketActual.RespuestaAdmin;

            const payload = {
                "ID": id,
                "Estado": nuevoEstado,
                "RespuestaAdmin": respuestaFinal
            };

            if(typeof appSheetCRUD === 'function') {
                await appSheetCRUD("Reclamos", "Edit", [payload]);
            }

            // 2. Enviar Email al Usuario (Si hay respuesta nueva)
            if(nuevaRespuesta && emailUser) {
                await enviarEmailRespuesta(emailUser, {
                    nombre: document.getElementById("ticketNombre").value,
                    unidad: document.getElementById("ticketUnidad").value,
                    categoria: document.getElementById("mCat").innerText,
                    respuesta: nuevaRespuesta,
                    estado: nuevoEstado
                });
            }

            cerrarModal();
            await cargarDatos(); // Refrescar

        } catch(err) {
            alert("Error: " + err.message);
        } finally {
            document.getElementById("spinner").style.display = "none";
        }
    };

    async function enviarEmailRespuesta(email, datos) {
        if (typeof emailjs === 'undefined') return;

        const htmlBody = `
            <div style="font-family:sans-serif; padding:20px; border:1px solid #eee; border-radius:8px;">
                <h2 style="color:#1A2B48;">Actualización de Ticket</h2>
                <p>Estimado(a) <strong>${datos.nombre}</strong>,</p>
                <p>Hemos actualizado el estado de tu solicitud de <strong>${datos.categoria}</strong>.</p>
                
                <div style="background:#f0fdf4; padding:15px; border-left:4px solid #10b981; margin:20px 0;">
                    <p><strong>Respuesta Administración:</strong></p>
                    <p><em>"${datos.respuesta}"</em></p>
                    <p style="margin-top:10px;"><strong>Nuevo Estado:</strong> ${datos.estado.toUpperCase()}</p>
                </div>
                
                <p style="font-size:12px; color:#666;">Santa Josefina SpA</p>
            </div>
        `;

        try {
            await emailjs.send("service_p9hqkqn", "template_80q9psi", {
                to_email: email,
                subject: `Respuesta a Solicitud ${datos.categoria}`,
                html_body: htmlBody
            });
        } catch(e) { console.error("Fallo email", e); }
    }

    function formatearFecha(iso) { 
      if(!iso) return ""; 
      const [y,m,d] = iso.split("-");
      return `${d}/${m}/${y}`;
    }
</script>

</body>
</html>