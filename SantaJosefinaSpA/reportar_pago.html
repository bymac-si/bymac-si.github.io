<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Reportar Pago - Santa Josefina</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="assets/css/styles.css">
  <script src="assets/js/app.js"></script>
  
  <style>
    /* Estilos Base (Igual a portal.html) */
    body { background-color: #f8fafc; padding-bottom: 40px; }
    
    /* Header Azul Curvo */
    .app-header {
      background: #1A2B48; color: white; padding: 20px 20px 30px;
      border-bottom-left-radius: 25px; border-bottom-right-radius: 25px;
      box-shadow: 0 4px 15px rgba(26, 43, 72, 0.2);
      display: flex; align-items: center; gap: 15px;
    }
    .btn-back { color: white; font-size: 20px; text-decoration: none; opacity: 0.9; }
    .page-title { font-size: 18px; font-weight: 700; margin: 0; color: white; }

    /* Tarjeta Formulario */
    .form-card {
      background: white; margin: -20px 15px 20px; padding: 25px 20px;
      border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.06);
      border: 1px solid #e2e8f0; position: relative;
    }

    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 8px; }
    
    /* Inputs */
    .input-app, .select-app, .textarea-app {
      width: 100%; padding: 14px; border: 1px solid #cbd5e1;
      border-radius: 12px; font-size: 15px; background: #f8fafc;
      color: #1e293b; transition: all 0.2s; box-sizing: border-box;
    }
    .input-app:focus { border-color: #3b82f6; background: white; outline: none; }

    /* Upload */
    .file-upload-area {
      border: 2px dashed #cbd5e1; border-radius: 12px;
      padding: 30px 20px; text-align: center;
      background: #f8fafc; cursor: pointer; position: relative;
      transition: all 0.2s;
    }
    .file-upload-area:active { background: #e2e8f0; }
    .file-upload-area.has-file { border-color: #10b981; background: #ecfdf5; }
    .upload-icon { font-size: 30px; color: #94a3b8; margin-bottom: 10px; }
    .upload-text { font-size: 13px; color: #64748b; }
    #fileInput { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

    /* Botón */
    .btn-submit {
      background: #2563eb; color: white; width: 100%; padding: 16px;
      border: none; border-radius: 12px; font-weight: 700; font-size: 16px;
      margin-top: 10px; cursor: pointer;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    .btn-submit:active { transform: scale(0.98); }

    /* Spinner */
    .spinner-overlay {
      position: fixed; inset: 0; background: rgba(255,255,255,0.9);
      display: none; flex-direction: column; align-items: center; justify-content: center;
      z-index: 999;
    }
  </style>
</head>
<body>

  <div class="app-header">
    <a href="portal.html" class="btn-back"><i class="fa-solid fa-arrow-left"></i></a>
    <h1 class="page-title">Reportar Pago</h1>
  </div>

  <main>
    <div class="form-card">
      <p class="muted" style="font-size:13px; margin-bottom:20px; line-height:1.5; color:#64748b;">
        Sube el comprobante de tu transferencia. La administración validará el pago en un plazo de 24 a 48 hrs.
      </p>

      <form id="formPago">
        
        <div class="form-group">
          <label class="form-label">¿Qué estás pagando?</label>
          <select id="selCobro" class="select-app" required onchange="actualizarMonto()">
            <option value="" disabled selected>Calculando deudas...</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Fecha de Transferencia</label>
          <input type="date" id="fechaPago" class="input-app" required>
        </div>

        <div class="form-group">
          <label class="form-label">Monto Transferido</label>
          <input type="number" id="montoPago" class="input-app" placeholder="$0" required>
        </div>

        <div class="form-group">
          <label class="form-label">Comprobante (Imagen o PDF)</label>
          <div class="file-upload-area" id="uploadArea">
            <i class="fa-solid fa-cloud-arrow-up upload-icon" id="uploadIcon"></i>
            <div class="upload-text" id="uploadText">Toca para subir foto</div>
            <input type="file" id="fileInput" accept="image/*,application/pdf" required onchange="previewFile()">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Nota (Opcional)</label>
          <textarea id="obsPago" class="textarea-app" rows="2" placeholder="Ej: Transferencia desde cuenta de tercero..."></textarea>
        </div>

        <button type="submit" class="btn-submit">Enviar Reporte</button>
      </form>
    </div>
  </main>

  <div id="spinner" class="spinner-overlay">
    <div style="width:40px; height:40px; border-radius:50%; border:4px solid #eee; border-top-color:#1A2B48; animation:spin 1s linear infinite;"></div>
    <div style="margin-top:15px; font-weight:600; color:#1A2B48;">Enviando...</div>
  </div>

  <script>
    let USUARIO = null;
    let OPCIONES_PAGO = [];
    
    // --- TU API KEY DE IMGBB AQUÍ ---
    const IMGBB_API_KEY = "d096ade1d65ede2aa12f00d94094a854"; 
    // -------------------------------

    document.addEventListener("DOMContentLoaded", async () => {
        try {
            const sesion = localStorage.getItem("sesion_residente");
            if(!sesion) throw new Error("No session");
            USUARIO = JSON.parse(sesion);
        } catch(e) {
            window.location.href = "login_residente.html";
            return;
        }

        document.getElementById("fechaPago").value = new Date().toISOString().split('T')[0];
        await cargarOpcionesDeuda();
    });

    async function cargarOpcionesDeuda() {
        const sel = document.getElementById("selCobro");
        try {
            const [copropiedades, unidades, gastosComunes, gastos, cobrosInd] = await Promise.all([
                fetchData('Copropiedades'),
                fetchData('Unidades'),
                fetchData('GastosComunes').catch(()=>[]),
                fetchData('Gastos'),
                fetchData('Cobros').catch(()=>[])
            ]);

            const coproID = USUARIO.CopropiedadID;
            const unidadID = USUARIO.UnidadID;
            
            const comunidad = copropiedades.find(c => String(getKeyVal(c)) === String(coproID));
            const unidad = unidades.find(u => String(getKeyVal(u)) === String(unidadID));

            if(!comunidad || !unidad) throw new Error("Datos incompletos");

            // Cálculo Gasto Mes Actual
            const fechaHoy = new Date();
            const mesStr = `${String(fechaHoy.getMonth() + 1).padStart(2, '0')}-${fechaHoy.getFullYear()}`;
            
            let totalGastoComunidad = 0;
            const resumenMes = gastosComunes.find(g => g.CopropiedadID === coproID && g.Mes === mesStr);
            if(resumenMes && resumenMes.TotalGastos) {
                totalGastoComunidad = parseFloat(resumenMes.TotalGastos);
            } else {
                const gastosMes = gastos.filter(g => String(g.CopropiedadID) === String(coproID) && g.Mes === mesStr);
                totalGastoComunidad = gastosMes.reduce((sum, g) => sum + (parseFloat(g.Monto)||0), 0);
            }

            const alicuotaPct = parseFloat(unidad.Alicuota && unidad.Alicuota.replace(',', '.')) || 0;
            const fondoPct = parseFloat(comunidad.FondoReserva) || 0;
            const factorFondo = fondoPct > 1 ? (fondoPct / 100) : fondoPct;

            const montoBase = Math.round(totalGastoComunidad * (alicuotaPct / 100));
            const montoFondo = Math.round(montoBase * factorFondo);
            const totalMesActual = montoBase + montoFondo;

            // Cálculo Mora
            const moras = cobrosInd.filter(c => String(c.UnidadID) === String(unidadID) && c.Estado === 'Pendiente');
            const totalMora = moras.reduce((sum, c) => sum + (parseFloat(c.TotalAPagar)||0), 0);

            OPCIONES_PAGO = [];
            const granTotal = totalMesActual + totalMora;
            
            if(granTotal > 0) OPCIONES_PAGO.push({ id: "TOTAL", label: `Pagar Todo (${clp(granTotal)})`, monto: granTotal });
            if(totalMesActual > 0) OPCIONES_PAGO.push({ id: "MES_ACTUAL", label: `Solo Mes Actual (${clp(totalMesActual)})`, monto: totalMesActual });
            if(totalMora > 0) OPCIONES_PAGO.push({ id: "MORA", label: `Solo Deuda Anterior (${clp(totalMora)})`, monto: totalMora });
            
            OPCIONES_PAGO.push({ id: "OTRO", label: "Otro Monto / Abono", monto: "" });

            sel.innerHTML = '<option value="" selected disabled>Selecciona...</option>';
            OPCIONES_PAGO.forEach(op => {
                const el = document.createElement("option");
                el.value = op.id;
                el.textContent = op.label;
                sel.appendChild(el);
            });

        } catch(e) {
            console.error(e);
            sel.innerHTML = '<option>Error cargando datos</option>';
        }
    }

    function actualizarMonto() {
        const id = document.getElementById("selCobro").value;
        const op = OPCIONES_PAGO.find(o => o.id === id);
        if(op) document.getElementById("montoPago").value = op.monto;
    }

    function previewFile() {
        const file = document.getElementById("fileInput").files[0];
        if (file) {
            document.getElementById("uploadArea").classList.add("has-file");
            document.getElementById("uploadText").textContent = file.name;
            document.getElementById("uploadIcon").className = "fa-solid fa-check-circle";
            document.getElementById("uploadIcon").style.color = "#10b981";
        }
    }

    // === NUEVA FUNCIÓN DE SUBIDA DE IMAGEN ===
    async function subirImagenNube(file) {
        if (!IMGBB_API_KEY || IMGBB_API_KEY === "") {
            throw new Error("Falta configurar la API Key de ImgBB en el código.");
        }

        const formData = new FormData();
        formData.append("image", file);

        const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
            method: "POST",
            body: formData
        });

        const data = await response.json();
        if (data.success) {
            return data.data.url; // Retorna la URL pública (ej: https://i.ibb.co/...)
        } else {
            throw new Error("Error subiendo imagen: " + (data.error ? data.error.message : "Desconocido"));
        }
    }

    // === ENVÍO ===
    document.getElementById("formPago").onsubmit = async (e) => {
        e.preventDefault();
        
        const tipoPago = document.getElementById("selCobro").value;
        const monto = parseFloat(document.getElementById("montoPago").value) || 0;
        const fileInput = document.getElementById("fileInput");

        if(!tipoPago) return alert("Selecciona qué pagas.");
        if(fileInput.files.length === 0) return alert("Sube el comprobante.");
        if(monto <= 0) return alert("Monto inválido.");

        // UI Loading
        const spinner = document.getElementById("spinner");
        const spinnerText = spinner.querySelector("div:last-child");
        spinner.style.display = "flex";

        try {
            // 1. Subir Imagen a la Nube
            spinnerText.textContent = "Subiendo comprobante...";
            const urlComprobante = await subirImagenNube(fileInput.files[0]);
            
            // 2. Preparar Datos para AppSheet
            spinnerText.textContent = "Registrando pago...";
            
            let cobroRef = "";
            if(tipoPago === 'MES_ACTUAL') cobroRef = "GC_MES_ACTUAL";
            else if(tipoPago === 'MORA') cobroRef = "MORA_HISTORICA";
            else if(tipoPago === 'TOTAL') cobroRef = "TOTAL_DEUDA";
            else cobroRef = "ABONO";

            const payload = {
                "ID": "PAY_" + Date.now(),
                "CobroID": cobroRef, 
                "UnidadID": String(USUARIO.UnidadID), // Texto
                "FechaPago": document.getElementById("fechaPago").value,
                "Monto": monto,
                "Metodo": "Transferencia",
                "Estado": "Pendiente",
                "ComprobanteURL": urlComprobante, // AHORA ES UNA URL CORTA :)
                "Observaciones": document.getElementById("obsPago").value,
                "RegistradoPor": USUARIO.Email,
                "FechaRegistro": new Date().toISOString()
            };

            // 3. Enviar a AppSheet
            if(typeof appSheetCRUD === 'function'){
                await appSheetCRUD("Pagos", "Add", [payload]);
            } else {
                await new Promise(r => setTimeout(r, 2000));
            }

            alert("✅ ¡Pago enviado con éxito!");
            window.location.href = "portal.html"; 

        } catch (err) {
            console.error(err);
            alert("Error: " + err.message);
        } finally {
            spinner.style.display = "none";
        }
    };

    function clp(v) { return "$" + new Intl.NumberFormat("es-CL").format(v); }
    function getKeyVal(o) { return o.ID || o.id || ""; }
</script>
</body>
</html>