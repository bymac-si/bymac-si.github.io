<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Reportar Pago - Santa Josefina</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="assets/css/styles.css">
  <script src="assets/js/app.js"></script>
  
  <style>
    /* Estilos Base (Igual a portal.html) */
    body { background-color: #f8fafc; padding-bottom: 40px; }
    
    /* Header Azul Curvo */
    .app-header {
      background: #1A2B48; color: white; padding: 20px 20px 30px;
      border-bottom-left-radius: 25px; border-bottom-right-radius: 25px;
      box-shadow: 0 4px 15px rgba(26, 43, 72, 0.2);
      display: flex; align-items: center; gap: 15px;
    }
    .btn-back { color: white; font-size: 20px; text-decoration: none; opacity: 0.9; }
    .page-title { font-size: 18px; font-weight: 700; margin: 0; color: white; }

    /* Tarjeta Formulario */
    .form-card {
      background: white; margin: -20px 15px 20px; padding: 25px 20px;
      border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.06);
      border: 1px solid #e2e8f0; position: relative;
    }

    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 8px; }
    
    /* Inputs */
    .input-app, .select-app, .textarea-app {
      width: 100%; padding: 14px; border: 1px solid #cbd5e1;
      border-radius: 12px; font-size: 15px; background: #f8fafc;
      color: #1e293b; transition: all 0.2s; box-sizing: border-box;
    }
    .input-app:focus { border-color: #3b82f6; background: white; outline: none; }

    /* Upload */
    .file-upload-area {
      border: 2px dashed #cbd5e1; border-radius: 12px;
      padding: 30px 20px; text-align: center;
      background: #f8fafc; cursor: pointer; position: relative;
      transition: all 0.2s;
    }
    .file-upload-area:active { background: #e2e8f0; }
    .file-upload-area.has-file { border-color: #10b981; background: #ecfdf5; }
    .upload-icon { font-size: 30px; color: #94a3b8; margin-bottom: 10px; }
    .upload-text { font-size: 13px; color: #64748b; }
    #fileInput { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

    /* Botón */
    .btn-submit {
      background: #2563eb; color: white; width: 100%; padding: 16px;
      border: none; border-radius: 12px; font-weight: 700; font-size: 16px;
      margin-top: 10px; cursor: pointer;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    .btn-submit:active { transform: scale(0.98); }

    /* Spinner */
    .spinner-overlay {
      position: fixed; inset: 0; background: rgba(255,255,255,0.9);
      display: none; flex-direction: column; align-items: center; justify-content: center;
      z-index: 999;
    }
  </style>
</head>
<body>

  <div class="app-header">
    <a href="portal.html" class="btn-back"><i class="fa-solid fa-arrow-left"></i></a>
    <h1 class="page-title">Reportar Transferencia</h1>
  </div>

  <main>
    <div class="form-card">
      <p class="muted" style="font-size:13px; margin-bottom:20px; line-height:1.5; color:#64748b;">
        Sube el comprobante de tu transferencia. La administración validará el pago en un plazo de 24 a 48 hrs.
      </p>

      <form id="formPago">
        
        <div class="form-group">
          <label class="form-label">¿Qué estás pagando?</label>
          <select id="selCobro" class="select-app" required onchange="actualizarMonto()">
            <option value="" disabled selected>Cargando deudas...</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Fecha de Transferencia</label>
          <input type="date" id="fechaPago" class="input-app" required>
        </div>

        <div class="form-group">
          <label class="form-label">Monto Transferido</label>
          <input type="number" id="montoPago" class="input-app" placeholder="$0" required>
        </div>

        <div class="form-group">
          <label class="form-label">Comprobante (Imagen o PDF)</label>
          <div class="file-upload-area" id="uploadArea">
            <i class="fa-solid fa-cloud-arrow-up upload-icon" id="uploadIcon"></i>
            <div class="upload-text" id="uploadText">Toca para subir foto</div>
            <input type="file" id="fileInput" accept="image/*,application/pdf" required onchange="previewFile()">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Nota (Opcional)</label>
          <textarea id="obsPago" class="textarea-app" rows="2" placeholder="Ej: Transferencia desde cuenta de tercero..."></textarea>
        </div>

        <button type="submit" class="btn-submit">Enviar Reporte</button>
      </form>
    </div>
  </main>

  <div id="spinner" class="spinner-overlay">
    <div style="width:40px; height:40px; border-radius:50%; border:4px solid #eee; border-top-color:#1A2B48; animation:spin 1s linear infinite;"></div>
    <div style="margin-top:15px; font-weight:600; color:#1A2B48;">Enviando comprobante...</div>
  </div>

  <script>
    let USUARIO = null;
    let DEUDAS_PENDIENTES = [];
    let FILE_BASE64 = null;

    document.addEventListener("DOMContentLoaded", async () => {
        // 1. Validar Sesión
        try {
            const sesion = localStorage.getItem("sesion_residente");
            if(!sesion) throw new Error("No session");
            USUARIO = JSON.parse(sesion);
        } catch(e) {
            window.location.href = "login_residente.html";
            return;
        }

        // 2. Fecha Hoy
        document.getElementById("fechaPago").value = new Date().toISOString().split('T')[0];
        
        // 3. Cargar Deudas Reales
        await cargarDeudas();
    });

    async function cargarDeudas() {
        const sel = document.getElementById("selCobro");
        sel.innerHTML = '<option disabled>Cargando...</option>';

        try {
            // Fetch real a tabla 'Cobros'
            let cobros = [];
            if(typeof fetchData === 'function') {
                cobros = await fetchData('Cobros').catch(()=>[]);
            }

            // Filtrar por Unidad y Estado Pendiente
            DEUDAS_PENDIENTES = cobros.filter(c => 
                String(c.UnidadID) === String(USUARIO.UnidadID) && 
                (c.Estado||'Pendiente') === 'Pendiente'
            );

            // Si no hay datos (o falló fetch), usar mock solo para demo visual si quieres, o dejar vacío.
            if(DEUDAS_PENDIENTES.length === 0 && !cobros.length) {
                 // Mock Fallback (Solo si no hay backend conectado aún)
                 DEUDAS_PENDIENTES = [
                    { ID: 'MOCK_1', Mes: 'Gasto Común (Simulado)', TotalAPagar: 85000 }
                 ];
            }

            sel.innerHTML = '<option value="" selected disabled>Selecciona una deuda...</option>';
            
            if(DEUDAS_PENDIENTES.length > 0){
                DEUDAS_PENDIENTES.forEach(d => {
                    const monto = d.TotalAPagar || d.Total || 0;
                    const mes = d.Mes || "Cobro General";
                    const opt = document.createElement('option');
                    opt.value = d.ID;
                    opt.textContent = `${mes} - ${clp(monto)}`;
                    sel.appendChild(opt);
                });
                
                // Opción genérica "Abono / Otro"
                const optOtro = document.createElement('option');
                optOtro.value = "OTRO";
                optOtro.textContent = "Otro Monto / Abono";
                sel.appendChild(optOtro);

            } else {
                sel.innerHTML = '<option value="">¡Estás al día! No hay deudas pendientes.</option>';
            }

        } catch(e) {
            console.error(e);
            sel.innerHTML = '<option>Error cargando deudas</option>';
        }
    }

    function actualizarMonto() {
        const id = document.getElementById("selCobro").value;
        const deuda = DEUDAS_PENDIENTES.find(d => d.ID === id);
        
        if(deuda) {
            const total = deuda.TotalAPagar || deuda.Total || 0;
            document.getElementById("montoPago").value = total;
        } else {
            document.getElementById("montoPago").value = ""; // Limpiar si es "Otro"
        }
    }

    function previewFile() {
        const file = document.getElementById("fileInput").files[0];
        const area = document.getElementById("uploadArea");
        const text = document.getElementById("uploadText");
        const icon = document.getElementById("uploadIcon");

        if (file) {
            area.classList.add("has-file");
            text.textContent = `Archivo: ${file.name}`;
            icon.className = "fa-solid fa-check-circle";
            icon.style.color = "#10b981";

            const reader = new FileReader();
            reader.onload = (e) => FILE_BASE64 = e.target.result;
            reader.readAsDataURL(file);
        }
    }

    document.getElementById("formPago").onsubmit = async (e) => {
        e.preventDefault();
        
        const cobroId = document.getElementById("selCobro").value;
        if(!cobroId) { alert("Por favor selecciona qué deuda estás pagando."); return; }
        if(!FILE_BASE64) { alert("Debes adjuntar el comprobante."); return; }

        document.getElementById("spinner").style.display = "flex";

        const payload = {
            "ID": "PAY_" + Date.now(),
            "CobroID": cobroId === 'OTRO' ? '' : cobroId, // Si es abono, va vacío o ref genérica
            "UnidadID": USUARIO.UnidadID, // ID interno
            "UnidadLabel": USUARIO.UnidadLabel, // Dato visual para el admin
            "FechaPago": document.getElementById("fechaPago").value,
            "Monto": parseFloat(document.getElementById("montoPago").value) || 0,
            "Metodo": "Transferencia",
            "Estado": "Pendiente Revisión",
            "ComprobanteURL": FILE_BASE64,
            "Observaciones": document.getElementById("obsPago").value,
            "RegistradoPor": USUARIO.Email,
            "FechaRegistro": new Date().toISOString()
        };

        try {
            if(typeof appSheetCRUD === 'function'){
                await appSheetCRUD("Pagos", "Add", [payload]);
            } else {
                await new Promise(r => setTimeout(r, 2000));
            }

            alert("✅ Reporte enviado. La administración lo revisará pronto.");
            window.location.href = "portal.html"; 

        } catch (err) {
            console.error(err);
            alert("Error al enviar: " + err.message);
        } finally {
            document.getElementById("spinner").style.display = "none";
        }
    };

    function clp(v) { return "$" + new Intl.NumberFormat("es-CL").format(v); }
  </script>
</body>
</html>