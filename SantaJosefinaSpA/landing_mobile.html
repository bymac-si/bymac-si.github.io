<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <title>Santa Josefina - Móvil</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/css/mobile.css" />
    <link rel="stylesheet" href="assets/css/landing_mobile.css" />
<link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#1a2b48" />

    <script src="assets/js/app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
      (function () {
        if (typeof emailjs !== "undefined") emailjs.init("7Il4AhmGHchP7qfxu");
      })();
    </script></head>
  <body style="margin: auto;">
    <div class="m-hero">
      <img
        src="assets/img/logo_santajosefina.png"
        class="m-logo"
        alt="Santa Josefina"
      />
      <div class="m-title">Gestión Inmobiliaria</div>
      <div class="m-subtitle">Administración & Corretaje</div>
    </div>

    <div class="access-grid">
      <a href="checklist_seguridad.html" class="access-card" style="border-left: 4px solid #e74e35;">
  <i class="fa-solid fa-user-shield access-icon" style="color: #e74e35"></i>
  <span class="access-text">Test de Seguridad</span>
  <span class="access-sub">Evalúa tu edificio gratis</span>
</a>
      <a href="login_residente.html" class="access-card">
        <i
          class="fa-solid fa-users access-icon"
          style="color: #e74e35"
        ></i>
        <span class="access-text">Portal Comunidad</span>
        <span class="access-sub">Residentes y Dueños</span>
      </a>

      <a href="login.html" class="access-card">
        <i class="fa-solid fa-id-badge access-icon" style="color: #1a2b48"></i>
        <span class="access-text">Acceso Agentes</span>
        <span class="access-sub">CRM Interno</span>
      </a>
    </div>

    <div class="action-list">
      <div class="section-label">¿Qué buscas hoy?</div>

      <div class="btn-action highlight" onclick="abrirModal('propiedades')">
        <div style="display: flex; align-items: center; gap: 12px">
          <i class="fa-solid fa-magnifying-glass"></i>
          <span>Buscar Propiedad</span>
        </div>
        <i
          class="fa-solid fa-chevron-right"
          style="font-size: 12px; opacity: 0.5"
        ></i>
      </div>

      <div class="btn-action" onclick="abrirModal('contacto')">
        <div style="display: flex; align-items: center; gap: 12px">
          <i class="fa-solid fa-headset" style="color: #e74e35"></i>
          <span>Contactar Administración</span>
        </div>
        <i
          class="fa-solid fa-chevron-right"
          style="font-size: 12px; opacity: 0.5"
        ></i>
      </div>

      <a href="tel:+56998647190" class="btn-action">
        <div style="display: flex; align-items: center; gap: 12px">
          <i class="fa-solid fa-phone" style="color: #64748b"></i>
          <span>Llamar a Soporte</span>
        </div>
      </a>
    </div>

    <div class="footer-links">
      © 2026 Santa Josefina SpA<br />
      <a href="landing_desktop.html">Ver sitio web completo</a>
    </div>

    <a
      href="https://wa.me/56998647190?text=Hola,%20contacto%20desde%20la%20App."
      class="fab-whatsapp"
      target="_blank"
    >
      <i class="fa-brands fa-whatsapp"></i>
    </a>

    <div id="modalPropiedades" class="modal-overlay">
      <div class="modal-sheet">
        <div class="sheet-header">
          <h3 class="sheet-title">Propiedades Disponibles</h3>
          <button class="btn-close" onclick="cerrarModal('propiedades')">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="sheet-content" id="contenedorPropiedades">
          <div style="text-align: center; color: #64748b; padding-top: 40px">
            <i class="fa-solid fa-circle-notch fa-spin"></i> Cargando...
          </div>
        </div>
      </div>
    </div>

    <div id="modalContacto" class="modal-overlay">
      <div class="modal-sheet">
        <div class="sheet-header">
          <h3 class="sheet-title">Escríbenos</h3>
          <button class="btn-close" onclick="cerrarModal('contacto')">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="sheet-content">
          <form id="formContactoMobile">
            <p style="font-size: 13px; color: #64748b; margin-bottom: 20px">
              Déjanos tus datos y te contactaremos a la brevedad.
            </p>
            <input
              type="text"
              id="mNombre"
              class="input-mobile"
              placeholder="Nombre completo"
              required
            />
            <input
              type="email"
              id="mEmail"
              class="input-mobile"
              placeholder="Correo electrónico"
              required
            />
            <input
              type="tel"
              id="mTel"
              class="input-mobile"
              placeholder="Teléfono (+569...)"
            />
            <textarea
              id="mMensaje"
              class="input-mobile"
              rows="4"
              placeholder="¿Cómo podemos ayudarte?"
              required
            ></textarea>
            <button type="submit" id="btnSubmitM" class="btn-submit-mobile">
              Enviar Mensaje
            </button>
          </form>
        </div>
      </div>
    </div>

    <script>
      // Verificar sesión activa (Solo redirige si es AGENTE, no Residente)
      document.addEventListener("DOMContentLoaded", () => {
        if (typeof getAuthUser === "function") {
          const user = getAuthUser();
          // Si es un Agente (tiene sesión interna), va al dashboard
          if (user && user.Nombre && !window.location.href.includes("dashboard")) {
            window.location.href = "mobile_dashboard.html";
          }
        }
      });

      /* === LÓGICA DE MODALES === */
      function abrirModal(tipo) {
        if (tipo === "propiedades") {
          document.getElementById("modalPropiedades").classList.add("active");
          cargarPropiedades();
        } else if (tipo === "contacto") {
          document.getElementById("modalContacto").classList.add("active");
        }
      }

      function cerrarModal(tipo) {
        if (tipo === "propiedades") {
          document.getElementById("modalPropiedades").classList.remove("active");
        } else if (tipo === "contacto") {
          document.getElementById("modalContacto").classList.remove("active");
        }
      }

      /* === CARGAR PROPIEDADES === */
      let propiedadesCargadas = false;

      async function cargarPropiedades() {
        if (propiedadesCargadas) return;
        const contenedor = document.getElementById("contenedorPropiedades");

        try {
          const props = typeof fetchData === "function" ? await fetchData("Propiedades") : [];
          const disponibles = props.filter((p) => (p.Estado || "") === "Disponible");

          if (disponibles.length === 0) {
            contenedor.innerHTML = '<p style="text-align:center; color:#999; margin-top:20px;">No hay propiedades destacadas.</p>';
            return;
          }

          contenedor.innerHTML = disponibles.map((p) => {
              const precioFmt = "$" + new Intl.NumberFormat("es-CL").format(p.Precio || 0);
              const tagClass = p.Operacion === "Arriendo" ? "tag-arriendo" : "tag-venta";
              const imgUrl = p.ImagenURL || "assets/img/default_prop.jpg";
              const wspText = `Hola, me interesa: ${p.Titulo} (${precioFmt})`;

              return `
                    <div class="prop-card-mini">
                        <img src="${imgUrl}" class="prop-img" loading="lazy" onerror="this.src='assets/img/default_prop.jpg'">
                        <div class="prop-info">
                            <span class="prop-tag ${tagClass}">${p.Operacion || "Venta"}</span>
                            <div class="prop-price">${precioFmt}</div>
                            <div style="font-weight:600; font-size:14px; margin-top:2px;">${p.Titulo}</div>
                            <div class="prop-addr"><i class="fa-solid fa-location-dot"></i> ${p.Comuna || "Santiago"}</div>
                            <a href="https://wa.me/56998647190?text=${encodeURIComponent(wspText)}" target="_blank" class="btn-wsp-outline">
                                <i class="fa-brands fa-whatsapp"></i> Consultar
                            </a>
                        </div>
                    </div>`;
            }).join("");

          propiedadesCargadas = true;
        } catch (e) {
          console.error(e);
          contenedor.innerHTML = '<p style="text-align:center; color:red;">Error cargando datos.</p>';
        }
      }

      /* === FORMULARIO CONTACTO === */
      document.getElementById("formContactoMobile").onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById("btnSubmitM");
        const txtOriginal = btn.innerText;
        btn.innerText = "Enviando...";
        btn.disabled = true;

        const payload = {
          ID: "WEB_M_" + Date.now(),
          Nombre: document.getElementById("mNombre").value,
          Email: document.getElementById("mEmail").value,
          Telefono: document.getElementById("mTel").value,
          Observaciones: document.getElementById("mMensaje").value,
          "Fecha Registro": new Date().toISOString().split("T")[0],
          Estado: "Nuevo",
          Canal: "App Mobile",
          Agente: "Asignar",
        };

        try {
          if (typeof appSheetCRUD === "function") {
            await appSheetCRUD("ProspectosCorretaje", "Add", [payload]);
          }
          if (typeof emailjs !== "undefined") {
            await emailjs.send("service_p9hqkqn", "template_80q9psi", {
              to_email: "marcos.castro@santajosefinaspa.cl",
              subject: "[APP] Nuevo Mensaje: " + payload.Nombre,
              html_body: `Mensaje: ${payload.Observaciones} <br> Tel: ${payload.Telefono}`,
            });
          }
          alert("¡Mensaje enviado! Te contactaremos pronto.");
          document.getElementById("formContactoMobile").reset();
          cerrarModal("contacto");
        } catch (err) {
          alert("Error al enviar. Intenta por WhatsApp.");
        } finally {
          btn.innerText = txtOriginal;
          btn.disabled = false;
        }
      };
    </script>
  </body>
</html>