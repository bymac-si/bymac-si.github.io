<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>CRM - Copropietarios y Residentes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a2b48">
    <link rel="apple-touch-icon" href="assets/img/icon-192.png">

    <script src="assets/js/app.js"></script>
    <script>requireAuth();</script>

    
    <link rel="stylesheet" href="assets/css/pages/copropietarios.inline.css">
</head>
<body>
    <div id="header"></div>

    <main>
        <div class="dashboard-header">
            <div class="header-top">
                <div>
                    <h1 class="page-title">Copropietarios y Residentes</h1>
                    <p style="margin: 5px 0 0; color: #64748b; font-size: 14px">Gestión de comunidad, contactos e historial.</p>
                </div>
                <div style="display: flex; gap: 10px">
                    <button class="btn-sec" onclick="cargarDatos()" title="Recargar"><i class="fa-solid fa-rotate-right"></i></button>
                    <button class="btn-green" onclick="abrirImportar()"><i class="fa-solid fa-file-excel"></i> Importar</button>
                    <button class="btn-main" onclick="abrirModalUsuario()"><i class="fa-solid fa-plus"></i> Nuevo</button>
                </div>
            </div>

            <div class="header-filters">
                <div class="filter-group" style="flex: 2">
                    <label class="label">Comunidad / Condominio</label>
                    <select id="filtroCopropiedad" class="input-modern" onchange="aplicarFiltros()">
                        <option value="">(Cargando...)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="label">Buscar Persona</label>
                    <input id="filtroBuscar" class="input-modern" placeholder="Nombre, email, unidad..." onkeyup="aplicarFiltros()" />
                </div>
                <div class="filter-group">
                    <label class="label">Tipo</label>
                    <select id="filtroTipo" class="input-modern" onchange="aplicarFiltros()">
                        <option value="">(Todos)</option>
                        <option value="Propietario">Propietario</option>
                        <option value="Arrendatario">Arrendatario</option>
                        <option value="Corredor">Corredor</option>
                    </select>
                </div>
            </div>
        </div>

        <div style="background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden;">
            <table>
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Unidad</th>
                        <th>Contacto</th>
                        <th>Tipo</th>
                        <th style="text-align: right">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaUsuarios">
                    <tr><td colspan="5" style="text-align: center; padding: 30px; color: #94a3b8">Cargando datos...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <div id="modalUsuario" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" style="margin-top: 0">Nueva Persona</h2>
            <form id="formUsuario">
                <input type="hidden" id="uID" />
                <input type="hidden" id="uCopropiedadID" />

                <label class="label" style="margin-top: 10px">Comunidad</label>
                <input id="uCopropiedadNombre" class="input-modern" style="background: #f1f5f9" readonly />

                <div style="margin-top: 15px">
                    <label class="label">Nombre Completo</label>
                    <input id="uNombre" class="input-modern" required placeholder="Ej: Juan Pérez" />
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div>
                        <label class="label">Asignar Unidad</label>
                        <select id="uUnidadID" class="input-modern"><option value="">(Sin Unidad)</option></select>
                    </div>
                    <div>
                        <label class="label">Rol</label>
                        <select id="uTipo" class="input-modern">
                            <option value="Propietario">Propietario</option>
                            <option value="Arrendatario">Arrendatario</option>
                            <option value="Residente">Residente</option>
                            <option value="Corredor">Corredor</option>
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div>
                        <label class="label">Email</label>
                        <input id="uEmail" type="email" class="input-modern" placeholder="juan@correo.com" />
                    </div>
                    <div>
                        <label class="label">Teléfono</label>
                        <input id="uTelefono" class="input-modern" placeholder="+569..." />
                    </div>
                </div>

                <div style="text-align: right; margin-top: 25px">
                    <button type="button" class="btn-sec" onclick="document.getElementById('modalUsuario').style.display='none'">Cancelar</button>
                    <button type="submit" class="btn-main">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalGestion" class="modal">
        <div class="modal-content" style="height: 80vh;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0;"><i class="fa-solid fa-clipboard-user"></i> Historial Residente</h2>
                <button onclick="document.getElementById('modalGestion').style.display='none'" class="btn-icon"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <p id="lblGestionUser" style="margin-top:-10px; color:#64748b; font-size:13px; border-bottom:1px solid #eee; padding-bottom:10px;">Usuario: ...</p>

            <div id="timelineContainer" class="chat-container">
                </div>

            <div style="background: white; border-top: 1px solid #e2e8f0; padding-top: 10px;">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <select id="bitTipo" class="input-modern" style="width: 140px;">
                        <option value="Nota">Nota</option>
                        <option value="Reclamo">Reclamo</option>
                        <option value="Pago">Pago/Gasto</option>
                        <option value="Correo">Correo</option>
                        <option value="Llamada">Llamada</option>
                    </select>
                    <input type="date" id="bitFecha" class="input-modern">
                </div>
                <textarea id="bitNota" rows="2" class="input-modern" style="height:auto; padding:10px;" placeholder="Detalle de la interacción..."></textarea>
                <div style="text-align: right; margin-top: 10px;">
                    <button class="btn-main" onclick="guardarInteraccion()">Registrar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modalImportar" class="modal">
        <div class="modal-content" style="max-width: 800px">
            <h2 style="margin-top: 0"><i class="fa-solid fa-users" style="color: #10b981"></i> Carga Masiva</h2>
            <p style="color: #64748b; font-size: 13px; margin-bottom: 15px">
                Copia desde Excel y pega abajo. Orden: <b>1. Nombre | 2. Email | 3. N° Unidad</b>
            </p>
            <textarea id="txtPaste" class="paste-area" placeholder="Ej: Juan Pérez  juan@mail.com  101"></textarea>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button type="button" class="btn-sec" onclick="procesarPegado()"><i class="fa-solid fa-eye"></i> Previsualizar</button>
                <span id="importStats" style="font-size: 12px; font-weight: 700"></span>
            </div>
            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 6px; margin-top: 10px;">
                <table class="preview-table">
                    <thead><tr><th>#</th><th>Nombre</th><th>Email</th><th>Unidad Detectada</th></tr></thead>
                    <tbody id="tblPreview"><tr><td colspan="4" style="text-align: center; color: #ccc">Nada para mostrar...</td></tr></tbody>
                </table>
            </div>
            <div style="text-align: right; margin-top: 20px; border-top: 1px solid #f1f5f9; padding-top: 15px;">
                <button type="button" class="btn-sec" onclick="document.getElementById('modalImportar').style.display='none'">Cerrar</button>
                <button type="button" class="btn-green" onclick="enviarCargaMasiva()" id="btnConfirmarCarga" disabled>Confirmar Carga</button>
            </div>
        </div>
    </div>

    <div id="pageSpinner" class="spinner-overlay">
        <div style="text-align: center"><div class="spinner"></div><div id="spinnerText" style="margin-top: 10px; font-weight: 600; color: #1a2b48">Cargando...</div></div>
    </div>

    <div id="footer"></div>

    <script src="assets/js/pages/copropietarios.inline.js"></script>
</body>
</html>