<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Mis Tareas</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/mobile.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a2b48">

    <script src="assets/js/app.js"></script>
    <script>requireAuth();</script>

    <style>
        /* ESTILOS ESPEC√çFICOS PARA TAREAS */
        .filter-scroll {
            display: flex; gap: 10px; overflow-x: auto; padding: 15px 15px 5px;
            background: white; border-bottom: 1px solid #e2e8f0;
            position: sticky; top: 56px; z-index: 90;
        }
        .filter-pill {
            padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600;
            background: #f1f5f9; color: #64748b; white-space: nowrap; border: 1px solid transparent;
            transition: all 0.2s;
        }
        .filter-pill.active {
            background: #1a2b48; color: white; box-shadow: 0 2px 5px rgba(26, 43, 72, 0.3);
        }

        .task-card {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03); border: 1px solid #e2e8f0;
            display: flex; align-items: center; gap: 12px; position: relative;
            transition: transform 0.2s;
        }
        .task-card:active { transform: scale(0.98); }
        
        .prio-line {
            position: absolute; left: 0; top: 12px; bottom: 12px; width: 4px;
            border-radius: 0 4px 4px 0;
        }
        .p-Alta { background-color: #ef4444; }
        .p-Media { background-color: #f59e0b; }
        .p-Baja { background-color: #cbd5e1; }

        .task-info { flex: 1; margin-left: 8px; }
        .task-title { font-weight: 700; font-size: 15px; color: #1e293b; margin-bottom: 4px; }
        .task-desc { font-size: 12px; color: #64748b; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .task-meta { font-size: 11px; color: #94a3b8; margin-top: 6px; display: flex; align-items: center; gap: 10px; }

        .btn-check {
            width: 40px; height: 40px; border-radius: 50%; border: 2px solid #e2e8f0;
            display: flex; align-items: center; justify-content: center;
            color: #cbd5e1; font-size: 18px; cursor: pointer; flex-shrink: 0;
            transition: all 0.2s;
        }
        .btn-check.checked {
            background: #10b981; border-color: #10b981; color: white;
        }

        /* Avatar peque√±o */
        .mini-avatar {
            width: 20px; height: 20px; border-radius: 50%; background: #e2e8f0;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: bold; color: #64748b; overflow: hidden; border: 1px solid white;
        }
        .mini-avatar img { width: 100%; height: 100%; object-fit: cover; }

        /* Modal Sheet */
        .modal-sheet {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: #f8fafc; z-index: 2000;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column;
        }
        .modal-sheet.open { transform: translateY(0); }
        
        .sheet-head {
            padding: 15px 20px; background: white; border-bottom: 1px solid #e2e8f0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .sheet-body { flex: 1; overflow-y: auto; padding: 20px; }
          .m-logo {
        width: 80px;
        margin-bottom: 20px;
        filter: brightness(0) invert(1);
      }
    </style>
</head>
<body>

    <div class="mobile-header"><img
        src="assets/img/logo_santajosefina.png"
        class="m-logo"
        alt="Santa Josefina"
      />
      <div class="header-title">Tareas del Equipo</div>
      <div onclick="window.location.href='mobile_dashboard.html'" style="cursor: pointer; opacity: 0.8">
        <i class="fa-solid fa-home"></i>
      </div>
    </div>

    <div class="filter-scroll">
        <div class="filter-pill active" onclick="filtrar('Pendiente', this)">Pendientes</div>
        <div class="filter-pill" onclick="filtrar('Alta', this)">Urgentes üî•</div>
        <div class="filter-pill" onclick="filtrar('Media', this)">Normales</div>
        <div class="filter-pill" onclick="filtrar('Completada', this)">Historial</div>
    </div>

    <div class="app-container" id="listaTareas" style="padding-top: 10px;">
        <div style="text-align: center; color: #94a3b8; margin-top: 50px;">
            <i class="fa-solid fa-circle-notch fa-spin"></i> Cargando...
        </div>
    </div>

    <div style="height: 60px;"></div>

    <nav class="bottom-nav">
        <a href="mobile_dashboard.html" class="nav-btn">
            <i class="fa-solid fa-house"></i> <span>Inicio</span>
        </a>
        <a href="mobile_prospecto.html" class="nav-btn">
            <i class="fa-solid fa-users"></i> <span>Prospectos</span>
        </a>
        <a href="mobile_propiedades.html" class="nav-btn">
            <i class="fa-solid fa-building"></i> <span>Props</span>
        </a>
        <a href="mobile_tareas.html" class="nav-btn active">
            <i class="fa-solid fa-list-check"></i> <span>Tareas</span>
        </a>
    </nav>

    <button class="fab" onclick="abrirModal()">
        <i class="fa-solid fa-plus"></i>
    </button>

    <div id="modalTarea" class="modal-sheet">
        <div class="sheet-head">
            <h3 style="margin:0; font-size: 18px;" id="modalTitle">Nueva Tarea</h3>
            <button onclick="cerrarModal()" style="border:none; background:none; font-size:16px; color:#64748b;">Cancelar</button>
        </div>
        <div class="sheet-body">
            <form id="formTarea">
                <input type="hidden" id="tID">
                
                <label class="input-label">T√≠tulo</label>
                <input type="text" id="tTitulo" class="input-std" placeholder="Ej: Llamar a cliente..." required 
                       style="width:100%; padding:15px; border:1px solid #cbd5e1; border-radius:12px; margin-bottom:15px; font-size:16px;">

                <label class="input-label">Asignar a Agente</label>
                <select id="tAgente" class="input-std" 
                        style="width:100%; padding:12px; border-radius:12px; border:1px solid #cbd5e1; margin-bottom:15px; background:white;">
                    <option value="">Cargando agentes...</option>
                </select>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label class="input-label">Creaci√≥n</label>
                        <input type="date" id="tCreacion" class="input-std" 
                               style="width:100%; padding:12px; border-radius:12px; border:1px solid #cbd5e1; background:#f1f5f9;">
                    </div>
                    <div>
                        <label class="input-label">Vencimiento</label>
                        <input type="date" id="tFecha" class="input-std" required 
                               style="width:100%; padding:12px; border-radius:12px; border:1px solid #cbd5e1;">
                    </div>
                </div>

                <div style="margin-bottom:15px;">
                    <label class="input-label">Prioridad</label>
                    <select id="tPrioridad" class="input-std" 
                            style="width:100%; padding:12px; border-radius:12px; border:1px solid #cbd5e1;">
                        <option value="Baja">Baja</option>
                        <option value="Media" selected>Media</option>
                        <option value="Alta">Alta üî•</option>
                    </select>
                </div>

                <label class="input-label">Descripci√≥n</label>
                <textarea id="tDesc" rows="4" class="input-std" placeholder="Detalles adicionales..." 
                          style="width:100%; padding:15px; border:1px solid #cbd5e1; border-radius:12px; margin-bottom:20px;"></textarea>

                <button type="submit" class="fab-save" style="position:static; width:100%; box-shadow:none;">
                    Guardar Tarea
                </button>
                
                <button type="button" id="btnEliminar" onclick="eliminarTarea()" style="width:100%; margin-top:15px; padding:15px; background:#fee2e2; color:#b91c1c; border:none; border-radius:12px; font-weight:600; display:none;">
                    Eliminar Tarea
                </button>
            </form>
        </div>
    </div>

    <div id="toast" style="position:fixed; bottom:90px; left:50%; transform:translateX(-50%); background:#333; color:white; padding:10px 20px; border-radius:30px; font-size:13px; opacity:0; transition:opacity 0.3s; pointer-events:none; z-index:3000;">
        Acci√≥n completada
    </div>

    <script>
        let TAREAS = [];
        let AGENTES = []; 
        let FILTRO_ACTUAL = 'Pendiente'; 
        let USUARIO_ACTUAL_ID = ""; 

        document.addEventListener("DOMContentLoaded", async () => {
            try {
                const u = getAuthUser(); 
                USUARIO_ACTUAL_ID = u.Nombre || "";
                await cargarDatos();
            } catch(e) { console.error(e); }
        });

        async function cargarDatos() {
            try {
                const [tareasData, agentesData] = await Promise.all([
                    fetchData("Tareas").catch(()=>[]),
                    fetchData("Agentes").catch(()=>[])
                ]);
                
                TAREAS = tareasData || [];
                AGENTES = agentesData || [];

                llenarSelectAgentes();
                aplicarFiltro(FILTRO_ACTUAL);
            } catch(e) {
                console.error(e);
                document.getElementById("listaTareas").innerHTML = "<div style='text-align:center; padding:30px;'>Error de conexi√≥n</div>";
            }
        }

        function llenarSelectAgentes() {
            const sel = document.getElementById("tAgente");
            const activos = AGENTES.filter(a => String(a.Activo).toLowerCase() === "true" || a.Activo === true);
            const listaAMostrar = activos.length > 0 ? activos : AGENTES;

            sel.innerHTML = '<option value="">-- Sin Asignar --</option>' + 
                listaAMostrar.map(a => `<option value="${a.ID}">${a.Nombre}</option>`).join("");
        }

        function filtrar(tipo, btn) {
            FILTRO_ACTUAL = tipo;
            document.querySelectorAll('.filter-pill').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            aplicarFiltro(tipo);
        }

        function aplicarFiltro(tipo) {
            let lista = [];
            if(tipo === 'Pendiente') {
                lista = TAREAS.filter(t => t.Estado !== 'Completada');
                lista.sort((a,b) => new Date(a.FechaLimite) - new Date(b.FechaLimite));
            } else if (tipo === 'Completada') {
                lista = TAREAS.filter(t => t.Estado === 'Completada');
                lista.sort((a,b) => new Date(b.FechaLimite) - new Date(a.FechaLimite));
            } else {
                lista = TAREAS.filter(t => t.Prioridad === tipo && t.Estado !== 'Completada');
            }
            renderLista(lista);
        }

        function renderLista(lista) {
            const container = document.getElementById("listaTareas");
            
            if(lista.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding:50px 20px; color:#94a3b8;">
                        <i class="fa-solid fa-clipboard-check" style="font-size:40px; margin-bottom:10px; opacity:0.3;"></i>
                        <p>No hay tareas aqu√≠.</p>
                    </div>`;
                return;
            }

            container.innerHTML = lista.map(t => {
                const isDone = t.Estado === 'Completada';
                // Formateo estricto a dd/mm/yyyy
                const fechaFmt = formatearFecha(t.FechaLimite);
                
                const agente = AGENTES.find(a => String(a.ID) === String(t.AgenteID));
                let avatarHTML = '';
                
                if(agente) {
                    if(agente.Avatar && agente.Avatar.startsWith("http")) {
                        avatarHTML = `<div class="mini-avatar"><img src="${agente.Avatar}"></div>`;
                    } else {
                        avatarHTML = `<div class="mini-avatar" style="background:#e2e8f0; color:#64748b;">${agente.Nombre.charAt(0)}</div>`;
                    }
                } else {
                    avatarHTML = `<div class="mini-avatar" title="Sin asignar"><i class="fa-solid fa-user-plus" style="font-size:10px;"></i></div>`;
                }

                return `
                <div class="task-card" onclick="editar('${t.ID}')">
                    <div class="prio-line p-${t.Prioridad}"></div>
                    
                    <div class="btn-check ${isDone ? 'checked' : ''}" onclick="toggleCheck('${t.ID}', event)">
                        <i class="fa-solid fa-check"></i>
                    </div>

                    <div class="task-info">
                        <div class="task-title" style="${isDone ? 'text-decoration:line-through; opacity:0.6;' : ''}">
                            ${t["T√≠tulo"] || "Sin t√≠tulo"}
                        </div>
                        <div class="task-desc">${t["Descripci√≥n"] || ""}</div>
                        <div class="task-meta">
                            <i class="fa-regular fa-calendar"></i> ${fechaFmt} 
                            <span style="border-left:1px solid #e2e8f0; padding-left:10px; display:flex; align-items:center; gap:5px;">
                                ${avatarHTML} <span style="font-size:10px;">${agente ? agente.Nombre.split(" ")[0] : "Asignar"}</span>
                            </span>
                        </div>
                    </div>
                </div>`;
            }).join("");
        }

        async function toggleCheck(id, event) {
            event.stopPropagation();
            const task = TAREAS.find(t => t.ID === id);
            if(!task) return;

            const nuevoEstado = task.Estado === 'Completada' ? 'Pendiente' : 'Completada';
            
            task.Estado = nuevoEstado;
            aplicarFiltro(FILTRO_ACTUAL);
            mostrarToast(nuevoEstado === 'Completada' ? "Tarea completada ‚úÖ" : "Tarea reactivada üîÑ");

            try {
                await appSheetCRUD("Tareas", "Edit", [{ "ID": id, "Estado": nuevoEstado }]);
            } catch(e) {
                alert("Error al guardar en la nube");
            }
        }

        function abrirModal() {
            document.getElementById("formTarea").reset();
            document.getElementById("tID").value = "";
            document.getElementById("modalTitle").innerText = "Nueva Tarea";
            
            const hoy = new Date().toISOString().split("T")[0];
            document.getElementById("tFecha").value = hoy;
            document.getElementById("tCreacion").value = hoy;

            document.getElementById("btnEliminar").style.display = "none";
            
            const miAgente = AGENTES.find(a => a.Nombre === USUARIO_ACTUAL_ID);
            if(miAgente) document.getElementById("tAgente").value = miAgente.ID;

            document.getElementById("modalTarea").classList.add("open");
        }

        function editar(id) {
            const t = TAREAS.find(x => x.ID === id);
            if(!t) return;

            document.getElementById("tID").value = t.ID;
            document.getElementById("tTitulo").value = t["T√≠tulo"] || "";
            document.getElementById("tFecha").value = t.FechaLimite || "";
            document.getElementById("tCreacion").value = t["FechaCreaci√≥n"] || new Date().toISOString().split("T")[0];
            document.getElementById("tDesc").value = t["Descripci√≥n"] || "";
            document.getElementById("tPrioridad").value = t.Prioridad || "Media";
            document.getElementById("tAgente").value = t.AgenteID || ""; 
            
            document.getElementById("modalTitle").innerText = "Editar Tarea";
            document.getElementById("btnEliminar").style.display = "block";
            
            document.getElementById("modalTarea").classList.add("open");
        }

        function cerrarModal() {
            document.getElementById("modalTarea").classList.remove("open");
        }

        document.getElementById("formTarea").onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById("tID").value;
            const isNew = !id;
            const finalID = id || "TSK_" + Date.now();
            
            const payload = {
                "ID": finalID,
                "T√≠tulo": document.getElementById("tTitulo").value,
                "Descripci√≥n": document.getElementById("tDesc").value,
                "Prioridad": document.getElementById("tPrioridad").value,
                "FechaLimite": document.getElementById("tFecha").value,
                "FechaCreaci√≥n": document.getElementById("tCreacion").value, 
                "AgenteID": document.getElementById("tAgente").value, 
                "Estado": isNew ? "Pendiente" : (TAREAS.find(t=>t.ID===id)?.Estado || "Pendiente")
            };

            cerrarModal();
            mostrarToast("Guardando...");

            try {
                const action = isNew ? "Add" : "Edit";
                await appSheetCRUD("Tareas", action, [payload]);
                await cargarDatos();
                mostrarToast("Guardado exitoso");
            } catch(e) {
                alert("Error: " + e.message);
            }
        };

        async function eliminarTarea() {
            const id = document.getElementById("tID").value;
            if(!confirm("¬øEliminar esta tarea definitivamente?")) return;

            cerrarModal();
            mostrarToast("Eliminando...");

            try {
                await appSheetCRUD("Tareas", "Delete", [{ "ID": id }]);
                TAREAS = TAREAS.filter(t => t.ID !== id);
                aplicarFiltro(FILTRO_ACTUAL);
                mostrarToast("Tarea eliminada üóëÔ∏è");
            } catch(e) { alert("Error: " + e.message); }
        }

        function mostrarToast(msg) {
            const t = document.getElementById("toast");
            t.innerText = msg;
            t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 3000);
        }

        /* FUNCI√ìN FORMATO DD/MM/YYYY */
        function formatearFecha(iso) {
            if(!iso) return "S/F";
            
            // Intenta convertir YYYY-MM-DD a DD/MM/YYYY
            if(iso.indexOf('-') > -1) {
                const [y, m, d] = iso.split('-');
                if(d && m && y) return `${d}/${m}/${y}`;
            }
            
            // Si ya viene como MM/DD/YYYY (formato gringo), intenta invertirlo
            // O usa Date para normalizar
            const d = new Date(iso);
            if(!isNaN(d.getTime())) {
                 const dia = String(d.getDate()).padStart(2, '0');
                 const mes = String(d.getMonth() + 1).padStart(2, '0');
                 const anio = d.getFullYear();
                 return `${dia}/${mes}/${anio}`;
            }

            return iso;
        }
    </script>
</body>
</html>