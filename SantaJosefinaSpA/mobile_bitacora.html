<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <title>Bit谩cora M贸vil</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/css/mobile.css" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#1a2b48" />

    <script src="assets/js/app.js"></script>
    <script>
      requireAuth();
    </script>

    <style>
      /* ESTILOS MOBILE ESPECIFICOS */
      .input-group {
        background: white;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid #e2e8f0;
      }
      .input-label {
        display: block;
        font-size: 11px;
        font-weight: 700;
        color: #64748b;
        text-transform: uppercase;
        margin-bottom: 8px;
      }
      input,
      select,
      textarea {
        width: 100%;
        border: 1px solid #cbd5e1;
        background: #fff;
        padding: 12px;
        font-size: 16px;
        border-radius: 8px;
        box-sizing: border-box;
      }

      /* Timeline */
      .timeline {
        position: relative;
        border-left: 2px solid #e2e8f0;
        margin-left: 10px;
        padding-left: 20px;
        margin-top: 15px;
      }
      .timeline-item {
        margin-bottom: 20px;
        position: relative;
      }
      .timeline-dot {
        width: 12px;
        height: 12px;
        background: #fff;
        border: 2px solid #3b82f6;
        border-radius: 50%;
        position: absolute;
        left: -27px;
        top: 5px;
      }
      .timeline-dot.Llamada {
        border-color: #3b82f6;
      }
      .timeline-dot.Correo {
        border-color: #f59e0b;
      }
      .timeline-dot.Reunion {
        border-color: #10b981;
      }
      .timeline-content {
        background: #f8fafc;
        padding: 12px;
        border-radius: 8px;
        font-size: 13px;
        color: #334155;
        border: 1px solid #e2e8f0;
      }
      .timeline-date {
        font-size: 11px;
        color: #94a3b8;
        margin-bottom: 4px;
        font-weight: 600;
        display: block;
      }

      /* Spinner & Toast */
      .spinner-overlay {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 3000;
        flex-direction: column;
      }
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #e2e8f0;
        border-top-color: #1a2b48;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .success-toast {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #10b981;
        color: white;
        padding: 10px 20px;
        border-radius: 20px;
        font-size: 13px;
        display: none;
        z-index: 3001;
        font-weight: 600;
      }
         .m-logo {
        width: 80px;
        margin-bottom: 20px;
        filter: brightness(0) invert(1);
      }
    </style>
  </head>
  <body>
    <div class="mobile-header"><img
        src="assets/img/logo_santajosefina.png"
        class="m-logo"
        alt="Santa Josefina"
      />
      <div class="header-title">Propiedades</div>
      <div onclick="window.location.href='mobile_dashboard.html'" style="cursor: pointer; opacity: 0.8">
        <i class="fa-solid fa-house"></i>
      </div>
    </div>

    <div class="app-container" style="padding-top: 20px">
      <div class="input-group">
        <label class="input-label">Buscar Cliente / Prospecto</label>
        <input
          list="dlProspectos"
          id="inpBuscar"
          placeholder="Escribe para buscar..."
          oninput="verificarSeleccion()"
          autocomplete="off"
        />
        <datalist id="dlProspectos"></datalist>

        <input type="hidden" id="prospectoID" />
        <div
          id="infoSeleccion"
          style="
            font-size: 12px;
            color: #166534;
            margin-top: 8px;
            font-weight: 600;
            display: none;
          "
        >
          <i class="fa-solid fa-check-circle"></i> Cliente seleccionado
        </div>
      </div>

      <div id="formBitacora" style="display: none">
        <div class="input-group">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px">
            <div>
              <label class="input-label">Acci贸n</label>
              <select id="bitTipo">
                <option value="Nota">Nota </option>
                <option value="Llamada">Llamada </option>
                <option value="Correo">Correo </option>
                <option value="Reunion">Reuni贸n </option>
              </select>
            </div>
            <div>
              <label class="input-label">Fecha</label>
              <input type="date" id="bitFecha" />
            </div>
          </div>
          <div style="margin-top: 15px">
            <label class="input-label">Detalle</label>
            <textarea
              id="bitNota"
              rows="3"
              placeholder="Escribe los detalles aqu铆..."
            ></textarea>
          </div>
        </div>

        <button
          onclick="guardarLog()"
          class="fab"
          style="
            position: relative;
            bottom: auto;
            right: auto;
            width: 100%;
            border-radius: 10px;
            margin-bottom: 20px;
          "
        >
          <i class="fa-solid fa-paper-plane"></i> Guardar en Bit谩cora
        </button>

        <h4
          style="
            margin: 10px 0 15px 0;
            color: #1a2b48;
            font-size: 14px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 5px;
          "
        >
          Historial Reciente
        </h4>
        <div id="timelineContainer"></div>
      </div>

      <div
        id="msgInicial"
        style="text-align: center; color: #94a3b8; margin-top: 60px"
      >
        <i
          class="fa-solid fa-magnifying-glass"
          style="font-size: 40px; margin-bottom: 15px; opacity: 0.3"
        ></i>
        <p style="font-size: 14px">
          Busca un prospecto arriba<br />para ver su historial.
        </p>
      </div>
    </div>

    <div id="loader" class="spinner-overlay">
      <div class="spinner"></div>
      <div style="margin-top: 15px; font-weight: 600; color: #1a2b48">
        Cargando...
      </div>
    </div>

    <div id="toastSuccess" class="success-toast">
      <i class="fa-solid fa-check"></i> Guardado correctamente
    </div>

    <nav class="bottom-nav">
      <a href="mobile_dashboard.html" class="nav-btn">
        <i class="fa-solid fa-house"></i> <span>Inicio</span>
      </a>
      <a href="mobile_prospecto.html" class="nav-btn">
        <i class="fa-solid fa-users"></i> <span>Prospectos</span>
      </a>
      <a href="mobile_propiedades.html" class="nav-btn">
        <i class="fa-solid fa-building"></i> <span>Props</span>
      </a>
      <a href="mobile_tareas.html" class="nav-btn">
        <i class="fa-solid fa-list-check"></i> <span>Tareas</span>
      </a>
    </nav>

    <script>
      let TODOS_PROSPECTOS = [];
      let BITACORA_CACHE = [];

      document.addEventListener("DOMContentLoaded", async () => {
        // Fecha hoy por defecto
        document.getElementById("bitFecha").valueAsDate = new Date();

        // Si viene ID en la URL (redirecci贸n desde otro lado)
        const params = new URLSearchParams(window.location.search);
        const preID = params.get("id");
        const preNombre = params.get("nombre");

        await cargarDatosIniciales();

        if (preID && preNombre) {
          document.getElementById("inpBuscar").value = preNombre;
          seleccionarProspectoPorID(preID);
        }
      });

      async function cargarDatosIniciales() {
        mostrarLoader(true);
        try {
          // Carga paralela de tablas necesarias
          const [admin, corretaje, bitacora] = await Promise.all([
            fetchData("ProspectosCopro").catch(() => []),
            fetchData("ProspectosCorretaje").catch(() => []),
            fetchData("Bitacora").catch(() => []),
          ]);

          BITACORA_CACHE = bitacora || [];

          // Unificar prospectos en una sola lista para el buscador
          const listaA = admin.map((p) => ({
            ID: p.ID,
            Nombre: p.Nombre,
            Tipo: "Admin",
          }));
          const listaB = corretaje.map((p) => ({
            ID: p.ID,
            Nombre: p.Nombre,
            Tipo: "Corretaje",
          }));

          TODOS_PROSPECTOS = [...listaA, ...listaB];

          // Llenar Datalist
          const dl = document.getElementById("dlProspectos");
          dl.innerHTML = TODOS_PROSPECTOS.map(
            (p) => `<option value="${p.Nombre}"></option>`
          ).join("");
        } catch (e) {
          console.error(e);
          alert("Error de conexi贸n al cargar datos.");
        } finally {
          mostrarLoader(false);
        }
      }

      /* --- LGICA DE BSQUEDA --- */
      function verificarSeleccion() {
        const val = document.getElementById("inpBuscar").value;
        if (!val) {
          resetView();
          return;
        }

        // Buscar coincidencia exacta en el nombre
        const encontrado = TODOS_PROSPECTOS.find(
          (p) => p.Nombre.toLowerCase() === val.toLowerCase()
        );

        if (encontrado) {
          seleccionarProspectoPorID(encontrado.ID);
        }
      }

      function seleccionarProspectoPorID(id) {
        const p = TODOS_PROSPECTOS.find((x) => String(x.ID) === String(id));
        if (!p) return;

        // UI Feedback
        document.getElementById("prospectoID").value = p.ID;
        document.getElementById("infoSeleccion").style.display = "block";
        document.getElementById(
          "infoSeleccion"
        ).innerHTML = `<i class="fa-solid fa-user-check"></i> ${p.Nombre} <small style="color:#64748b">(${p.Tipo})</small>`;

        // Mostrar Formulario
        document.getElementById("formBitacora").style.display = "block";
        document.getElementById("msgInicial").style.display = "none";

        renderTimeline(p.ID);
      }

      function resetView() {
        document.getElementById("formBitacora").style.display = "none";
        document.getElementById("msgInicial").style.display = "block";
        document.getElementById("infoSeleccion").style.display = "none";
        document.getElementById("prospectoID").value = "";
      }

      /* --- HISTORIAL --- */
      function renderTimeline(id) {
        const container = document.getElementById("timelineContainer");

        // Filtrar bit谩cora por ID de prospecto
        const historia = BITACORA_CACHE.filter(
          (b) => String(b.ProspectoID) === String(id)
        );

        // Ordenar: M谩s reciente primero
        historia.sort((a, b) => new Date(b.Fecha) - new Date(a.Fecha));

        if (historia.length === 0) {
          container.innerHTML =
            '<div style="text-align:center; padding:20px; color:#cbd5e1; font-size:13px;">No hay registros previos.</div>';
          return;
        }

        container.innerHTML =
          `<div class="timeline">` +
          historia
            .map(
              (h) => `
                <div class="timeline-item">
                    <div class="timeline-dot ${h.Tipo}"></div>
                    <span class="timeline-date">${formatearFecha(
                      h.Fecha
                    )}</span>
                    <div class="timeline-content">
                        <strong style="display:block; margin-bottom:4px; font-size:12px;">${
                          h.Tipo
                        }</strong>
                        ${h.Nota}
                        <div style="text-align:right; font-size:10px; color:#94a3b8; margin-top:5px;">Por: ${
                          h.Usuario || "Agente"
                        }</div>
                    </div>
                </div>
            `
            )
            .join("") +
          `</div>`;
      }

      /* --- GUARDAR --- */
      async function guardarLog() {
        const id = document.getElementById("prospectoID").value;
        const nota = document.getElementById("bitNota").value;

        if (!id) return alert("Debes buscar y seleccionar un cliente primero.");
        if (!nota.trim()) return alert("La nota no puede estar vac铆a.");

        mostrarLoader(true);

        // Obtener usuario actual
        let usuario = "M贸vil";
        try {
          const u = getAuthUser();
          if (u && u.Nombre) usuario = u.Nombre.split(" ")[0];
        } catch (e) {}

        const payload = {
          ID: "BIT_" + Date.now(),
          ProspectoID: id,
          Fecha: document.getElementById("bitFecha").value,
          Tipo: document.getElementById("bitTipo").value,
          Nota: nota,
          Usuario: usuario,
        };

        try {
          await appSheetCRUD("Bitacora", "Add", [payload]);

          // Actualizar Cache Local y UI
          BITACORA_CACHE.push(payload);
          renderTimeline(id);

          // Limpiar
          document.getElementById("bitNota").value = "";

          const t = document.getElementById("toastSuccess");
          t.style.display = "block";
          setTimeout(() => (t.style.display = "none"), 2500);
        } catch (e) {
          alert("Error al guardar: " + e.message);
        } finally {
          mostrarLoader(false);
        }
      }

      /* UTILS */
      function mostrarLoader(show) {
        document.getElementById("loader").style.display = show
          ? "flex"
          : "none";
      }

      function formatearFecha(iso) {
        if (!iso) return "";
        const partes = iso.split("-");
        if (partes.length === 3)
          return `${partes[2]}/${partes[1]}/${partes[0]}`;
        return iso;
      }
    </script>
  </body>
</html>
