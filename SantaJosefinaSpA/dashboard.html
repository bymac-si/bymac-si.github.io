<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>CRM Inmobiliario - Dashboard - Corretaje</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/css/styles.css" />

    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#1a2b48" />
    <link rel="apple-touch-icon" href="assets/img/icon-192.png" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-doughnutlabel-rebourne"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-funnel"></script>
    <script src="assets/js/app.js"></script>

    <script>
      requireAuth();
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          document.getElementById("header").innerHTML = await (
            await fetch("header.html")
          ).text();
          if (typeof initHeader === "function") initHeader();
        } catch (e) {
          console.error("Error header:", e);
        }

        try {
          document.getElementById("footer").innerHTML = await (
            await fetch("footer.html")
          ).text();
        } catch (e) {
          console.error("Error footer:", e);
        }

        if (typeof bindUI === "function") bindUI();
        if (typeof cargarDashboard === "function") await cargarDashboard();
      });

      function bindUI() {
        document
          .getElementById("btnReload")
          .addEventListener("click", cargarDashboard);
      }
    </script>

    <style>
      /* Estilos Base Unificados */
      body {
        max-width: 1300px;
        margin: 0 auto;
        color: #1a2b48;
        background-color: #f8f9fa;
      }
      main {
        padding: 40px;
      }

      /* Header */
      .dashboard-header {
        background-color: #fff;
        padding: 20px 25px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        margin-bottom: 30px;
        border: 1px solid #f0f0f0;
      }
      .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
      }
      .page-title {
        font-size: 28px;
        font-weight: 700;
        margin: 0;
        color: #1a2b48;
      }
      .header-actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      /* Botones */
      .btn-head {
        height: 44px;
        padding: 0 20px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.2s;
        text-decoration: none;
      }
      .btn-head:hover {
        transform: translateY(-2px);
      }
      .btn-secundario {
        background-color: #fff;
        color: #475569;
        border: 1px solid #cbd5e1;
      }
      .btn-secundario:hover {
        background-color: #f8fafc;
        border-color: #94a3b8;
      }
      .btn-nuevo {
        background-color: #0f172a;
        color: white;
      }

      /* KPIs */
      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 24px;
        margin-bottom: 30px;
      }
      .kpi-card {
        background: #ffffff;
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border-left: 5px solid #ccc;
        display: flex;
        flex-direction: column;
        justify-content: center;
        transition: transform 0.2s;
        height: 100%;
        border: 1px solid #f0f0f0;
        border-left-width: 5px;
      }
      .kpi-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      }
      .kpi-title {
        font-size: 0.8rem;
        color: #6c757d;
        font-weight: 700;
        text-transform: uppercase;
        margin-bottom: 8px;
      }
      .kpi-value {
        font-size: 2.2rem;
        font-weight: 700;
        color: #212529;
        line-height: 1.1;
      }
      .kpi-sub {
        font-size: 0.85rem;
        color: #adb5bd;
        margin-top: 5px;
      }

      /* Cards & Charts */
      .card {
        border: 1px solid #f0f0f0;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        background-color: #fff;
      }
      .card h2 {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 15px;
        color: #1a2b48;
        padding-bottom: 10px;
        border-bottom: 1px solid #f1f5f9;
      }

      /* Tabla */
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th {
        font-weight: 600;
        color: #4b5563;
        background-color: #f8fafc;
        border-bottom: 2px solid #e2e8f0;
        font-size: 0.9rem;
      }
      td {
        border-bottom: 1px solid #f1f5f9;
        font-size: 0.9rem;
        color: #334155;
      }

      /* Gauges */
      .gauge-container {
        display: inline-block;
        width: 250px;
        height: 250px;
        margin: 20px;
        text-align: center;
      }
      .gauge-detail {
        font-size: 14px;
        color: #555;
        margin-top: 4px;
      }
      .badge-agent {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        color: #fff;
        font-size: 12px;
        font-weight: 600;
      }

      /* Spinner */
      .spinner-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      .spinner-card {
        background: #fff;
        padding: 18px 22px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
        text-align: center;
      }
      .spinner {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 3px solid #eee;
        border-top-color: #b46a55;
        margin: 0 auto 10px;
        animation: spin 0.9s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div id="header"></div>

    <main>
      <div class="dashboard-header no-print">
        <div class="header-top">
          <h1 class="page-title">Panel de Control Corretaje</h1>
          <div class="header-actions">
            <button
              class="btn-head btn-secundario"
              id="btnReload"
              title="Recargar"
            >
              <i class="fa-solid fa-rotate-right"></i>
              <span class="btn-text">Recargar</span>
            </button>
            <button
              class="btn-head btn-secundario"
              onclick="window.print()"
              title="Imprimir"
            >
              <i class="fa-solid fa-print"></i>
              <span class="btn-text">Imprimir</span>
            </button>
          </div>
        </div>
      </div>

      <div class="kpi-grid">
        <div class="kpi-card" style="border-left-color: #ffc107">
          <span class="kpi-title">Total Clientes</span>
          <span class="kpi-value" id="kpiClientes">0</span>
          <span class="kpi-sub">Activos en cartera</span>
        </div>
        <div class="kpi-card" style="border-left-color: #fd7e14">
          <span class="kpi-title">Propiedades Disp.</span>
          <span class="kpi-value" id="kpiPropiedades">0</span>
          <span class="kpi-sub">En venta/arriendo</span>
        </div>
        <div class="kpi-card" style="border-left-color: #198754">
          <span class="kpi-title">Visitas Agendadas</span>
          <span class="kpi-value" id="kpiVisitas">0</span>
          <span class="kpi-sub">Próximas fechas</span>
        </div>
        <div class="kpi-card" style="border-left-color: #0dcaf0">
          <span class="kpi-title">Tareas Pendientes</span>
          <span class="kpi-value" id="kpiTareasPendientes">0</span>
          <span class="kpi-sub">Acciones requeridas</span>
        </div>
      </div>

      <div class="row g-4 mb-4">
        <div class="col-12 col-lg-6">
          <div class="card p-4 h-100">
            <h2>Cartera de Clientes por Estado</h2>
            <div
              style="max-height: 300px; display: flex; justify-content: center"
            >
              <canvas id="graficoClientesEstado"></canvas>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-6">
          <div class="card p-4 h-100">
            <h2>Embudo de Ventas (Propiedades)</h2>
            <canvas id="graficoEmbudo"></canvas>
          </div>
        </div>
      </div>

      <div class="row g-4 mb-4">
        <div class="col-12 col-lg-6">
          <div class="card p-4 h-100">
            <h2>Conversión: Leads vs Clientes</h2>
            <p
              style="
                font-size: 12px;
                color: #666;
                margin-top: -10px;
                margin-bottom: 15px;
              "
            >
              Comparativa de captación por campaña
            </p>
            <canvas id="graficoMarketing"></canvas>
          </div>
        </div>

        <div class="col-12 col-lg-6">
          <div class="card p-4 h-100">
            <h2>Alcance de Campañas (Clicks)</h2>
            <p
              style="
                font-size: 12px;
                color: #666;
                margin-top: -10px;
                margin-bottom: 15px;
              "
            >
              Tráfico generado por fuente
            </p>
            <canvas id="graficoAlcance"></canvas>
          </div>
        </div>
      </div>

      <div class="row g-4 mb-4">
        <div class="col-12 col-lg-6">
          <div class="card p-4 h-100">
            <h2>Próximas Visitas</h2>
            <div style="overflow-y: auto; max-height: 300px">
              <table style="width: 100%; margin-top: 10px">
                <thead>
                  <tr>
                    <th style="padding: 10px">Cliente</th>
                    <th style="padding: 10px">Propiedad</th>
                    <th style="padding: 10px">Fecha</th>
                  </tr>
                </thead>
                <tbody id="tablaVisitasFuturas"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-6">
          <div class="card p-4 h-100">
            <h2>Tareas por Estado</h2>
            <div
              style="max-height: 300px; display: flex; justify-content: center"
            >
              <canvas id="graficoTareasEstado"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-4 mb-4">
        <div class="col-12 col-lg-6">
          <div class="card p-4 h-100">
            <h2>Pendientes por Agente</h2>
            <div
              style="max-height: 300px; display: flex; justify-content: center"
            >
              <canvas id="graficoTareasAgente"></canvas>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="card p-4 h-100">
            <h2>Detalle Tareas Pendientes</h2>
            <div style="overflow-x: auto; max-height: 300px">
              <table style="width: 100%; margin-top: 12px">
                <thead>
                  <tr>
                    <th style="text-align: left; padding: 12px">Título</th>
                    <th style="text-align: left; padding: 12px">Agente</th>
                    <th style="text-align: left; padding: 12px">Límite</th>
                  </tr>
                </thead>
                <tbody id="tablaTareasPendientes"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-12">
        <div class="card p-4">
          <h2>Cumplimiento Global vs Agentes</h2>
          <div style="text-align: center; margin-bottom: 30px">
            <div class="gauge-container">
              <canvas id="gaugeGlobal"></canvas>
              <p><b>Global Empresa</b></p>
              <p id="detalleGlobal" class="gauge-detail"></p>
            </div>
          </div>
          <div
            id="gaugesUsuarios"
            style="
              display: flex;
              flex-wrap: wrap;
              justify-content: center;
              gap: 20px;
              padding-bottom: 20px;
            "
          ></div>
        </div>
      </div>
    </main>

    <div id="pageSpinner" class="spinner-backdrop hidden" aria-hidden="true">
      <div class="spinner-card">
        <div class="spinner"></div>
        <div id="spinnerText">Cargando Dashboard...</div>
      </div>
    </div>

    <div id="footer"></div>

    <script>
      /* --- FUNCIONES AUXILIARES --- */
      function normalizarEstado(e) {
        if (!e) return "";
        return e
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .trim();
      }
      function formatearFechaCL(fechaISO) {
        if (!fechaISO) return "";
        const d = new Date(fechaISO);
        return d.toLocaleDateString("es-CL", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
        });
      }
      function getGaugeColor(pct) {
        if (pct >= 70) return "#66cc66";
        if (pct >= 40) return "#ffcc00";
        return "#ff6666";
      }
      function showSpinner(msg) {
        const sp = document.getElementById("pageSpinner");
        if (msg) document.getElementById("spinnerText").textContent = msg;
        sp.classList.remove("hidden");
      }
      function hideSpinner() {
        document.getElementById("pageSpinner").classList.add("hidden");
      }

      /* --- LÓGICA PRINCIPAL --- */
      async function cargarDashboard() {
        try {
          showSpinner("Procesando datos...");
          const [clientes, propiedades, visitas, tareas, marketing, agentes] =
            await Promise.all([
              fetchData("Clientes").catch(() => []),
              fetchData("Propiedades").catch(() => []),
              fetchData("Visitas").catch(() => []),
              fetchData("Tareas").catch(() => []),
              fetchData("Marketing").catch(() => []),
              fetchData("Agentes").catch(() => []),
            ]);

          const clienteMap = {};
          clientes.forEach((c) => (clienteMap[c.ID] = c.Nombre));
          const propMap = {};
          propiedades.forEach((p) => (propMap[p.ID] = p.Direccion));
          const agenteMap = {};
          agentes.forEach((a) => (agenteMap[a.ID] = a.Nombre));

          const baseColors = [
            "#ffcc00",
            "#ff9933",
            "#66cc66",
            "#66ccff",
            "#B46A55",
            "#9333ea",
          ];
          const colorAgente = {};
          agentes.forEach((a, i) => {
            colorAgente[a.ID] = baseColors[i % baseColors.length];
          });

          // === KPIs ===
          kpiClientes.textContent = clientes.length;
          kpiPropiedades.textContent = propiedades.filter(
            (p) => normalizarEstado(p.Estado) === "disponible"
          ).length;

          const hoy = new Date();
          hoy.setHours(0, 0, 0, 0);
          const visitasFuturas = visitas
            .filter((v) => {
              const f = new Date(v.Fecha || v["Fecha Visita"]);
              return !isNaN(f) && f >= hoy;
            })
            .sort((a, b) => new Date(a.Fecha) - new Date(b.Fecha));
          kpiVisitas.textContent = visitasFuturas.length;

          kpiTareasPendientes.textContent = tareas.filter(
            (t) => normalizarEstado(t["Estado"]) !== "completada"
          ).length;

          // === 1. GRÁFICO: ESTATUS CLIENTES ===
          const estadosClientes = {};
          clientes.forEach((c) => {
            const est = c.Estado || "Sin Estado";
            estadosClientes[est] = (estadosClientes[est] || 0) + 1;
          });
          new Chart(document.getElementById("graficoClientesEstado"), {
            type: "doughnut",
            data: {
              labels: Object.keys(estadosClientes),
              datasets: [
                {
                  data: Object.values(estadosClientes),
                  backgroundColor: [
                    "#166534",
                    "#dc2626",
                    "#eab308",
                    "#2563eb",
                    "#9333ea",
                  ],
                },
              ],
            },
            options: {
              responsive: true,
              plugins: { legend: { position: "right" } },
            },
          });

          // === 2. EMBUDO VENTAS ===
          const etapas = [
            "Prospecto",
            "En Negociación",
            "Reservado",
            "Cerrado",
          ];
          const conteoEmbudo = [
            clientes.filter((c) => normalizarEstado(c["Estado"]) === "activo")
              .length,
            clientes.filter(
              (c) => normalizarEstado(c["Estado"]) === "en negociacion"
            ).length,
            propiedades.filter(
              (p) => normalizarEstado(p["Estado"]) === "reservado"
            ).length,
            propiedades.filter((p) =>
              ["vendido", "arrendado"].includes(normalizarEstado(p["Estado"]))
            ).length,
          ];

          new Chart(document.getElementById("graficoEmbudo"), {
            type: "funnel",
            data: {
              labels: etapas,
              datasets: [
                { data: conteoEmbudo, backgroundColor: baseColors.slice(0, 4) },
              ],
            },
            options: { indexAxis: "y" },
          });

          // === 3. MARKETING (ACTUALIZADO: LEADS VS CLIENTES) ===
          const labelsMkt = marketing.map((m) => `${m["Campaña"]}`);

          // Datos Leads (Potenciales)
          const dataLeads = marketing.map(
            (m) => m["Leads"] || m["Clientes Captados"] || 0
          );

          // Datos Clientes (Cerrados/Reales) - Asegúrate de tener esta columna en tu tabla Marketing o usa lógica
          const dataClientes = marketing.map(
            (m) => m["Clientes"] || m["Cierres"] || 0
          );

          new Chart(document.getElementById("graficoMarketing"), {
            type: "bar",
            data: {
              labels: labelsMkt,
              datasets: [
                {
                  label: "Leads (Potenciales)",
                  data: dataLeads,
                  backgroundColor: "#3b82f6", // Azul
                },
                {
                  label: "Clientes Captados",
                  data: dataClientes,
                  backgroundColor: "#10b981", // Verde
                },
              ],
            },
            options: {
              responsive: true,
              interaction: {
                mode: "index",
                intersect: false,
              },
            },
          });

          // === 3.1 NUEVO GRÁFICO ALCANCE (CLICKS) ===
          // Asumimos columna "Clicks" o "Alcance" en tabla Marketing
          const dataClicks = marketing.map(
            (m) => m["Clics"] || m["Alcance"] || 0
          );

          new Chart(document.getElementById("graficoAlcance"), {
            type: "bar",
            data: {
              labels: labelsMkt,
              datasets: [
                {
                  label: "Clicks / Alcance",
                  data: dataClicks,
                  backgroundColor: "#8b5cf6", // Violeta
                  borderRadius: 4,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: { legend: { display: false } }, // Ocultar leyenda si es solo 1 serie
              scales: {
                y: { beginAtZero: true },
              },
            },
          });

          // === 4. VISITAS TABLA ===
          const tbodyVis = document.getElementById("tablaVisitasFuturas");
          tbodyVis.innerHTML =
            visitasFuturas
              .slice(0, 5)
              .map(
                (v) => `
            <tr>
                <td style="padding:10px;">${
                  clienteMap[v.Cliente] || "Anon"
                }</td>
                <td style="padding:10px;">${propMap[v.Propiedad] || "-"}</td>
                <td style="padding:10px;">${formatearFechaCL(v.Fecha)}</td>
            </tr>
          `
              )
              .join("") ||
            "<tr><td colspan='3' style='text-align:center; color:#999;'>Sin visitas próximas</td></tr>";

          // === 5. TAREAS DONAS ===
          const estadosTar = ["pendiente", "en progreso", "completada"];
          const dataEstadosTar = estadosTar.map(
            (e) => tareas.filter((t) => normalizarEstado(t.Estado) === e).length
          );
          new Chart(document.getElementById("graficoTareasEstado"), {
            type: "doughnut",
            data: {
              labels: ["Pendiente", "En Progreso", "Listo"],
              datasets: [
                {
                  data: dataEstadosTar,
                  backgroundColor: ["#f59e0b", "#3b82f6", "#10b981"],
                },
              ],
            },
          });

          const agentesTar = [
            ...new Set(
              tareas
                .filter((t) => normalizarEstado(t.Estado) !== "completada")
                .map((t) => t.AgenteID)
            ),
          ];
          const dataAgentesTar = agentesTar.map(
            (id) =>
              tareas.filter(
                (t) =>
                  t.AgenteID === id &&
                  normalizarEstado(t.Estado) !== "completada"
              ).length
          );
          const labelsAgentesTar = agentesTar.map(
            (id) => agenteMap[id] || "Sin Asignar"
          );

          new Chart(document.getElementById("graficoTareasAgente"), {
            type: "doughnut",
            data: {
              labels: labelsAgentesTar,
              datasets: [{ data: dataAgentesTar, backgroundColor: baseColors }],
            },
          });

          // === 6. TABLA TAREAS ===
          const pendientes = tareas
            .filter((t) => normalizarEstado(t.Estado) !== "completada")
            .slice(0, 10);
          document.getElementById("tablaTareasPendientes").innerHTML =
            pendientes
              .map(
                (t) => `
            <tr>
                <td style="padding:10px;">${t.Título}</td>
                <td style="padding:10px;"><span class="badge-agent" style="background:${
                  colorAgente[t.AgenteID] || "#999"
                }">${agenteMap[t.AgenteID] || "-"}</span></td>
                <td style="padding:10px;">${formatearFechaCL(
                  t.FechaLimite
                )}</td>
            </tr>
          `
              )
              .join("");

          // === 7. GAUGES RENDIMIENTO ===
          const totalT = tareas.length;
          const doneT = tareas.filter(
            (t) => normalizarEstado(t.Estado) === "completada"
          ).length;
          const pctGlobal = totalT ? Math.round((doneT / totalT) * 100) : 0;

          new Chart(document.getElementById("gaugeGlobal"), {
            type: "doughnut",
            data: {
              datasets: [
                {
                  data: [pctGlobal, 100 - pctGlobal],
                  backgroundColor: [getGaugeColor(pctGlobal), "#eee"],
                  borderWidth: 0,
                },
              ],
            },
            options: {
              rotation: -90,
              circumference: 180,
              cutout: "70%",
              plugins: {
                legend: false,
                title: {
                  display: true,
                  text: pctGlobal + "%",
                  position: "bottom",
                },
              },
            },
          });
          document.getElementById(
            "detalleGlobal"
          ).innerText = `${doneT}/${totalT} tareas`;

          // Gauges individuales
          const divGauges = document.getElementById("gaugesUsuarios");
          divGauges.innerHTML = "";
          agentes.forEach((a) => {
            const misTareas = tareas.filter((t) => t.AgenteID === a.ID);
            if (misTareas.length === 0) return;

            const misDone = misTareas.filter(
              (t) => normalizarEstado(t.Estado) === "completada"
            ).length;
            const miPct = Math.round((misDone / misTareas.length) * 100);

            const div = document.createElement("div");
            div.className = "gauge-container";
            div.innerHTML = `<canvas id="g_${
              a.ID
            }"></canvas><p style="font-weight:bold; color:${
              colorAgente[a.ID]
            }">${a.Nombre}</p><p class="gauge-detail">${misDone}/${
              misTareas.length
            }</p>`;
            divGauges.appendChild(div);

            new Chart(document.getElementById(`g_${a.ID}`), {
              type: "doughnut",
              data: {
                datasets: [
                  {
                    data: [miPct, 100 - miPct],
                    backgroundColor: [getGaugeColor(miPct), "#eee"],
                    borderWidth: 0,
                  },
                ],
              },
              options: {
                rotation: -90,
                circumference: 180,
                cutout: "70%",
                plugins: {
                  legend: false,
                  title: {
                    display: true,
                    text: miPct + "%",
                    position: "bottom",
                  },
                },
              },
            });
          });
        } catch (err) {
          console.error(err);
          // alert("Error al cargar dashboard: " + err.message);
        } finally {
          hideSpinner();
        }
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
