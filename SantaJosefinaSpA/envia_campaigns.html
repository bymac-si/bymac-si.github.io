<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Gestor de Campañas | CRM Santa Josefina</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/css/styles.css" />

    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="assets/js/app.js"></script>

    <script>
      (function () {
        if (typeof emailjs !== "undefined") {
          emailjs.init("7Il4AhmGHchP7qfxu"); // Tu Public Key
        }
      })();
      if (typeof requireAuth === "function") requireAuth();
    </script>

    <style>
      body {
        max-width: 1200px;
        margin: auto;
        background-color: #f8f9fa;
        color: #1a2b48;
        font-family: sans-serif;
      }
      main {
        padding: 40px;
      }
      .card {
        background: #fff;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border: 1px solid #f0f0f0;
        margin-bottom: 20px;
      }
      .preview-box {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 15px;
        height: 300px;
        overflow-y: auto;
        background: #fff;
        margin-top: 10px;
      }
      .btn-nuevo {
        background: #0f172a;
        color: white;
        font-weight: 600;
        padding: 12px 20px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        width: 100%;
      }
      .btn-nuevo:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .progress-container {
        display: none;
        margin-top: 20px;
      }
      .progress-bar {
        height: 10px;
        background: #e2e8f0;
        border-radius: 5px;
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        background: #3b82f6;
        width: 0%;
        transition: width 0.3s;
      }
    </style>
  </head>

  <body style="margin: auto">
    <div id="header"></div>
    <main>
      <div class="card">
        <h1 style="font-size: 24px; margin-bottom: 10px">
          <i class="fa-solid fa-bullhorn"></i> Gestor de Campañas
        </h1>
        <p class="text-muted">
          Santa Josefina SpA · Gestión Inmobiliaria Integral
        </p>
      </div>

      <div class="card">
        <label class="fw-bold">1. Seleccionar Campaña</label>
        <select
          id="campaignSelect"
          class="form-select"
          onchange="loadPreview()"
          style="width: 100%; padding: 10px; margin-top: 10px"
        >
          <option disabled selected>Cargando datos de AppSheet...</option>
        </select>
      </div>

      <div class="card">
        <label class="fw-bold">2. Vista Previa</label>
        <div
          id="subjectPreview"
          style="
            font-weight: bold;
            margin-top: 10px;
            padding: 10px;
            background: #f1f5f9;
            border-radius: 5px;
          "
        >
          Asunto: -
        </div>
        <div id="htmlPreview" class="preview-box">
          Seleccione una campaña...
        </div>
      </div>

      <div class="card text-center">
        <div id="loader" class="loader"></div>
        <button
          id="btnSend"
          class="btn-nuevo w-100 mb-2"
          onclick="ejecutarEnvioMasivo()"
          disabled
        >
          <i class="fa-solid fa-paper-plane"></i> Enviar campaña ahora
        </button>

        <div id="progresoArea" style="display: none; margin-top: 20px">
          <div
            style="
              height: 10px;
              background: #eee;
              border-radius: 5px;
              overflow: hidden;
            "
          >
            <div
              id="barraProgreso"
              style="
                height: 100%;
                background: #0f172a;
                width: 0%;
                transition: width 0.4s;
              "
            ></div>
          </div>
          <div
            id="statusMsg"
            class="fw-bold mt-3"
            style="font-size: 14px; color: #0f172a"
          ></div>
        </div>
      </div>
      <div id="footer"></div>
    </main>

    <script>
      /* ===== Inicialización ===== */
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          document.getElementById("header").innerHTML = await (
            await fetch("header.html")
          ).text();
        } catch (e) {}
        try {
          document.getElementById("footer").innerHTML = await (
            await fetch("footer.html")
          ).text();
        } catch (e) {}

        bindUI();
        await cargarTodo();
      });
      let campaignsData = [];
      let leadsActivos = [];
      const API_URL =
        "https://script.google.com/macros/s/AKfycbwfy9r__x7tYFF8pcvYcE3RGDXaEV7nxjxE8JqodWlczl9OFnY_xzWttDqXITOd5gBh/exec";

      // 1. CARGAR DATOS (CAMPAÑAS Y LEADS)
      window.onload = async () => {
        try {
          // 1. Obtenemos los datos de AppSheet
          const [campanas, leadsData] = await Promise.all([
            fetchData("Campañas"),
            fetchData("Leads_Marketing"),
          ]);

          campaignsData = campanas;

          // 2. CORRECCIÓN: Usar 'leadsData' (la variable que definimos arriba)
          leadsActivos = leadsData.filter(
            (l) =>
              l.Estado &&
              l.Estado.trim().toLowerCase().includes("activ") &&
              l.ID &&
              l.ID.includes("@"),
          );

          console.log("Leads activos detectados:", leadsActivos.length);

          const s = document.getElementById("campaignSelect");
          s.innerHTML =
            "<option disabled selected>-- Elija una campaña --</option>";
          campanas.forEach((c) => {
            s.innerHTML += `<option value="${c.ID_Campaña}">${c.ID_Campaña} - ${c.Asunto}</option>`;
          });
        } catch (err) {
          console.error("Error cargando datos:", err);
          alert("No se pudieron cargar los datos de AppSheet.");
        }
      };
      function loadPreview() {
        const id = document.getElementById("campaignSelect").value;
        const c = campaignsData.find((x) => x.ID_Campaña === id);
        if (!c) return;

        document.getElementById("subjectPreview").innerText =
          `Asunto: ${c.Asunto}`;
        document.getElementById("htmlPreview").innerHTML = c.Cuerpo_HTML;
        document.getElementById("btnSend").disabled = false;
        document.getElementById("btnSend").innerText =
          `Enviar a ${Math.min(leadsActivos.length, 30)} leads activos`;
      }

      async function ejecutarEnvioMasivo() {
        const idCampaña = document.getElementById("campaignSelect").value;
        const campania = campaignsData.find((x) => x.ID_Campaña === idCampaña);

        const lote = leadsActivos
          .filter((l) => l.Campaña_Enviada !== idCampaña)
          .slice(0, 15); // Lote inicial de seguridad

        if (lote.length === 0) return alert("No hay leads pendientes.");
        if (!confirm(`¿Iniciar envío vía Resend para ${lote.length} leads?`))
          return;

        mostrarProgreso(true);
        let enviados = 0;

        for (let i = 0; i < lote.length; i++) {
          const lead = lote[i];
          actualizarStatus(`Enviando a ${lead.Nombre}...`);

          try {
            const cuerpoFinal = campania.Cuerpo_HTML.replace(
              /{{Nombre}}/g,
              lead.Nombre || "Vecino",
            );

            // Llamada a tu Google Script (puente a Resend)
            // Reemplaza el bloque del fetch por este:
            const res = await fetch(`${API_URL}?action=apiResend`, {
              method: "POST",
              mode: "no-cors", // Añadimos esto para evitar bloqueos del navegador
              headers: {
                "Content-Type": "text/plain", // Google Apps Script prefiere esto para el postData
              },
              body: JSON.stringify({
                to: lead.ID,
                subject: campania.Asunto,
                html: cuerpoFinal,
              }),
            });

            // Actualizamos AppSheet tras éxito
            await appSheetCRUD("Leads_Marketing", "Edit", [
              {
                ID: lead.ID,
                Campaña_Enviada: idCampaña,
                Ultimo_Envio: new Date().toISOString(),
                Estado_Envio: "ENVIADO (RESEND)",
              },
            ]);

            enviados++;
          } catch (err) {
            console.error(`Error en lead ${lead.ID}:`, err);
          }

          actualizarBarra(((i + 1) / lote.length) * 100);

          // Pausa aleatoria humanizada
          if (i < lote.length - 1) {
            const pausa = Math.floor(Math.random() * (10000 - 5000 + 1)) + 5000;
            await new Promise((r) => setTimeout(r, pausa));
          }
        }

        alert(`Proceso terminado. ${enviados} correos enviados exitosamente.`);
        window.location.reload();
      }
      // --- FUNCIONES DE APOYO PARA LA INTERFAZ ---

      function mostrarProgreso(visible) {
        const area = document.getElementById("progresoArea");
        if (area) area.style.display = visible ? "block" : "none";
      }

      function actualizarStatus(texto) {
        const msg = document.getElementById("statusMsg");
        if (msg) msg.innerText = texto;
      }

      function actualizarBarra(porcentaje) {
        const barra = document.getElementById("barraProgreso");
        if (barra) barra.style.width = porcentaje + "%";
      }
    </script>
  </body>
</html>
