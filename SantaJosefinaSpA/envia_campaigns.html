<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gestor de Campañas | CRM Santa Josefina</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <link rel="stylesheet" href="assets/css/styles.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="assets/js/app.js"></script>
  <script>if(typeof requireAuth === "function") requireAuth();</script>

  <style>
    body {
      max-width: 1200px;
      margin: auto;
      background-color: #f8f9fa;
      color: #1a2b48;
      font-family: sans-serif;
    }
    main { padding: 40px; }
    .card {
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      border: 1px solid #f0f0f0;
      margin-bottom: 20px;
    }
    .preview-box {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 15px;
      height: 300px;
      overflow-y: auto;
      background: #fff;
      margin-top: 10px;
    }
    .btn-nuevo {
      background: #0f172a;
      color: white;
      font-weight: 600;
      padding: 12px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      width: 100%;
    }
    .btn-nuevo:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .text-center { text-align: center; }
    #statusMsg { font-size: 14px; margin-top: 10px; color: #64748b; }
    .barra-container { height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin-top: 20px; }
    #barraProgreso { height: 100%; background: #2563eb; width: 0%; transition: width 0.3s; }
  </style>
</head>

<body style="margin: auto;">

<div id="header"></div>

<main>
  <div class="card" style="border-left:5px solid #0f172a">
    <h1><i class="fa-solid fa-bullhorn"></i> Gestor de Campañas</h1>
    <p>Santa Josefina SpA - Panel de Prospección</p>
  </div>

  <div class="card">
    <label>1. Seleccionar Campaña</label>
    <select id="campaignSelect" onchange="loadPreview()" style="width:100%;padding:12px;margin-top:10px;border-radius:8px;border:1px solid #ddd;">
      <option>Cargando campañas...</option>
    </select>
  </div>

  <div class="card">
    <label>2. Vista Previa</label>
    <div id="subjectPreview" style="font-weight:bold;padding:12px;background:#f1f5f9;margin-top:10px;border-radius:5px;">
      Asunto: -
    </div>
    <div id="htmlPreview" class="preview-box">
      Seleccione una campaña para previsualizar.
    </div>
  </div>

  <div class="card text-center">
    <button id="btnSend" class="btn-nuevo" onclick="ejecutarEnvioMasivo()" disabled>
      Enviar campaña a leads activos
    </button>

    <div id="progresoArea" style="display:none;">
      <div class="barra-container">
        <div id="barraProgreso"></div>
      </div>
      <div id="statusMsg">Esperando inicio...</div>
    </div>
  </div>
</main>

<div id="footer"></div>

<script>
// URL unificada con analitica.html (Versión actual de tu script)
const API_URL = "https://script.google.com/macros/s/AKfycbzXAuOSwm59jCVMrPwqJ_MymZLXN5g9wsR_DODH76nCk6eVPAep0ER-wHADhDFfijz8/exec";

let campaignsData = [];
let leadsActivos = [];

/* ===== CARGA INICIAL (HEADER/FOOTER + DATOS) ===== */
document.addEventListener("DOMContentLoaded", async () => {
  // Carga de componentes visuales sincronizada con analitica.html
  try {
    const h = await fetch("header.html"); if(h.ok) document.getElementById("header").innerHTML = await h.text();
    const f = await fetch("footer.html"); if(f.ok) document.getElementById("footer").innerHTML = await f.text();
  } catch(e) { 
    console.warn("Componentes header/footer no cargados localmente."); 
  }

  await cargarBaseDeDatos();
});

async function cargarBaseDeDatos() {
  try {
    // fetchData y appSheetCRUD deben estar definidos en tu assets/js/app.js
    const [campanas, leads] = await Promise.all([
      fetchData("Campañas"),
      fetchData("Leads_Marketing")
    ]);

    campaignsData = campanas || [];
    // Filtro: Debe tener email (ID) y estar en estado Activo
    leadsActivos = (leads || []).filter(l => 
      l.ID && l.ID.includes("@") && 
      l.Estado && l.Estado.toLowerCase().includes("activ")
    );

    const sel = document.getElementById("campaignSelect");
    sel.innerHTML = `<option disabled selected>-- Seleccione una campaña --</option>`;
    
    campaignsData.forEach(c => {
      sel.innerHTML += `<option value="${c.ID_Campaña}">${c.ID_Campaña} - ${c.Asunto}</option>`;
    });

  } catch (err) {
    console.error("Error inicial:", err);
    alert("Error al cargar datos de Google Sheets / AppSheet");
  }
}

/* ===== PREVIEW ===== */
function loadPreview() {
  const id = document.getElementById("campaignSelect").value;
  const camp = campaignsData.find(c => c.ID_Campaña === id);
  if (!camp) return;

  document.getElementById("subjectPreview").innerText = "Asunto: " + camp.Asunto;
  document.getElementById("htmlPreview").innerHTML = camp.Cuerpo_HTML;

  const btn = document.getElementById("btnSend");
  btn.disabled = false;
  
  // Contar cuántos faltan por recibir esta campaña específica
  const pendientes = leadsActivos.filter(l => l.Campaña_Enviada !== id);
  btn.innerText = `Enviar a lote de ${Math.min(pendientes.length, 15)} leads pendientes`;
}

/* ===== MOTOR DE ENVÍO (CORS BYPASS) ===== */
async function ejecutarEnvioMasivo() {
  const idCampaña = document.getElementById("campaignSelect").value;
  const camp = campaignsData.find(c => c.ID_Campaña === idCampaña);
  
  // Tomamos un lote pequeño para no saturar (máximo 15 por tanda)
  const lote = leadsActivos
    .filter(l => l.Campaña_Enviada !== idCampaña)
    .slice(0, 15);

  if (!lote.length) {
    alert("No hay leads pendientes para esta campaña.");
    return;
  }

  if (!confirm(`¿Confirmas el envío de ${lote.length} correos?`)) return;

  document.getElementById("progresoArea").style.display = "block";
  document.getElementById("btnSend").disabled = true;

  let exitos = 0;

  for (let i = 0; i < lote.length; i++) {
    const lead = lote[i];
    actualizarUI(`Enviando a: ${lead.Nombre}...`, ((i + 1) / lote.length) * 100);

    try {
      const htmlPersonalizado = camp.Cuerpo_HTML.replace(/{{Nombre}}/g, lead.Nombre || "Vecino");

      // ENVÍO A GOOGLE (Proxy para Resend)
      await fetch(API_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify({
          action: "apiResend",
          to: lead.ID,
          subject: camp.Asunto,
          html: htmlPersonalizado
        })
      });

      exitos++;

      // REGISTRO EN APP SHEET (Actualizamos la fila del lead)
      if (typeof appSheetCRUD === "function") {
        await appSheetCRUD("Leads_Marketing", "Edit", [{
          ID: lead.ID,
          Campaña_Enviada: idCampaña,
          Ultimo_Envio: new Date().toISOString(),
          Estado_Envio: "ENVIADO (RESEND)"
        }]);
      }

    } catch (err) {
      console.error("Fallo en envío:", err);
    }

    // Pausa de seguridad entre correos (6 segundos) para evitar bloqueos
    if (i < lote.length - 1) {
      await new Promise(resolve => setTimeout(resolve, 6000));
    }
  }

  actualizarUI(`¡Finalizado! ${exitos} correos procesados.`, 100);
  alert("Proceso de envío terminado.");
  location.reload();
}

/* ===== UI HELPERS ===== */
function actualizarUI(mensaje, porcentaje) {
  const statusMsg = document.getElementById("statusMsg");
  const barraProgreso = document.getElementById("barraProgreso");
  if(statusMsg) statusMsg.innerText = mensaje;
  if(barraProgreso) barraProgreso.style.width = porcentaje + "%";
}
</script>

</body>
</html>