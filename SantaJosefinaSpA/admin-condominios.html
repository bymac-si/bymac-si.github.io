<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Contrato Administración de Condominios</title>
  <link rel="stylesheet" href="assets/css/styles.css">
  <script src="assets/js/app.js"></script>
  <script>requireAuth();</script>
</head>
<body>
<div id="header" class="no-print"></div>

<main class="container">
  <h2 class="page-title no-print">Contrato de Administración de Condominios</h2>

  <div class="card no-print">
    <div class="row">
      <div>
        <label class="label">Copropiedad</label>
        <select id="selCopro" style="height: 37px; font-size: 14px;"></select>
      </div>
      <div>
        <label class="label">Comuna</label>
        <input id="inpComuna" readonly style="width: 90%;font-size: 14px;">
      </div>
      <div>
        <label class="label">Factor Comuna (TablaTarifas)</label>
        <input id="inpFactor" class="mono" readonly style="width: 90%;font-size: 14px;">
      </div>
      <div>
        <label class="label">N° Unidades</label>
        <input id="inpUnidades" class="mono" readonly style="width: 90%;font-size: 14px;">
      </div>
      <div>
        <label class="label">UTM (CLP)</label>
        <input id="inpUTM" class="mono" placeholder="Ej: 67.000" inputmode="decimal" style="width: 98%;font-size: 14px;">
      </div>
    </div>
    <div class="btns">
      <button class="btn-primary" onclick="window.location.reload()">Actualizar</button>
      <button class="btn-primary" onclick="imprimir()">Imprimir Contrato</button>
    </div>
  </div>

  <div class="grid no-print">
    <div class="card">
      <h2 class="section-title">Resumen</h2>
      <p><b>Copropiedad:</b> <span id="cxCopro">—</span></p>
      <p><b>Dirección:</b> <span id="cxDir">—</span></p>
      <p><b>RUT:</b> <span id="cxRUT">—</span></p>
      <p><b>Comuna:</b> <span id="cxComuna">—</span> <span class="badge">Factor: <span id="cxFactor">—</span></span></p>
      <p><b>N° Unidades:</b> <span id="cxUnidades">—</span></p>
      <p><b>UTM:</b> <span id="cxUTM">—</span></p>
    </div>
    <div class="card">
      <h2 class="section-title">Cálculo de Honorarios</h2>
      <p class="small muted">Fórmula aplicada:</p>
      <p class="mono" id="outFormula">—</p>
      <table>
        <tr><th>Neto (CLP)</th>   <td id="outMontoNeto" class="mono">—</td></tr>
        <tr><th>IVA 19%</th>      <td id="outIVA"       class="mono">—</td></tr>
        <tr><th>Total a pagar</th><td id="outTotal"     class="mono">—</td></tr>
      </table>
    </div>
  </div>

  <div class="contrato print-only logo-print print-section" id="areaContrato">
    <div style="font-size:0.8em;">
      <img src="assets/img/logo_santajosefina.png" alt="Logo Santa Josefina" style="width: 140px; position: relative; top: -50px;" class="logo-print">
      <div>
        <div class="small muted logo-print" style="position:relative; top:-75px;">Administración de Edificios y Condominios</div>
      </div><br>
      <div style="position:relative; top:-75px;">
      <h3 class="page-title" style="text-align:center;line-height: 1.5em;">Contrato de Administración de Condominios</h3>
    
      <hr style="border:none; border-top:1px solid #e5e7eb; margin:10px 0 18px;">

      <p>En Santiago a <span id="c_fecha_hoy" style="font-weight: bold;">[Fecha]</span>, entre: <b>
        <span id="c_razon">[Nombre de la Comunidad]</span></b>, RUT <span id="c_rut" style="font-weight: bold;">[RUT]</span>, con domicilio en <span id="c_dir" style="font-weight: bold;">[Dirección]</span>, 
        comuna de <span id="c_comuna" style="font-weight: bold;">[Comuna]</span> (en adelante, la “Comunidad”); y <b>Santa Josefina SpA</b>, RUT 77.233.573-3, con domicilio en Santiago, (en adelante, el “Administrador”), 
        se celebra el presente <b>Contrato de Administración de Condominio</b>, sujeto a las siguientes cláusulas:</p>

      <h3 class="stitle">Primera: Objeto</h3>
      <p>La Comunidad contrata al Administrador para la administración integral del condominio <span id="c_razon_2" style="font-weight: bold;">[Nombre de la Comunidad]</span>, ubicado en <span id="c_dir_2" style="font-weight: bold;">[Dirección]</span>, conformado por <span id="c_unidades" style="font-weight: bold;">[Nº Unidades]</span> unidades.</p>

      <h3 class="stitle">Segunda: Honorarios</h3>
      <p>Los honorarios mensuales del Administrador se calcularán conforme a la siguiente regla:</p>
      <ul>
        <li><b>Si el condominio tiene 20 unidades o menos:</b> <span class="mono">FactorComuna × base × UTM</span>.</li>
        <li><b>Si el condominio tiene más de 20 unidades:</b> <span class="mono">(NºUnidades – 20) × FactorComuna × base × UTM × 0,013</span>.</li>
      </ul>
      <p>Para este contrato, la comuna es <b><span id="c_comuna_2">[Comuna]</span></b>, con factor <b><span id="c_factor">[Factor]</span></b>, y UTM vigente de <b><span id="c_utm">[UTM]</span></b>.</p>
      <table style="margin:10px 0 6px; font-size:0.65em;">
        <tr><th style="width:180px;">Neto (CLP)</th>       <td id="c_monto_neto" class="mono" style="text-align:right;">[Neto]</td></tr>
        <tr><th>IVA 19%</th>                               <td id="c_monto_iva"  class="mono" style="text-align:right;">[IVA]</td></tr>
        <tr><th>Total a pagar</th>                         <td id="c_monto_tot"  class="mono" style="text-align:right;">[Total]</td></tr>
      </table>

      <h3 class="stitle">Tercera: Obligaciones del Administrador</h3>
      <p>El Administrador realizará la gestión operativa, financiera y administrativa del condominio, de acuerdo con la <b>Ley N°21.442</b> y su reglamento, incluyendo, entre otras, la elaboración de presupuestos, recaudación de gastos comunes, pago a proveedores, mantención preventiva y correctiva, y rendición periódica a la comunidad.</p>

      <h3 class="stitle">Cuarta: Plazo</h3>
      <p>El presente contrato tendrá una duración de <b>12 meses</b>, renovable automáticamente por iguales períodos, salvo aviso en contrario con 30 días de anticipación.</p>

      <h3 class="stitle">Quinta: Terminación</h3>
      <p>Cualquiera de las partes podrá poner término por incumplimiento grave de la otra, mediando comunicación por escrito y otorgando un plazo de 10 días para subsanar.</p>

      <h3 class="stitle">Sexta: Domicilio</h3>
      <p>Para todos los efectos legales, las partes fijan su domicilio en la ciudad de Santiago.</p>
      <br><br><br><br><br><br>
      <div class="firma-grid">
        <div class="firma-box">
          <div class="firma-line"></div>
          <div><b>Representante Comunidad</b></div>
          <div class="small muted" id="c_razon_firma">[Nombre de la Comunidad]</div>
        </div>
        <div class="firma-box" style="text-align: right;position:relative; top:-35px;">
          <div class="firma-line"></div>
          <div><b>Santa Josefina SpA</b></div>
          <div class="small muted">RUT 77.233.573-3</div>
        </div>
      </div>
      </div>
    </div>
  </div>
</main>

<div id="pageSpinner" class="spinner-backdrop hidden" aria-hidden="true">
  <div class="spinner-card">
    <div class="spinner"></div>
    <div id="spinnerText">Cargando datos...</div>
  </div>
</div>

<div id="footer" class="no-print"></div>

<script>
document.addEventListener("DOMContentLoaded", async ()=>{
  try { document.getElementById("header").innerHTML = await (await fetch("header.html")).text(); } catch(e){}
  try { document.getElementById("footer").innerHTML = await (await fetch("footer.html")).text(); } catch(e){}

  // Fecha "dd de mmmm de yyyy"
  const nodoFecha = document.getElementById("c_fecha_hoy");
  if(nodoFecha) nodoFecha.textContent = fechaHoyTexto();

  await cargarDatos();
});

function fechaHoyTexto(){
  const d = new Date();
  const meses = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
  return `${String(d.getDate()).padStart(2,"0")} de ${meses[d.getMonth()]} de ${d.getFullYear()}`;
}

function showSpinner(msg){ document.getElementById('pageSpinner').classList.remove('hidden'); if(msg) document.getElementById('spinnerText').textContent=msg; }
function hideSpinner(){ document.getElementById('pageSpinner').classList.add('hidden'); }
function formatoCLP(v){ return "$" + new Intl.NumberFormat("es-CL",{maximumFractionDigits:0}).format(Number(v||0)); }
function getKeyVal(o){ return o._id || o.ID || o.Id || o.id || ""; }

let COPROS=[], UNIDADES=[], TARIFAS=[];
let coproSel=null, factor=0, nUnidades=0, utmCLP=0;

async function cargarDatos(){
  try{
    showSpinner("Cargando datos...");
    
    // Carga paralela de datos
    [COPROS, UNIDADES, TARIFAS] = await Promise.all([
      fetchData("Copropiedades"),
      fetchData("Unidades"),    // Puede venir vacía para el cliente nuevo
      fetchData("TablaTarifas")
    ]);

    const sel = document.getElementById("selCopro");
    sel.innerHTML = COPROS.map(c=>`<option value="${getKeyVal(c)}">${c.Nombre || c.RazonSocial || c['Nombre Condominio'] || "(Sin Nombre)"}</option>`).join("");
    sel.onchange = onSelectCopro;

    // LÓGICA DE AUTO-SELECCIÓN POR URL
    const params = new URLSearchParams(window.location.search);
    const incomingId = params.get('id');

    if(incomingId && COPROS.some(c => String(getKeyVal(c)) === String(incomingId))) {
       // Si viene un ID en la URL y existe en la lista, lo seleccionamos
       sel.value = incomingId;
    } else if(COPROS.length) {
       // Si no, seleccionamos el primero por defecto
       sel.value = getKeyVal(COPROS[0]);
    }
    
    // Ejecutar la carga de datos del seleccionado
    await onSelectCopro();

    // Listener para recalcular si cambian la UTM manualmente
    document.getElementById("inpUTM").addEventListener("input", calcular);

  }catch(err){
    alert("Error al cargar datos: "+(err.message||err));
    console.error(err);
  }finally{
    hideSpinner();
  }
}

async function onSelectCopro(){
  const id = document.getElementById("selCopro").value;
  coproSel = COPROS.find(c=> String(getKeyVal(c))===String(id));
  if(!coproSel) return;

  // Llenado de campos UI
  const fields = {
    "cxCopro": coproSel.Nombre, "c_razon": coproSel.Nombre, "c_razon_2": coproSel.Nombre, "c_razon_firma": coproSel.Nombre,
    "cxDir": coproSel.Direccion, "c_dir": coproSel.Direccion, "c_dir_2": coproSel.Direccion,
    "cxRUT": coproSel.RUT, "c_rut": coproSel.RUT,
    "cxComuna": coproSel.Comuna, "c_comuna": coproSel.Comuna, "c_comuna_2": coproSel.Comuna
  };

  for(const [kid, val] of Object.entries(fields)) {
    const el = document.getElementById(kid);
    if(el) el.textContent = val || "—";
  }
  document.getElementById("inpComuna").value = coproSel.Comuna||"";

  // Buscar Factor
  const tarifa = TARIFAS.find(t => (t.Comuna||"").toLowerCase().trim() === (coproSel.Comuna||"").toLowerCase().trim());
  factor = tarifa ? Number(tarifa.Factor||0) : 0;
  
  document.getElementById("inpFactor").value = factor || "";
  document.getElementById("cxFactor").textContent = factor || "—";
  if(document.getElementById("c_factor")) document.getElementById("c_factor").textContent = factor || "[Factor]";

  // LÓGICA DE UNIDADES (CORREGIDA)
  // 1. Intenta contar las filas en la tabla "Unidades"
  const coproID = getKeyVal(coproSel);
  let countFromTable = UNIDADES.filter(u=> String(u.CopropiedadID)===String(coproID)).length;
  
  // 2. Si es 0, busca en la columna Unidades de la tabla Copropiedades
  if(countFromTable === 0) {
      countFromTable = Number(coproSel.Unidades || coproSel.CantidadUnidades || coproSel.NUnidades || 0);
  }
  
  nUnidades = countFromTable;

  document.getElementById("inpUnidades").value = nUnidades;
  document.getElementById("cxUnidades").textContent = nUnidades || "—";
  document.getElementById("c_unidades").textContent = nUnidades || "[Nº Unidades]";

  calcular();
}

function calcular(){
  const inp = document.getElementById("inpUTM");
  if(!inp) return;

  // 1. Obtener valor UTM limpio
  const rawUTM = inp.value.toString().replaceAll(".","").replace(",", ".");
  utmCLP = parseFloat(rawUTM) || 0;

  // Actualizar UI de la UTM
  const fmtUTM = utmCLP>0 ? formatoCLP(utmCLP) : "—";
  if(document.getElementById("cxUTM")) document.getElementById("cxUTM").textContent = fmtUTM;
  if(document.getElementById("c_utm")) document.getElementById("c_utm").textContent = fmtUTM;

  let neto = 0, iva = 0, total = 0, desc = "—";

  if(factor > 0 && utmCLP > 0 && nUnidades >= 0){
    
    // VARIABLE EXCEL: bases!F1 = UTM * 2.6
    const baseF1 = utmCLP * 2.6;

    let netoTeorico = 0;

    // CONDICIÓN EXCEL: SI(D6 < 20; ...)
    if(nUnidades < 20){
      // CASO VERDADERO: bases!F1 * E6 -> (UTM * 2.6) * Factor
      netoTeorico = baseF1 * factor;
      desc = `(2.6 × UTM) × Factor`;

    } else {
      // CASO FALSO: (bases!F1 + ((D6-20)*(bases!F1*0,013))) * E6
      const extra = nUnidades - 20;
      
      // Parte interna: (bases!F1 * 0,013)
      const valorExtraUnitario = baseF1 * 0.013; 
      
      // Suma: (bases!F1 + (extra * valorExtraUnitario))
      const sumaBase = baseF1 + (extra * valorExtraUnitario);

      // Multiplicación final por E6 (Factor)
      netoTeorico = sumaBase * factor;

      desc = `[Base + (Extra × Base × 0,013)] × Factor`;
    }

    // EXCEL: REDOND.MULT(... ; 1000)
    // Redondeamos el neto al 1000 más cercano
    neto = Math.round(netoTeorico / 1000) * 1000;

    // EXCEL: ... * 1,19 (Cálculo del Total)
    total = Math.round(neto * 1.19);
    
    // Despejamos el IVA por diferencia para que cuadre exacto (Total = Neto + IVA)
    iva = total - neto;
  }
  
  // Actualizar Textos en Pantalla
  if(document.getElementById("outFormula")) document.getElementById("outFormula").textContent = desc;
  
  const ids = ["outMontoNeto", "outIVA", "outTotal", "c_monto_neto", "c_monto_iva", "c_monto_tot"];
  const vals = [neto, iva, total, neto, iva, total];
  
  ids.forEach((id, i) => {
      const el = document.getElementById(id);
      if(el) el.textContent = formatoCLP(vals[i]);
  });
}

function imprimir(){ window.print(); }
</script>
</body>
</html>