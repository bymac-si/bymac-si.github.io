<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>CRM - Conciliación de Pagos</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="assets/css/styles.css">
  <script src="assets/js/app.js"></script>
  <script>requireAuth();</script>

  <style>
    /* Estilos Dashboard Unificados */
    body { max-width: 1300px; margin: 0 auto; color: #1a2b48; }
    main { padding: 40px; }
    .page-title { font-size: 28px; font-weight: 700; margin-bottom: 16px; }

    /* Header */
    .dashboard-header { background: #fff; padding: 20px 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid #f0f0f0; }
    .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .header-filters { display: flex; gap: 15px; border-top: 1px solid #e2e8f0; padding-top: 20px; }
    
    /* Inputs */
    .input-modern, select { height: 44px; padding: 0 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; background: #f8fafc; width: 100%; }

    /* Tabla */
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 15px; border-bottom: 1px solid #e5e7eb; text-align: left; vertical-align: middle; }
    th { background: #fafafa; font-weight: 600; color: #4b5563; }

    /* Badges Estado */
    .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
    .st-pendiente { background: #fef3c7; color: #b45309; }
    .st-aprobado { background: #dcfce7; color: #15803d; }
    .st-rechazado { background: #fee2e2; color: #b91c1c; }

    /* Botones */
    .btn-icon { width: 34px; height: 34px; border: none; border-radius: 6px; background: #f3f4f6; color: #555; cursor: pointer; transition: all 0.2s; }
    .btn-icon:hover { transform: translateY(-2px); color: white; background: #3b82f6; }
    .btn-primary { background: #1A2B48; color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; }

    /* Modal Comprobante */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; padding: 25px; border-radius: 12px; max-width: 500px; width: 90%; text-align: center; }
    .comprobante-img { max-width: 100%; max-height: 400px; border-radius: 8px; border: 1px solid #eee; margin: 15px 0; object-fit: contain; background: #f9fafb;}
    
    /* Spinner */
    .spinner-backdrop { position: fixed; inset: 0; background: rgba(255,255,255,0.8); display: none; place-items: center; z-index: 12000; }
    .spinner { width: 30px; height: 30px; border-radius: 50%; border: 3px solid #eee; border-top-color: #1A2B48; animation: spin .8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="header"></div>

  <main>
    <div class="dashboard-header no-print">
      <div class="header-top">
        <div>
          <h1 class="page-title" style="margin:0;">Conciliación Bancaria</h1>
          <p class="muted" style="margin:5px 0 0; font-size:13px;">Valida los pagos reportados por los residentes.</p>
        </div>
        <div>
          <button class="btn-primary" onclick="cargarDatos()" style="background: white; color: #475569; border: 1px solid #cbd5e1;">
            <i class="fa-solid fa-rotate-right"></i> Recargar
          </button>
        </div>
      </div>

      <div class="header-filters">
        <div style="flex: 1;">
          <label class="label">Buscar</label>
          <input id="inpBuscar" class="input-modern" style="width: 97%; height: 42px;" placeholder="Unidad, monto, ID..." oninput="aplicarFiltros()">
        </div>
        <div style="width: 200px;">
          <label class="label">Estado</label>
          <select id="selEstado" onchange="aplicarFiltros()">
            <option value="Pendiente">Pendientes</option> <option value="Aprobado">Aprobados</option>
            <option value="Rechazado">Rechazados</option>
            <option value="">(Todos)</option>
          </select>
        </div>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Unidad</th>
          <th>Monto</th>
          <th>Método</th>
          <th style="text-align:center;">Comprobante</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tablaPagos">
        <tr><td colspan="7" class="muted">Cargando pagos...</td></tr>
      </tbody>
    </table>
  </main>

  <div id="modalRevision" class="modal">
    <div class="modal-content">
      <h2 style="margin:0 0 5px;">Revisar Pago</h2>
      <p class="muted" id="modalSubtitulo">...</p>
      
      <div style="background:#f9fafb; min-height:150px; display:flex; align-items:center; justify-content:center; border-radius:8px;">
        <img id="modalImg" class="comprobante-img" src="" alt="Sin imagen">
        <div id="modalNoImg" style="display:none; color:#999;">Sin comprobante visual</div>
      </div>

      <div style="text-align:left; margin-top:15px; font-size:13px; color:#555;">
        <p><b>Nota:</b> <span id="modalObs">—</span></p>
        <p><b>Deuda Asociada (ID):</b> <span id="modalCobroID" class="mono">—</span></p>
      </div>

      <div style="margin-top:20px; display:flex; gap:10px; justify-content:center;">
        <button class="btn-primary" style="background:#ef4444;" onclick="procesarPago('Rechazado')">
          <i class="fa-solid fa-xmark"></i> Rechazar
        </button>
        <button class="btn-primary" style="background:#10b981;" onclick="procesarPago('Aprobado')">
          <i class="fa-solid fa-check"></i> Aprobar Pago
        </button>
      </div>
      <button onclick="cerrarModal()" style="margin-top:15px; background:none; border:none; color:#666; cursor:pointer; text-decoration:underline;">Cancelar</button>
    </div>
  </div>

  <div id="pageSpinner" class="spinner-backdrop">
    <div style="background:white; padding:20px; border-radius:10px; text-align:center;">
      <div class="spinner" style="margin:0 auto 10px;"></div>
      <div>Procesando...</div>
    </div>
  </div>

  <div id="footer"></div>

  <script>
    /* VARIABLES GLOBAL */
    let PAGOS = [], UNIDADES = [], COBROS = [], VIEW = [];
    let PAGO_ACTUAL = null;

    document.addEventListener("DOMContentLoaded", async () => {
      try { 
    document.getElementById("header").innerHTML = await (await fetch("header.html")).text(); 
    // AGREGAR ESTA LÍNEA CLAVE:
    if (typeof initHeader === "function") initHeader(); 
} catch(e){}

      try { document.getElementById("footer").innerHTML = await (await fetch("footer.html")).text(); } catch(e){}
      cargarDatos();
    });

    async function cargarDatos() {
      try {
        // Cargamos también COBROS para poder cruzarlos y cerrar deudas
        const [pagos, unidades, cobros] = await Promise.all([
            fetchData("Pagos").catch(()=>[]),
            fetchData("Unidades").catch(()=>[]),
            fetchData("Cobros").catch(()=>[]) 
        ]);
        PAGOS = pagos;
        UNIDADES = unidades;
        COBROS = cobros;
        
        // Ordenar por fecha descendente
        PAGOS.sort((a,b) => new Date(b.FechaPago) - new Date(a.FechaPago));

        aplicarFiltros();
      } catch(e) { console.error(e); }
    }

    function aplicarFiltros() {
      const q = (document.getElementById("inpBuscar").value || "").toLowerCase();
      const estado = document.getElementById("selEstado").value;

      VIEW = PAGOS.filter(p => {
        if(estado && !p.Estado.includes(estado)) return false;
        
        const unidadNum = resolverUnidad(p.UnidadID);
        const searchStr = [unidadNum, p.Monto, p.ID, p.Metodo].join(" ").toLowerCase();
        if(q && !searchStr.includes(q)) return false;
        
        return true;
      });

      renderTabla();
    }

    function resolverUnidad(id) {
        const u = UNIDADES.find(x => String(getKeyVal(x)) === String(id));
        return u ? (u.Numero || u.Nombre) : id;
    }

    function renderTabla() {
      const tb = document.getElementById("tablaPagos");
      if(VIEW.length === 0) { tb.innerHTML = '<tr><td colspan="7" class="muted">No hay pagos con estos filtros.</td></tr>'; return; }

      tb.innerHTML = VIEW.map(p => {
        let badgeClass = "st-pendiente";
        if(p.Estado === 'Aprobado') badgeClass = "st-aprobado";
        if(p.Estado === 'Rechazado') badgeClass = "st-rechazado";

        const tieneImg = p.ComprobanteURL ? '<i class="fa-solid fa-image" style="color:#3b82f6;"></i>' : '<span class="muted">-</span>';

        return `
          <tr>
            <td class="mono">${formatearFecha(p.FechaPago)}</td>
            <td style="font-weight:700;">${resolverUnidad(p.UnidadID)}</td>
            <td class="mono">${clp(p.Monto)}</td>
            <td>${p.Metodo}</td>
            <td style="text-align:center;">${tieneImg}</td>
            <td><span class="badge ${badgeClass}">${p.Estado}</span></td>
            <td>
              <button class="btn-icon" onclick='abrirRevision("${getKeyVal(p)}")' title="Revisar">
                <i class="fa-solid fa-magnifying-glass"></i>
              </button>
            </td>
          </tr>
        `;
      }).join("");
    }

    function abrirRevision(id) {
      PAGO_ACTUAL = PAGOS.find(p => String(getKeyVal(p)) === String(id));
      if(!PAGO_ACTUAL) return;

      const numUnidad = resolverUnidad(PAGO_ACTUAL.UnidadID);
      document.getElementById("modalSubtitulo").textContent = `Unidad ${numUnidad} - ${clp(PAGO_ACTUAL.Monto)}`;
      document.getElementById("modalObs").textContent = PAGO_ACTUAL.Observaciones || "Sin nota";
      
      // Mostrar etiqueta amigable en vez de ID técnico si es un tag
      let etiquetaDeuda = PAGO_ACTUAL.CobroID;
      if(etiquetaDeuda === "TOTAL_DEUDA") etiquetaDeuda = "Pago Total Deuda";
      if(etiquetaDeuda === "GC_MES_ACTUAL") etiquetaDeuda = "Gasto Común Mes Actual";
      
      document.getElementById("modalCobroID").textContent = etiquetaDeuda || "Pago Genérico";

      const img = document.getElementById("modalImg");
      const noImg = document.getElementById("modalNoImg");
      
      if(PAGO_ACTUAL.ComprobanteURL) {
        img.src = PAGO_ACTUAL.ComprobanteURL;
        img.style.display = "block"; noImg.style.display = "none";
      } else {
        img.style.display = "none"; noImg.style.display = "block";
      }

      document.getElementById("modalRevision").classList.add("active");
    }

    function cerrarModal() {
      document.getElementById("modalRevision").classList.remove("active");
      PAGO_ACTUAL = null;
    }

    // --- LÓGICA INTELIGENTE DE APROBACIÓN ---
    async function procesarPago(nuevoEstado) {
      if(!PAGO_ACTUAL) return;
      if(!confirm(`¿Confirmas marcar este pago como ${nuevoEstado}?`)) return;

      document.getElementById("pageSpinner").style.display = "grid";
      
      try {
        // 1. Actualizar el estado en la tabla PAGOS (Siempre se hace)
        const payloadPago = {
            ID: getKeyVal(PAGO_ACTUAL),
            Estado: nuevoEstado
        };

        if(typeof appSheetCRUD === 'function') {
            
            // Paso A: Actualizar Pago
            await appSheetCRUD("Pagos", "Edit", [payloadPago]);
            
            // Paso B: Actualizar Deuda en COBROS (Solo si se aprueba)
            if(nuevoEstado === 'Aprobado' && PAGO_ACTUAL.CobroID) {
                
                const cobroRef = PAGO_ACTUAL.CobroID;
                const unidadID = PAGO_ACTUAL.UnidadID;
                let filasAEditar = [];

                // CASO 1: Es un ID Específico (ej: COB_ENE_2026)
                // Verificamos si existe en la lista de cobros cargada
                const cobroEspecifico = COBROS.find(c => String(getKeyVal(c)) === String(cobroRef));
                
                if (cobroEspecifico) {
                    filasAEditar.push({ ID: cobroRef, Estado: "Pagado" });
                
                } else if (["TOTAL_DEUDA", "GC_MES_ACTUAL", "MORA_HISTORICA"].includes(cobroRef)) {
                    // CASO 2: Es una etiqueta genérica ("TOTAL_DEUDA")
                    // Buscamos TODOS los cobros pendientes de esa unidad
                    const pendientes = COBROS.filter(c => 
                        String(c.UnidadID) === String(unidadID) && 
                        c.Estado === 'Pendiente'
                    );
                    
                    // Los marcamos todos como pagados
                    pendientes.forEach(p => {
                        filasAEditar.push({ ID: getKeyVal(p), Estado: "Pagado" });
                    });
                }

                // Ejecutar actualización masiva o individual en Cobros
                if (filasAEditar.length > 0) {
                    console.log("Actualizando Cobros:", filasAEditar);
                    await appSheetCRUD("Cobros", "Edit", filasAEditar);
                } else {
                    console.warn("No se encontraron cobros vinculados para actualizar.");
                }
            }

        } else {
            // Mock local
            await new Promise(r => setTimeout(r, 1000));
        }

        cerrarModal();
        await cargarDatos(); 
        alert(`Pago ${nuevoEstado} exitosamente.`);

      } catch(e) {
        console.error(e);
        alert("Error al procesar: " + (e.message || e));
      } finally {
        document.getElementById("pageSpinner").style.display = "none";
      }
    }

    /* Helpers */
    function clp(v) { return "$" + new Intl.NumberFormat("es-CL").format(v); }
    function formatearFecha(iso) { if(!iso) return ""; return iso.split("T")[0]; }
    function getKeyVal(o) { return o.ID || o.id || ""; }
</script>
</body>
</html>