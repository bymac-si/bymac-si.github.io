<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Dashboard MÃ³vil</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="assets/css/mobile.css" />

    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#1a2b48" />

    <script src="assets/js/app.js"></script>
    <script>requireAuth();</script>
    
    <style>
        .m-logo { width: 80px; margin-bottom: 20px; filter: brightness(0) invert(1); }
        
        /* Estilos para la etiqueta de Agente en la tarjeta */
        .agent-pill {
            display: flex; align-items: center; gap: 5px;
            background: #f1f5f9; padding: 3px 8px; border-radius: 12px;
            font-size: 10px; color: #475569; font-weight: 600;
        }
        .agent-avatar-xs {
            width: 16px; height: 16px; border-radius: 50%; object-fit: cover;
            background: #cbd5e1; display: flex; align-items: center; justify-content: center;
            color: white; font-size: 8px;
        }
    </style>
</head>
<body>
    <div class="mobile-header">
        <img src="assets/img/logo_santajosefina.png" class="m-logo" alt="Santa Josefina" />
        <div class="header-title">CRM Santa Josefina</div>
        <div onclick="logout()" style="cursor: pointer; opacity: 0.8">
            <i class="fa-solid fa-power-off"></i>
        </div>
    </div>

    <div class="app-container">
        <div style="margin-bottom: 15px">
            <div style="font-size: 12px; color: #64748b">Bienvenido,</div>
            <div style="font-size: 20px; font-weight: 700; color: #1e293b" id="lblUsuario">
                Cargando...
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 20px;">
            <div class="m-card" style="margin: 0; padding: 20px; border-left: 5px solid #f59e0b; display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <div class="m-kpi-label" style="font-size: 13px">Cartera Clientes</div>
                    <div style="font-size: 11px; color: #94a3b8; margin-top: 2px">Activos actualmente</div>
                </div>
                <div class="m-kpi-val" id="kpiClientes" style="font-size: 28px">--</div>
            </div>

            <div class="m-card" style="margin: 0; padding: 20px; border-left: 5px solid #3b82f6; display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <div class="m-kpi-label" style="font-size: 13px">Propiedades</div>
                    <div style="font-size: 11px; color: #94a3b8; margin-top: 2px">Disponibles para venta/arriendo</div>
                </div>
                <div class="m-kpi-val" id="kpiProps" style="font-size: 28px">--</div>
            </div>

            <div class="m-card" style="margin: 0; padding: 20px; border-left: 5px solid #ef4444; display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <div class="m-kpi-label" style="font-size: 13px">Tareas Pendientes</div>
                    <div style="font-size: 11px; color: #94a3b8; margin-top: 2px">Acciones requeridas hoy</div>
                </div>
                <div class="m-kpi-val" id="kpiTareas" style="color: #ef4444; font-size: 28px">--</div>
            </div>
        </div>

        <h3 style="font-size: 14px; margin: 15px 0 10px; color: #334155">GestiÃ³n RÃ¡pida</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px">
            <div class="m-card" onclick="window.location.href='mobile_prospecto.html'" style="margin: 0; text-align: center; padding: 15px; cursor: pointer">
                <div class="m-kpi-icon" style="margin: 0 auto 8px; background: #dcfce7; color: #166534">
                    <i class="fa-solid fa-user-plus"></i>
                </div>
                <div style="font-size: 12px; font-weight: 600">Nuevo Lead</div>
            </div>

            <div class="m-card" onclick="window.location.href='mobile_bitacora.html'" style="margin: 0; text-align: center; padding: 15px; cursor: pointer">
                <div class="m-kpi-icon" style="margin: 0 auto 8px">
                    <i class="fa-solid fa-clipboard-list"></i>
                </div>
                <div style="font-size: 12px; font-weight: 600">BitÃ¡cora</div>
            </div>

            <div class="m-card" onclick="window.location.href='mobile_mapa.html'" style="margin: 0; text-align: center; padding: 15px; cursor: pointer">
                <div class="m-kpi-icon" style="margin: 0 auto 8px; background: #e0f2fe; color: #0369a1">
                    <i class="fa-solid fa-map-location-dot"></i>
                </div>
                <div style="font-size: 12px; font-weight: 600">Mapa</div>
            </div>

            <div class="m-card" onclick="window.location.href='mobile_tareas.html'" style="margin: 0; text-align: center; padding: 15px; cursor: pointer">
                <div class="m-kpi-icon" style="margin: 0 auto 8px; background: #fef3c7; color: #b45309">
                    <i class="fa-solid fa-list-check"></i>
                </div>
                <div style="font-size: 12px; font-weight: 600">Mis Tareas</div>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: end; margin-top: 25px; margin-bottom: 10px;">
            <h3 style="font-size: 14px; margin: 0; color: #334155">Agenda Prioritaria</h3>
            <a href="mobile_tareas.html" style="font-size: 11px; color: #3b82f6; text-decoration: none">Ver todo</a>
        </div>

        <div class="m-card" style="padding: 0 15px; margin-bottom: 20px">
            <div id="listaTareasMobile">
                <div style="padding: 20px; text-align: center; color: #94a3b8; font-size: 12px">
                    <i class="fa-solid fa-circle-notch fa-spin"></i> Cargando agenda...
                </div>
            </div>
        </div>

        <div style="height: 60px"></div>
    </div>

    <nav class="bottom-nav">
        <a href="mobile_dashboard.html" class="nav-btn active">
            <i class="fa-solid fa-house"></i> <span>Inicio</span>
        </a>
        <a href="mobile_prospecto.html" class="nav-btn">
            <i class="fa-solid fa-users"></i> <span>Prospectos</span>
        </a>
        <a href="mobile_propiedades.html" class="nav-btn">
            <i class="fa-solid fa-building"></i> <span>Props</span>
        </a>
        <a href="mobile_tareas.html" class="nav-btn">
            <i class="fa-solid fa-list-check"></i> <span>Tareas</span>
        </a>
    </nav>

    <script>
        // Cache para agentes
        let AGENTES_CACHE = [];

        document.addEventListener("DOMContentLoaded", async () => {
            // 1. Obtener usuario (MÃ¡s robusto)
            try {
                const u = getAuthUser();
                // Verifica mayÃºsculas y minÃºsculas
                const nombre = u.Nombre || u.nombre || "Agente";
                document.getElementById("lblUsuario").innerText = nombre.split(" ")[0]; // Solo primer nombre
            } catch (e) {
                document.getElementById("lblUsuario").innerText = "Agente";
            }

            // 2. Cargar Datos (INCLUYENDO AGENTES)
            try {
                const [clientes, props, tareas, agentes] = await Promise.all([
                    fetchData("Clientes").catch(() => []),
                    fetchData("Propiedades").catch(() => []),
                    fetchData("Tareas").catch(() => []),
                    fetchData("Agentes").catch(() => []) // <--- ESTO FALTABA
                ]);

                AGENTES_CACHE = agentes || [];

                // KPIs
                document.getElementById("kpiClientes").innerText = clientes.length;
                document.getElementById("kpiProps").innerText = props.filter(
                    (p) => (p.Estado || "") === "Disponible"
                ).length;

                const pendientes = tareas.filter(
                    (t) => (t.Estado || "") !== "Completada"
                );
                document.getElementById("kpiTareas").innerText = pendientes.length;

                // Renderizar Tareas
                renderTareasResumen(pendientes);
            } catch (e) {
                console.error(e);
            }
        });

        function renderTareasResumen(lista) {
            const container = document.getElementById("listaTareasMobile");
            if (lista.length === 0) {
                container.innerHTML =
                    "<div style='padding:15px; text-align:center; font-size:12px; color:#cbd5e1;'>Â¡Todo al dÃ­a! ðŸŽ‰</div>";
                return;
            }

            // Ordenar por fecha lÃ­mite
            lista.sort((a, b) => {
                if (!a.FechaLimite) return 1;
                if (!b.FechaLimite) return -1;
                return new Date(a.FechaLimite) - new Date(b.FechaLimite);
            });

            const top3 = lista.slice(0, 3);

            container.innerHTML = top3
                .map((t) => {
                    let colorPrio = "#94a3b8"; // Baja
                    if (t.Prioridad === "Media") colorPrio = "#f59e0b";
                    if (t.Prioridad === "Alta") colorPrio = "#ef4444";

                    // BUSCAR AGENTE
                    const agente = AGENTES_CACHE.find(a => String(a.ID) === String(t.AgenteID));
                    let avatarHtml = `<div class="agent-avatar-xs">?</div>`;
                    let nombreAgente = "Sin Asignar";

                    if(agente) {
                        nombreAgente = agente.Nombre.split(" ")[0];
                        if(agente.Avatar && agente.Avatar.startsWith("http")) {
                            avatarHtml = `<img src="${agente.Avatar}" class="agent-avatar-xs">`;
                        } else {
                            avatarHtml = `<div class="agent-avatar-xs">${agente.Nombre.charAt(0)}</div>`;
                        }
                    }

                    return `
                    <div class="m-list-item" onclick="window.location.href='mobile_tareas.html'">
                        <div style="width:10px; height:10px; border-radius:50%; background:${colorPrio}; margin-right:10px; flex-shrink:0;"></div>
                        <div class="m-info" style="width:100%;">
                            <div class="m-title" style="font-size:13px;">${t["TÃ­tulo"]}</div>
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:2px;">
                                <div class="m-sub" style="font-size:11px; display:flex; align-items:center;">
                                    <i class="fa-regular fa-calendar" style="margin-right:4px;"></i>${formatearFechaCorrecta(t.FechaLimite)}
                                </div>
                                <div class="agent-pill">
                                    ${avatarHtml} ${nombreAgente}
                                </div>
                            </div>
                        </div>
                        <i class="fa-solid fa-chevron-right" style="color:#e2e8f0; font-size:12px; margin-left:10px;"></i>
                    </div>
                    `;
                })
                .join("");
        }

        /* --- FUNCIÃ“N FECHA TODOTERRENO --- */
        function formatearFechaCorrecta(fecha) {
            if (!fecha) return "S/F";

            // Caso 1: Viene con barras (MM/DD/YYYY o DD/MM/YYYY)
            if (fecha.indexOf('/') > -1) {
                const parts = fecha.split('/');
                // Si el primer nÃºmero es mayor a 12, asumimos DD/MM/YYYY, si no, asumimos formato US
                // Para simplificar y estandarizar a Chile:
                // Si la fecha ya viene correcta visualmente, no la tocamos, pero si es MM/DD, la invertimos.
                
                // Intento seguro con Date:
                const d = new Date(fecha);
                if (!isNaN(d.getTime())) {
                    const dia = String(d.getDate()).padStart(2, '0');
                    const mes = String(d.getMonth() + 1).padStart(2, '0');
                    const anio = d.getFullYear();
                    return `${dia}/${mes}/${anio}`;
                }
                return fecha; // Devolver original si falla
            }

            // Caso 2: Viene como ISO (YYYY-MM-DD)
            if (fecha.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const [y, m, d] = fecha.split('-');
                return `${d}/${m}/${y}`;
            }

            return fecha;
        }
    </script>
</body>
</html>