<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Arrendatarios</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a2b48">
    <script src="assets/js/app.js"></script>
    <script>requireAuth();</script>
    <style>
        body { max-width: 1400px; margin: 0 auto; background: #f8fafc; }
        main { padding: 40px; }
        .badge-pago { font-size: 11px; padding: 4px 8px; border-radius: 12px; font-weight: bold; }
        .bg-ok { background: #dcfce7; color: #166534; }
        .bg-warn { background: #fef9c3; color: #854d0e; }
        .bg-danger { background: #fee2e2; color: #991b1b; }
        /* Reutilizamos estilos de chat/modal del dashboard anterior */
        .chat-container { display: flex; flex-direction: column; gap: 10px; max-height: 300px; overflow-y: auto; padding: 10px; background: #f1f5f9; border-radius: 8px; }
        .chat-bubble { background: white; padding: 10px; border-radius: 8px; font-size: 13px; border-left: 3px solid #3b82f6; }
    </style>
</head>
<body>
    <div id="header"></div>

    <main>
        <div class="dashboard-header no-print">
            <div class="header-top">
                <h1 class="page-title"><i class="fa-solid fa-key"></i> Contratos de Arriendo</h1>
                <div class="header-actions">
                    <button class="btn-head btn-secundario" onclick="cargarTodo()"><i class="fa-solid fa-rotate"></i></button>
                    <button class="btn-head btn-nuevo" onclick="abrirModalContrato()"><i class="fa-solid fa-plus"></i> Nuevo Contrato</button>
                </div>
            </div>
            <div class="header-filters">
                <div class="filter-item" style="flex-grow: 1;">
                    <label class="label">Buscar Arrendatario / Propiedad</label>
                    <input id="inpBuscar" class="input-modern" placeholder="Nombre, RUT, Propiedad..." oninput="filtrar()">
                </div>
            </div>
        </div>

        <div style="background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow: hidden;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0; text-align: left;">
                        <th style="padding: 15px;">Arrendatario</th>
                        <th style="padding: 15px;">Propiedad</th>
                        <th style="padding: 15px;">Canon</th>
                        <th style="padding: 15px;">Día Pago</th>
                        <th style="padding: 15px;">Vigencia</th>
                        <th style="padding: 15px;">Estado</th>
                        <th style="padding: 15px; text-align: right;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaContratos"></tbody>
            </table>
        </div>
    </main>

    <div id="modalContrato" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 id="ttlContrato">Nuevo Arriendo</h2>
            <form id="formContrato" style="margin-top: 20px; display: grid; gap: 15px;">
                <input type="hidden" id="contID">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div><label class="label">RUT Arrendatario</label><input id="cRut" class="input-modern" required></div>
                    <div><label class="label">Nombre Completo</label><input id="cNombre" class="input-modern" required></div>
                </div>
                <div><label class="label">Propiedad (ID)</label><input id="cPropiedad" class="input-modern" placeholder="ID Propiedad"></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div><label class="label">Monto ($)</label><input type="number" id="cMonto" class="input-modern" required></div>
                    <div><label class="label">Día de Pago (1-31)</label><input type="number" id="cDia" class="input-modern" max="31" required></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div><label class="label">Email</label><input type="email" id="cEmail" class="input-modern"></div>
                    <div><label class="label">Teléfono</label><input id="cTel" class="input-modern"></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div><label class="label">Inicio</label><input type="date" id="cInicio" class="input-modern"></div>
                    <div><label class="label">Fin</label><input type="date" id="cFin" class="input-modern"></div>
                </div>
                <div style="text-align: right; margin-top: 10px;">
                    <button type="button" class="btn-head btn-secundario" onclick="cerrarModal('modalContrato')">Cancelar</button>
                    <button type="submit" class="btn-head btn-nuevo">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalGestion" class="modal">
        <div class="modal-content" style="max-width: 700px; height: 80vh; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0;">Gestión Arrendatario</h2>
                <button onclick="cerrarModal('modalGestion')" class="btn-head btn-secundario">Cerrar</button>
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn-head btn-nuevo" onclick="enviarCobroMail()"><i class="fa-regular fa-envelope"></i> Enviar Cobro</button>
                <button class="btn-head btn-secundario" onclick="registrarPagoManual()"><i class="fa-solid fa-money-bill-wave"></i> Registrar Pago</button>
            </div>

            <h4 style="margin: 0 0 10px; color: #64748b;">Bitácora de Interacciones</h4>
            <div id="timelineContainer" class="chat-container" style="flex: 1;"></div>
            
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <input id="txtNota" class="input-modern" placeholder="Nueva nota o compromiso..." style="flex: 1;">
                <button class="btn-head btn-nuevo" onclick="guardarNota()">Agregar</button>
            </div>
        </div>
    </div>

    <div id="footer"></div>

    <script>
        let CONTRATOS = [], ACTUAL_ID = null;

        document.addEventListener("DOMContentLoaded", async () => {
            try { document.getElementById("header").innerHTML = await (await fetch("header.html")).text(); if(typeof initHeader==='function') initHeader(); } catch(e){}
            try { document.getElementById("footer").innerHTML = await (await fetch("footer.html")).text(); } catch(e){}
            await cargarTodo();
        });

        async function cargarTodo() {
            // Asumimos tabla "ContratosArriendo"
            CONTRATOS = await fetchData("ContratosArriendo").catch(() => []);
            renderTabla(CONTRATOS);
        }

        function filtrar() {
            const q = document.getElementById("inpBuscar").value.toLowerCase();
            const filtrados = CONTRATOS.filter(c => 
                (c["Nombre Arrendatario"]||"").toLowerCase().includes(q) || 
                (c["RUT Arrendatario"]||"").toLowerCase().includes(q)
            );
            renderTabla(filtrados);
        }

        function renderTabla(lista) {
            const tb = document.getElementById("tablaContratos");
            tb.innerHTML = "";
            lista.forEach(c => {
                // Lógica de Semáforo de Pago
                const hoy = new Date().getDate();
                const diaPago = parseInt(c["Dia Pago"]);
                let badge = '<span class="badge-pago bg-ok">Al día</span>';
                if(hoy > diaPago) badge = '<span class="badge-pago bg-warn">Por Vencer</span>';
                if(hoy > diaPago + 5) badge = '<span class="badge-pago bg-danger">Atrasado</span>';

                tb.innerHTML += `
                <tr style="border-bottom: 1px solid #f1f5f9;">
                    <td style="padding: 15px;">
                        <div style="font-weight: bold;">${c["Nombre Arrendatario"]}</div>
                        <div style="font-size: 12px; color: #64748b;">${c["RUT Arrendatario"]}</div>
                    </td>
                    <td style="padding: 15px;">ID: ${c.PropiedadID}</td>
                    <td style="padding: 15px;">$${parseInt(c["Monto Arriendo"]).toLocaleString()}</td>
                    <td style="padding: 15px;">Día ${c["Dia Pago"]}</td>
                    <td style="padding: 15px; font-size: 13px;">${c["Fecha Inicio"]} <br>a ${c["Fecha Fin"]}</td>
                    <td style="padding: 15px;">${badge}</td>
                    <td style="padding: 15px; text-align: right;">
                        <button class="btn-icon" onclick="gestionar('${c.ID}')" title="Gestión"><i class="fa-solid fa-list-check"></i></button>
                        <button class="btn-icon" onclick="editar('${c.ID}')" title="Editar"><i class="fa-solid fa-pen"></i></button>
                    </td>
                </tr>`;
            });
        }

        /* --- CRUD CONTRATO --- */
        function abrirModalContrato() {
            document.getElementById("formContrato").reset();
            document.getElementById("contID").value = "";
            document.getElementById("modalContrato").style.display = "flex";
        }
        function cerrarModal(id) { document.getElementById(id).style.display = "none"; }

        function editar(id) {
            const c = CONTRATOS.find(x => x.ID === id);
            if(!c) return;
            document.getElementById("contID").value = c.ID;
            document.getElementById("cRut").value = c["RUT Arrendatario"];
            document.getElementById("cNombre").value = c["Nombre Arrendatario"];
            document.getElementById("cPropiedad").value = c.PropiedadID;
            document.getElementById("cMonto").value = c["Monto Arriendo"];
            document.getElementById("cDia").value = c["Dia Pago"];
            document.getElementById("cEmail").value = c.Email;
            document.getElementById("cTel").value = c.telefono; // Ojo mayúsculas
            document.getElementById("cInicio").value = c["Fecha Inicio"];
            document.getElementById("cFin").value = c["Fecha Fin"];
            document.getElementById("modalContrato").style.display = "flex";
        }

        document.getElementById("formContrato").onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById("contID").value;
            const payload = {
                "RUT Arrendatario": document.getElementById("cRut").value,
                "Nombre Arrendatario": document.getElementById("cNombre").value,
                "PropiedadID": document.getElementById("cPropiedad").value,
                "Monto Arriendo": document.getElementById("cMonto").value,
                "Dia Pago": document.getElementById("cDia").value,
                "Email": document.getElementById("cEmail").value,
                "telefono": document.getElementById("cTel").value,
                "Fecha Inicio": document.getElementById("cInicio").value,
                "Fecha Fin": document.getElementById("cFin").value,
                "Estado": "Activo"
            };
            
            if(id) payload["ID"] = id; 
            else payload["ID"] = "CTR_" + Date.now();

            const action = id ? "Edit" : "Add";
            await appSheetCRUD("ContratosArriendo", action, [payload]);
            cerrarModal("modalContrato");
            cargarTodo();
        }

        /* --- GESTIÓN / BITÁCORA --- */
        async function gestionar(id) {
            ACTUAL_ID = id;
            document.getElementById("modalGestion").style.display = "flex";
            cargarBitacora();
        }

        async function cargarBitacora() {
            const div = document.getElementById("timelineContainer");
            div.innerHTML = "Cargando...";
            // Reusamos tabla Bitacora, ProspectoID = ContratoID
            const logs = await fetchData("Bitacora").catch(()=>[]);
            const misLogs = logs.filter(l => l.ProspectoID === ACTUAL_ID).sort((a,b)=> new Date(b.Fecha)-new Date(a.Fecha));
            
            div.innerHTML = misLogs.map(l => `
                <div class="chat-bubble">
                    <div style="display:flex; justify-content:space-between; color:#64748b; font-size:11px; margin-bottom:4px;">
                        <span>${l.Fecha} (${l.Tipo})</span>
                        <span>${l.Usuario}</span>
                    </div>
                    <div>${l.Nota}</div>
                </div>
            `).join("");
        }

        async function guardarNota() {
            const nota = document.getElementById("txtNota").value;
            if(!nota) return;
            const payload = {
                "ID": "BIT_" + Date.now(),
                "ProspectoID": ACTUAL_ID,
                "Fecha": new Date().toISOString().split("T")[0],
                "Tipo": "Nota",
                "Nota": nota,
                "Usuario": "Agente" // Usar getAuthUser() si está disponible
            };
            await appSheetCRUD("Bitacora", "Add", [payload]);
            document.getElementById("txtNota").value = "";
            cargarBitacora();
        }

        function enviarCobroMail() {
            const c = CONTRATOS.find(x => x.ID === ACTUAL_ID);
            if(!c || !c.Email) return alert("El contrato no tiene email.");
            
            const subject = `Recordatorio de Pago Arriendo - ${c["Nombre Arrendatario"]}`;
            const body = `Estimado(a),\n\nLe recordamos que su arriendo de la propiedad ${c.PropiedadID} vence el día ${c["Dia Pago"]}.\n\nMonto a pagar: $${c["Monto Arriendo"]}\n\nAtte,\nSanta Josefina SpA`;
            
            window.open(`mailto:${c.Email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
            
            // Registrar en bitácora automático
            appSheetCRUD("Bitacora", "Add", [{
                "ID": "BIT_" + Date.now(), "ProspectoID": ACTUAL_ID, "Fecha": new Date().toISOString().split("T")[0],
                "Tipo": "Cobranza", "Nota": "Se envió recordatorio de cobro por mail.", "Usuario": "Sistema"
            }]);
        }

        function registrarPagoManual() {
            // Aquí podrías abrir otro modal simple o guardar directo
            const fecha = new Date().toISOString().split("T")[0];
            const nota = `Pago recibido manualmente en oficina/transferencia. Fecha: ${fecha}`;
            
            if(confirm("¿Confirmar recepción de pago manual del mes en curso?")) {
                appSheetCRUD("Bitacora", "Add", [{
                    "ID": "BIT_" + Date.now(), "ProspectoID": ACTUAL_ID, "Fecha": fecha,
                    "Tipo": "Pago", "Nota": nota, "Usuario": "Agente"
                }]);
                alert("Pago registrado en bitácora.");
                cargarBitacora();
            }
        }
    </script>
</body>
</html>