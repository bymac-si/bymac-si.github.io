<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Anal칤tica | CRM Santa Josefina</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<link rel="stylesheet" href="assets/css/styles.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="assets/js/app.js"></script>
<script>if(typeof requireAuth === "function") requireAuth();</script>

<style>
body{background:#f8f9fa;color:#1e293b;font-family: sans-serif;}
main{max-width:1100px;margin:40px auto;padding:20px}
.card{background:#fff;padding:25px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05);margin-bottom:20px;}
.alert-good{color:#16a34a;font-weight:700; background: #f0fdf4; padding: 10px; border-radius: 8px;}
.alert-bad{color:#dc2626;font-weight:700; background: #fef2f2; padding: 10px; border-radius: 8px;}
table{width:100%;border-collapse:collapse}
th,td{padding:12px;border-bottom:1px solid #e5e7eb;text-align:left}
th{color:#64748b;font-size:.85rem; text-transform: uppercase;}
.chart-container { height: 350px; display: flex; justify-content: center; position: relative;}
</style>
</head>

<body>

<div id="header"></div>

<main>
    <div class="card" style="border-left:5px solid #0f172a">
        <h1 style="margin:0">游늵 Anal칤tica de Campa침as</h1>
        <p id="reco">Cargando an치lisis de datos real...</p>
    </div>

    <div class="card">
        <h3>Distribuci칩n de Clics (CTR)</h3>
        <div class="chart-container">
            <canvas id="chartClics"></canvas>
        </div>
    </div>

    <div class="card">
        <h3>Rendimiento por campa침a</h3>
        <table>
            <thead>
                <tr>
                    <th>Campa침a</th>
                    <th>Enviados</th>
                    <th>Clics</th>
                    <th>Leads A</th>
                    <th>Conversi칩n A</th>
                </tr>
            </thead>
            <tbody id="tablaCampa침as">
                <tr><td colspan="5">Cargando datos...</td></tr>
            </tbody>
        </table>
    </div>
</main>

<div id="footer"></div>

<script>
// URL ACTUALIZADA A VERSI칍N 69
const API_URL = "https://script.google.com/macros/s/AKfycbzXAuOSwm59jCVMrPwqJ_MymZLXN5g9wsR_DODH76nCk6eVPAep0ER-wHADhDFfijz8/exec";
let miGrafico = null;

document.addEventListener("DOMContentLoaded", async () => {
  try {
    const h = await fetch("header.html"); if(h.ok) document.getElementById("header").innerHTML = await h.text();
    const f = await fetch("footer.html"); if(f.ok) document.getElementById("footer").innerHTML = await f.text();
  } catch(e){ console.warn("Header/Footer no cargado localmente"); }

  cargarAnalitica();
});

async function cargarAnalitica(){
  try {
    const res = await fetch(`${API_URL}?action=getAnaliticaCampanas&t=${Date.now()}`);
    const data = await res.json();

    let totalEnviados=0, totalClics=0;
    const tbody = document.getElementById("tablaCampa침as");
    tbody.innerHTML="";

    const keys = Object.keys(data);
    
    if(keys.length === 0 || (keys.length === 1 && keys[0] === "Sin campa침a")) {
        tbody.innerHTML = "<tr><td colspan='5' style='text-align:center'>No hay datos de campa침as enviadas a칰n.</td></tr>";
        document.getElementById("reco").innerText = "Sin datos suficientes para an치lisis.";
        return;
    }

    keys.forEach(c => {
      const r = data[c];
      const conv = r.enviados ? Math.round((r.leadsA / r.enviados) * 100) : 0;

      totalEnviados += r.enviados;
      totalClics += r.clics;

      tbody.innerHTML += `
        <tr>
          <td><span class="badge" style="background:#0f172a; color:white; padding:3px 8px; border-radius:4px; font-size:0.8rem">${c}</span></td>
          <td>${r.enviados}</td>
          <td>${r.clics}</td>
          <td>${r.leadsA}</td>
          <td><b style="color:#0f172a">${conv}%</b></td>
        </tr>`;
    });

    renderChart(totalClics, Math.max(0, totalEnviados - totalClics));

    const ctr = totalEnviados ? (totalClics / totalEnviados) * 100 : 0;
    const reco = document.getElementById("reco");

    if(ctr > 10){
      reco.innerText = `Buen CTR (${ctr.toFixed(1)}%). El inter칠s es alto. Asegura un seguimiento r치pido por WhatsApp.`;
      reco.className = "alert-good";
    } else {
      reco.innerText = `CTR Bajo (${ctr.toFixed(1)}%). Considera cambiar el asunto del correo o la hora de env칤o.`;
      reco.className = "alert-bad";
    }
  } catch (err) {
    console.error(err);
    document.getElementById("tablaCampa침as").innerHTML = "<tr><td colspan='5'>Error al cargar datos.</td></tr>";
  }
}

function renderChart(clics, noclics){
  const ctx = document.getElementById("chartClics").getContext('2d');
  
  // Destruir gr치fico previo si existe para evitar duplicados
  if(miGrafico) miGrafico.destroy();

  miGrafico = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["Clics Reales", "Sin Interacci칩n"],
      datasets: [{
        data: [clics, noclics],
        backgroundColor: ["#0f172a", "#e2e8f0"],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: "bottom" }
      },
      cutout: '70%'
    }
  });
}
</script>
</body>
</html>