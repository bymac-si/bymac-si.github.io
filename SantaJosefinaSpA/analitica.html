<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Anal칤tica | CRM Santa Josefina</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<link rel="stylesheet" href="assets/css/styles.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="assets/js/app.js"></script>
<script>requireAuth();</script>

<style>
body{background:#f8f9fa;color:#1e293b}
main{max-width:1100px;margin:40px auto;padding:20px}
.card{background:#fff;padding:25px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05)}
.alert-good{color:#16a34a;font-weight:700}
.alert-bad{color:#dc2626;font-weight:700}
table{width:100%;border-collapse:collapse}
th,td{padding:12px;border-bottom:1px solid #e5e7eb;text-align:left}
th{color:#64748b;font-size:.85rem}
</style>
</head>

<body>

<!-- HEADER -->
<div id="header"></div>

<main>

<div class="card mb-4" style="border-left:5px solid #0f172a">
<h1 style="margin:0">游늵 Anal칤tica de Campa침as</h1>
<p id="reco" class="alert-good">Cargando an치lisis...</p>
</div>
<br>
<div class="card mb-4" style="height:300px; align-items:center; display:flex; justify-content:center;">
<canvas id="chartClics" ></canvas>
</div>
<br>
<div class="card">
<h3>Rendimiento por campa침a</h3>
<table>
<thead>
<tr>
<th>Campa침a</th>
<th>Enviados</th>
<th>Clics</th>
<th>Leads A</th>
<th>Conversi칩n A</th>
</tr>
</thead>
<tbody id="tablaCampa침as"></tbody>
</table>
</div>

</main>

<!-- FOOTER -->
<div id="footer"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwBsxC4CnsE26XFBm-IzuL_ftfsVmyQip5lbI-ztoBQzrpwJ7dB_vouLXWvFlwewbQu/exec";
const chartClics = document.getElementById("chartClics");

document.addEventListener("DOMContentLoaded", async () => {
  // Header / Footer
  try {
    document.getElementById("header").innerHTML = await (await fetch("header.html")).text();
    document.getElementById("footer").innerHTML = await (await fetch("footer.html")).text();
  } catch(e){ console.warn("Header/Footer no cargado"); }

  cargarAnalitica();
});

async function cargarAnalitica(){
  const res = await fetch(`${API_URL}?action=getAnaliticaCampanas&t=${Date.now()}`);
  const data = await res.json();

  let totalEnviados=0, totalClics=0;
  const tbody = document.getElementById("tablaCampa침as");
  tbody.innerHTML="";

  Object.keys(data).forEach(c=>{
    const r = data[c];
    const conv = r.enviados ? Math.round((r.leadsA/r.enviados)*100) : 0;

    totalEnviados += r.enviados;
    totalClics += r.clics;

    tbody.innerHTML += `
      <tr>
        <td><b>${c}</b></td>
        <td>${r.enviados}</td>
        <td>${r.clics}</td>
        <td>${r.leadsA}</td>
        <td><b>${conv}%</b></td>
      </tr>`;
  });

  renderChart(totalClics, totalEnviados-totalClics);

  const ctr = totalEnviados ? (totalClics/totalEnviados)*100 : 0;
  const reco = document.getElementById("reco");

  if(ctr > 15){
    reco.innerText = "Buen CTR. Optimiza copy y CTA para aumentar Leads A.";
    reco.className = "alert-good";
  }else{
    reco.innerText = "Muchos env칤os con bajo impacto. Revisar segmentaci칩n y mensaje.";
    reco.className = "alert-bad";
  }
}

function renderChart(clics, noclics){

  const ctx = document.getElementById("chartClics");

  new Chart(ctx,{
    type:"doughnut",
    data:{
      labels:["Clic","Sin clic"],
      datasets:[{
        data:[clics,noclics],
        backgroundColor:["#0f172a","#e5e7eb"]
      }]
    },
    options:{
      plugins:{
        legend:{position:"bottom"}
      }
    }
  });
}
</script>
</body>
</html>