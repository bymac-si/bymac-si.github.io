<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>CRM - Gestión de Reclamos</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="assets/css/styles.css">
  
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>
     (function(){
        // IMPORTANTE: Inicializa EmailJS si no está en app.js
        emailjs.init("7Il4AhmGHchP7qfxu"); 
     })();
  </script>

  <script src="assets/js/app.js"></script>
  <script>requireAuth();</script>

  <style>
    /* Estilos Base */
    body { max-width: 1400px; margin: 0 auto; color: #1a2b48; background: #f8fafc; }
    main { padding: 40px; }

    /* Header */
    .dashboard-header { background: #fff; padding: 20px 25px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 25px; }
    .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .page-title { font-size: 24px; font-weight: 700; margin: 0; color: #1e293b; }
    
    .header-filters { display: flex; gap: 15px; align-items: end; flex-wrap: wrap; }
    .filter-group { display: flex; flex-direction: column; gap: 5px; min-width: 200px; }
    .label { font-size: 12px; font-weight: 700; color: #64748b; text-transform: uppercase; }
    .input-modern { height: 42px; padding: 0 12px; border: 1px solid #cbd5e1; border-radius: 8px; background: #fff; width: 100%; box-sizing: border-box; }

    /* Grid Tickets */
    .ticket-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
    
    .ticket-card { 
        background: white; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; 
        transition: transform 0.2s; position: relative; border-left: 5px solid #cbd5e1;
    }
    .ticket-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    
    .border-Pendiente { border-left-color: #f59e0b; }
    .border-Proceso, .border-EnProceso { border-left-color: #3b82f6; }
    .border-Resuelto { border-left-color: #10b981; }

    .ticket-body { padding: 20px; }
    .t-meta { display: flex; justify-content: space-between; font-size: 12px; color: #64748b; margin-bottom: 10px; }
    .t-cat { font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    
    .t-title { font-weight: 700; color: #1e293b; margin-bottom: 5px; font-size: 15px; }
    .t-desc { font-size: 14px; color: #475569; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    
    .t-footer { padding: 15px 20px; background: #f8fafc; border-top: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
    
    .badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
    .bg-Pendiente { background: #fff7ed; color: #c2410c; }
    .bg-Proceso, .bg-EnProceso { background: #eff6ff; color: #1e40af; }
    .bg-Resuelto { background: #ecfdf5; color: #047857; }

    /* Modal */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; width: 100%; max-width: 900px; height: 85vh; border-radius: 12px; display: flex; overflow: hidden; }
    
    .modal-left { flex: 1; background: #f1f5f9; padding: 30px; overflow-y: auto; border-right: 1px solid #e2e8f0; }
    .modal-right { flex: 1.5; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; background:white; }

    /* CHAT STYLES */
    .chat-container {
        flex: 1; border: 1px solid #e2e8f0; border-radius: 8px; 
        padding: 20px; margin-bottom: 20px; background: #f8fafc; 
        overflow-y: auto; display: flex; flex-direction: column; gap: 15px;
    }
    .chat-bubble {
        padding: 12px 16px; border-radius: 12px; font-size: 13px; 
        max-width: 80%; line-height: 1.5; position: relative; word-wrap: break-word;
    }
    .chat-bubble.user {
        background: white; border: 1px solid #cbd5e1; color: #334155;
        align-self: flex-start; border-bottom-left-radius: 0;
    }
    .chat-bubble.admin {
        background: #1A2B48; color: white;
        align-self: flex-end; border-bottom-right-radius: 0;
    }
    .bubble-meta { font-size: 10px; margin-bottom: 4px; opacity: 0.7; font-weight: 700; text-transform: uppercase; }
    .bubble-date { font-size: 9px; opacity: 0.6; text-align: right; margin-top: 5px; }

    .btn-main { background: #1A2B48; color: white; border: none; padding: 0 20px; height: 42px; border-radius: 8px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;}
    .btn-sec { background: white; border: 1px solid #cbd5e1; color: #1e293b; padding: 0 15px; height: 42px; border-radius: 8px; font-weight: 600; cursor: pointer; }

    .spinner-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); display: none; place-items: center; z-index: 2000; }
  </style>
</head>
<body>

<div id="header"></div>

<main>
  <div class="dashboard-header">
    <div class="header-top">
      <div>
        <h1 class="page-title">Gestión de Reclamos</h1>
        <p style="margin:5px 0 0; color:#64748b; font-size:14px;">Bandeja de entrada de tickets y solicitudes.</p>
      </div>
      <button class="btn-sec" onclick="cargarDatos()"><i class="fa-solid fa-rotate"></i> Actualizar</button>
    </div>

    <div class="header-filters">
      <div class="filter-group" style="flex:2;">
        <label class="label">Comunidad</label>
        <select id="filtroCopropiedad" class="input-modern" onchange="cargarDatos()">
            <option value="">Cargando...</option>
        </select>
      </div>
      <div class="filter-group">
        <label class="label">Estado</label>
        <select id="filtroEstado" class="input-modern" onchange="aplicarFiltros()">
            <option value="">(Todos)</option>
            <option value="Pendiente">Pendientes</option>
            <option value="En Proceso">En Proceso</option>
            <option value="Resuelto">Resueltos</option>
        </select>
      </div>
    </div>
  </div>

  <div id="gridTickets" class="ticket-grid">
    </div>
</main>

<div id="modalTicket" class="modal">
    <div class="modal-content">
        <div class="modal-left">
            <h3 style="margin-top:0; color:#64748b;">Ticket #<span id="mID"></span></h3>
            <h2 id="mCat" style="margin:10px 0; color:#1A2B48;">Categoría</h2>
            
            <div style="background:white; padding:15px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:20px;">
                <div style="font-weight:700; color:#1e293b; margin-bottom:5px;">Residente:</div>
                <div id="mUser" style="font-size:14px;">...</div>
                <div id="mUnidad" style="font-size:12px; color:#64748b;">...</div>
                
                <hr style="border:0; border-top:1px solid #f1f5f9; margin:15px 0;">
                
                <div style="font-weight:700; color:#1e293b; margin-bottom:5px;">Descripción Original:</div>
                <div id="mDesc" style="color:#475569; font-size:13px; line-height:1.5;">...</div>
                <div id="mDate" style="font-size:11px; color:#94a3b8; margin-top:5px; text-align:right;">Fecha</div>
            </div>

            <div id="mFotoContainer" style="display:none;">
                <div style="font-weight:700; color:#64748b; margin-bottom:10px;">Evidencia Adjunta:</div>
                <img id="mFoto" src="" style="width:100%; border-radius:8px; border:1px solid #cbd5e1; object-fit:contain; background:white; max-height:250px;">
                <a id="mFotoLink" href="#" target="_blank" style="display:block; text-align:center; font-size:11px; margin-top:5px; color:#3b82f6;">Ver original</a>
            </div>
        </div>

        <div class="modal-right">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2 style="margin:0; font-size:18px;">Interacción</h2>
                <button class="btn-sec" onclick="cerrarModal()" style="height:32px; padding:0 10px;"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div id="chatHistory" class="chat-container">
                </div>

            <form id="formRespuesta" style="display:flex; flex-direction:column; background:white; border-top:1px solid #e2e8f0; padding-top:15px;">
                <input type="hidden" id="ticketID">
                <input type="hidden" id="ticketEmail">
                <input type="hidden" id="ticketNombre">
                
                <label class="label">Nueva Respuesta</label>
                <textarea id="mRespuesta" class="input-modern" style="height:70px; padding:10px; margin-bottom:10px; font-family:sans-serif;" placeholder="Escribe para responder al residente..."></textarea>

                <div style="display:flex; gap:10px; align-items:end;">
                    <div style="flex:1;">
                        <label class="label">Estado</label>
                        <select id="mNuevoEstado" class="input-modern">
                            <option value="Pendiente">Pendiente</option>
                            <option value="En Proceso">En Proceso</option>
                            <option value="Resuelto">Resuelto</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-main">Enviar <i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="spinner" class="spinner-overlay">
    <div style="width:40px; height:40px; border-radius:50%; border:4px solid #eee; border-top-color:#1A2B48; animation:spin 1s linear infinite;"></div>
</div>

<div id="footer"></div>

<script>
    let DB = { Tickets:[], Unidades:[], Copropiedades:[], Usuarios:[] };
    let VIEW = [];
    let TICKET_ACTUAL = null;

    document.addEventListener("DOMContentLoaded", async () => {
        try { document.getElementById("header").innerHTML = await (await fetch("header.html")).text(); } catch(e){}
        try { document.getElementById("footer").innerHTML = await (await fetch("footer.html")).text(); } catch(e){}
        await cargarFiltrosIniciales();
    });

    async function cargarFiltrosIniciales() {
        document.getElementById("spinner").style.display = "grid";
        try {
            DB.Copropiedades = await fetchData("Copropiedades").catch(()=>[]) || [];
            const sel = document.getElementById("filtroCopropiedad");
            sel.innerHTML = DB.Copropiedades.length ? "" : "<option>No hay comunidades</option>";
            
            DB.Copropiedades.forEach(c => {
                const opt = document.createElement("option");
                opt.value = c.ID;
                opt.textContent = c.Nombre;
                sel.appendChild(opt);
            });

            if(DB.Copropiedades.length > 0) {
                sel.value = DB.Copropiedades[0].ID; 
                await cargarDatos(); 
            }
        } catch(e) { console.error(e); } finally { document.getElementById("spinner").style.display = "none"; }
    }

    async function cargarDatos() {
        const idCopro = document.getElementById("filtroCopropiedad").value;
        if(!idCopro) return;

        document.getElementById("spinner").style.display = "grid";
        try {
            const [tickets, unidades, usuarios] = await Promise.all([
                fetchData("Reclamos").catch(()=>[]),
                fetchData("Unidades").catch(()=>[]),
                fetchData("Copropietarios").catch(()=>[])
            ]);

            DB.Tickets = (tickets || []).filter(t => String(t.CopropiedadID) === String(idCopro));
            DB.Unidades = (unidades || []).filter(u => String(u.CopropiedadID) === String(idCopro));
            DB.Usuarios = (usuarios || []).filter(u => String(u.CopropiedadID) === String(idCopro));

            aplicarFiltros();

        } catch(e) {
            console.error(e);
            alert("Error: " + e.message);
        } finally { document.getElementById("spinner").style.display = "none"; }
    }

    function aplicarFiltros() {
        const estado = document.getElementById("filtroEstado").value;
        VIEW = DB.Tickets;

        if(estado) {
            VIEW = VIEW.filter(t => t.Estado === estado || (estado === 'En Proceso' && t.Estado === 'EnProceso'));
        }

        VIEW.sort((a,b) => {
            if(a.Estado === 'Pendiente' && b.Estado !== 'Pendiente') return -1;
            if(a.Estado !== 'Pendiente' && b.Estado === 'Pendiente') return 1;
            return new Date(b.Fecha) - new Date(a.Fecha);
        });

        renderGrid();
    }

    function renderGrid() {
        const container = document.getElementById("gridTickets");
        if(VIEW.length === 0) {
            container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:#94a3b8;">No hay tickets.</div>';
            return;
        }

        container.innerHTML = VIEW.map(t => {
            const unidad = DB.Unidades.find(u => String(u.ID) === String(t.UnidadID));
            const nombreUnidad = unidad ? unidad.Numero : "U. Desconocida";
            const usuario = DB.Usuarios.find(u => String(u.ID) === String(t.UsuarioID));
            const nombreUsuario = usuario ? usuario.Nombre : "Residente";

            let estadoClean = (t.Estado || "Pendiente").replace(" ", ""); 
            if(estadoClean === 'EnProceso') estadoClean = 'Proceso';

            return `
            <div class="ticket-card border-${estadoClean}" onclick='abrirTicket("${t.ID}")'>
                <div class="ticket-body">
                    <div class="t-meta">
                        <span class="t-cat">${t.Categoria}</span>
                        <span>${formatearFecha(t.Fecha)}</span>
                    </div>
                    <div class="t-title">${nombreUnidad} - ${nombreUsuario}</div>
                    <div class="t-desc">${t.Descripcion}</div>
                </div>
                <div class="t-footer">
                    <span class="badge bg-${estadoClean}">${t.Estado || 'Pendiente'}</span>
                    <button class="btn-sec" style="height:30px; font-size:12px; padding:0 10px;">Ver Caso</button>
                </div>
            </div>
            `;
        }).join("");
    }

    /* --- GESTIÓN MODAL (CORREGIDA PARA MOSTRAR SIEMPRE CHAT) --- */
    function abrirTicket(id) {
        const t = DB.Tickets.find(x => x.ID === id);
        if(!t) return;
        TICKET_ACTUAL = t;

        // DEBUG: Muestra en la consola (F12) qué está llegando realmente
        console.log(">> Abriendo Ticket:", t);
        console.log(">> Historial Raw:", t.Historial);

        // 1. Datos Básicos UI
        document.getElementById("mID").innerText = id.replace("REQ_", "");
        document.getElementById("mCat").innerText = t.Categoria;
        document.getElementById("mDesc").innerText = t.Descripcion;
        document.getElementById("mDate").innerText = formatearFecha(t.Fecha);
        
        const unidad = DB.Unidades.find(u => String(u.ID) === String(t.UnidadID));
        const usuario = DB.Usuarios.find(u => String(u.ID) === String(t.UsuarioID));
        const nombreUsuario = usuario ? usuario.Nombre : "Residente";
        
        document.getElementById("mUser").innerText = nombreUsuario;
        document.getElementById("mUnidad").innerText = `Unidad: ${unidad ? unidad.Numero : t.UnidadID}`;

        // 2. Foto
        const imgCont = document.getElementById("mFotoContainer");
        const img = document.getElementById("mFoto");
        const link = document.getElementById("mFotoLink");
        
        if(t.Foto && t.Foto.length > 10) {
            img.src = t.Foto;
            link.href = t.Foto;
            imgCont.style.display = "block";
        } else {
            imgCont.style.display = "none";
        }

        // 3. Preparar Formulario (Hidden)
        document.getElementById("ticketID").value = t.ID;
        document.getElementById("ticketEmail").value = usuario ? usuario.Email : "";
        document.getElementById("ticketNombre").value = nombreUsuario;
        document.getElementById("mNuevoEstado").value = t.Estado || "Pendiente";
        document.getElementById("mRespuesta").value = "";

        // ============================================================
        // 4. LÓGICA DE RENDERING DEL CHAT (AQUÍ ESTÁ LA CORRECCIÓN)
        // ============================================================
        const chatBox = document.getElementById("chatHistory");
        chatBox.innerHTML = "";

        let historial = [];

        // A) Intentar Parsear Historial JSON
        if (t.Historial) {
            try {
                // Si ya es objeto (raro en AppSheet) o string JSON
                historial = typeof t.Historial === 'string' ? JSON.parse(t.Historial) : t.Historial;
            } catch (e) {
                console.warn("Historial no es JSON válido, tratando como texto plano legacy:", t.Historial);
                // Si falla, asumimos que es texto antiguo y lo metemos como mensaje admin
                historial.push({autor: "admin", nombre: "Admin (Legacy)", texto: String(t.Historial)});
            }
        } 
        
        // B) Si no hay historial JSON, buscar RespuestaAdmin antigua (Legacy)
        if ((!historial || historial.length === 0) && t.RespuestaAdmin) {
            historial.push({autor: "admin", nombre: "Admin", texto: t.RespuestaAdmin});
        }

        // C) ASEGURAR QUE LA DESCRIPCIÓN ORIGINAL ESTÉ AL INICIO
        // Verificamos si el primer mensaje NO es la descripción para agregarla
        const mensajeInicial = {
            autor: "user", 
            nombre: nombreUsuario, 
            texto: t.Descripcion, 
            fecha: t.Fecha
        };

        if (historial.length === 0) {
            // Si está vacío, ponemos la descripción
            historial.unshift(mensajeInicial);
        } else {
            // Si tiene datos, revisamos si el primero coincide con la descripción
            // Si el texto es distinto, asumimos que falta la ficha inicial y la agregamos
            if (historial[0].texto !== t.Descripcion) {
                historial.unshift(mensajeInicial);
            }
        }

        // D) DIBUJAR BURBUJAS
        historial.forEach(msg => {
            const isAdmin = msg.autor === 'admin';
            const clase = isAdmin ? 'admin' : 'user';
            const nombre = msg.nombre || (isAdmin ? "Administración" : nombreUsuario);
            
            let fechaTxt = "";
            if(msg.fecha) {
                // Intentar formatear fecha si existe
                try {
                    const d = new Date(msg.fecha);
                    if(!isNaN(d)) fechaTxt = d.toLocaleDateString() + " " + d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                } catch(e){}
            }

            chatBox.innerHTML += `
                <div class="chat-bubble ${clase}">
                    <div class="bubble-meta">${nombre}</div>
                    ${msg.texto}
                    <div class="bubble-date">${fechaTxt}</div>
                </div>
            `;
        });

        document.getElementById("modalTicket").style.display = "flex";
        setTimeout(() => chatBox.scrollTop = chatBox.scrollHeight, 100);
    }

    function cerrarModal() {
        document.getElementById("modalTicket").style.display = "none";
    }

    /* --- RESPUESTA ADMIN --- */
    document.getElementById("formRespuesta").onsubmit = async (e) => {
        e.preventDefault();
        
        const texto = document.getElementById("mRespuesta").value.trim();
        const nuevoEstado = document.getElementById("mNuevoEstado").value;
        const emailUser = document.getElementById("ticketEmail").value;
        const nombreUser = document.getElementById("ticketNombre").value;

        if(!texto && nuevoEstado === TICKET_ACTUAL.Estado) return alert("Escribe una respuesta o cambia el estado.");
        if(!confirm("¿Enviar actualización?")) return;

        document.getElementById("spinner").style.display = "grid";

        try {
            // 1. Actualizar Historial
            let historial = [];
            try {
                if(TICKET_ACTUAL.Historial) {
                    historial = typeof TICKET_ACTUAL.Historial === 'string' ? JSON.parse(TICKET_ACTUAL.Historial) : TICKET_ACTUAL.Historial;
                } else if(TICKET_ACTUAL.RespuestaAdmin) {
                    historial.push({autor:"admin", nombre:"Admin", texto:TICKET_ACTUAL.RespuestaAdmin});
                }
            } catch(err) { console.warn("Reset", err); }

            if(texto) {
                historial.push({
                    autor: "admin",
                    nombre: "Administración",
                    texto: texto,
                    fecha: new Date().toISOString()
                });
            }

            // 2. Guardar en AppSheet
            const jsonHistorial = JSON.stringify(historial);
            const payload = {
                "ID": String(TICKET_ACTUAL.ID),
                "Estado": nuevoEstado,
                "Historial": jsonHistorial,
                "RespuestaAdmin": texto // Legacy update
            };

            if(typeof appSheetCRUD === 'function') {
                await appSheetCRUD("Reclamos", "Edit", [payload]);
            }

            // 3. Notificar Residente
            if(emailUser && (texto || nuevoEstado !== TICKET_ACTUAL.Estado)) {
                await enviarEmailRespuesta(emailUser, {
                    nombre: nombreUser,
                    categoria: TICKET_ACTUAL.Categoria,
                    respuesta: texto || "(Solo actualización de estado)",
                    estado: nuevoEstado
                });
            }

            // 4. Update Local
            TICKET_ACTUAL.Historial = jsonHistorial;
            TICKET_ACTUAL.Estado = nuevoEstado;
            TICKET_ACTUAL.RespuestaAdmin = texto;
            
            document.getElementById("mRespuesta").value = "";
            abrirTicket(TICKET_ACTUAL.ID); // Re-render sin cerrar modal
            // Opcional: cerrarModal(); await cargarDatos();

        } catch(err) {
            alert("Error: " + err.message);
        } finally {
            document.getElementById("spinner").style.display = "none";
        }
    };

    async function enviarEmailRespuesta(email, datos) {
        if (typeof emailjs === 'undefined') return;

        const htmlBody = `
            <div style="font-family:sans-serif; padding:20px; border:1px solid #e2e8f0; border-radius:8px;">
                <h2 style="color:#1A2B48;">Actualización de Ticket</h2>
                <p>Estimado(a) <strong>${datos.nombre}</strong>,</p>
                <p>Hay novedades en tu solicitud de <strong>${datos.categoria}</strong>.</p>
                <div style="background:#f0fdf4; padding:15px; border-left:4px solid #10b981; margin:20px 0;">
                    <p style="font-size:12px; font-weight:700; color:#047857; margin-bottom:5px;">RESPUESTA ADMIN:</p>
                    <p style="margin:0;"><em>"${datos.respuesta}"</em></p>
                    <hr style="border:0; border-top:1px solid #d1fae5; margin:10px 0;">
                    <p style="margin:0; font-size:12px;"><strong>Estado Actual:</strong> ${datos.estado.toUpperCase()}</p>
                </div>
                <p style="font-size:12px; color:#64748b;">Ingresa al Portal para ver el chat completo.</p>
            </div>
        `;

        emailjs.send("service_p9hqkqn", "template_80q9psi", {
            to_email: email,
            subject: `Actualización Ticket: ${datos.categoria}`,
            html_body: htmlBody
        }).catch(e => console.warn(e));
    }

    function formatearFecha(iso) { 
      if(!iso) return ""; 
      const [y,m,d] = iso.split("-");
      return `${d}/${m}/${y}`;
    }
</script>

</body>
</html>