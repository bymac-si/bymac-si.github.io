<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>CRM - Gestión de Reservas</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <script src="assets/js/app.js"></script>
    <script>
      requireAuth();
    </script>

    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"
    ></script>
    <script type="text/javascript">
      (function () {
        // TU PUBLIC KEY
        emailjs.init("7Il4AhmGHchP7qfxu");
        console.log(">>> EmailJS Inicializado Correctamente");
      })();
    </script>

    <style>
      /* Estilos Base Admin */
      body {
        max-width: 1300px;
        margin: 0 auto;
        color: #1a2b48;
        background: #f8fafc;
      }
      main {
        padding: 40px;
      }

      /* Header Dashboard */
      .dashboard-header {
        background: #fff;
        padding: 20px 25px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        margin-bottom: 25px;
        border: 1px solid #e2e8f0;
      }
      .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .page-title {
        font-size: 24px;
        font-weight: 700;
        margin: 0;
        color: #1e293b;
      }
      .header-filters {
        display: flex;
        gap: 15px;
        border-top: 1px solid #e2e8f0;
        padding-top: 20px;
        flex-wrap: wrap;
      }

      /* Inputs y Selects */
      .input-modern {
        height: 42px;
        padding: 0 12px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        font-size: 14px;
        background: #fff;
      }
      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      .label {
        font-size: 12px;
        font-weight: 700;
        color: #64748b;
        text-transform: uppercase;
      }

      /* Tabla */
      .table-card {
        background: white;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 14px 20px;
        text-align: left;
        border-bottom: 1px solid #f1f5f9;
        font-size: 14px;
      }
      th {
        background: #f8fafc;
        font-weight: 600;
        color: #475569;
        text-transform: uppercase;
        font-size: 12px;
        letter-spacing: 0.5px;
      }
      tr:hover {
        background: #f8fafc;
      }

      /* Estados */
      .badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        display: inline-block;
      }
      .st-pendiente {
        background: #fff7ed;
        color: #c2410c;
        border: 1px solid #ffedd5;
      }
      .st-confirmada {
        background: #ecfdf5;
        color: #15803d;
        border: 1px solid #dcfce7;
      }
      .st-rechazada {
        background: #fef2f2;
        color: #b91c1c;
        border: 1px solid #fee2e2;
      }

      /* Botones */
      .btn-icon {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        margin-right: 4px;
      }
      .btn-approve {
        background: #dcfce7;
        color: #166534;
      }
      .btn-approve:hover {
        background: #166534;
        color: white;
      }
      .btn-reject {
        background: #fee2e2;
        color: #991b1b;
      }
      .btn-reject:hover {
        background: #991b1b;
        color: white;
      }
      .btn-delete {
        background: #f1f5f9;
        color: #64748b;
      }
      .btn-delete:hover {
        background: #64748b;
        color: white;
      }

      /* Conflicto */
      .conflict-row {
        background-color: #fff1f2 !important;
      }
      .conflict-msg {
        color: #e11d48;
        font-size: 11px;
        font-weight: 700;
        display: block;
        margin-top: 4px;
      }

      .spinner-overlay {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.8);
        display: none;
        place-items: center;
        z-index: 999;
      }
    </style>
  </head>
  <body>
    <div id="header"></div>

    <main>
      <div class="dashboard-header">
        <div class="header-top">
          <div>
            <h1 class="page-title">Gestión de Espacios Comunes</h1>
            <p style="color: #64748b; font-size: 14px; margin: 5px 0 0">
              Administra las reservas de quinchos, salas y estacionamientos.
            </p>
          </div>
          <button
            class="input-modern"
            style="
              background: #1a2b48;
              color: white;
              border: none;
              font-weight: 600;
              cursor: pointer;
            "
            onclick="cargarDatos()"
          >
            <i class="fa-solid fa-rotate"></i> Actualizar
          </button>
        </div>

        <div class="header-filters">
          <div class="filter-group">
            <label class="label">Fecha Inicio</label>
            <input
              type="date"
              id="filtroFecha"
              class="input-modern"
              onchange="aplicarFiltros()"
              style="width: 90%; height: 40px"
            />
          </div>
          <div class="filter-group">
            <label class="label">Espacio</label>
            <select
              id="filtroEspacio"
              class="input-modern"
              onchange="aplicarFiltros()"
            >
              <option value="">(Todos)</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="label">Estado</label>
            <select
              id="filtroEstado"
              class="input-modern"
              onchange="aplicarFiltros()"
            >
              <option value="Pendiente">Pendientes</option>
              <option value="Confirmada">Confirmadas</option>
              <option value="Rechazada">Rechazadas</option>
              <option value="">(Todas)</option>
            </select>
          </div>
          <div class="filter-group" style="flex-grow: 1">
            <label class="label">Buscar Unidad</label>
            <input
              type="text"
              id="filtroBuscar"
              class="input-modern"
              placeholder="Ej: 304..."
              onkeyup="aplicarFiltros()"
              style="width: 90%; height: 40px"
            />
          </div>
        </div>
      </div>

      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th>Fecha / Bloque</th>
              <th>Espacio</th>
              <th>Unidad</th>
              <th>Costo</th>
              <th>Estado</th>
              <th style="text-align: right">Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaReservas">
            <tr>
              <td
                colspan="6"
                style="text-align: center; padding: 30px; color: #94a3b8"
              >
                Cargando reservas...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>

    <div id="spinner" class="spinner-overlay">
      <div
        style="
          width: 40px;
          height: 40px;
          border-radius: 50%;
          border: 4px solid #e2e8f0;
          border-top-color: #1a2b48;
          animation: spin 1s linear infinite;
        "
      ></div>
    </div>

    <div id="footer"></div>

    <script>
    let RESERVAS = [], ESPACIOS = [], UNIDADES = [], BLOQUES = [], COPROPIEDADES = [], VIEW = [];

    document.addEventListener("DOMContentLoaded", async () => {
      try { document.getElementById("header").innerHTML = await (await fetch("header.html")).text(); } catch(e){}
      try { document.getElementById("footer").innerHTML = await (await fetch("footer.html")).text(); } catch(e){}
      
      document.getElementById("filtroFecha").value = new Date().toISOString().split('T')[0];
      
      await cargarDatos();
    });

    async function cargarDatos() {
      showSpinner(true);
      try {
        // CARGAMOS LAS 5 TABLAS NECESARIAS PARA CRUZAR DATOS
        const [reservas, espacios, unidades, bloques, copropiedades] = await Promise.all([
          fetchData("Reservas").catch(()=>[]),
          fetchData("Espacios").catch(()=>[]), 
          fetchData("Unidades").catch(()=>[]),
          fetchData("Bloques").catch(()=>[]),
          fetchData("Copropiedades").catch(()=>[]) // Nueva carga
        ]);

        RESERVAS = reservas || [];
        ESPACIOS = espacios || []; 
        UNIDADES = unidades || [];
        BLOQUES = bloques || [];
        COPROPIEDADES = copropiedades || [];

        // Llenar select espacios
        const uniqueSpaces = [...new Set(RESERVAS.map(r => r.EspacioNombre || r.EspacioID))].filter(Boolean);
        const selEspacio = document.getElementById("filtroEspacio");
        selEspacio.innerHTML = '<option value="">(Todos)</option>' + 
          uniqueSpaces.map(s => `<option value="${s}">${s}</option>`).join("");

        aplicarFiltros();

      } catch(e) {
        console.error(e);
        document.getElementById("tablaReservas").innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">Error: ${e.message}</td></tr>`;
      } finally {
        showSpinner(false);
      }
    }

    function aplicarFiltros() {
      const fecha = document.getElementById("filtroFecha").value;
      const espacio = document.getElementById("filtroEspacio").value.toLowerCase();
      const estado = document.getElementById("filtroEstado").value;
      const busqueda = document.getElementById("filtroBuscar").value.toLowerCase();

      VIEW = RESERVAS.filter(r => {
        if(fecha && (!r.Fecha || !r.Fecha.includes(fecha))) return false;
        if(estado && r.Estado !== estado) return false;
        
        const spName = (r.EspacioNombre || r.EspacioID || "").toLowerCase();
        if(espacio && !spName.includes(espacio)) return false;

        const uLabel = resolverUnidad(r.UnidadID).toLowerCase();
        if(busqueda && !uLabel.includes(busqueda)) return false;

        return true;
      });

      // Ordenar por hora
      VIEW.sort((a,b) => {
        if(a.Estado === 'Pendiente' && b.Estado !== 'Pendiente') return -1;
        if(a.Estado !== 'Pendiente' && b.Estado === 'Pendiente') return 1;
        const horaA = getBlockStart(a.Bloque);
        const horaB = getBlockStart(b.Bloque);
        return horaA.localeCompare(horaB);
      });

      renderTabla();
    }

    function renderTabla() {
      const tb = document.getElementById("tablaReservas");
      if(VIEW.length === 0) {
        tb.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:#64748b;">No hay reservas con estos filtros.</td></tr>';
        return;
      }

      const conflictMap = {};
      VIEW.forEach(r => {
        if(r.Estado === 'Rechazada') return;
        const key = `${r.Fecha}_${r.EspacioID}_${r.Bloque}`;
        conflictMap[key] = (conflictMap[key] || 0) + 1;
      });

      tb.innerHTML = VIEW.map(r => {
        const uLabel = resolverUnidad(r.UnidadID);
        const bloqueInfo = resolveBlockInfo(r.Bloque);
        let stClass = "st-pendiente";
        if(r.Estado === 'Confirmada') stClass = "st-confirmada";
        if(r.Estado === 'Rechazada') stClass = "st-rechazada";

        const key = `${r.Fecha}_${r.EspacioID}_${r.Bloque}`;
        const isConflict = (conflictMap[key] > 1 && r.Estado !== 'Rechazada');
        const rowClass = isConflict ? "conflict-row" : "";
        const conflictHtml = isConflict ? `<span class="conflict-msg"><i class="fa-solid fa-triangle-exclamation"></i> Tope de horario</span>` : "";

        let acciones = "";
        if(r.Estado === 'Pendiente') {
          acciones = `
            <button class="btn-icon btn-approve" onclick="cambiarEstado('${r.ID}', 'Confirmada')" title="Aprobar"><i class="fa-solid fa-check"></i></button>
            <button class="btn-icon btn-reject" onclick="cambiarEstado('${r.ID}', 'Rechazada')" title="Rechazar"><i class="fa-solid fa-xmark"></i></button>
          `;
        } else if (r.Estado === 'Confirmada') {
           acciones = `<button class="btn-icon btn-reject" onclick="cambiarEstado('${r.ID}', 'Rechazada')" title="Cancelar"><i class="fa-solid fa-ban"></i></button>`;
        }
        
        acciones += `<button class="btn-icon btn-delete" onclick="eliminarReserva('${r.ID}')"><i class="fa-solid fa-trash"></i></button>`;

        return `
          <tr class="${rowClass}">
            <td><div style="font-weight:700;">${formatearFecha(r.Fecha)}</div>${bloqueInfo}${conflictHtml}</td>
            <td>${r.EspacioNombre || r.EspacioID}</td>
            <td style="font-weight:600; color:#1e293b;">${uLabel}</td>
            <td class="mono">${clp(r.Costo)}</td>
            <td><span class="badge ${stClass}">${r.Estado || "Pendiente"}</span></td>
            <td style="text-align:right;">${acciones}</td>
          </tr>
        `;
      }).join("");
    }

    /* --- LÓGICA PRINCIPAL DE CAMBIO DE ESTADO Y CORREO --- */
    async function cambiarEstado(id, nuevoEstado) {
      if(!confirm(`¿Marcar reserva como ${nuevoEstado}?`)) return;
      showSpinner(true);
      
      try {
        // 1. OBTENER TODOS LOS DATOS RELACIONADOS
        const reserva = RESERVAS.find(r => r.ID === id);
        if (!reserva) throw new Error("Reserva no encontrada");

        // Datos Unidad
        const unidad = UNIDADES.find(u => String(u.ID) === String(reserva.UnidadID));
        const nombreResidente = unidad ? (unidad.Nombre || "Residente") : "Residente";
        const numeroUnidad = unidad ? (unidad.Numero || reserva.UnidadID) : reserva.UnidadID;
        const emailDestino = unidad ? unidad.Email : null;

        // Datos Espacio y Comunidad
        const espacio = ESPACIOS.find(e => String(e.ID) === String(reserva.EspacioID));
        const nombreEspacio = espacio ? espacio.Nombre : (reserva.EspacioNombre || "Espacio Común");
        
        // Buscar Comunidad (cruzando ID del espacio)
        let nombreComunidad = "Condominio Santa Josefina"; // Default
        if (espacio && espacio.CopropiedadID) {
            const copro = COPROPIEDADES.find(c => String(c.ID) === String(espacio.CopropiedadID));
            if (copro) nombreComunidad = copro.Nombre;
        }

        // Datos Bloque (Horario bonito)
        let textoBloque = reserva.Bloque;
        const bloqueObj = BLOQUES.find(b => b.ID === reserva.Bloque || b.Nombre === reserva.Bloque);
        if (bloqueObj) {
            textoBloque = `${bloqueObj.Nombre} (${bloqueObj.HoraInicio} - ${bloqueObj.HoraFin})`;
        }

        // 2. ACTUALIZAR BD
        if(typeof appSheetCRUD === 'function') {
          await appSheetCRUD("Reservas", "Edit", [{ "ID": id, "Estado": nuevoEstado }]);
        }

        // 3. ENVIAR CORREO PERSONALIZADO
        if(emailDestino && typeof enviarEmailAPI === 'function') {
            const asunto = `${nuevoEstado}: Solicitud de Reserva ${nombreEspacio}`;
            
            // Generar HTML con todos los datos recolectados
            const cuerpoHTML = generarPlantillaEmail({
                estado: nuevoEstado,
                residente: nombreResidente,
                unidad: numeroUnidad,
                espacio: nombreEspacio,
                comunidad: nombreComunidad,
                fecha: reserva.Fecha,
                bloque: textoBloque
            });

            // Enviar sin await para no bloquear
            enviarEmailAPI(emailDestino, asunto, cuerpoHTML);
        } else {
            console.warn("No se envió correo: Falta email o librería.");
        }

        await cargarDatos(); 

      } catch(e) {
        console.error(e);
        alert("Error: " + e.message);
      } finally {
        showSpinner(false);
      }
    }

    /* --- PLANTILLA DE CORREO MEJORADA --- */
    function generarPlantillaEmail(datos) {
      const esAprobado = datos.estado === 'Confirmada';
      const color = esAprobado ? '#10b981' : '#ef4444'; // Verde o Rojo
      const titulo = esAprobado ? '¡Solicitud Aprobada!' : 'Solicitud Rechazada';
      const textoIntro = esAprobado 
        ? 'Nos complace informarle que su solicitud de reserva ha sido aprobada exitosamente.' 
        : 'Lamentamos informarle que su solicitud de reserva no ha podido ser cursada en esta ocasión debido a disponibilidad o normativas vigentes.';

      // Formato Fecha Larga (ej: Lunes 10 de Enero, 2026)
      const fechaObj = new Date(datos.fecha);
      const fechaTexto = fechaObj.toLocaleDateString('es-CL', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

      return `
        <div style="background-color: #f4f4f7; padding: 30px; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; color: #51545E;">
          <div style="max-width: 600px; margin: 0 auto; background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            
            <div style="background-color: #1A2B48; padding: 25px; text-align: center;">
               <h2 style="color: #ffffff; margin: 0; font-size: 20px; font-weight: 600;">Gestión de Reservas</h2>
               <div style="color: #aeb4c1; font-size: 13px; margin-top: 5px;">${datos.comunidad}</div>
            </div>

            <div style="padding: 40px 30px;">
               <h1 style="color: #333333; font-size: 24px; font-weight: bold; margin-top: 0; text-align:center;">${titulo}</h1>
               
               <p style="font-size: 16px; line-height: 1.5;">
                 Estimado(a) <strong>${datos.residente}</strong>,<br>
                 Residente de la Unidad <strong>${datos.unidad}</strong>.
               </p>
               
               <p style="font-size: 15px; line-height: 1.5; color: #555;">${textoIntro}</p>

               <div style="background-color: #f8fafc; border-left: 5px solid ${color}; padding: 20px; margin: 25px 0; border-radius: 4px;">
                  <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                      <td style="padding: 5px 0; color: #1A2B48; font-weight: bold; width: 100px;">Espacio:</td>
                      <td style="padding: 5px 0;">${datos.espacio}</td>
                    </tr>
                    <tr>
                      <td style="padding: 5px 0; color: #1A2B48; font-weight: bold;">Fecha:</td>
                      <td style="padding: 5px 0;">${fechaTexto}</td>
                    </tr>
                    <tr>
                      <td style="padding: 5px 0; color: #1A2B48; font-weight: bold;">Horario:</td>
                      <td style="padding: 5px 0;">${datos.bloque}</td>
                    </tr>
                    <tr>
                      <td style="padding: 5px 0; color: #1A2B48; font-weight: bold;">Estado:</td>
                      <td style="padding: 5px 0; color: ${color}; font-weight: bold; text-transform: uppercase;">${datos.estado}</td>
                    </tr>
                  </table>
               </div>

               <p style="font-size: 13px; color: #888; text-align: center; margin-top: 30px;">
                 Para ver más detalles o cancelar su reserva (si aplica), por favor ingrese al Portal de Residentes.
               </p>
            </div>

            <div style="background-color: #f4f4f7; padding: 20px; text-align: center; font-size: 12px; color: #999;">
               <p style="margin: 0;">&copy; ${new Date().getFullYear()} ${datos.comunidad}. Todos los derechos reservados.</p>
            </div>
          </div>
        </div>
      `;
    }

    // --- EMAILJS ---
    async function enviarEmailAPI(to, subject, htmlBody) {
      console.log(">>> Enviando a:", to);
      if (typeof emailjs === 'undefined') return console.error("EmailJS no cargado");

      try {
          await emailjs.send('service_p9hqkqn', 'template_80q9psi', {
              to_email: to,
              subject: subject,
              html_body: htmlBody 
          });
          console.log(">>> Email enviado correctamente.");
          // No hacemos alert aquí para no interrumpir el flujo visual del admin
      } catch (error) {
          console.error(">>> Error EmailJS:", error);
          alert("La reserva se actualizó, pero falló el envío del correo.");
      }
    }

    /* --- HELPERS GENÉRICOS --- */
    async function eliminarReserva(id) {
      if(!confirm("¿Eliminar registro?")) return;
      showSpinner(true);
      try {
        if(typeof appSheetCRUD === 'function') await appSheetCRUD("Reservas", "Delete", [{ "ID": id }]);
        await cargarDatos();
      } catch(e) { alert("Error: " + e.message); } finally { showSpinner(false); }
    }

    function resolveBlockInfo(bloqueVal) {
        if(!bloqueVal) return `<div style="color:#94a3b8; font-size:13px;">--</div>`;
        const b = BLOQUES.find(x => x.ID === bloqueVal || x.Nombre === bloqueVal);
        if (b) return `<div style="font-size:13px; color:#1A2B48; font-weight:600;">${b.Nombre}</div><div style="font-size:11px; color:#64748b;">${b.HoraInicio} - ${b.HoraFin}</div>`;
        return `<div style="color:#64748b; font-size:13px;">${bloqueVal}</div>`;
    }

    function getBlockStart(bloqueVal) {
        if(!bloqueVal) return "99:99";
        const b = BLOQUES.find(x => x.ID === bloqueVal || x.Nombre === bloqueVal);
        return b ? b.HoraInicio : "99:99";
    }

    function resolverUnidad(id) {
      const u = UNIDADES.find(x => String(x.ID || x.id) === String(id));
      return u ? (u.Numero || u.Nombre) : id;
    }
    function formatearFecha(iso) { 
      if(!iso) return ""; 
      const [y,m,d] = iso.split("-");
      return `${d}/${m}/${y}`;
    }
    function clp(v) { return "$" + new Intl.NumberFormat("es-CL").format(v || 0); }
    function showSpinner(show) { document.getElementById("spinner").style.display = show ? "grid" : "none"; }
</script>
  </body>
</html>
