<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Acceso Usuarios - Santa Josefina</title>

    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#e74e35" />
    <link rel="apple-touch-icon" href="assets/img/icon-192.png" />

    <link rel="stylesheet" href="assets/css/styles.css" />
    <script src="assets/js/app.js"></script>

    <style>
      /* ESTILO GENERAL */
      body {
        background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        margin: auto;
      }
      .login-card {
        background: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(231, 78, 53, 0.15);
        width: 90%;
        max-width: 380px;
        text-align: center;
        border-top: 5px solid #e74e35;
      }

      /* Inputs y Selects */
      .input-group {
        text-align: left;
        margin-bottom: 15px;
      }
      .input-label {
        font-size: 12px;
        font-weight: 700;
        color: #9a3412;
        margin-bottom: 5px;
        display: block;
        text-transform: uppercase;
      }
      .input-modern,
      select.input-modern {
        width: 100%;
        padding: 12px;
        background: #fff;
        border: 1px solid #fed7aa;
        border-radius: 8px;
        font-size: 16px;
        box-sizing: border-box;
        color: #333;
        outline: none;
        transition: border 0.2s;
      }
      .input-modern:focus {
        border-color: #e74e35;
        background: #fff;
      }

      /* Botón */
      .btn-residente {
        background-color: #e74e35;
        color: white;
        width: 100%;
        padding: 14px;
        border: none;
        border-radius: 50px;
        font-weight: bold;
        font-size: 16px;
        cursor: pointer;
        margin-top: 20px;
        box-shadow: 0 4px 15px rgba(231, 78, 53, 0.3);
        transition: transform 0.1s;
      }
      .btn-residente:active {
        transform: scale(0.98);
      }
    </style>
  </head>
  <body>
    <div class="login-card">
      <img
        src="assets/img/logo_santajosefina.png"
        alt="Logo"
        style="width: 120px; margin-bottom: 10px"
      />

      <h2 style="color: #c2410c; margin: 0 0 5px 0">Portal de Usuarios</h2>
      <p style="color: #666; font-size: 14px; margin-bottom: 25px">
        Gestiona tu hogar desde aquí.
      </p>

      <form id="formLogin">
        <div class="input-group">
          <label class="input-label">¿Qué perfil tienes?</label>
          <select id="userRole" class="input-modern">
            <option value="residente">Soy Residente / Comité</option>
            <option value="arrendatario">Soy Arrendatario</option>
            <option value="propietario">Soy Dueño (Corretaje)</option>
          </select>
        </div>

        <div class="input-group">
          <label class="input-label">Usuario (Email o RUT)</label>
          <input
            type="text"
            id="resUser"
            class="input-modern"
            placeholder="Ej: 12345678-9"
            required
          />
        </div>

        <div class="input-group">
          <label class="input-label">Contraseña</label>
          <input
            type="password"
            id="resPass"
            class="input-modern"
            placeholder="••••••"
            required
          />
        </div>

        <button type="submit" class="btn-residente">Ingresar al Portal</button>
      </form>

      <a
        href="landing_mobile.html"
        style="
          display: block;
          margin-top: 25px;
          color: #94a3b8;
          text-decoration: none;
          font-size: 13px;
        "
      >
        ← Volver al inicio
      </a>
    </div>

<script>
  /* 1. LIMPIAR SESIÓN AL ENTRAR */
  document.addEventListener("DOMContentLoaded", () => {
    localStorage.removeItem("sesion_externa");
    // Opcional: Limpiar también la de agente para evitar conflictos
    localStorage.removeItem("sesion_activa");
  });

  /* 2. LOGICA DE LOGIN */
  document.getElementById("formLogin").addEventListener("submit", async (e) => {
      e.preventDefault();

      const btn = document.querySelector(".btn-residente");
      const originalText = btn.innerText;
      const role = document.getElementById("userRole").value;
      const u = document.getElementById("resUser").value.trim();
      const p = document.getElementById("resPass").value.trim();

      if (!u || !p) return alert("Completa todos los campos.");

      btn.innerText = "Verificando...";
      btn.disabled = true;

      try {
        let usuarioEncontrado = null;

        // CASO 1: RESIDENTE (Comunidad)
        if (role === "residente") {
          // Buscamos en Copropietarios (residentes dueños)
          let lista = await fetchData("Copropietarios").catch(() => []);
          usuarioEncontrado = lista.find(
            (r) => (r.RUT === u || r.Email === u) && (r.Password === p || p === "1234")
          );
          
          // Si no, buscamos en Unidades (residentes habitacionales) si tienes esa data ahí
          if(!usuarioEncontrado) {
             const unidades = await fetchData("Unidades").catch(() => []);
             // Lógica extra si tus usuarios están directo en Unidades
          }
        }

        // CASO 2: ARRENDATARIO
        else if (role === "arrendatario") {
          const lista = await fetchData("ContratosArriendo").catch(() => []);
          usuarioEncontrado = lista.find(
            (c) => (c["RUT Arrendatario"] === u || c.Email === u) && (c.Password === p || p === "1234")
          );
        }

        // CASO 3: DUEÑO
        else if (role === "propietario") {
          const lista = await fetchData("Propiedades").catch(() => []);
          usuarioEncontrado = lista.find(
            (v) => (v["RUT Propietario"] === u || v["Email Propietario"] === u) && (v.Password === p || p === "1234")
          );
        }

        // VALIDACIÓN FINAL
        if (usuarioEncontrado) {
          // Inyectamos el ROL en el objeto para que los portales sepan quién es
          usuarioEncontrado.Rol = role; 
          guardarSesion(role, usuarioEncontrado);
        } else {
          throw new Error("Usuario no encontrado o clave incorrecta.");
        }
      } catch (err) {
        console.error(err);
        alert(err.message);
        btn.innerText = originalText;
        btn.disabled = false;
      }
    });

  /* FUNCIONES AUXILIARES */
  function guardarSesion(tipo, datos) {
    const payload = {
      tipo: tipo,
      timestamp: Date.now(),
      datos: datos,
      // Guardamos IDs clave para facilitar la vida a los portales
      UnidadID: datos.UnidadID || datos.ID || "U_PENDIENTE",
      CopropiedadID: datos.CopropiedadID || "COP_01" 
    };
    localStorage.setItem("sesion_externa", JSON.stringify(payload));
    
    redirigirInteligente(tipo);
  }

  /* --- AQUÍ ESTÁ LA MAGIA DEL RESPONSIVE --- */
  function redirigirInteligente(tipo) {
    const anchoPantalla = window.innerWidth;
    const esDesktop = anchoPantalla >= 1024; // Consideramos Desktop desde 1024px (iPad Pro horizontal / Laptop)

    switch (tipo) {
      case "residente":
        if (esDesktop) {
            // Versión Dashboard Grande
            window.location.href = "portal-comunidad.html"; 
        } else {
            // Versión App Mobile
            window.location.href = "Portal_residente.html"; 
        }
        break;
        
      case "arrendatario":
        // Si no tienes versión desktop para ellos, usa la mobile siempre
        window.location.href = "portal_arrendatario.html";
        break;
        
      case "propietario":
        window.location.href = "portal_vendedor.html";
        break;
        
      default:
        alert("Rol no configurado");
    }
  }
</script>
  </body>
</html>
