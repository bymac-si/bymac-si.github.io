<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Reclamos - Santa Josefina</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="assets/css/styles.css">
  <script src="assets/js/app.js"></script>
  
  <style>
    /* Estilos App Mobile */
    body { background-color: #f8fafc; padding-bottom: 90px; }
    
    .app-header-simple {
      background: white; padding: 15px 20px;
      display: flex; align-items: center; gap: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      position: sticky; top: 0; z-index: 100;
    }
    .page-title { font-size: 18px; font-weight: 700; color: #1e293b; margin: 0; }
    .btn-back { color: #64748b; font-size: 18px; text-decoration: none; }

    /* Tabs de Navegación (Nuevo vs Historial) */
    .tabs-container { display: flex; padding: 15px; gap: 10px; }
    .tab-btn {
      flex: 1; padding: 10px; border-radius: 8px; border: none;
      font-weight: 600; font-size: 14px; cursor: pointer;
      background: white; color: #64748b; border: 1px solid #e2e8f0;
      transition: all 0.2s;
    }
    .tab-btn.active { background: #1A2B48; color: white; border-color: #1A2B48; }

    /* Contenedores de Vistas */
    .view-section { display: none; padding: 0 15px; }
    .view-section.active { display: block; }

    /* Estilos Formulario (Reutilizados) */
    .form-group { margin-bottom: 20px; }
    .label-app { display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 8px; }
    .input-app, .textarea-app, .select-app {
      width: 100%; padding: 14px; border: 1px solid #cbd5e1;
      border-radius: 12px; font-size: 15px; background: white;
      box-sizing: border-box;
    }
    
    /* Upload Área */
    .upload-box {
      border: 2px dashed #cbd5e1; border-radius: 12px; padding: 20px;
      text-align: center; color: #64748b; position: relative; background: white;
    }
    .upload-box.has-file { border-color: #10b981; background: #ecfdf5; color: #065f46; }

    /* Tarjetas de Historial */
    .ticket-card {
      background: white; padding: 15px; border-radius: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.03); margin-bottom: 10px;
      border-left: 4px solid #cbd5e1; position: relative;
    }
    .ticket-card.status-pendiente { border-left-color: #f59e0b; }
    .ticket-card.status-proceso { border-left-color: #3b82f6; }
    .ticket-card.status-resuelto { border-left-color: #10b981; }

    .t-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
    .t-cat { font-size: 11px; font-weight: 700; text-transform: uppercase; color: #64748b; }
    .t-date { font-size: 11px; color: #94a3b8; }
    .t-desc { font-weight: 600; color: #1e293b; font-size: 14px; margin-bottom: 5px; }
    .t-status { font-size: 11px; padding: 2px 8px; border-radius: 10px; background: #f1f5f9; color: #475569; display: inline-block; }

    /* Modal Detalle */
    .modal-full {
      position: fixed; inset: 0; background: white; z-index: 2000;
      display: none; flex-direction: column;
    }
    .modal-full.active { display: flex; }
    .modal-body { flex: 1; overflow-y: auto; padding: 20px; }
    .chat-bubble {
      background: #f1f5f9; padding: 10px 15px; border-radius: 12px;
      margin-bottom: 10px; font-size: 13px; max-width: 85%;
    }
    .chat-bubble.admin { background: #e0f2fe; color: #0369a1; margin-left: auto; border-bottom-right-radius: 2px; }
    .chat-bubble.user { background: #f1f5f9; color: #334155; border-bottom-left-radius: 2px; }

    .btn-submit {
      background: #1A2B48; color: white; width: 100%; padding: 15px;
      border: none; border-radius: 12px; font-weight: 700; cursor: pointer;
    }
  </style>
</head>
<body>

  <div class="app-header-simple">
    <a href="portal.html" class="btn-back"><i class="fa-solid fa-arrow-left"></i></a>
    <h1 class="page-title">Centro de Ayuda</h1>
  </div>

  <div class="tabs-container">
    <button class="tab-btn active" onclick="switchTab('new')">Nuevo Reclamo</button>
    <button class="tab-btn" onclick="switchTab('history')">Mis Tickets</button>
  </div>

  <div id="viewNew" class="view-section active">
    <form id="formTicket">
      <div class="form-group">
        <label class="label-app">Categoría</label>
        <select id="catTicket" class="select-app" required>
          <option value="">Selecciona...</option>
          <option value="Mantención">Mantención / Reparaciones</option>
          <option value="Ruidos">Ruidos Molestos</option>
          <option value="Seguridad">Seguridad / Acceso</option>
          <option value="Aseo">Aseo y Limpieza</option>
          <option value="Administración">Administración / Gastos Comunes</option>
        </select>
      </div>

      <div class="form-group">
        <label class="label-app">Descripción del problema</label>
        <textarea id="descTicket" class="textarea-app" rows="4" placeholder="Describe qué pasó, dónde y cuándo..." required></textarea>
      </div>

      <div class="form-group">
        <label class="label-app">Evidencia (Foto)</label>
        <div class="upload-box" id="uploadArea">
          <i class="fa-solid fa-camera" style="font-size:24px; margin-bottom:5px;"></i>
          <div style="font-size:12px;">Toca para subir foto</div>
          <input type="file" id="fileInput" accept="image/*" style="position:absolute; inset:0; opacity:0;" onchange="previewFile()">
        </div>
      </div>

      <button type="submit" class="btn-submit">Enviar Solicitud</button>
    </form>
  </div>

  <div id="viewHistory" class="view-section">
    <div id="listaTickets">
      <div style="text-align:center; padding:40px; color:#94a3b8;">Cargando...</div>
    </div>
  </div>

  <div id="modalTicket" class="modal-full">
    <div class="app-header-simple" style="box-shadow:none; border-bottom:1px solid #eee;">
      <button class="btn-back" onclick="cerrarModal()" style="background:none; border:none; cursor:pointer;"><i class="fa-solid fa-xmark"></i></button>
      <h1 class="page-title">Detalle Ticket #<span id="mdlID"></span></h1>
    </div>
    
    <div class="modal-body">
      <div style="margin-bottom:20px;">
        <span class="t-cat" id="mdlCat">CATEGORÍA</span>
        <h2 style="margin:5px 0 10px; font-size:18px;" id="mdlDesc">...</h2>
        <div id="mdlStatus" class="badge">...</div>
        
        <div id="mdlFotoContainer" style="margin-top:15px; display:none;">
          <img id="mdlFoto" src="" style="width:100%; border-radius:8px; border:1px solid #eee;">
        </div>
      </div>

      <hr style="border:none; border-top:1px solid #eee; margin:20px 0;">
      
      <h3 style="font-size:14px; margin-bottom:15px;">Seguimiento</h3>
      <div id="chatContainer">
        </div>
    </div>
  </div>

  <div id="spinner" style="position:fixed; inset:0; background:rgba(255,255,255,0.8); display:none; place-items:center; z-index:3000;">
    <div style="width:30px; height:30px; border-radius:50%; border:3px solid #ccc; border-top-color:#1A2B48; animation:spin .8s linear infinite;"></div>
  </div>

  <script>
    const USUARIO = { UnidadID: "101" };
    let FILE_BASE64 = null;
    
    // MOCK DATA (Simulación Backend)
    const TICKETS_MOCK = [
      { ID: 'REQ_992', Categoria: 'Mantención', Descripcion: 'Foco quemado en pasillo piso 3', Estado: 'Pendiente', Fecha: '2026-01-08', Respuestas: [] },
      { ID: 'REQ_881', Categoria: 'Ruidos', Descripcion: 'Fiesta ruidosa unidad 305 pasada las 2 AM', Estado: 'Resuelto', Fecha: '2025-12-20', FotoURL: 'assets/img/demo.jpg', Respuestas: [
          { autor: 'Admin', texto: 'Se cursó multa según reglamento. Gracias por avisar.' }
      ]}
    ];

    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
      
      if(tab === 'new') {
        document.querySelector('button[onclick="switchTab(\'new\')"]').classList.add('active');
        document.getElementById('viewNew').classList.add('active');
      } else {
        document.querySelector('button[onclick="switchTab(\'history\')"]').classList.add('active');
        document.getElementById('viewHistory').classList.add('active');
        cargarHistorial();
      }
    }

    function previewFile() {
        const file = document.getElementById("fileInput").files[0];
        const box = document.getElementById("uploadArea");
        if (file) {
            box.classList.add("has-file");
            box.innerHTML = `<i class="fa-solid fa-check"></i> ${file.name}`;
            const reader = new FileReader();
            reader.onload = (e) => FILE_BASE64 = e.target.result;
            reader.readAsDataURL(file);
        }
    }

    /* 1. CREAR TICKET */
    document.getElementById("formTicket").onsubmit = async (e) => {
        e.preventDefault();
        document.getElementById("spinner").style.display = "grid";

        const payload = {
            ID: "REQ_" + Date.now().toString().slice(-4),
            UnidadID: USUARIO.UnidadID,
            Categoria: document.getElementById("catTicket").value,
            Descripcion: document.getElementById("descTicket").value,
            FotoURL: FILE_BASE64, // Base64
            Estado: "Pendiente",
            Fecha: new Date().toISOString().split('T')[0]
        };

        try {
            if(typeof appSheetCRUD === 'function') {
                await appSheetCRUD("Tickets", "Add", [payload]);
            } else {
                // Simulación local
                TICKETS_MOCK.unshift(payload); 
                await new Promise(r => setTimeout(r, 1500));
            }
            
            alert("Solicitud enviada correctamente.");
            document.getElementById("formTicket").reset();
            FILE_BASE64 = null;
            document.getElementById("uploadArea").classList.remove("has-file");
            document.getElementById("uploadArea").innerHTML = `<i class="fa-solid fa-camera" style="font-size:24px; margin-bottom:5px;"></i><div style="font-size:12px;">Toca para subir foto</div><input type="file" id="fileInput" accept="image/*" style="position:absolute; inset:0; opacity:0;" onchange="previewFile()">`;
            
            switchTab('history'); // Ir al historial para verla

        } catch(err) {
            alert("Error: " + err.message);
        } finally {
            document.getElementById("spinner").style.display = "none";
        }
    };

    /* 2. VER HISTORIAL */
    async function cargarHistorial() {
        const container = document.getElementById("listaTickets");
        // Aquí deberías hacer fetchData('Tickets') filtrando por unidad
        const tickets = TICKETS_MOCK; 

        if(tickets.length === 0) {
            container.innerHTML = '<div style="text-align:center; margin-top:30px; color:#94a3b8;">No tienes solicitudes registradas.</div>';
            return;
        }

        container.innerHTML = tickets.map(t => {
            let statusClass = 'status-pendiente';
            if(t.Estado === 'En Proceso') statusClass = 'status-proceso';
            if(t.Estado === 'Resuelto') statusClass = 'status-resuelto';

            return `
            <div class="ticket-card ${statusClass}" onclick='abrirDetalle(${JSON.stringify(t)})'>
                <div class="t-header">
                    <span class="t-cat">${t.Categoria}</span>
                    <span class="t-date">${t.Fecha}</span>
                </div>
                <div class="t-desc">${t.Descripcion}</div>
                <div class="t-status">${t.Estado}</div>
                ${t.Respuestas && t.Respuestas.length > 0 ? '<i class="fa-solid fa-comment-dots" style="float:right; color:#3b82f6;"></i>' : ''}
            </div>
            `;
        }).join("");
    }

    /* 3. VER DETALLE */
    function abrirDetalle(t) {
        document.getElementById("mdlID").textContent = t.ID;
        document.getElementById("mdlCat").textContent = t.Categoria;
        document.getElementById("mdlDesc").textContent = t.Descripcion;
        
        const imgCont = document.getElementById("mdlFotoContainer");
        if(t.FotoURL) {
            imgCont.style.display = "block";
            document.getElementById("mdlFoto").src = t.FotoURL;
        } else {
            imgCont.style.display = "none";
        }

        // Render Chat (Respuestas)
        const chat = document.getElementById("chatContainer");
        chat.innerHTML = "";
        
        // Mensaje original del usuario
        chat.innerHTML += `<div class="chat-bubble user"><b>Tú:</b> ${t.Descripcion}</div>`;

        if(t.Respuestas && t.Respuestas.length > 0) {
            t.Respuestas.forEach(r => {
                chat.innerHTML += `<div class="chat-bubble admin"><b>${r.autor}:</b> ${r.texto}</div>`;
            });
        } else {
            chat.innerHTML += `<div style="font-size:12px; color:#94a3b8; text-align:center; margin-top:10px;">Esperando respuesta de administración...</div>`;
        }

        document.getElementById("modalTicket").classList.add("active");
    }

    function cerrarModal() {
        document.getElementById("modalTicket").classList.remove("active");
    }
  </script>
</body>
</html>