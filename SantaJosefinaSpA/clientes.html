<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>CRM - Gesti√≥n de Clientes</title>

   <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#1a2b48" />
    <script src="assets/js/app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
      (function () {
        emailjs.init("7Il4AhmGHchP7qfxu");
      })();
      if (typeof requireAuth === "function") requireAuth();
    </script>

    <style>
      /* ===== ESTILOS BASE (Tu dise√±o original) ===== */
      body {
        max-width: 1300px;
        margin: 0 auto;
        color: #1a2b48;
        background-color: #f8fafc;
      }
      main {
        padding: 40px;
      }
      .page-title {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 16px;
      }

      /* Tablas */
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 10px 8px;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
        vertical-align: middle;
      }
      th {
        background: #fafafa;
        font-weight: 600;
        color: #4b5563;
      }

      /* Inputs */
      .modal input,
      .modal select,
      .modal textarea {
        width: 95%;
        box-sizing: border-box;
      }
      input,
      select,
      textarea {
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-family: inherit;
      }
      .label {
        display: block;
        font-weight: 600;
        margin-bottom: 4px;
        font-size: 13px;
        color: #374151;
      }

      /* MODAL */
      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        z-index: 10000;
        align-items: center;
        justify-content: center;
      }
      .modal.active {
        display: flex;
      }
      .modal-content {
        width: 100%;
        max-width: 600px;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.18);
        max-height: 90vh;
        overflow-y: auto;
      }

      /* SPINNER */
      .spinner-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.85);
        display: none;
        place-items: center;
        z-index: 12000;
      }
      .spinner-card {
        background: #fff;
        padding: 18px 22px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
        text-align: center;
        min-width: 260px;
        color: #1a2b48;
        font-weight: 600;
      }
      .spinner {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 3px solid #eee;
        border-top-color: #b46a55;
        margin: 0 auto 10px;
        animation: spin 0.9s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .mono {
        font-family: ui-monospace, monospace;
      }
      .muted {
        color: #666;
        font-size: 0.9em;
      }

      /* HEADER & FILTROS */
      .dashboard-header {
        background-color: #fff;
        padding: 20px 25px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        margin-bottom: 25px;
        border: 1px solid #f0f0f0;
      }
      .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
      }
      .header-actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .header-filters {
        display: flex;
        gap: 15px;
        align-items: flex-end;
        flex-wrap: wrap;
        padding-top: 20px;
        border-top: 1px solid #e2e8f0;
      }
      .filter-item {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .input-modern {
        height: 44px;
        padding: 0 12px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        font-size: 14px;
        background-color: #f8fafc;
        width: 95%;
        height: 38px;
      }

      /* BOTONES */
      .acciones-group {
        display: flex;
        gap: 6px;
        justify-content: flex-start;
        align-items: center;
      }
      .btn-icon {
        width: 34px;
        height: 34px;
        border: none;
        border-radius: 6px;
        background-color: #f3f4f6;
        color: #555;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: all 0.2s ease;
      }
      .btn-icon:hover {
        transform: translateY(-2px);
        color: white;
      }
      .btn-editar:hover {
        background-color: #f59e0b;
      }
      .btn-eliminar:hover {
        background-color: #ef4444;
      }

      .btn-head {
        height: 44px;
        padding: 0 20px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.2s;
      }
      .btn-head:hover {
        transform: translateY(-2px);
      }
      .btn-nuevo {
        background-color: #0f172a;
        color: white;
      }
      .btn-secundario {
        background-color: #fff;
        color: #475569;
        border: 1px solid #cbd5e1;
      }
      .btn-secundario:hover {
        background-color: #f8fafc;
        border-color: #94a3b8;
      }

      /* ===== NUEVOS ESTILOS CRM (Seguimiento) ===== */
      /* Badges */
      .seg-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .seg-vip {
        background: #fef3c7;
        color: #b45309;
        border: 1px solid #fcd34d;
      }
      .seg-inversionista {
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #bfdbfe;
      }
      .seg-habitacional {
        background: #f3f4f6;
        color: #4b5563;
        border: 1px solid #e5e7eb;
      }

      .st-activo {
        color: #166534;
        background: #dcfce7;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: bold;
      }
      .st-inactivo {
        color: #991b1b;
        background: #fee2e2;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: bold;
      }

      /* Chat Timeline */
      .chat-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
        max-height: 350px;
        overflow-y: auto;
        padding: 15px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        margin-top: 10px;
      }
      .chat-bubble {
        background: white;
        padding: 12px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        position: relative;
        border-left: 4px solid #3b82f6;
      }
      .chat-bubble.Compromiso {
        border-left-color: #e11d48;
        background: #fff1f2;
      }
      .chat-bubble.Reunion {
        border-left-color: #10b981;
      }
      .chat-meta {
        font-size: 11px;
        color: #94a3b8;
        margin-bottom: 4px;
        display: flex;
        justify-content: space-between;
      }
      .chat-text {
        font-size: 13px;
        color: #334155;
        line-height: 1.4;
      }
    </style>
  </head>
  <body>
    <div id="header"></div>

    <main>
      <div class="dashboard-header no-print">
        <div class="header-top">
          <h1 class="page-title">Gesti√≥n de Clientes</h1>
          <div class="header-actions">
            <button
              class="btn-head btn-secundario"
              id="btnReload"
              title="Recargar"
            >
              <i class="fa-solid fa-rotate-right"></i>
            </button>
            <button
              class="btn-head btn-secundario"
              id="btnExport"
              title="Exportar CSV"
            >
              <i class="fa-solid fa-file-csv"></i>
            </button>
            <button class="btn-head btn-nuevo" id="btnNew">
              <i class="fa-solid fa-plus"></i> <span>Nuevo Cliente</span>
            </button>
          </div>
        </div>

        <div class="header-filters">
          <div class="filter-item" style="flex-grow: 2">
            <label class="label">Buscar</label>
            <input
              id="inpBuscar"
              class="input-modern"
              placeholder="Nombre, RUT, email..."
              type="text"
            />
          </div>
          <div class="filter-item">
            <label class="label">Segmento</label>
            <select
              id="filSegmento"
              class="input-modern"
              onchange="aplicarFiltros()"
            >
              <option value="">(Todos)</option>
              <option value="VIP">VIP</option>
              <option value="Inversionista">Inversionista</option>
              <option value="Habitacional">Habitacional</option>
            </select>
          </div>
          <div class="filter-item">
            <label class="label">Estado</label>
            <select
              id="filEstado"
              class="input-modern"
              onchange="aplicarFiltros()"
            >
              <option value="">(Todos)</option>
              <option value="Activo">Activo</option>
              <option value="Inactivo">Inactivo</option>
            </select>
          </div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Cliente / RUT</th>
            <th>Contacto</th>
            <th>Inter√©s Principal</th>
            <th>Segmento</th>
            <th>Estado</th>
            <th>Agente</th>
            <th class="no-print" style="width: 140px">Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaClientes">
          <tr>
            <td colspan="7" class="muted">Cargando datos...</td>
          </tr>
        </tbody>
      </table>
    </main>

    <div id="modalCliente" class="modal" aria-hidden="true">
      <div class="modal-content">
        <h2 id="modalTitleCliente" style="margin-top: 0">Ficha Cliente</h2>
        <form id="formCliente" style="margin-top: 20px">
          <input type="hidden" id="clienteID" />

          <div style="display: flex; gap: 15px; margin-bottom: 15px">
            <div style="flex: 2">
              <label class="label">Nombre Completo</label>
              <input id="clienteNombre" required placeholder="Ej: Juan P√©rez" />
            </div>
            <div style="flex: 1">
              <label class="label">RUT</label>
              <input id="clienteRUT" placeholder="11.111.111-1" />
            </div>
          </div>

          <div style="display: flex; gap: 15px; margin-bottom: 15px">
            <div style="flex: 1">
              <label class="label">Email</label>
              <input id="clienteEmail" type="email" />
            </div>
            <div style="flex: 1">
              <label class="label">Tel√©fono</label>
              <input id="clienteTelefono" />
            </div>
          </div>

          <div style="display: flex; gap: 15px; margin-bottom: 15px">
            <div style="flex: 1">
              <label class="label">Segmento</label>
              <select id="clienteSegmento">
                <option value="Habitacional">Habitacional</option>
                <option value="Inversionista">Inversionista</option>
                <option value="VIP">VIP</option>
              </select>
            </div>
            <div style="flex: 1">
              <label class="label">Estado</label>
              <select id="clienteEstado">
                <option value="Activo">Activo</option>
                <option value="Inactivo">Inactivo</option>
              </select>
            </div>
          </div>

          <div style="display: flex; gap: 15px; margin-bottom: 15px">
            <div style="flex: 2">
              <label class="label">Inter√©s (Propiedad Buscada)</label>
              <input id="clienteInteres" placeholder="Ej: Depto 2D2B Centro" />
            </div>
            <div style="flex: 1">
              <label class="label">Canal</label>
              <select id="clienteCanal">
                <option value="Web Landing">Web</option>
                <option value="Referido">Referido</option>
                <option value="Portal Inmobiliario">Portal</option>
                <option value="Presencial">Presencial</option>
              </select>
            </div>
          </div>

          <div
            style="
              text-align: right;
              margin-top: 20px;
              display: flex;
              justify-content: flex-end;
              gap: 10px;
            "
          >
            <button
              type="button"
              class="btn-head btn-secundario"
              onclick="cerrarModalCliente()"
            >
              Cancelar
            </button>
            <button type="submit" class="btn-head btn-nuevo">Guardar</button>
          </div>
        </form>
      </div>
    </div>

    <div id="modalSeguimiento" class="modal" aria-hidden="true">
      <div class="modal-content" style="max-width: 600px">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
          "
        >
          <h2 style="margin: 0">
            <i class="fa-solid fa-clock-rotate-left"></i> Historial
          </h2>
          <button
            onclick="document.getElementById('modalSeguimiento').classList.remove('active')"
            class="btn-icon"
          >
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>

        <p
          id="segSubtitulo"
          class="muted"
          style="margin-top: -5px; font-size: 13px"
        >
          Cliente: ...
        </p>

        <div id="timelineContainer" class="chat-container"></div>

        <div
          style="
            margin-top: 15px;
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
          "
        >
          <div style="display: flex; gap: 10px; margin-bottom: 10px">
            <select id="segTipo" class="input-modern" style="width: 140px">
              <option value="Nota">üìù Nota</option>
              <option value="Llamada">üìû Llamada</option>
              <option value="Whatsapp">üí¨ WhatsApp</option>
              <option value="Correo">üìß Correo</option>
              <option value="Reunion">ü§ù Reuni√≥n</option>
              <option value="Compromiso">üìå Compromiso</option>
            </select>
            <input type="date" id="segFecha" class="input-modern" />
          </div>
          <textarea
            id="segNota"
            rows="2"
            style="
              width: 96%;
              padding: 10px;
              border-radius: 6px;
              border: 1px solid #cbd5e1;
            "
            placeholder="Detalle..."
          ></textarea>
          <div style="text-align: right; margin-top: 10px">
            <button
              class="btn-head btn-nuevo"
              onclick="guardarInteraccion()"
              style="height: 36px"
            >
              Registrar
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="pageSpinner" class="spinner-backdrop" aria-hidden="true">
      <div class="spinner-card">
        <div class="spinner"></div>
        <div id="spinnerText">Cargando...</div>
      </div>
    </div>

    <div id="footer"></div>

    <script>
      /* ===== UTILS ===== */
      function showSpinner(msg) {
        const sp = document.getElementById("pageSpinner");
        if (msg) document.getElementById("spinnerText").textContent = msg;
        sp.style.display = "grid";
      }
      function hideSpinner() {
        document.getElementById("pageSpinner").style.display = "none";
      }
      function norm(s) {
        return (s || "")
          .toString()
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .trim();
      }
      function escapeCSV(v) {
        if (v == null) return "";
        const s = String(v).replaceAll('"', '""');
        return /[",\n]/.test(s) ? '"' + s + '"' : s;
      }
      function formatearFecha(f) {
        if (!f) return "";
        const [y, m, d] = f.split("-");
        return `${d}/${m}`;
      }

      // Helpers ID
      function getKeyVal(o) {
        return o.ID || o.id || "";
      }
      function generateKey(prefix = "ID") {
        return `${prefix}_${Date.now().toString(36)}`;
      }

      /* ===== ESTADO ===== */
      let CLIENTES = [],
        VIEW_CLIENTES = [],
        CURRENT_CLIENT_ID = null;

      /* ===== BOOT ===== */
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          document.getElementById("header").innerHTML = await (
            await fetch("header.html")
          ).text();
          if (typeof initHeader === "function") initHeader();
        } catch (e) {}
        try {
          document.getElementById("footer").innerHTML = await (
            await fetch("footer.html")
          ).text();
        } catch (e) {}

        bindUI();
        await cargarTodo();
      });

      function bindUI() {
        document
          .getElementById("btnNew")
          .addEventListener("click", () => abrirFormCliente());
        document
          .getElementById("btnReload")
          .addEventListener("click", cargarTodo);
        document
          .getElementById("btnExport")
          .addEventListener("click", exportCSV);
        document
          .getElementById("inpBuscar")
          .addEventListener("input", aplicarFiltros);
      }

      /* ===== CARGA ===== */
      async function cargarTodo() {
        try {
          showSpinner("Cargando clientes...");
          CLIENTES = (await fetchData("Clientes")) || [];
          aplicarFiltros();
        } catch (e) {
          console.error(e);
          alert("Error: " + e.message);
        } finally {
          hideSpinner();
        }
      }

      /* ===== FILTROS & RENDER ===== */
      function aplicarFiltros() {
        const q = norm(document.getElementById("inpBuscar").value);
        const seg = document.getElementById("filSegmento").value;
        const est = document.getElementById("filEstado").value;

        VIEW_CLIENTES = CLIENTES.filter((c) => {
          if (seg && c.Segmento !== seg) return false;
          if (est && c.Estado !== est) return false;
          if (!q) return true;

          const str = [
            c.Nombre,
            c.Email,
            c.Telefono,
            c["Tel√©fono"],
            c.rut,
            c.Segmento,
            c.Estado,
          ]
            .map((v) => norm(v))
            .join(" ");
          return str.includes(q);
        });

        renderTabla();
      }

      function renderTabla() {
        const tb = document.getElementById("tablaClientes");
        if (!VIEW_CLIENTES.length) {
          tb.innerHTML =
            '<tr><td colspan="7" class="muted" style="text-align:center; padding:20px;">No se encontraron clientes.</td></tr>';
          return;
        }

        tb.innerHTML = VIEW_CLIENTES.map((c) => {
          const key = getKeyVal(c);

          // Estilos din√°micos
          let claseSeg = "seg-habitacional";
          if (c.Segmento === "VIP") claseSeg = "seg-vip";
          if (c.Segmento === "Inversionista") claseSeg = "seg-inversionista";

          const estadoHtml =
            c.Estado === "Activo"
              ? '<span class="st-activo">Activo</span>'
              : '<span class="st-inactivo">Inactivo</span>';

          return `
            <tr>
              <td>
                  <div style="font-weight:700; color:#1e293b;">${
                    c.Nombre || "Sin Nombre"
                  }</div>
                  <div style="font-size:11px; color:#64748b;">${
                    c.rut || ""
                  }</div>
              </td>
              <td style="font-size:13px;">
                  <div><i class="fa-regular fa-envelope"></i> ${
                    c.Email || "-"
                  }</div>
                  <div><i class="fa-solid fa-phone"></i> ${
                    c.Telefono || c["Tel√©fono"] || "-"
                  }</div>
              </td>
              <td style="font-size:13px; max-width: 180px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                  ${c.Interes || "-"}
              </td>
              <td><span class="seg-badge ${claseSeg}">${
            c.Segmento || "General"
          }</span></td>
              <td>${estadoHtml}</td>
              <td style="font-size:12px;">${c.Agente || "-"}</td>
              <td class="no-print">
                 <div class="acciones-group">
                    <button class="btn-icon" onclick="abrirSeguimiento('${key}')" title="Historial / Bit√°cora" style="background:#e0f2fe; color:#0369a1;">
                       <i class="fa-solid fa-comments"></i>
                    </button>
                    <button class="btn-icon btn-editar" onclick="abrirFormCliente('${key}')" title="Editar">
                       <i class="fa-solid fa-pen"></i>
                    </button>
                    <button class="btn-icon btn-eliminar" onclick="eliminarCliente('${key}')" title="Eliminar">
                       <i class="fa-solid fa-trash"></i>
                    </button>
                 </div>
              </td>
            </tr>`;
        }).join("");
      }

      /* ===== CRUD CLIENTE ===== */
      function abrirFormCliente(id) {
        const title = document.getElementById("modalTitleCliente");
        document.getElementById("formCliente").reset();
        document.getElementById("clienteID").value = "";

        if (id) {
          title.textContent = "Editar Cliente";
          const c = CLIENTES.find((x) => String(getKeyVal(x)) === String(id));
          if (!c) return;

          document.getElementById("clienteID").value = id;
          document.getElementById("clienteNombre").value = c.Nombre || "";
          document.getElementById("clienteRUT").value = c.rut || "";
          document.getElementById("clienteEmail").value = c.Email || "";
          document.getElementById("clienteTelefono").value =
            c.Telefono || c["Tel√©fono"] || "";
          document.getElementById("clienteCanal").value =
            c.Canal || "Web Landing";
          document.getElementById("clienteSegmento").value =
            c.Segmento || "Habitacional";
          document.getElementById("clienteEstado").value = c.Estado || "Activo";
          document.getElementById("clienteInteres").value = c.Interes || "";
        } else {
          title.textContent = "Nuevo Cliente";
          document.getElementById("clienteEstado").value = "Activo";
          document.getElementById("clienteSegmento").value = "Habitacional";
        }
        document.getElementById("modalCliente").classList.add("active");
      }

      function cerrarModalCliente() {
        document.getElementById("modalCliente").classList.remove("active");
      }

      document.getElementById("formCliente").onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById("clienteID").value;
        const nuevoID = id || generateKey("CLI");

        // Mapeo EXACTO a tus columnas
        const payload = {
          ID: nuevoID,
          Nombre: document.getElementById("clienteNombre").value.trim(),
          rut: document.getElementById("clienteRUT").value.trim(),
          Email: document.getElementById("clienteEmail").value.trim(),
          Telefono: document.getElementById("clienteTelefono").value.trim(),
          Canal: document.getElementById("clienteCanal").value,
          Segmento: document.getElementById("clienteSegmento").value,
          Estado: document.getElementById("clienteEstado").value,
          Interes: document.getElementById("clienteInteres").value,
          // Agente solo si es nuevo (para no sobrescribir)
          ...(!id && {
            Agente:
              typeof getAuthUser === "function"
                ? getAuthUser().nombre
                : "Admin",
          }),
          ...(!id && {
            "Fecha Creaci√≥n": new Date().toISOString().split("T")[0],
          }),
        };

        try {
          showSpinner("Guardando...");
          const action = id ? "Edit" : "Add";
          await appSheetCRUD("Clientes", action, [payload]);
          cerrarModalCliente();
          await cargarTodo();
        } catch (err) {
          alert("Error: " + err.message);
        } finally {
          hideSpinner();
        }
      };

      async function eliminarCliente(id) {
        if (!confirm("¬øEliminar este cliente?")) return;
        try {
          showSpinner("Eliminando...");
          await appSheetCRUD("Clientes", "Delete", [{ ID: id }]);
          await cargarTodo();
        } catch (err) {
          alert("Error: " + err.message);
        } finally {
          hideSpinner();
        }
      }

      /* ===== SEGUIMIENTO (BIT√ÅCORA) ===== */
      async function abrirSeguimiento(id) {
        CURRENT_CLIENT_ID = id;
        const c = CLIENTES.find((x) => String(getKeyVal(x)) === String(id));
        document.getElementById("segSubtitulo").innerText = `Cliente: ${
          c ? c.Nombre : "..."
        }`;
        document.getElementById("segFecha").valueAsDate = new Date();

        document.getElementById("modalSeguimiento").classList.add("active");
        cargarHistorial(id);
      }

      async function cargarHistorial(clienteId) {
        const container = document.getElementById("timelineContainer");
        container.innerHTML =
          '<div style="text-align:center; color:#94a3b8;">Cargando...</div>';

        try {
          // Reutilizamos la tabla 'Bitacora'
          const logs = await fetchData("Bitacora");
          // Filtramos por el ID del cliente (Columna ProspectoID en Bitacora)
          const historial = logs.filter(
            (l) => String(l.ProspectoID) === String(clienteId)
          );

          historial.sort((a, b) => new Date(b.Fecha) - new Date(a.Fecha));

          if (historial.length === 0) {
            container.innerHTML =
              '<div style="text-align:center; padding:20px; color:#cbd5e1;"><i class="fa-regular fa-comment-dots" style="font-size:30px;"></i><br>Sin registros.</div>';
            return;
          }

          container.innerHTML = historial
            .map((h) => {
              let icon = "fa-comment";
              if (h.Tipo === "Llamada") icon = "fa-phone";
              if (h.Tipo === "Correo") icon = "fa-envelope";
              if (h.Tipo === "Compromiso") icon = "fa-thumbtack";
              if (h.Tipo === "Reunion") icon = "fa-handshake";
              if (h.Tipo === "Whatsapp") icon = "fa-brands fa-whatsapp";

              return `
                  <div class="chat-bubble ${h.Tipo}">
                      <div class="chat-meta">
                          <span><i class="fa-solid ${icon}"></i> <b>${
                h.Tipo
              }</b></span>
                          <span>${formatearFecha(h.Fecha)}</span>
                      </div>
                      <div class="chat-text">${h.Nota}</div>
                      <div style="font-size:10px; color:#cbd5e1; text-align:right; margin-top:4px;">Por: ${
                        h.Usuario || "Sistema"
                      }</div>
                  </div>`;
            })
            .join("");
        } catch (e) {
          container.innerHTML = "Error cargando bit√°cora.";
        }
      }

      async function guardarInteraccion() {
        const nota = document.getElementById("segNota").value;
        const tipo = document.getElementById("segTipo").value;
        const fecha = document.getElementById("segFecha").value;

        if (!nota) return alert("Escribe el detalle.");

        // Usuario actual
        let usuario = "Agente";
        if (typeof getAuthUser === "function") {
          const u = getAuthUser();
          if (u) usuario = u.nombre;
        }

        const payload = {
          ID: "BIT_" + Date.now(),
          ProspectoID: CURRENT_CLIENT_ID, // Vinculaci√≥n
          Fecha: fecha,
          Tipo: tipo,
          Nota: nota,
          Usuario: usuario,
        };

        try {
          document.getElementById("segNota").disabled = true;
          await appSheetCRUD("Bitacora", "Add", [payload]);
          document.getElementById("segNota").value = "";
          document.getElementById("segNota").disabled = false;
          await cargarHistorial(CURRENT_CLIENT_ID);
        } catch (e) {
          alert("Error: " + e.message);
          document.getElementById("segNota").disabled = false;
        }
      }

      /* ===== Exportar ===== */
      function exportCSV() {
        const headers = [
          "ID",
          "Nombre",
          "Email",
          "Telefono",
          "RUT",
          "Canal",
          "Segmento",
          "Estado",
        ];
        const lines = [headers.join(",")];
        VIEW_CLIENTES.forEach((r) => {
          lines.push(
            [
              escapeCSV(getKeyVal(r)),
              escapeCSV(r.Nombre),
              escapeCSV(r.Email),
              escapeCSV(r.Telefono),
              escapeCSV(r.rut),
              escapeCSV(r.Canal),
              escapeCSV(r.Segmento),
              escapeCSV(r.Estado),
            ].join(",")
          );
        });
        const blob = new Blob([lines.join("\n")], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "Clientes.csv";
        a.click();
        URL.revokeObjectURL(url);
      }
    </script>
  </body>
</html>
