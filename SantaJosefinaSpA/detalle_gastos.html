<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <title>Detalle Gastos - Santa Josefina</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/css/styles.css" />
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1a2b48">
<link rel="apple-touch-icon" href="assets/img/icon-192.png">

    <script src="assets/js/app.js"></script>

    <style>
      /* --- Estilos Base Portal --- */
      body {
        background-color: #f8fafc;
        padding-bottom: 40px;
        font-family: system-ui, -apple-system, sans-serif;
      }

      .app-header {
        background: #1a2b48;
        color: white;
        padding: 20px;
        padding-top: 25px;
        padding-bottom: 40px;
        border-bottom-left-radius: 25px;
        border-bottom-right-radius: 25px;
        box-shadow: 0 4px 15px rgba(26, 43, 72, 0.2);
        display: flex;
        align-items: center;
        gap: 15px;
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .btn-back {
        color: white;
        font-size: 18px;
        text-decoration: none;
        background: rgba(255, 255, 255, 0.1);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* Tarjeta Resumen */
      .bill-card {
        background: white;
        margin: -30px 15px 20px;
        padding: 25px 20px;
        border-radius: 16px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
        border: 1px solid #e2e8f0;
        position: relative;
        z-index: 10;
      }

      .bill-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px dashed #e2e8f0;
        font-size: 14px;
        color: #64748b;
      }
      .bill-row:last-child {
        border-bottom: none;
      }
      .bill-row.total {
        margin-top: 10px;
        border-top: 2px solid #1e293b;
        padding-top: 15px;
        font-weight: 800;
        color: #1e293b;
        font-size: 18px;
      }
      .bill-value {
        font-weight: 600;
        color: #334155;
      }

      /* Desglose */
      .section-title {
        font-size: 14px;
        font-weight: 700;
        color: #334155;
        margin: 25px 15px 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
      }

      .expense-group {
        background: white;
        margin: 0 15px 15px;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid #e2e8f0;
      }
      .group-header {
        background: #f1f5f9;
        padding: 12px 15px;
        font-weight: 600;
        font-size: 13px;
        color: #1e293b;
        display: flex;
        justify-content: space-between;
      }
      .expense-item {
        padding: 12px 15px;
        border-bottom: 1px solid #f1f5f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .expense-item:last-child {
        border-bottom: none;
      }

      .exp-main {
        flex-grow: 1;
        padding-right: 10px;
      }
      .exp-provider {
        display: block;
        font-weight: 600;
        font-size: 13px;
        color: #1e293b;
        margin-bottom: 2px;
      }
      .exp-desc {
        font-size: 12px;
        color: #64748b;
        line-height: 1.3;
      }
      .exp-date {
        font-size: 10px;
        color: #94a3b8;
        display: block;
        margin-top: 4px;
      }
      .exp-amount {
        font-weight: 700;
        font-size: 13px;
        color: #334155;
        white-space: nowrap;
      }

      /* Deuda */
      .debt-item {
        background: #fff1f2;
        border: 1px solid #fecdd3;
        color: #9f1239;
        margin: 0 15px 10px;
        padding: 12px 15px;
        border-radius: 10px;
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        font-weight: 600;
      }

      .badge-info {
        background: #e0f2fe;
        color: #0369a1;
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 11px;
      }
      .spinner-overlay {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }
    </style>
  </head>
  <body>
    <div class="app-header">
      <a href="portal.html" class="btn-back">
        <i class="fa-solid fa-arrow-left"></i>
      </a>
      <div>
        <h1 style="margin: 0; font-size: 18px; font-weight: 600">
          Detalle de Gastos
        </h1>
        <div style="font-size: 12px; opacity: 0.8; margin-top: 2px">
          Unidad: <span id="lblUnidad">...</span> | <span id="lblMes">...</span>
        </div>
      </div>
    </div>

    <div class="bill-card">
      <div class="bill-row">
        <span>Gasto Común (Comunidad)</span>
        <span class="bill-value" id="resGC">$0</span>
      </div>
      <div class="bill-row">
        <span>Mi Alícuota (<span id="lblAlicuota">0%</span>)</span>
        <span class="bill-value" id="resMiCuota">$0</span>
      </div>
      <div class="bill-row">
        <span>Fondo de Reserva (<span id="lblFondoPct">0%</span>)</span>
        <span class="bill-value" id="resFondo">$0</span>
      </div>
      <div
        class="bill-row"
        id="rowDeudaAnt"
        style="color: #ef4444; display: none"
      >
        <span>(+) Deuda Anterior</span>
        <span class="bill-value" id="resDeuda" style="color: #ef4444">$0</span>
      </div>
      <div class="bill-row total">
        <span>TOTAL A PAGAR</span>
        <span style="color: #2563eb" id="resTotal">$0</span>
      </div>

      <div
        style="
          text-align: center;
          margin-top: 15px;
          font-size: 11px;
          color: #94a3b8;
        "
      >
        Vencimiento estimado: <span id="lblVence">...</span>
      </div>
    </div>

    <div id="wrapperDeudas" style="display: none">
      <div class="section-title" style="color: #9f1239">Pagos Atrasados</div>
      <div id="listaDeudas"></div>
    </div>

    <div class="section-title">
      <span>Gastos Comunidad</span>
      <span class="badge-info"
        >Total: <span id="lblTotalComunidad">$0</span></span
      >
    </div>

    <div id="listaGastosComunidad">
      <div
        style="
          text-align: center;
          padding: 30px;
          color: #94a3b8;
          font-size: 13px;
        "
      >
        Cargando detalle...
      </div>
    </div>

    <div style="height: 40px"></div>

    <div id="loader" class="spinner-overlay">
      <div
        style="
          width: 40px;
          height: 40px;
          border-radius: 50%;
          border: 4px solid #eee;
          border-top-color: #1a2b48;
          animation: spin 1s linear infinite;
        "
      ></div>
      <div
        style="
          margin-top: 15px;
          font-size: 13px;
          font-weight: 600;
          color: #1a2b48;
        "
      >
        Cargando...
      </div>
    </div>

    <script>
      /* --- HELPERS --- */
      function clp(v) {
        return "$" + new Intl.NumberFormat("es-CL").format(v || 0);
      }
      function parseMonto(v) {
        return (
          parseFloat(
            String(v)
              .replace(/\$|\.|,/g, "")
              .trim()
          ) || 0
        );
      }
      function parsePct(v) {
        return parseFloat(String(v).replace(",", ".")) || 0;
      }
      function getKeyVal(o) {
        return o.ID || o.id || "";
      }

      let USUARIO = null;
      let PROV_MAP = {}; // Mapa de proveedores: ID -> Nombre

      document.addEventListener("DOMContentLoaded", async () => {
        try {
          const sesion = localStorage.getItem("sesion_residente");
          if (!sesion) window.location.href = "login_residente.html";
          USUARIO = JSON.parse(sesion);

          document.getElementById("lblUnidad").textContent =
            USUARIO.UnidadLabel || USUARIO.UnidadID;

          await cargarDetalle();
        } catch (e) {
          console.error(e);
          alert("Error cargando detalles");
        } finally {
          document.getElementById("loader").style.display = "none";
        }
      });

      async function cargarDetalle() {
        // 1. CARGA DE DATOS (Incluyendo Proveedores ahora)
        const [
          copropiedades,
          unidades,
          gastos,
          cobros,
          gastosComunes,
          proveedores,
        ] = await Promise.all([
          fetchData("Copropiedades"),
          fetchData("Unidades"),
          fetchData("Gastos").catch(() => []),
          fetchData("Cobros").catch(() => []),
          fetchData("GastosComunes").catch(() => []),
          fetchData("Proveedores").catch(() => []), // <--- NUEVO
        ]);

        // 2. Crear Mapa de Proveedores para búsqueda rápida
        proveedores.forEach((p) => {
          PROV_MAP[getKeyVal(p)] = p.Nombre || p.RazonSocial || "Proveedor";
        });

        const myCoproID = String(USUARIO.CopropiedadID).trim();
        const myUnidadID = String(USUARIO.UnidadID).trim();

        const comunidad = copropiedades.find(
          (c) => String(getKeyVal(c)) === myCoproID
        );
        const unidad = unidades.find(
          (u) => String(getKeyVal(u)) === myUnidadID
        );

        if (!comunidad || !unidad) throw new Error("Datos no encontrados");

        // --- Periodo ---
        const hoy = new Date();
        const mesStr = `${String(hoy.getMonth() + 1).padStart(
          2,
          "0"
        )}-${hoy.getFullYear()}`;
        document.getElementById("lblMes").textContent =
          new Date().toLocaleDateString("es-CL", {
            month: "long",
            year: "numeric",
          });

        const fechaVence = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 5);
        document.getElementById("lblVence").textContent =
          fechaVence.toLocaleDateString("es-CL");

        // --- Gastos Mes ---
        let totalGastoComunidad = 0;
        const gastosMes = gastos.filter((g) => {
          if (String(g.CopropiedadID) !== myCoproID) return false;
          // Filtro simple por mes actual (mejora esto en producción con g.Fecha)
          if (!g.Fecha) return false;
          const d = new Date(g.Fecha);
          const m = String(d.getMonth() + 1).padStart(2, "0");
          const y = d.getFullYear();
          return `${m}-${y}` === mesStr;
        });

        totalGastoComunidad = gastosMes.reduce(
          (s, g) => s + parseMonto(g.Monto),
          0
        );

        // --- Cuota ---
        const alicuota = parsePct(unidad.Alicuota);
        const pctFondo = parsePct(comunidad.FondoReserva);
        const factorFondo = pctFondo > 1 ? pctFondo / 100 : pctFondo;

        const miGastoComun = Math.round(totalGastoComunidad * (alicuota / 100));
        const miFondo = Math.round(miGastoComun * factorFondo);

        // --- Deuda Anterior ---
        const moras = cobros.filter(
          (c) =>
            String(c.UnidadID) === myUnidadID &&
            c.Estado === "Pendiente" &&
            c.Mes !== mesStr
        );
        const totalMora = moras.reduce(
          (s, c) => s + parseMonto(c.TotalAPagar),
          0
        );

        // --- Cobro Oficial ---
        const cobroActual = cobros.find(
          (c) => String(c.UnidadID) === myUnidadID && c.Mes === mesStr
        );
        let finalPagar = 0;

        if (cobroActual) {
          const gcOficial = parseMonto(cobroActual.MontoGastoComun);
          const moraOficial = parseMonto(cobroActual.MontoMoraAnterior);

          if (cobroActual.Estado === "Pagado") {
            document.getElementById("resGC").textContent = "$0 (Pagado)";
            document.getElementById("resGC").style.color = "#10b981";
            document.getElementById("resMiCuota").textContent = "$0";
            document.getElementById("resFondo").textContent = "$0";
            document.getElementById("resDeuda").textContent = clp(totalMora);
            finalPagar = totalMora;
          } else {
            const totalOficial = parseMonto(cobroActual.TotalAPagar);
            const fondoInferido = totalOficial - gcOficial - moraOficial;

            document.getElementById("resGC").textContent =
              clp(totalGastoComunidad);
            document.getElementById("resMiCuota").textContent = clp(gcOficial);
            document.getElementById("resFondo").textContent = clp(
              fondoInferido > 0 ? fondoInferido : 0
            );
            document.getElementById("resDeuda").textContent = clp(moraOficial);
            finalPagar = totalOficial;
          }
        } else {
          document.getElementById("resGC").textContent =
            clp(totalGastoComunidad);
          document.getElementById("resMiCuota").textContent = clp(miGastoComun);
          document.getElementById("resFondo").textContent = clp(miFondo);
          document.getElementById("resDeuda").textContent = clp(totalMora);
          finalPagar = miGastoComun + miFondo + totalMora;
        }

        // --- Render UI ---
        document.getElementById("lblAlicuota").textContent = alicuota + "%";
        document.getElementById("lblFondoPct").textContent =
          factorFondo * 100 + "%";
        document.getElementById("resTotal").textContent = clp(finalPagar);
        document.getElementById("lblTotalComunidad").textContent =
          clp(totalGastoComunidad);

        if (totalMora > 0) {
          document.getElementById("rowDeudaAnt").style.display = "flex";
          document.getElementById("wrapperDeudas").style.display = "block";
          const listaDeudas = document.getElementById("listaDeudas");
          listaDeudas.innerHTML = moras
            .map(
              (m) => `
                <div class="debt-item">
                    <span>${m.Mes}</span>
                    <span>${clp(parseMonto(m.TotalAPagar))}</span>
                </div>
            `
            )
            .join("");
        }

        renderDesglose(gastosMes);
      }

      function renderDesglose(gastos) {
        const container = document.getElementById("listaGastosComunidad");
        if (gastos.length === 0) {
          container.innerHTML =
            '<div style="text-align:center; padding:30px; color:#94a3b8; font-size:13px;">No hay gastos registrados este mes.</div>';
          return;
        }

        // Agrupar
        const grupos = {};
        gastos.forEach((g) => {
          const cat = g.TipoGasto || "Otros";
          if (!grupos[cat]) grupos[cat] = { total: 0, items: [] };
          grupos[cat].total += parseMonto(g.Monto);
          grupos[cat].items.push(g);
        });

        let html = "";
        for (const [cat, data] of Object.entries(grupos)) {
          html += `
            <div class="expense-group">
                <div class="group-header">
                    <span>${cat}</span>
                    <span>${clp(data.total)}</span>
                </div>
                ${data.items
                  .map((item) => {
                    // RESOLUCIÓN DE NOMBRE DE PROVEEDOR
                    // Buscamos en el mapa si existe ID, si no usamos el campo texto, si no "Sin Proveedor"
                    const nombreProv =
                      PROV_MAP[item.ProveedorID] || item.Proveedor || "";
                    const descrip = item.Descripcion || "";

                    return `
                    <div class="expense-item">
                        <div class="exp-main">
                            <span class="exp-provider">${
                              nombreProv || "Gasto General"
                            }</span>
                            <span class="exp-desc">${descrip}</span>
                            <span class="exp-date">${
                              item.Fecha
                                ? new Date(item.Fecha).toLocaleDateString()
                                : ""
                            }</span>
                        </div>
                        <div class="exp-amount">${clp(
                          parseMonto(item.Monto)
                        )}</div>
                    </div>
                `;
                  })
                  .join("")}
            </div>`;
        }
        container.innerHTML = html;
      }
    </script>
  </body>
</html>
