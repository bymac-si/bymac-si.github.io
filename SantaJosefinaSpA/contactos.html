<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>CRM - Buzón Web Unificado</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#1a2b48" />

    <script src="assets/js/app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
      (function () {
        if (typeof emailjs !== "undefined") emailjs.init("7Il4AhmGHchP7qfxu");
      })();
      if (typeof requireAuth === "function") requireAuth();
    </script>

    <style>
      body {
        max-width: 1200px;
        margin: 0 auto;
        color: #1a2b48;
        background-color: #f8fafc;
      }
      main {
        padding: 30px;
      }

      .inbox-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
      }

      .message-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        transition:
          transform 0.2s,
          box-shadow 0.2s;
        border-left: 5px solid #cbd5e1;
        position: relative;
      }
      .message-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
      }

      .card-nuevo {
        border-left-color: #10b981;
        background-color: #ffffff;
      }
      .card-procesado {
        border-left-color: #cbd5e1;
        opacity: 0.85;
        background: #f8fafc;
      }

      .msg-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        font-size: 12px;
        color: #64748b;
        text-transform: uppercase;
        font-weight: 600;
        border-bottom: 1px solid #f1f5f9;
        padding-bottom: 8px;
      }

      .msg-name {
        font-size: 18px;
        font-weight: 800;
        color: #1e293b;
        margin-bottom: 5px;
      }

      .msg-body {
        font-size: 14px;
        color: #334155;
        line-height: 1.6;
        background: #f8fafc;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        border: 1px solid #e2e8f0;
      }

      .msg-footer {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        font-size: 13px;
        align-items: center;
        flex-wrap: wrap;
      }

      .contact-pill {
        display: flex;
        align-items: center;
        gap: 6px;
        background: #eff6ff;
        color: #1e40af;
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 600;
        text-decoration: none;
        transition: background 0.2s;
      }
      .contact-pill:hover {
        background: #dbeafe;
      }

      .badge-origin {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 10px;
        margin-right: 5px;
      }
      .bg-web {
        background: #e0f2fe;
        color: #0369a1;
      }
      .bg-app {
        background: #f3e8ff;
        color: #7e22ce;
      }
      .bg-check {
        background: #ffedd5;
        color: #c2410c;
      }

      /* Botón Editar Flotante */
      .btn-edit-card {
        position: absolute;
        top: 15px;
        right: 15px;
        background: white;
        border: 1px solid #e2e8f0;
        color: #64748b;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
      }
      .btn-edit-card:hover {
        background: #f1f5f9;
        color: #1a2b48;
        border-color: #cbd5e1;
      }

      /* MODAL */
      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 10000;
        justify-content: center;
        align-items: center;
      }
      .modal.active {
        display: flex;
      }
      .modal-content {
        background: white;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        font-size: 12px;
        font-weight: 700;
        margin-bottom: 5px;
        color: #64748b;
      }
      .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        box-sizing: border-box;
      }

      /* SPINNER */
      .spinner-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        place-items: center;
        z-index: 12000;
      }
      .spinner {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 4px solid #eee;
        border-top-color: #1a2b48;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div id="header"></div>

    <main>
      <div class="inbox-header">
        <div>
          <h1 style="margin: 0; font-size: 24px; color: #1a2b48">
            <i class="fa-solid fa-inbox"></i> Buzón Web Unificado
          </h1>
          <p style="margin: 5px 0 0; color: #64748b; font-size: 14px">
            Centralización de leads digitales.
          </p>
        </div>
        <div>
          <button
            class="btn-head"
            onclick="cargarBuzon()"
            title="Recargar"
            style="
              padding: 10px 20px;
              cursor: pointer;
              border-radius: 8px;
              border: 1px solid #cbd5e1;
              background: white;
              font-weight: 600;
              color: #1a2b48;
            "
          >
            <i class="fa-solid fa-rotate-right"></i> Actualizar
          </button>
        </div>
      </div>

      <div id="listaMensajes"></div>
    </main>

    <div id="modalEdicion" class="modal">
      <div class="modal-content">
        <h3 style="margin-top: 0; color: #1a2b48">Editar Lead</h3>
        <form id="formEdicion">
          <input type="hidden" id="editID" />
          <input type="hidden" id="editTabla" />
          <div class="form-group">
            <label>Nombre</label>
            <input
              type="text"
              id="editNombre"
              class="form-control"
              readonly
              style="background: #f1f5f9"
            />
          </div>

          <div class="form-group">
            <label>Estado</label>
            <select id="editEstado" class="form-control">
              <option value="Nuevo">Nuevo</option>
              <option value="Contactado">Contactado</option>
              <option value="Procesado">Procesado / Archivado</option>
              <option value="Descartado">Descartado</option>
            </select>
          </div>

          <div class="form-group">
            <label>Notas / Diagnóstico</label>
            <textarea id="editNotas" rows="4" class="form-control"></textarea>
          </div>

          <div style="text-align: right; margin-top: 20px">
            <button
              type="button"
              onclick="
                document
                  .getElementById('modalEdicion')
                  .classList.remove('active')
              "
              style="
                padding: 8px 16px;
                background: white;
                border: 1px solid #cbd5e1;
                border-radius: 6px;
                cursor: pointer;
                margin-right: 10px;
              "
            >
              Cancelar
            </button>
            <button
              type="submit"
              style="
                padding: 8px 16px;
                background: #1a2b48;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 700;
              "
            >
              Guardar Cambios
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="pageSpinner" class="spinner-backdrop" aria-hidden="true">
      <div style="text-align: center">
        <div class="spinner" style="margin: 0 auto 15px"></div>
        <div style="font-weight: 600; color: #1a2b48">Procesando...</div>
      </div>
    </div>

    <div id="footer"></div>

    <script>
      let GLOBAL_LEADS = []; // Para almacenar datos en memoria

      document.addEventListener("DOMContentLoaded", async () => {
        try {
          const h = await fetch("header.html");
          if (h.ok)
            document.getElementById("header").innerHTML = await h.text();
          const f = await fetch("footer.html");
          if (f.ok)
            document.getElementById("footer").innerHTML = await f.text();
          if (typeof initHeader === "function") initHeader();
          const scripts = document
            .getElementById("header")
            .querySelectorAll("script");
          scripts.forEach((s) => eval(s.innerHTML));
        } catch (e) {}

        await cargarBuzon();
      });

      async function cargarBuzon() {
        const spinner = document.getElementById("pageSpinner");
        spinner.style.display = "grid";

        try {
          const [tablaCRM, tablaWeb] = await Promise.all([
            fetchData("ProspectosCorretaje").catch(() => []),
            fetchData("contactos").catch(() => []),
          ]);

          const leadsCRM = tablaCRM.map((p) => ({
            ID: p.ID,
            Nombre: p.Nombre,
            Email: p.Email,
            Telefono: p.Telefono,
            Mensaje: p.Observaciones || p.Mensaje,
            Fecha: p["Fecha Registro"] || p.Fecha,
            Estado: p.Estado || "Nuevo",
            CanalOriginal: p.Canal || "CRM",
            Notas: p.Notas,
            Fuente: "CRM",
            TablaOrigen: "ProspectosCorretaje",
          }));

          const leadsWeb = tablaWeb.map((c) => ({
            ID: c.ID,
            Nombre: c.Nombre,
            Email: c.Email,
            Telefono: c.Telefono,
            Mensaje: c.Mensaje,
            Fecha: c.Fecha,
            Estado: c.Estado || "Nuevo",
            CanalOriginal: "Formulario Web",
            Notas: c.Notas,
            Fuente: "WEB",
            TablaOrigen: "contactos",
          }));

          const todos = [...leadsCRM, ...leadsWeb];
          const keywords = [
            "web",
            "checklist",
            "app",
            "portal",
            "digital",
            "landing",
          ];

          GLOBAL_LEADS = todos.filter((item) => {
            const texto = (
              item.CanalOriginal +
              " " +
              item.Mensaje
            ).toLowerCase();
            return (
              item.Fuente === "WEB" || keywords.some((k) => texto.includes(k))
            );
          });

          GLOBAL_LEADS.sort((a, b) => {
            const dateA = new Date(a.Fecha || 0);
            const dateB = new Date(b.Fecha || 0);
            return dateB - dateA;
          });

          renderMensajes(GLOBAL_LEADS);
        } catch (err) {
          console.error(err);
          document.getElementById("listaMensajes").innerHTML =
            `<div style="text-align:center; color:red; padding:20px;">Error al cargar datos.</div>`;
        } finally {
          spinner.style.display = "none";
        }
      }

      function renderMensajes(lista) {
        const contenedor = document.getElementById("listaMensajes");

        if (lista.length === 0) {
          contenedor.innerHTML = `<div style="text-align: center; padding: 80px; color: #cbd5e1;"><i class="fa-regular fa-envelope-open" style="font-size: 60px;"></i><p>Buzón vacío.</p></div>`;
          return;
        }

        contenedor.innerHTML = lista
          .map((lead) => {
            const esNuevo = lead.Estado === "Nuevo";
            const claseCard = esNuevo ? "card-nuevo" : "card-procesado";

            const labelEstado = esNuevo
              ? '<span style="color:#166534; background:#dcfce7; padding:2px 8px; border-radius:4px;"><i class="fa-solid fa-star"></i> NUEVO</span>'
              : `<span style="color:#64748b; background:#f1f5f9; padding:2px 8px; border-radius:4px;"><i class="fa-solid fa-check"></i> ${lead.Estado}</span>`;

            let badge = "";
            const contexto = (lead.Mensaje || "") + (lead.CanalOriginal || "");
            if (contexto.toLowerCase().includes("checklist"))
              badge = `<span class="badge-origin bg-check"><i class="fa-solid fa-shield-halved"></i> Checklist</span>`;
            else if (contexto.toLowerCase().includes("app"))
              badge = `<span class="badge-origin bg-app"><i class="fa-solid fa-mobile-screen"></i> App</span>`;
            else
              badge = `<span class="badge-origin bg-web"><i class="fa-solid fa-globe"></i> Web</span>`;

            let bloqueDiagnostico = "";
            if (lead.Notas && lead.Notas.length > 5) {
              bloqueDiagnostico = `<div style="background:#fff7ed; border-left:4px solid #f97316; padding:10px; margin-bottom:10px; font-size:13px; color:#9a3412;"><i class="fa-solid fa-triangle-exclamation"></i> <strong>Diagnóstico:</strong><br>${lead.Notas}</div>`;
            }

            return `
              <div class="message-card ${claseCard}">
                  <button class="btn-edit-card" onclick="abrirEdicion('${lead.ID}')" title="Editar"><i class="fa-solid fa-pen"></i></button>
                  
                  <div class="msg-header">
                      <div style="display:flex; align-items:center; gap:10px;">${badge} <span style="color:#cbd5e1;">|</span> ID: ${lead.ID}</div>
                      <div style="display:flex; align-items:center; gap:10px;">${formatearFecha(lead.Fecha)} ${labelEstado}</div>
                  </div>
                  
                  <div class="msg-name">${lead.Nombre || "Usuario Web"}</div>
                  
                  <div class="msg-footer">
                      ${lead.Email ? `<a href="mailto:${lead.Email}" class="contact-pill"><i class="fa-regular fa-envelope"></i> ${lead.Email}</a>` : ""}
                      ${lead.Telefono ? `<a href="https://wa.me/${lead.Telefono.replace("+", "")}" target="_blank" class="contact-pill"><i class="fa-brands fa-whatsapp"></i> ${lead.Telefono}</a>` : ""}
                  </div>

                  <div class="msg-body">
                      ${bloqueDiagnostico}
                      <div style="font-weight:600; font-size:12px; color:#64748b; margin-bottom:5px;">MENSAJE:</div>
                      ${lead.Mensaje || "Sin mensaje."}
                  </div>

                  <div style="margin-top: 15px; text-align: right; border-top:1px solid #f1f5f9; padding-top:15px;">
                      <button onclick="gestionarLead('${lead.ID}', '${lead.Fuente}')" 
                        style="background: #c2410c; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: 600; font-size: 13px; box-shadow: 0 2px 5px rgba(26,43,72,0.2);">
                          <i class="fa-solid fa-arrow-up-right-from-square"></i> Promover a CRM
                      </button>
                  </div>
              </div>`;
          })
          .join("");
      }

      function formatearFecha(fecha) {
        if (!fecha) return "";
        const [y, m, d] = fecha.split("T")[0].split("-");
        if (y && m && d) return `${d}/${m}/${y}`;
        return fecha;
      }

      /* --- FUNCIÓN GESTIONAR (Promoción a CRM y Marketing) --- */
async function gestionarLead(id, fuente) {
  if (fuente === "CRM") {
    window.location.href = `prospectos.html?id=${id}`;
    return;
  }

  if (fuente === "WEB") {
    if (!confirm("¿Ingresar este contacto al CRM y activar motor de Marketing?")) return;
    
    const btn = event.currentTarget;
    const txt = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Procesando...';
    btn.disabled = true;

    try {
      const lista = await fetchData("contactos");
      const contacto = lista.find(c => String(c.ID).trim() === String(id).trim());
      
      if (!contacto) throw new Error("Contacto no encontrado");

      const nuevoID_CRM = "PROS_" + Date.now();

      // 1. CREAR EN PROSPECTOS CORRETAJE (Gestión Comercial)
      const nuevoProspecto = {
        ID: nuevoID_CRM,
        Nombre: contacto.Nombre,
        Email: contacto.Email,
        Telefono: contacto.Telefono,
        Observaciones: (contacto.Mensaje || "") + (contacto.Notas ? "\n\nDiagnóstico: " + contacto.Notas : ""),
        "Fecha Registro": new Date().toISOString().split("T")[0],
        Estado: "Nuevo",
        Canal: "Web/Checklist",
        "Tipo Operacion": "Captación",
        Agente: "Por Asignar"
      };

      // 2. CREAR EN LEADS_MARKETING (Motor de Resend/SLA)
      const leadMarketing = {
        ID: contacto.Email, // Email como identificador único para campañas
        Nombre: contacto.Nombre,
        Fuente: "Web Unificado",
        Estado: "Activo",
        Telefono: contacto.Telefono,
        Fecha_Ingreso: new Date().toISOString(),
        Respondio_Diagnostico: contacto.Notas ? "SI" : "NO" // Si tiene notas, ya suma puntos
      };

      // Ejecutamos ambas inserciones
      await Promise.all([
        appSheetCRUD("ProspectosCorretaje", "Add", [nuevoProspecto]),
        appSheetCRUD("Leads_Marketing", "Add", [leadMarketing])
      ]);

      // Marcamos como procesado en el buzón web
      await appSheetCRUD("contactos", "Edit", [{ ID: contacto.ID, Estado: "Procesado" }]);

      alert("✅ ¡Éxito! Lead ingresado al CRM y al motor de Marketing.");
      window.location.href = `prospectos.html?id=${nuevoID_CRM}`;

    } catch (e) {
      console.error(e);
      alert("Error en la promoción: " + e.message);
      btn.innerHTML = txt;
      btn.disabled = false;
    }
  }


// Enviamos también a la tabla de Marketing para que entre al flujo de Resend
await appSheetCRUD("Leads_Marketing", "Add", [leadMarketing]);
      }

      /* --- FUNCIÓN EDITAR RÁPIDA --- */
      function abrirEdicion(id) {
        const lead = GLOBAL_LEADS.find((l) => String(l.ID) === String(id));
        if (!lead) return;

        document.getElementById("editID").value = lead.ID;
        document.getElementById("editTabla").value = lead.TablaOrigen;
        document.getElementById("editNombre").value = lead.Nombre;
        document.getElementById("editEstado").value = lead.Estado || "Nuevo";
        document.getElementById("editNotas").value = lead.Notas || "";

        document.getElementById("modalEdicion").classList.add("active");
      }

      document.getElementById("formEdicion").onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById("editID").value;
        const tabla = document.getElementById("editTabla").value;
        const estado = document.getElementById("editEstado").value;
        const notas = document.getElementById("editNotas").value;

        document.getElementById("modalEdicion").classList.remove("active");
        document.getElementById("pageSpinner").style.display = "grid";

        try {
          const payload = { ID: id, Estado: estado, Notas: notas };
          await appSheetCRUD(tabla, "Edit", [payload]);
          await cargarBuzon(); // Recargar lista
        } catch (err) {
          alert("Error al guardar cambios: " + err.message);
          document.getElementById("pageSpinner").style.display = "none";
        }
      };
    </script>
  </body>
</html>
