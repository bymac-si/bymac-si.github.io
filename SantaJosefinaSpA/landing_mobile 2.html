<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <title>Santa Josefina - Móvil</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#1a2b48" />

    <script src="assets/js/app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
      (function () {
        if (typeof emailjs !== "undefined") emailjs.init("7Il4AhmGHchP7qfxu");
      })();
    </script>

    <style>
      /* === ESTILOS BASE MÓVIL === */
      body {
        background: #f8fafc;
        padding-bottom: 40px;
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
      }

      /* Hero Section */
      .m-hero {
        background: #1a2b48;
        color: white;
        padding: 40px 20px 60px;
        text-align: center;
        border-bottom-left-radius: 30px;
        border-bottom-right-radius: 30px;
        box-shadow: 0 4px 20px rgba(26, 43, 72, 0.3);
        position: relative;
        z-index: 1;
      }
      .m-logo {
        width: 140px;
        margin-bottom: 20px;
        filter: brightness(0) invert(1);
      }
      .m-title {
        font-size: 22px;
        font-weight: 800;
        line-height: 1.2;
        margin-bottom: 8px;
      }
      .m-subtitle {
        font-size: 13px;
        opacity: 0.8;
        margin-bottom: 20px;
      }

      /* Accesos Rápidos */
      .access-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        padding: 0 20px;
        margin-top: -40px;
        position: relative;
        z-index: 2;
      }
      .access-card {
        background: white;
        border-radius: 16px;
        padding: 20px 10px;
        text-align: center;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
        text-decoration: none;
        color: #1a2b48;
        transition: transform 0.1s;
        border: 1px solid rgba(0, 0, 0, 0.03);
      }
      .access-card:active {
        transform: scale(0.96);
        background: #f1f5f9;
      }
      .access-icon {
        font-size: 24px;
        margin-bottom: 8px;
        display: block;
      }
      .access-text {
        font-weight: 700;
        font-size: 13px;
        display: block;
        line-height: 1.3;
      }
      .access-sub {
        font-size: 10px;
        color: #64748b;
        font-weight: 400;
        display: block;
        margin-top: 4px;
      }

      /* Lista de Acciones */
      .action-list {
        padding: 30px 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .section-label {
        font-size: 11px;
        font-weight: 800;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 5px;
      }

      .btn-action {
        background: white;
        border: 1px solid #e2e8f0;
        padding: 16px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        text-decoration: none;
        color: #334155;
        font-weight: 600;
        font-size: 14px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        cursor: pointer;
      }
      .btn-action:active {
        background: #f8fafc;
      }
      .btn-action i {
        font-size: 18px;
        width: 30px;
        text-align: center;
      }
      .btn-action.highlight {
        background: #e0f2fe;
        color: #0284c7;
        border-color: #bae6fd;
      }

      /* Footer */
      .footer-links {
        text-align: center;
        padding: 20px;
        opacity: 0.6;
        font-size: 11px;
      }
      .footer-links a {
        color: #1a2b48;
        font-weight: 700;
        text-decoration: none;
      }

      /* WhatsApp Flotante */
      .fab-whatsapp {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #25d366;
        color: white;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4);
        z-index: 1000;
        text-decoration: none;
        transition: transform 0.2s;
      }
      .fab-whatsapp:active {
        transform: scale(0.9);
      }

      /* === MODALES === */
      .modal-overlay {
        position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 2000;
        opacity: 0; visibility: hidden; transition: all 0.3s; backdrop-filter: blur(2px);
      }
      .modal-overlay.active { opacity: 1; visibility: visible; }

      .modal-sheet {
        position: fixed; bottom: 0; left: 0; right: 0; top: 20px;
        background: #f8fafc; border-radius: 20px 20px 0 0; z-index: 2001;
        transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        display: flex; flex-direction: column; overflow: hidden;
      }
      .modal-overlay.active .modal-sheet { transform: translateY(0); }

      .sheet-header {
        background: white; padding: 15px 20px; border-bottom: 1px solid #e2e8f0;
        display: flex; justify-content: space-between; align-items: center;
      }
      .sheet-title { font-size: 16px; font-weight: 700; color: #1e293b; margin: 0; }
      .btn-close {
        border: none; background: #f1f5f9; width: 32px; height: 32px;
        border-radius: 50%; color: #64748b; font-size: 16px; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
      }
      .sheet-content { flex: 1; overflow-y: auto; padding: 20px; }

      /* Estilos Propiedades */
      .prop-card-mini {
        background: white; border-radius: 12px; overflow: hidden; margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0;
        display: flex; flex-direction: column;
      }
      .prop-img { width: 100%; height: 150px; object-fit: cover; background: #eee; }
      .prop-info { padding: 12px; }
      .prop-tag {
        display: inline-block; font-size: 10px; font-weight: 700; text-transform: uppercase;
        padding: 2px 6px; border-radius: 4px; margin-bottom: 5px;
      }
      .tag-venta { background: #dcfce7; color: #166534; }
      .tag-arriendo { background: #dbeafe; color: #1e40af; }
      .prop-price { font-size: 16px; font-weight: 800; color: #1a2b48; }
      .prop-addr { font-size: 12px; color: #64748b; margin: 2px 0 10px; }
      .btn-wsp-outline {
        display: block; width: 100%; text-align: center; padding: 8px; border-radius: 8px;
        border: 1px solid #25d366; color: #25d366; font-weight: 600; text-decoration: none; font-size: 13px;
      }

      /* Inputs Form */
      .input-mobile {
        width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px;
        font-size: 16px; margin-bottom: 12px; box-sizing: border-box;
      }
      .btn-submit-mobile {
        width: 100%; padding: 14px; background: #1a2b48; color: white; border: none;
        border-radius: 10px; font-size: 16px; font-weight: 700; margin-top: 10px; cursor: pointer;
      }
      .btn-submit-mobile:disabled { background: #94a3b8; }
    </style>
  </head>
  <body>
    <div class="m-hero">
      <img
        src="assets/img/logo_santajosefina.png"
        class="m-logo"
        alt="Santa Josefina"
      />
      <div class="m-title">Gestión Inmobiliaria</div>
      <div class="m-subtitle">Administración & Corretaje</div>
    </div>

    <div class="access-grid">
      <a href="login_residente.html" class="access-card">
        <i
          class="fa-solid fa-users access-icon"
          style="color: #e74e35"
        ></i>
        <span class="access-text">Portal Comunidad</span>
        <span class="access-sub">Residentes y Dueños</span>
      </a>

      <a href="login.html" class="access-card">
        <i class="fa-solid fa-id-badge access-icon" style="color: #1a2b48"></i>
        <span class="access-text">Acceso Agentes</span>
        <span class="access-sub">CRM Interno</span>
      </a>
    </div>

    <div class="action-list">
      <div class="section-label">¿Qué buscas hoy?</div>

      <div class="btn-action highlight" onclick="abrirModal('propiedades')">
        <div style="display: flex; align-items: center; gap: 12px">
          <i class="fa-solid fa-magnifying-glass"></i>
          <span>Buscar Propiedad</span>
        </div>
        <i
          class="fa-solid fa-chevron-right"
          style="font-size: 12px; opacity: 0.5"
        ></i>
      </div>

      <div class="btn-action" onclick="abrirModal('contacto')">
        <div style="display: flex; align-items: center; gap: 12px">
          <i class="fa-solid fa-headset" style="color: #e74e35"></i>
          <span>Contactar Administración</span>
        </div>
        <i
          class="fa-solid fa-chevron-right"
          style="font-size: 12px; opacity: 0.5"
        ></i>
      </div>

      <a href="tel:+56998647190" class="btn-action">
        <div style="display: flex; align-items: center; gap: 12px">
          <i class="fa-solid fa-phone" style="color: #64748b"></i>
          <span>Llamar a Soporte</span>
        </div>
      </a>
    </div>

    <div class="footer-links">
      © 2026 Santa Josefina SpA<br />
      <a href="landing_desktop.html">Ver sitio web completo</a>
    </div>

    <a
      href="https://wa.me/56998647190?text=Hola,%20contacto%20desde%20la%20App."
      class="fab-whatsapp"
      target="_blank"
    >
      <i class="fa-brands fa-whatsapp"></i>
    </a>

    <div id="modalPropiedades" class="modal-overlay">
      <div class="modal-sheet">
        <div class="sheet-header">
          <h3 class="sheet-title">Propiedades Disponibles</h3>
          <button class="btn-close" onclick="cerrarModal('propiedades')">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="sheet-content" id="contenedorPropiedades">
          <div style="text-align: center; color: #64748b; padding-top: 40px">
            <i class="fa-solid fa-circle-notch fa-spin"></i> Cargando...
          </div>
        </div>
      </div>
    </div>

    <div id="modalContacto" class="modal-overlay">
      <div class="modal-sheet">
        <div class="sheet-header">
          <h3 class="sheet-title">Escríbenos</h3>
          <button class="btn-close" onclick="cerrarModal('contacto')">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="sheet-content">
          <form id="formContactoMobile">
            <p style="font-size: 13px; color: #64748b; margin-bottom: 20px">
              Déjanos tus datos y te contactaremos a la brevedad.
            </p>
            <input
              type="text"
              id="mNombre"
              class="input-mobile"
              placeholder="Nombre completo"
              required
            />
            <input
              type="email"
              id="mEmail"
              class="input-mobile"
              placeholder="Correo electrónico"
              required
            />
            <input
              type="tel"
              id="mTel"
              class="input-mobile"
              placeholder="Teléfono (+569...)"
            />
            <textarea
              id="mMensaje"
              class="input-mobile"
              rows="4"
              placeholder="¿Cómo podemos ayudarte?"
              required
            ></textarea>
            <button type="submit" id="btnSubmitM" class="btn-submit-mobile">
              Enviar Mensaje
            </button>
          </form>
        </div>
      </div>
    </div>

    <script>
      // Verificar sesión activa (Solo redirige si es AGENTE, no Residente)
      document.addEventListener("DOMContentLoaded", () => {
        if (typeof getAuthUser === "function") {
          const user = getAuthUser();
          // Si es un Agente (tiene sesión interna), va al dashboard
          if (user && user.Nombre && !window.location.href.includes("dashboard")) {
            window.location.href = "mobile_dashboard.html";
          }
        }
      });

      /* === LÓGICA DE MODALES === */
      function abrirModal(tipo) {
        if (tipo === "propiedades") {
          document.getElementById("modalPropiedades").classList.add("active");
          cargarPropiedades();
        } else if (tipo === "contacto") {
          document.getElementById("modalContacto").classList.add("active");
        }
      }

      function cerrarModal(tipo) {
        if (tipo === "propiedades") {
          document.getElementById("modalPropiedades").classList.remove("active");
        } else if (tipo === "contacto") {
          document.getElementById("modalContacto").classList.remove("active");
        }
      }

      /* === CARGAR PROPIEDADES === */
      let propiedadesCargadas = false;

      async function cargarPropiedades() {
        if (propiedadesCargadas) return;
        const contenedor = document.getElementById("contenedorPropiedades");

        try {
          const props = typeof fetchData === "function" ? await fetchData("Propiedades") : [];
          const disponibles = props.filter((p) => (p.Estado || "") === "Disponible");

          if (disponibles.length === 0) {
            contenedor.innerHTML = '<p style="text-align:center; color:#999; margin-top:20px;">No hay propiedades destacadas.</p>';
            return;
          }

          contenedor.innerHTML = disponibles.map((p) => {
              const precioFmt = "$" + new Intl.NumberFormat("es-CL").format(p.Precio || 0);
              const tagClass = p.Operacion === "Arriendo" ? "tag-arriendo" : "tag-venta";
              const imgUrl = p.ImagenURL || "assets/img/default_prop.jpg";
              const wspText = `Hola, me interesa: ${p.Titulo} (${precioFmt})`;

              return `
                    <div class="prop-card-mini">
                        <img src="${imgUrl}" class="prop-img" loading="lazy" onerror="this.src='assets/img/default_prop.jpg'">
                        <div class="prop-info">
                            <span class="prop-tag ${tagClass}">${p.Operacion || "Venta"}</span>
                            <div class="prop-price">${precioFmt}</div>
                            <div style="font-weight:600; font-size:14px; margin-top:2px;">${p.Titulo}</div>
                            <div class="prop-addr"><i class="fa-solid fa-location-dot"></i> ${p.Comuna || "Santiago"}</div>
                            <a href="https://wa.me/56998647190?text=${encodeURIComponent(wspText)}" target="_blank" class="btn-wsp-outline">
                                <i class="fa-brands fa-whatsapp"></i> Consultar
                            </a>
                        </div>
                    </div>`;
            }).join("");

          propiedadesCargadas = true;
        } catch (e) {
          console.error(e);
          contenedor.innerHTML = '<p style="text-align:center; color:red;">Error cargando datos.</p>';
        }
      }

      /* === FORMULARIO CONTACTO === */
      document.getElementById("formContactoMobile").onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById("btnSubmitM");
        const txtOriginal = btn.innerText;
        btn.innerText = "Enviando...";
        btn.disabled = true;

        const payload = {
          ID: "WEB_M_" + Date.now(),
          Nombre: document.getElementById("mNombre").value,
          Email: document.getElementById("mEmail").value,
          Telefono: document.getElementById("mTel").value,
          Observaciones: document.getElementById("mMensaje").value,
          "Fecha Registro": new Date().toISOString().split("T")[0],
          Estado: "Nuevo",
          Canal: "App Mobile",
          Agente: "Asignar",
        };

        try {
          if (typeof appSheetCRUD === "function") {
            await appSheetCRUD("ProspectosCorretaje", "Add", [payload]);
          }
          if (typeof emailjs !== "undefined") {
            await emailjs.send("service_p9hqkqn", "template_80q9psi", {
              to_email: "marcos.castro@santajosefinaspa.cl",
              subject: "[APP] Nuevo Mensaje: " + payload.Nombre,
              html_body: `Mensaje: ${payload.Observaciones} <br> Tel: ${payload.Telefono}`,
            });
          }
          alert("¡Mensaje enviado! Te contactaremos pronto.");
          document.getElementById("formContactoMobile").reset();
          cerrarModal("contacto");
        } catch (err) {
          alert("Error al enviar. Intenta por WhatsApp.");
        } finally {
          btn.innerText = txtOriginal;
          btn.disabled = false;
        }
      };
    </script>
  </body>
</html>