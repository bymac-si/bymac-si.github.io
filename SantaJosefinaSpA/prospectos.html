<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>CRM - Prospectos</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <script src="assets/js/app.js"></script>
    <script>
      requireAuth();
    </script>
    <style>
      body {
        max-width: 1200px;
        margin: 0 auto;
        color: #1a2b48;
      }
      main {
        padding: 40px;
      }
      .page-title {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 16px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 8px;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
      }
      th {
        background: #fafafa;
      }
      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: end;
      }
      .row > * {
        flex: 1 1 220px;
      }
      .label {
        display: block;
        font-weight: 600;
        margin-bottom: 4px;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
      }
      .btns {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }

      /* MODAL */
      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        z-index: 10000;
        align-items: center;
        justify-content: center;
      }
      .modal.active {
        display: flex;
      }
      .modal-content {
        width: 100%;
        max-width: 680px;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 18px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.18);
      }

      /* SPINNER */
      .spinner-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.85);
        display: none;
        place-items: center;
        z-index: 12000;
      }
      .spinner-card {
        background: #fff;
        padding: 18px 22px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
        text-align: center;
        min-width: 260px;
        color: #1a2b48;
        font-weight: 600;
      }
      .spinner {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 3px solid #eee;
        border-top-color: #b46a55;
        margin: 0 auto 10px;
        animation: spin 0.9s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Courier New",
          monospace;
      }
      .muted {
        color: #666;
      }

      /* ESTILOS DE ESTADO (BADGES) */
      .badge-status {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        white-space: nowrap;
      }
      .st-nuevo {
        background: #e0f2fe;
        color: #0369a1;
      }
      .st-contactado {
        background: #fef3c7;
        color: #b45309;
      }
      .st-propuesta {
        background: #f3e8ff;
        color: #7e22ce;
      }
      .st-negociacion {
        background: #ffedd5;
        color: #c2410c;
      }
      .st-ganado {
        background: #dcfce7;
        color: #15803d;
      }
      .st-perdido {
        background: #fee2e2;
        color: #b91c1c;
      }

      /* ESTILOS BIT√ÅCORA (TIMELINE) */
      .timeline {
        position: relative;
        border-left: 2px solid #e2e8f0;
        margin-left: 10px;
        padding-left: 20px;
        margin-top: 15px;
      }
      .timeline-item {
        margin-bottom: 20px;
        position: relative;
      }
      .timeline-dot {
        width: 12px;
        height: 12px;
        background: #fff;
        border: 2px solid #3b82f6;
        border-radius: 50%;
        position: absolute;
        left: -27px;
        top: 5px;
      }
      .timeline-dot.Llamada {
        border-color: #3b82f6;
      } /* Azul */
      .timeline-dot.Correo {
        border-color: #f59e0b;
      } /* Naranja */
      .timeline-dot.Reunion {
        border-color: #10b981;
      } /* Verde */
      .timeline-dot.Nota {
        border-color: #64748b;
      } /* Gris */

      .timeline-date {
        font-size: 11px;
        color: #94a3b8;
        font-weight: 600;
        margin-bottom: 2px;
      }
      .timeline-content {
        background: #f8fafc;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #f1f5f9;
        font-size: 13px;
        color: #334155;
      }
      .timeline-type {
        font-weight: 700;
        font-size: 11px;
        text-transform: uppercase;
        margin-bottom: 4px;
        display: block;
      }
    </style>
  </head>
  <body>
    <div id="header"></div>

    <main>
      <div class="dashboard-header no-print">
        <div class="header-top">
          <h1 class="page-title">Gesti√≥n de Prospectos</h1>

          <div class="header-actions">
            <button
              class="btn-head btn-secundario"
              id="btnReload"
              title="Recargar datos"
            >
              <i class="fa-solid fa-rotate-right"></i>
              <span class="btn-text">Recargar</span>
            </button>

            <button
              class="btn-head btn-secundario"
              id="btnExport"
              title="Descargar Excel/CSV"
            >
              <i class="fa-solid fa-file-csv"></i>
              <span class="btn-text">Exportar</span>
            </button>

            <button
              class="btn-head btn-secundario"
              onclick="window.print()"
              title="Imprimir vista"
            >
              <i class="fa-solid fa-print"></i>
              <span class="btn-text">Imprimir</span>
            </button>

            <button class="btn-head btn-nuevo" id="btnNew">
              <i class="fa-solid fa-plus"></i>
              <span>Nuevo Prospecto</span>
            </button>
          </div>
        </div>

        <div class="header-filters">
          <div class="filter-item" style="flex-grow: 2">
            <label class="label">Buscar</label>
            <input
              id="inpBuscar"
              class="input-modern"
              placeholder="Nombre, comuna, direcci√≥n, RUT..."
              type="text"
              style="width: 95%; height: 40px"
            />
          </div>

          <div class="filter-item">
            <label class="label">Comuna</label>
            <select id="selComuna" class="input-modern" style="height: 42px">
              <option value="">(Todas)</option>
            </select>
          </div>

          <div class="filter-item">
            <label class="label">UTM (CLP)</label>
            <input
              id="inpUTMPros"
              class="input-modern mono"
              placeholder="Cargando..."
              inputmode="decimal"
              style="width: 110px; height: 40px"
              readonly
            />
          </div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Nombre / Estado</th>
            <th>Comuna</th>
            <th style="text-align: right">Unidades</th>
            <th>Direcci√≥n</th>
            <th>RUT</th>
            <th>Contacto</th>
            <th>Tel√©fono</th>
            <th class="no-print">Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaProspectos">
          <tr>
            <td colspan="8" class="muted">Cargando‚Ä¶</td>
          </tr>
        </tbody>
      </table>
    </main>

    <div id="modalProspecto" class="modal" aria-hidden="true">
      <div class="modal-content">
        <h2 id="modalTitleProspecto">Nuevo Prospecto</h2>
        <form id="formProspecto">
          <input type="hidden" id="prospectoID" />

          <label class="label">Estado del Negocio</label>
          <select id="prosEstado" style="margin-bottom: 15px">
            <option value="Nuevo">Nuevo</option>
            <option value="Contactado">Contactado</option>
            <option value="Propuesta Enviada">Propuesta Enviada</option>
            <option value="En Negociaci√≥n">En Negociaci√≥n</option>
            <option value="Cerrado Ganado">Cerrado Ganado</option>
            <option value="Cerrado Perdido">Cerrado Perdido</option>
            <option value="Contrato Firmado">Contrato Firmado</option>
          </select>

          <label>Nombre</label><input id="prosNombre" required />
          <label>Comuna</label>
          <input id="prosComuna" list="dlComunas" placeholder="Ej: Santiago" />
          <datalist id="dlComunas"></datalist>
          <div class="muted" style="font-size: 12px">
            Sugerencias basadas en <b>TablaTarifas</b>.
          </div>

          <label>Unidades</label
          ><input id="prosUnidades" type="number" min="0" />
          <label>Direcci√≥n</label><input id="prosDireccion" /> <label>RUT</label
          ><input id="prosRUT" placeholder="12.345.678-9" />
          <label>Contacto</label
          ><input id="prosContacto" placeholder="Nombre / email / tel√©fono" />

          <div style="text-align: right; margin-top: 10px">
            <button
              type="button"
              class="btn-primary"
              onclick="cerrarModalProspecto()"
            >
              Cancelar
            </button>
            <button class="btn-primary">Guardar</button>
          </div>
        </form>
      </div>
    </div>

    <div id="modalDetalle" class="modal" aria-hidden="true">
      <div class="modal-content">
        <h2>Detalle Prospecto</h2>
        <div id="detalleContenido"></div>
        <div style="text-align: right; margin-top: 10px">
          <button
            class="btn-primary"
            type="button"
            onclick="cerrarModalDetalle()"
          >
            Cerrar
          </button>
        </div>
      </div>
    </div>

    <div id="modalBitacora" class="modal" aria-hidden="true">
      <div
        class="modal-content"
        style="
          max-width: 500px;
          max-height: 85vh;
          display: flex;
          flex-direction: column;
        "
      >
        <h2 style="margin-top: 0">Historial de Seguimiento</h2>
        <p
          class="muted"
          id="bitacoraSubtitle"
          style="margin-top: -10px; margin-bottom: 15px; font-size: 13px"
        >
          Prospecto: ...
        </p>

        <div
          id="timelineContainer"
          style="
            flex-grow: 1;
            overflow-y: auto;
            min-height: 200px;
            margin-bottom: 15px;
            padding-right: 5px;
          "
        >
          <div class="muted" style="text-align: center; padding: 20px">
            Cargando historia...
          </div>
        </div>

        <div
          style="
            background: #f1f5f9;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
          "
        >
          <label class="label" style="margin-top: 0">Nueva Interacci√≥n</label>
          <div style="display: flex; gap: 10px; margin-bottom: 8px">
            <select id="bitTipo" style="width: 120px">
              <option value="Nota">Nota üìù</option>
              <option value="Llamada">Llamada üìû</option>
              <option value="Correo">Correo üìß</option>
              <option value="Reunion">Reuni√≥n ü§ù</option>
            </select>
            <input type="date" id="bitFecha" style="margin: 0" />
          </div>
          <textarea
            id="bitNota"
            rows="2"
            placeholder="Detalles de la conversaci√≥n..."
            style="
              width: 100%;
              padding: 8px;
              border: 1px solid #d1d5db;
              border-radius: 6px;
              resize: vertical;
            "
          ></textarea>
          <div style="text-align: right; margin-top: 8px">
            <button
              class="btn-primary"
              onclick="guardarBitacora()"
              style="font-size: 12px"
            >
              Agregar Nota
            </button>
          </div>
        </div>

        <div style="text-align: right; margin-top: 10px">
          <button
            type="button"
            class="btn-secundario"
            onclick="document.getElementById('modalBitacora').classList.remove('active')"
          >
            Cerrar
          </button>
        </div>
      </div>
    </div>

    <div id="modalContrato" class="modal" aria-hidden="true">
      <div class="modal-content" style="max-width: 450px">
        <h2><i class="fa-solid fa-file-contract"></i> Gesti√≥n de Contrato</h2>
        <p class="muted">
          Sube el contrato firmado a Google Drive/Dropbox y pega el enlace aqu√≠
          para finalizar el negocio.
        </p>

        <input type="hidden" id="contratoProsID" />

        <label class="label">Enlace al Documento (URL)</label>
        <input
          id="inpContratoURL"
          placeholder="https://drive.google.com/file/d/..."
          style="width: 100%"
        />

        <div
          style="
            margin-top: 20px;
            background: #fff7ed;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            color: #c2410c;
          "
        >
          <i class="fa-solid fa-triangle-exclamation"></i> Al guardar, el estado
          cambiar√° a <b>"Contrato Firmado"</b>.
        </div>

        <div
          style="
            text-align: right;
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
          "
        >
          <button
            type="button"
            class="btn-secundario"
            onclick="document.getElementById('modalContrato').classList.remove('active')"
          >
            Cancelar
          </button>
          <button type="button" class="btn-primary" onclick="guardarContrato()">
            Guardar y Confirmar
          </button>
        </div>
      </div>
    </div>

    <div id="pageSpinner" class="spinner-backdrop" aria-hidden="true">
      <div class="spinner-card">
        <div class="spinner"></div>
        <div id="spinnerText">Cargando‚Ä¶</div>
      </div>
    </div>

    <div id="footer" class="no-print"></div>

    <script>
      /* ===== Utilidades ===== */
      function showSpinner(msg) {
        const sp = document.getElementById("pageSpinner");
        const txt = document.getElementById("spinnerText");
        if (msg) txt.textContent = msg;
        sp.style.display = "grid";
      }
      function hideSpinner() {
        document.getElementById("pageSpinner").style.display = "none";
      }
      function norm(s) {
        return (s || "")
          .toString()
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .trim();
      }
      function parseCLPInput(s) {
        return (
          parseFloat(
            (s || "").toString().replaceAll(".", "").replace(",", ".")
          ) || 0
        );
      }
      function escapeCSV(v) {
        if (v == null) return "";
        const s = String(v).replaceAll('"', '""');
        return /[",\n]/.test(s) ? '"' + s + '"' : s;
      }
      function clp(v) {
        return (
          "$" +
          new Intl.NumberFormat("es-CL", { maximumFractionDigits: 0 }).format(
            Number(v || 0)
          )
        );
      }

      /* Detectores de clave */
      if (typeof window.getKeyVal !== "function") {
        window.getKeyVal = (o) =>
          o
            ? o._id ??
              o.id ??
              o.ID ??
              o.Key ??
              o.key ??
              o.Id ??
              o[Object.keys(o)[0]]
            : "";
      }
      if (typeof window.getKeyName !== "function") {
        window.getKeyName = (row) => {
          if (!row || typeof row !== "object") return "ID";
          const cands = [
            "ID",
            "_id",
            "Id",
            "id",
            "Key",
            "key",
            "RowKey",
            "_RowNumber",
          ];
          for (const c of cands) {
            if (c in row) return c;
          }
          return Object.keys(row)[0] || "ID";
        };
      }
      function generateKey(prefix = "ID") {
        return `${prefix}_${Date.now().toString(36)}${Math.random()
          .toString(36)
          .slice(2, 8)
          .toUpperCase()}`;
      }

      /* ===== Estado ===== */
      let PROS = [],
        VIEW = [],
        TARIFAS = [];
      let KEY_NAME = "ID";
      let LAST_EDIT_ORIGINAL_KEY = null;
      let CURRENT_PROS_ID = null; // Variable global para bit√°cora/contrato

      /* ===== Boot ===== */
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          document.getElementById("header").innerHTML = await (
            await fetch("header.html")
          ).text();
        } catch (e) {}
        try {
          document.getElementById("footer").innerHTML = await (
            await fetch("footer.html")
          ).text();
        } catch (e) {}

        bindUI();
        await cargarTodo();
      });

      /* ===== UI ===== */
      function bindUI() {
        btnNew.addEventListener("click", () => abrirFormProspecto());
        btnReload.addEventListener("click", cargarTodo);
        btnExport.addEventListener("click", exportCSV);
        inpBuscar.addEventListener("input", aplicarFiltros);
        selComuna.addEventListener("change", aplicarFiltros);

        const m1 = modalProspecto,
          m2 = modalDetalle,
          m3 = modalBitacora,
          m4 = modalContrato;

        m1.addEventListener("click", (e) => {
          if (e.target === m1) cerrarModalProspecto();
        });
        m2.addEventListener("click", (e) => {
          if (e.target === m2) cerrarModalDetalle();
        });
        m3.addEventListener("click", (e) => {
          if (e.target === m3) m3.classList.remove("active");
        });
        m4.addEventListener("click", (e) => {
          if (e.target === m4) m4.classList.remove("active");
        });

        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            cerrarModalProspecto();
            cerrarModalDetalle();
            m3.classList.remove("active");
            m4.classList.remove("active");
          }
        });
      }

      /* ===== Carga de Datos ===== */
      async function cargarTodo() {
        try {
          showSpinner("Cargando datos‚Ä¶");

          const [pros, tarifas] = await Promise.all([
            fetchData("ProspectosCopro"),
            fetchData("TablaTarifas").catch(() => []),
          ]);

          PROS = pros || [];
          if (PROS.length) KEY_NAME = getKeyName(PROS[0]);
          TARIFAS = tarifas || [];

          const comunasPros = [
            ...new Set(PROS.map((p) => p.Comuna).filter(Boolean)),
          ].sort((a, b) => a.localeCompare(b));
          selComuna.innerHTML =
            '<option value="">(Todas)</option>' +
            comunasPros
              .map((c) => `<option value="${c}">${c}</option>`)
              .join("");

          const comunasTar = [
            ...new Set(TARIFAS.map((t) => t.Comuna).filter(Boolean)),
          ].sort((a, b) => a.localeCompare(b));
          dlComunas.innerHTML = comunasTar
            .map((c) => `<option value="${c}">`)
            .join("");

          if (typeof window.UTM_VALOR !== "undefined" && window.UTM_VALOR > 0) {
            inpUTMPros.value = new Intl.NumberFormat("es-CL").format(
              window.UTM_VALOR
            );
          }

          aplicarFiltros();
        } catch (err) {
          console.error(err);
          alert("Error al cargar datos: " + (err.message || err));
        } finally {
          hideSpinner();
        }
      }

      /* ===== Filtros/Render ===== */
      function aplicarFiltros() {
        const q = norm(inpBuscar.value);
        const comuna = selComuna.value;

        VIEW = PROS.filter((p) => {
          if (comuna && p.Comuna !== comuna) return false;
          if (!q) return true;
          return [
            getKeyVal(p),
            p.Nombre,
            p.Estado,
            p.Comuna,
            p.Unidades,
            p.Direccion,
            p.RUT,
            p.Contacto,
          ]
            .map((v) => norm(v))
            .some((s) => s.includes(q));
        });

        renderTabla();
      }

      function renderTabla() {
        if (!VIEW.length) {
          tablaProspectos.innerHTML =
            '<tr><td colspan="8" class="muted">Sin resultados.</td></tr>';
          return;
        }
        tablaProspectos.innerHTML = VIEW.map((p) => {
          const key = getKeyVal(p);
          const nombre = p.Nombre || p.RazonSocial || "‚Äî";
          const comuna = p.Comuna || "‚Äî";
          const unidades = p.Unidades || p.NUnidades || p.CantidadUnidades || 0;
          const direccion = p.Direccion || p.Direcci√≥n || "‚Äî";
          const rut = p.RUT || "‚Äî";
          const contacto = p.Contacto || p.Email || "‚Äî";
          const telefono = p.Telefono || "‚Äî";
          const estado = p.Estado || "Nuevo";

          let claseBadge = "st-nuevo";
          if (estado.includes("Contactado")) claseBadge = "st-contactado";
          if (estado.includes("Propuesta")) claseBadge = "st-propuesta";
          if (estado.includes("Negociaci√≥n")) claseBadge = "st-negociacion";
          if (estado.includes("Ganado")) claseBadge = "st-ganado";
          if (estado.includes("Contrato")) claseBadge = "st-ganado";
          if (estado.includes("Perdido")) claseBadge = "st-perdido";

          return `
      <tr>
        <td>
            <div style="font-weight:600; margin-bottom:4px;">${nombre}</div>
            <span class="badge-status ${claseBadge}">${estado}</span>
        </td>
        <td style="min-width: 100px;">${comuna}</td>
        <td class="mono" style="text-align:center;">${unidades || 0}</td>
        <td>${direccion}</td>
        <td class="mono">${rut}</td>
        <td>${contacto}</td>
        <td class="mono">${telefono}</td>
        <td class="no-print" style="min-width: 280px;">
          <div class="acciones-group" style="display:flex; gap:5px; flex-wrap:wrap;">
            
            <button class="btn-icon btn-ver" onclick='abrirDetalle(${JSON.stringify(
              key
            )})' title="Ver Detalle">
              <i class="fa-solid fa-eye"></i>
            </button>

            <button class="btn-icon btn-editar" onclick='abrirFormProspecto(${JSON.stringify(
              key
            )})' title="Editar">
              <i class="fa-solid fa-pen"></i>
            </button>
            
            <button class="btn-icon btn-mapa" onclick='abrirMapa(${JSON.stringify(
              key
            )})' title="Ver en Mapa" style="background:#f1f5f9;">
              <i class="fa-solid fa-map-location-dot"></i>
            </button>
            
            <button class="btn-icon" onclick='abrirBitacora(${JSON.stringify(
              key
            )})' title="Historial / Bit√°cora" style="background:#e0f2fe; color:#0369a1;">
              <i class="fa-solid fa-clock-rotate-left"></i>
            </button>
            
            <button class="btn-icon" onclick='abrirModalContrato(${JSON.stringify(
              key
            )})' title="Adjuntar Contrato" style="background:#fef3c7; color:#b45309;">
              <i class="fa-solid fa-file-signature"></i>
            </button>

            <button class="btn-icon btn-cotizar" onclick='abrirCotizacion(${JSON.stringify(
              key
            )})' title="Cotizar">
              <i class="fa-solid fa-file-invoice-dollar"></i>
            </button>
            
            <button class="btn-icon btn-eliminar" onclick='eliminarProspecto(${JSON.stringify(
              key
            )})' title="Eliminar">
              <i class="fa-solid fa-trash"></i>
            </button>

            <button class="btn-icon btn-cliente" onclick='agregarAClientes(${JSON.stringify(
              key
            )})' title="Convertir a Cliente">
              <i class="fa-solid fa-user-check"></i>
            </button>

          </div>
        </td>
      </tr>`;
        }).join("");
      }

      /* ===== Detalle y Formulario ===== */
      function abrirDetalle(id) {
        const p = PROS.find((x) => String(getKeyVal(x)) === String(id));
        if (!p) {
          alert("No encontrado");
          return;
        }
        detalleContenido.innerHTML = `
    <p><b>ID:</b> ${getKeyVal(p) || "‚Äî"}</p>
    <p><b>Estado:</b> ${p.Estado || "Nuevo"}</p>
    <p><b>Nombre:</b> ${p.Nombre || p.RazonSocial || "‚Äî"}</p>
    <p><b>Comuna:</b> ${p.Comuna || "‚Äî"}</p>
    <p><b>Unidades:</b> ${
      p.Unidades || p.NUnidades || p.CantidadUnidades || 0
    }</p>
    <p><b>Direcci√≥n:</b> ${p.Direccion || p.Direcci√≥n || "‚Äî"}</p>
    <p><b>RUT:</b> ${p.RUT || "‚Äî"}</p>
    <p><b>Contacto:</b> ${p.Contacto || p.Email || p.Telefono || "‚Äî"}</p>
    ${
      p.ContratoURL
        ? `<p><b>Contrato:</b> <a href="${p.ContratoURL}" target="_blank">Ver Documento</a></p>`
        : ""
    }`;
        modalDetalle.classList.add("active");
      }
      function cerrarModalDetalle() {
        modalDetalle.classList.remove("active");
      }

      function abrirFormProspecto(id) {
        const title = document.getElementById("modalTitleProspecto");
        formProspecto.reset();
        prospectoID.value = "";
        LAST_EDIT_ORIGINAL_KEY = null;

        if (id) {
          title.textContent = "Editar Prospecto";
          const p = PROS.find((x) => String(getKeyVal(x)) === String(id));
          if (!p) {
            alert("No encontrado");
            return;
          }
          LAST_EDIT_ORIGINAL_KEY = getKeyName(p);
          prospectoID.value = getKeyVal(p);

          prosEstado.value = p.Estado || "Nuevo";
          prosNombre.value = p.Nombre || p.RazonSocial || "";
          prosComuna.value = p.Comuna || "";
          prosUnidades.value =
            p.Unidades || p.NUnidades || p.CantidadUnidades || 0;
          prosDireccion.value = p.Direccion || p.Direcci√≥n || "";
          prosRUT.value = p.RUT || "";
          prosContacto.value = p.Contacto || p.Email || p.Telefono || "";
        } else {
          title.textContent = "Nuevo Prospecto";
          prosEstado.value = "Nuevo";
        }
        modalProspecto.classList.add("active");
      }
      function cerrarModalProspecto() {
        modalProspecto.classList.remove("active");
      }

      formProspecto.onsubmit = async (e) => {
        e.preventDefault();
        const idValue = prospectoID.value || null;

        const payload = {
          Estado: prosEstado.value,
          Nombre: (prosNombre.value || "").trim(),
          Comuna: (prosComuna.value || "").trim(),
          Unidades: Number(prosUnidades.value || 0),
          Direccion: (prosDireccion.value || "").trim(),
          RUT: (prosRUT.value || "").trim(),
          Contacto: (prosContacto.value || "").trim(),
        };

        const keyField = idValue
          ? LAST_EDIT_ORIGINAL_KEY || KEY_NAME
          : KEY_NAME;

        if (idValue) {
          payload[keyField] = idValue;
        } else {
          payload[keyField] = generateKey(keyField.toUpperCase());
        }

        try {
          showSpinner(idValue ? "Guardando‚Ä¶" : "Creando‚Ä¶");
          if (typeof upsertData === "function")
            await upsertData("ProspectosCopro", payload);
          else
            await appSheetCRUD("ProspectosCopro", idValue ? "Edit" : "Add", [
              payload,
            ]);
          cerrarModalProspecto();
          await cargarTodo();
        } catch (err) {
          console.error(err);
          alert("Error al guardar: " + (err.message || JSON.stringify(err)));
        } finally {
          hideSpinner();
        }
      };

      async function eliminarProspecto(id) {
        if (!confirm("¬øEliminar este prospecto?")) return;
        try {
          showSpinner("Eliminando‚Ä¶");
          if (typeof deleteByKey === "function")
            await deleteByKey("ProspectosCopro", id);
          else
            await appSheetCRUD("ProspectosCopro", "Delete", [
              { [KEY_NAME]: id },
            ]);
          await cargarTodo();
        } catch (err) {
          console.error(err);
          alert("Error al eliminar: " + (err.message || err));
        } finally {
          hideSpinner();
        }
      }

      /* ===== Mapa y Cotizaci√≥n ===== */
      function abrirMapa(id) {
        const row = PROS.find((x) => String(getKeyVal(x)) === String(id));
        if (!row) return;
        const latLong = row.Coordenadas || row.LatLong || row.Ubicacion || "";
        if (latLong && latLong.includes(",")) {
          const coords = latLong.replace(/\s/g, "");
          window.open(
            `https://www.google.com/maps/search/?api=1&query=${coords}`,
            "_blank"
          );
          return;
        }
        const direccion = row.Direccion || row.Direcci√≥n || "";
        const comuna = row.Comuna || "";
        if (direccion) {
          let query = direccion;
          if (comuna) query += `, ${comuna}`;
          query += ", Chile";
          window.open(
            `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(
              query
            )}`,
            "_blank"
          );
        } else {
          alert("El prospecto no tiene direcci√≥n ni coordenadas guardadas.");
        }
      }

      function getFactorByComuna(cname) {
        const c = (cname || "")
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .trim();
        const t = TARIFAS.find(
          (tt) =>
            (tt.Comuna || "")
              .toLowerCase()
              .normalize("NFD")
              .replace(/[\u0300-\u036f]/g, "")
              .trim() === c
        );
        return t ? Number(t.Factor || 0) : null;
      }

      function abrirCotizacion(id) {
        const row = PROS.find((x) => String(getKeyVal(x)) === String(id));
        if (!row) {
          alert("No se encontr√≥ el prospecto.");
          return;
        }
        const factor = getFactorByComuna(row.Comuna);
        let utm = parseCLPInput(inpUTMPros.value);
        if ((!utm || utm <= 0) && typeof window.UTM_VALOR !== "undefined") {
          utm = window.UTM_VALOR;
        }

        const params = new URLSearchParams({
          prospectoId: getKeyVal(row),
          nombre: row.Nombre || row.RazonSocial || "",
          comuna: row.Comuna || "",
          unidades: String(
            row.Unidades || row.NUnidades || row.CantidadUnidades || 0
          ),
          direccion: row.Direccion || row.Direcci√≥n || "",
          rut: row.RUT || "",
        });
        if (factor != null) params.set("factor", String(factor));
        if (utm > 0) params.set("utm", String(Math.round(utm)));

        window.location.href = `cotizacion-admin-condominio.html?${params.toString()}`;
      }

      /* ===== BIT√ÅCORA ===== */
      async function abrirBitacora(id) {
        CURRENT_PROS_ID = id;
        const p = PROS.find((x) => String(getKeyVal(x)) === String(id));
        if (!p) return;

        document.getElementById("bitacoraSubtitle").innerText = `Prospecto: ${
          p.Nombre || "Desconocido"
        }`;
        document.getElementById("modalBitacora").classList.add("active");
        document.getElementById("bitFecha").valueAsDate = new Date();
        document.getElementById("bitNota").value = "";

        renderTimeline([]);

        showSpinner("Cargando historial...");
        try {
          const data = await fetchData("Bitacora").catch(() => []);
          const historial = data.filter(
            (h) => String(h.ProspectoID) === String(id)
          );
          historial.sort((a, b) => new Date(b.Fecha) - new Date(a.Fecha));
          renderTimeline(historial);
        } catch (e) {
          console.error(e);
          document.getElementById("timelineContainer").innerHTML =
            '<p class="muted">No se pudo cargar la bit√°cora (¬øExiste la tabla?).</p>';
        } finally {
          hideSpinner();
        }
      }

      function renderTimeline(lista) {
        const container = document.getElementById("timelineContainer");
        if (lista.length === 0) {
          container.innerHTML =
            '<div style="text-align:center; padding:20px; color:#94a3b8;"><i class="fa-regular fa-comment-dots" style="font-size:24px; margin-bottom:10px;"></i><br>Sin registros a√∫n.<br>Agrega una nota abajo.</div>';
          return;
        }
        container.innerHTML =
          `<div class="timeline">` +
          lista
            .map(
              (item) => `
        <div class="timeline-item">
            <div class="timeline-dot ${item.Tipo}"></div>
            <div class="timeline-date">${item.Fecha || "---"}</div>
            <div class="timeline-content">
                <span class="timeline-type" style="color:${getColorTipo(
                  item.Tipo
                )}">${item.Tipo}</span>
                ${item.Nota || ""}
            </div>
        </div>
    `
            )
            .join("") +
          `</div>`;
      }

      function getColorTipo(tipo) {
        if (tipo === "Llamada") return "#2563eb";
        if (tipo === "Correo") return "#d97706";
        if (tipo === "Reunion") return "#059669";
        return "#475569";
      }

      async function guardarBitacora() {
        const nota = document.getElementById("bitNota").value.trim();
        if (!nota) return alert("Escribe una nota primero.");

        const payload = {
          ID: generateKey("BIT"),
          ProspectoID: CURRENT_PROS_ID,
          Fecha: document.getElementById("bitFecha").value,
          Tipo: document.getElementById("bitTipo").value,
          Nota: nota,
          Usuario: "Admin",
        };

        showSpinner("Guardando nota...");
        try {
          if (typeof upsertData === "function")
            await upsertData("Bitacora", payload);
          else await appSheetCRUD("Bitacora", "Add", [payload]);

          const allData = await fetchData("Bitacora");
          const historial = allData.filter(
            (h) => String(h.ProspectoID) === String(CURRENT_PROS_ID)
          );
          historial.sort((a, b) => new Date(b.Fecha) - new Date(a.Fecha));
          renderTimeline(historial);
          document.getElementById("bitNota").value = "";
        } catch (e) {
          alert("Error: " + e.message);
        } finally {
          hideSpinner();
        }
      }

      /* ===== CONTRATO ===== */
      function abrirModalContrato(id) {
        CURRENT_PROS_ID = id;
        const p = PROS.find((x) => String(getKeyVal(x)) === String(id));

        document.getElementById("contratoProsID").value = id;
        document.getElementById("inpContratoURL").value = p.ContratoURL || "";
        document.getElementById("modalContrato").classList.add("active");
      }

      async function guardarContrato() {
        const url = document.getElementById("inpContratoURL").value.trim();
        if (!url) return alert("Debes pegar un enlace al contrato.");

        const payload = {
          [KEY_NAME]: CURRENT_PROS_ID,
          ContratoURL: url,
          Estado: "Contrato Firmado",
        };

        showSpinner("Actualizando prospecto...");
        try {
          if (typeof upsertData === "function")
            await upsertData("ProspectosCopro", payload);
          else await appSheetCRUD("ProspectosCopro", "Edit", [payload]);

          document.getElementById("modalContrato").classList.remove("active");
          await cargarTodo();
          alert("‚úÖ Contrato registrado y estado actualizado.");
        } catch (e) {
          alert("Error: " + e.message);
        } finally {
          hideSpinner();
        }
      }

      /* ===== Convertir Cliente ===== */
      async function agregarAClientes(id) {
        if (
          !confirm(
            '¬øDeseas convertir este prospecto en una nueva Copropiedad?\n\nEsto tambi√©n cambiar√° su estado a "Cerrado Ganado".'
          )
        )
          return;

        try {
          const row = PROS.find((x) => String(getKeyVal(x)) === String(id));
          if (!row) {
            alert("No se encontr√≥ el prospecto.");
            return;
          }

          showSpinner("Procesando conversi√≥n...");

          const newID = generateKey("COPRO");
          let numUnidades = parseInt(
            row.Unidades || row.NUnidades || row.CantidadUnidades || 0
          );
          if (isNaN(numUnidades)) numUnidades = 0;

          const payloadCliente = {
            ID: newID,
            Nombre: (row.Nombre || row.RazonSocial || "").trim(),
            RUT: (row.RUT || "").trim(),
            Direccion: (row.Direccion || row.Direcci√≥n || "").trim(),
            Comuna: (row.Comuna || "").trim(),
            Ciudad: (row.Comuna || "").trim(),
            Banco: "",
            Cuenta: "",
            EmailAdmin: (row.Contacto || row.Email || "").trim(),
            Telefono: (row.Telefono || "").trim(),
            FondoReserva: 0,
            ReglamentoURL: "",
            LibroActasURL: "",
            Unidades: numUnidades,
          };

          if (typeof upsertData === "function")
            await upsertData("Copropiedades", payloadCliente);
          else await appSheetCRUD("Copropiedades", "Add", [payloadCliente]);

          const keyField = getKeyName(row);
          const payloadProspecto = {
            [keyField]: id,
            Estado: "Cerrado Ganado",
          };

          if (typeof upsertData === "function")
            await upsertData("ProspectosCopro", payloadProspecto);
          else
            await appSheetCRUD("ProspectosCopro", "Edit", [payloadProspecto]);

          await cargarTodo();

          if (
            confirm(
              '‚úÖ ¬°Felicidades! Nuevo cliente creado.\nEl prospecto ha pasado a "Cerrado Ganado".\n\n¬øIr al panel del nuevo condominio?'
            )
          ) {
            window.location.href = `admin-condominios.html?id=${newID}`;
          }
        } catch (e) {
          console.error(e);
          alert("Error al procesar: " + (e.message || e));
        } finally {
          hideSpinner();
        }
      }

      /* Export CSV */
      function exportCSV() {
        const headers = [
          "ID",
          "Estado",
          "Nombre",
          "Comuna",
          "Unidades",
          "Direccion",
          "RUT",
          "Contacto",
        ];
        const lines = [headers.join(",")];
        VIEW.forEach((r) => {
          lines.push(
            [
              escapeCSV(getKeyVal(r)),
              escapeCSV(r.Estado || "Nuevo"),
              escapeCSV(r.Nombre || r.RazonSocial || ""),
              escapeCSV(r.Comuna || ""),
              escapeCSV(r.Unidades || 0),
              escapeCSV(r.Direccion || ""),
              escapeCSV(r.RUT || ""),
              escapeCSV(r.Contacto || ""),
            ].join(",")
          );
        });
        const blob = new Blob([lines.join("\n")], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "ProspectosCopro.csv";
        a.click();
        URL.revokeObjectURL(url);
      }
    </script>
  </body>
</html>
