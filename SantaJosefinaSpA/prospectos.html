<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>CRM - Prospectos</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#1a2b48" />

    <script src="assets/js/app.js" defer></script>
    <script defer>
      document.addEventListener("DOMContentLoaded", () => {
        if (typeof requireAuth === "function") requireAuth();
      });
    </script>

    <style>
      /* ESTILOS BASE */
      body {
        max-width: 1200px;
        margin: 0 auto;
        color: #1a2b48;
      }
      main {
        padding: 40px;
      }
      .page-title {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 16px;
      }

      /* TABLAS */
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 8px;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
        vertical-align: middle;
      }
      th {
        background: #fafafa;
      }

      /* FORMULARIOS */
      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: end;
      }
      .row > * {
        flex: 1 1 220px;
      }
      .label {
        display: block;
        font-weight: 600;
        margin-bottom: 4px;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        box-sizing: border-box;
      }

      /* TIPO SELECTOR */
      .tipo-selector {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }
      .tipo-btn {
        flex: 1;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        text-align: center;
        cursor: pointer;
        font-weight: 600;
        color: #64748b;
        background: #f9fafb;
        transition: all 0.2s;
      }
      .tipo-btn:hover {
        background: #f3f4f6;
      }
      .tipo-btn.active {
        background: #eff6ff;
        color: #3b82f6;
        border-color: #3b82f6;
      }

      .hidden {
        display: none;
      }

      /* MODALES */
      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        z-index: 10000;
        align-items: center;
        justify-content: center;
      }
      .modal.active {
        display: flex;
      }
      .modal-content {
        width: 100%;
        max-width: 680px;
        background: #fff;
        border-radius: 10px;
        padding: 18px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.18);
        max-height: 90vh;
        overflow-y: auto;
      }

      /* SPINNER */
      .spinner-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.85);
        display: none;
        place-items: center;
        z-index: 12000;
      }
      .spinner-card {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        text-align: center;
        font-weight: 600;
      }
      .spinner {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: 4px solid #eee;
        border-top-color: #1a2b48;
        margin: 0 auto 10px;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .muted {
        color: #666;
      }

      /* BADGES */
      .badge-status {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        white-space: nowrap;
      }
      .st-nuevo {
        background: #e0f2fe;
        color: #0369a1;
      }
      .st-ganado {
        background: #dcfce7;
        color: #15803d;
      }
      .st-perdido {
        background: #fee2e2;
        color: #b91c1c;
      }
      .st-contactado {
        background: #fef3c7;
        color: #b45309;
      }
      .st-negociacion {
        background: #ffedd5;
        color: #c2410c;
      }

      .badge-type {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 4px;
        margin-right: 5px;
        text-transform: uppercase;
        font-weight: bold;
      }
      .type-admin {
        background: #e0e7ff;
        color: #3730a3;
        border: 1px solid #c7d2fe;
      }
      .type-corretaje {
        background: #ffedd5;
        color: #9a3412;
        border: 1px solid #fed7aa;
      }

      .badge-source {
        font-size: 9px;
        padding: 2px 5px;
        border-radius: 4px;
        margin-left: 5px;
        font-weight: 700;
        background: #fce7f3;
        color: #9d174d;
      }

      /* BIT√ÅCORA */
      .timeline {
        position: relative;
        border-left: 2px solid #e2e8f0;
        margin-left: 10px;
        padding-left: 20px;
        margin-top: 15px;
      }
      .timeline-item {
        margin-bottom: 20px;
        position: relative;
      }
      .timeline-dot {
        width: 12px;
        height: 12px;
        background: #fff;
        border: 2px solid #3b82f6;
        border-radius: 50%;
        position: absolute;
        left: -27px;
        top: 5px;
      }
      .timeline-date {
        font-size: 11px;
        color: #94a3b8;
        font-weight: 600;
        margin-bottom: 2px;
      }
      .timeline-content {
        background: #f8fafc;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #f1f5f9;
        font-size: 13px;
        color: #334155;
      }

      /* BOTONES ACCION */
      .btn-icon {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
        background: white;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #4b5563;
        transition: all 0.2s;
      }
      .btn-icon:hover {
        background: #f3f4f6;
        transform: translateY(-1px);
      }
      .btn-cotizar:hover {
        background: #e0e7ff;
        color: #3730a3;
        border-color: #c7d2fe;
      }
      .btn-cliente:hover {
        background: #dcfce7;
        color: #166534;
        border-color: #86efac;
      }
      .btn-eliminar:hover {
        background: #fee2e2;
        color: #ef4444;
        border-color: #fecaca;
      }
    </style>
  </head>
  <body>
    <div id="header"></div>
    <main>
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 30px;
        "
      >
        <div class="dashboard-header no-print" style="width: 100%">
          <div
            class="header-top"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <h1 class="page-title">Gesti√≥n de Prospectos</h1>
            <div class="header-actions" style="display: flex; gap: 10px">
              <button
                class="btn-head btn-secundario"
                id="btnReload"
                title="Recargar"
              >
                <i class="fa-solid fa-rotate-right"></i>
              </button>
              <button
                class="btn-head btn-secundario"
                onclick="window.print()"
                title="Imprimir"
              >
                <i class="fa-solid fa-print"></i>
              </button>
              <button class="btn-head btn-nuevo" id="btnNew">
                <i class="fa-solid fa-plus"></i> <span>Nuevo Prospecto</span>
              </button>
            </div>
          </div>

          <div
            class="header-filters"
            style="display: flex; gap: 10px; margin-top: 20px"
          >
            <div style="flex-grow: 2">
              <label class="label">Buscar</label
              ><input id="inpBuscar" placeholder="..." />
            </div>
            <div>
              <label class="label">Tipo</label
              ><select id="selTipo">
                <option value="">(Todos)</option>
                <option value="Administracion">Admin</option>
                <option value="Corretaje">Corretaje</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Nombre / Estado</th>
            <th>Tipo</th>
            <th>Direcci√≥n</th>
            <th>Contacto</th>
            <th class="no-print" style="width: 240px">Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaProspectos">
          <tr>
            <td colspan="5" class="muted">Cargando‚Ä¶</td>
          </tr>
        </tbody>
      </table>
    </main>

    <div id="modalProspecto" class="modal" aria-hidden="true">
      <div class="modal-content">
        <h2 id="modalTitleProspecto">Prospecto</h2>
        <form id="formProspecto">
          <input type="hidden" id="prospectoID" />
          <input type="hidden" id="prosTablaOriginal" />
          <input type="hidden" id="prosLatLong" />

          <label class="label">Tipo de Negocio</label>
          <div class="tipo-selector">
            <div
              class="tipo-btn active"
              onclick="setTipo('Administracion')"
              id="btnTipoAdmin"
            >
              <i class="fa-solid fa-building"></i> Administraci√≥n
            </div>
            <div
              class="tipo-btn"
              onclick="setTipo('Corretaje')"
              id="btnTipoCorretaje"
            >
              <i class="fa-solid fa-house-user"></i> Corretaje
            </div>
          </div>
          <input type="hidden" id="prosTipoNegocio" value="Administracion" />

          <div
            class="row"
            style="
              margin-top: 10px;
              background: #f0f9ff;
              padding: 10px;
              border-radius: 6px;
              border: 1px dashed #0284c7;
            "
          >
            <div style="flex: 2; display: flex; align-items: center; gap: 10px">
              <label class="label" style="margin: 0; min-width: 120px"
                >Asignar a:</label
              >
              <select
                id="prosAgente"
                style="margin: 0; font-weight: bold; color: #0284c7"
              >
                <option value="Sin Asignar">-- Sin Asignar --</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top: 10px">
            <div style="flex: 2">
              <label class="label">Nombre (Cliente/Condominio)</label
              ><input id="prosNombre" required />
            </div>
            <div>
              <label class="label">Estado</label>
              <select id="prosEstado">
                <option value="Nuevo">Nuevo</option>
                <option value="Contactado">Contactado</option>
                <option value="En Negociaci√≥n">En Negociaci√≥n</option>
                <option value="Cerrado Ganado">Cerrado Ganado</option>
                <option value="Cerrado Perdido">Cerrado Perdido</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top: 10px">
            <div style="flex: 1">
              <label class="label">Tel√©fono</label><input id="prosTelefono" />
            </div>
            <div style="flex: 1.5">
              <label class="label">Email</label
              ><input id="prosEmail" type="email" />
            </div>
          </div>

          <div class="row" style="margin-top: 10px">
            <div style="flex: 2">
              <label class="label">Direcci√≥n</label
              ><input id="prosDireccion" onchange="intentarGeocodificar()" />
            </div>
            <div style="flex: 1">
              <label class="label">Comuna</label
              ><input
                id="prosComuna"
                list="dlComunas"
                onchange="intentarGeocodificar()"
              /><datalist id="dlComunas"></datalist>
            </div>
          </div>

          <div id="camposAdmin" style="margin-top: 10px">
            <div class="row">
              <div>
                <label class="label">Cant. Unidades</label
                ><input
                  id="prosUnidades"
                  type="number"
                  min="0"
                  placeholder="0"
                />
              </div>
              <div>
                <label class="label">RUT Comunidad</label><input id="prosRUT" />
              </div>
            </div>
          </div>

          <div id="camposCorretaje" class="hidden" style="margin-top: 10px">
            <div class="row">
              <div>
                <label class="label">Operaci√≥n</label
                ><select id="prosOperacion">
                  <option value="Venta">Venta</option>
                  <option value="Arriendo">Arriendo</option>
                </select>
              </div>
              <div>
                <label class="label">Tipo Prop.</label
                ><select id="prosTipoProp">
                  <option value="Departamento">Departamento</option>
                  <option value="Casa">Casa</option>
                </select>
              </div>
            </div>
            <div class="row" style="margin-top: 10px">
              <div>
                <label class="label">Presupuesto</label
                ><input id="prosPresupuesto" />
              </div>
            </div>
          </div>

          <label class="label" style="margin-top: 10px"
            >Notas / Diagn√≥stico</label
          >
          <textarea id="prosNotas" rows="4"></textarea>

          <div style="text-align: right; margin-top: 20px">
            <button
              type="button"
              class="btn-head btn-secundario"
              onclick="
                document
                  .getElementById('modalProspecto')
                  .classList.remove('active')
              "
            >
              Cancelar
            </button>
            <button type="submit" class="btn-head btn-nuevo">Guardar</button>
          </div>
        </form>
      </div>
    </div>

    <div id="modalDetalle" class="modal" aria-hidden="true">
      <div class="modal-content">
        <h2>Detalle Prospecto</h2>
        <div id="detalleContenido"></div>
        <div style="text-align: right; margin-top: 10px">
          <button
            class="btn-head btn-secundario"
            onclick="
              document.getElementById('modalDetalle').classList.remove('active')
            "
          >
            Cerrar
          </button>
        </div>
      </div>
    </div>

    <div id="modalBitacora" class="modal" aria-hidden="true">
      <div
        class="modal-content"
        style="
          max-width: 500px;
          max-height: 85vh;
          display: flex;
          flex-direction: column;
        "
      >
        <h2 style="margin-top: 0">Bit√°cora</h2>
        <p class="muted" id="bitacoraSubtitle" style="font-size: 13px">
          Prospecto: ...
        </p>
        <div
          id="timelineContainer"
          style="
            flex-grow: 1;
            overflow-y: auto;
            min-height: 200px;
            margin-bottom: 15px;
          "
        ></div>
        <div style="background: #f1f5f9; padding: 15px; border-radius: 8px">
          <div style="display: flex; gap: 10px; margin-bottom: 8px">
            <select id="bitTipo" style="width: 120px">
              <option value="Nota">Nota üìù</option>
              <option value="Llamada">Llamada üìû</option>
              <option value="Correo">Correo üìß</option>
              <option value="Reunion">Reuni√≥n ü§ù</option>
            </select>
            <input type="date" id="bitFecha" style="margin: 0" />
          </div>
          <textarea
            id="bitNota"
            rows="2"
            placeholder="Detalles..."
            style="width: 100%"
          ></textarea>
          <div style="text-align: right; margin-top: 8px">
            <button
              class="btn-head btn-nuevo"
              onclick="guardarBitacora()"
              style="font-size: 12px"
            >
              Agregar
            </button>
          </div>
        </div>
        <div style="text-align: right; margin-top: 10px">
          <button
            type="button"
            class="btn-head btn-secundario"
            onclick="
              document
                .getElementById('modalBitacora')
                .classList.remove('active')
            "
          >
            Cerrar
          </button>
        </div>
      </div>
    </div>

    <div id="pageSpinner" class="spinner-backdrop" aria-hidden="true">
      <div class="spinner-card">
        <div class="spinner"></div>
        <div id="spinnerText">Cargando...</div>
      </div>
    </div>

    <div id="footer"></div>

    <script>
      /* ===== Utilidades ===== */
      function showSpinner(msg) {
        document.getElementById("spinnerText").textContent =
          msg || "Cargando...";
        document.getElementById("pageSpinner").style.display = "grid";
      }
      function hideSpinner() {
        document.getElementById("pageSpinner").style.display = "none";
      }
      function norm(s) {
        return (s || "")
          .toString()
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .trim();
      }

      let PROS = [],
        VIEW = [],
        AGENTES_LISTA = [],
        TARIFAS = [],
        CURRENT_PROS_ID = null;

      document.addEventListener("DOMContentLoaded", async () => {
        try {
          const h = await fetch("header.html");
          if (h.ok)
            document.getElementById("header").innerHTML = await h.text();
          const f = await fetch("footer.html");
          if (f.ok)
            document.getElementById("footer").innerHTML = await f.text();
          const scripts = document
            .getElementById("header")
            .querySelectorAll("script");
          scripts.forEach((s) => eval(s.innerHTML));
        } catch (e) {}

        bindUI();
        await cargarTodo();

        const params = new URLSearchParams(window.location.search);
        const focusId = params.get("id");
        if (focusId) {
          const target = PROS.find((p) => String(p.ID) === String(focusId));
          if (target) {
            VIEW = [target];
            renderTabla();
            abrirFormProspecto(target.ID);
          }
        }
      });

      function bindUI() {
        document
          .getElementById("btnNew")
          .addEventListener("click", () => abrirFormProspecto());
        document
          .getElementById("btnReload")
          .addEventListener("click", cargarTodo);
        document
          .getElementById("inpBuscar")
          .addEventListener("input", aplicarFiltros);
        document
          .getElementById("selTipo")
          .addEventListener("change", aplicarFiltros);
      }

      async function cargarTodo() {
        showSpinner("Cargando...");
        try {
          const [adminData, corretajeData, contactosData, agentes, tarifas] =
            await Promise.all([
              fetchData("ProspectosCopro").catch(() => []),
              fetchData("ProspectosCorretaje").catch(() => []),
              fetchData("contactos").catch(() => []),
              fetchData("Agentes").catch(() => []),
              fetchData("TablaTarifas").catch(() => []),
            ]);

          AGENTES_LISTA = agentes || [];
          TARIFAS = tarifas || [];
          const selAgente = document.getElementById("prosAgente");
          selAgente.innerHTML =
            '<option value="Sin Asignar">-- Sin Asignar --</option>';
          AGENTES_LISTA.forEach(
            (ag) =>
              (selAgente.innerHTML += `<option value="${ag.Nombre}">${ag.Nombre}</option>`),
          );

          // 1. Mapeo Admin
          const listA = adminData.map((p) => ({
            ...p,
            _tipo: "Administracion",
            _tabla: "ProspectosCopro",
            Contacto: p.Contacto || p.Nombre,
          }));
          // 2. Mapeo Corretaje
          const listB = corretajeData.map((p) => ({
            ...p,
            _tipo: "Corretaje",
            _tabla: "ProspectosCorretaje",
            Contacto: p.Nombre,
          }));

          // 3. Mapeo LEADS (contactos no procesados)
          const listC = contactosData
            .filter((c) => c.Estado !== "Procesado")
            .map((c) => {
              // SUGERENCIA DE TIPO SEG√öN ORIGEN
              let tipoSugerido = "Lead";
              if (
                (c.Notas || "").includes("Diagn√≥stico") ||
                String(c.ID).startsWith("LEAD_")
              )
                tipoSugerido = "Administracion";
              else if (String(c.ID).startsWith("WEB_"))
                tipoSugerido = "Corretaje";

              return {
                ID: c.ID,
                Nombre: c.Nombre,
                Email: c.Email,
                Telefono: c.Telefono,
                Observaciones: c.Mensaje + (c.Notas ? `\n\n${c.Notas}` : ""),
                Estado: "Nuevo",
                Comuna: "",
                Direccion: "",
                _tipo: tipoSugerido,
                _tabla: "contactos",
                Canal: "Web/Checklist",
                "Fecha Registro": c.Fecha, // Importante para la fecha
              };
            });

          PROS = [...listA, ...listB, ...listC];

          const comunas = [...new Set(PROS.map((p) => p.Comuna))]
            .filter(Boolean)
            .sort();
          document.getElementById("selComuna").innerHTML =
            '<option value="">(Todas)</option>' +
            comunas.map((c) => `<option value="${c}">${c}</option>`).join("");
          document.getElementById("dlComunas").innerHTML = comunas
            .map((c) => `<option value="${c}">`)
            .join("");

          aplicarFiltros();
        } catch (e) {
          console.error(e);
        } finally {
          hideSpinner();
        }
      }

      function aplicarFiltros() {
        const q = norm(document.getElementById("inpBuscar").value);
        const tipoFilter = document.getElementById("selTipo").value;

        VIEW = PROS.filter((p) => {
          if (tipoFilter && p._tabla !== "contactos" && p._tipo !== tipoFilter)
            return false;
          if (!q) return true;
          return [p.Nombre, p.Comuna, p.Email].some((v) => norm(v).includes(q));
        });
        renderTabla();
      }

      /* ===== RENDER TABLA CON BOTONES ===== */
      function renderTabla() {
        const tbody = document.getElementById("tablaProspectos");
        if (VIEW.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="muted">Sin resultados.</td></tr>';
          return;
        }

        tbody.innerHTML = VIEW.map((p) => {
          let badgeClass = p.Estado === "Nuevo" ? "st-nuevo" : "st-contactado";
          let tipoBadge = "";
          if (p._tipo === "Administracion")
            tipoBadge = '<span class="badge-type type-admin">Admin</span>';
          else if (p._tipo === "Corretaje")
            tipoBadge =
              '<span class="badge-type type-corretaje">Corretaje</span>';
          else tipoBadge = '<span class="badge-source checklist">LEAD</span>';

          // Botones espec√≠ficos
          const esAdmin = p._tipo === "Administracion";

          // Cotizar (Solo Admin)
          const btnCotizar = esAdmin
            ? `<button class="btn-icon btn-cotizar" onclick="abrirCotizacion('${p.ID}')" title="Cotizar Copropiedad"><i class="fa-solid fa-file-invoice-dollar"></i></button>`
            : "";

          // Convertir a Cliente (Solo Admin)
          const btnCliente = esAdmin
            ? `<button class="btn-icon btn-cliente" onclick="agregarAClientes('${p.ID}')" title="Pasar a Cliente (Copropiedad)"><i class="fa-solid fa-check-double"></i></button>`
            : "";

          return `
            <tr>
              <td>
                <div style="font-weight:600;">${p.Nombre} ${p.Canal?.includes("Web") ? '<span class="badge-source">WEB</span>' : ""}</div>
                <span class="badge-status ${badgeClass}">${p.Estado}</span>
                <div style="font-size:11px; margin-top:2px; color:#15803d;">${p.Agente || "Sin Asignar"}</div>
              </td>
              <td style="width:100px;">${tipoBadge}</td>
              <td style="font-size:13px;">${p.Direccion || "‚Äî"} (${p.Comuna || "-"})</td>
              <td style="font-size:13px;">${p.Email || "-"} <br> ${p.Telefono || "-"}</td>
              <td class="no-print">
                <div style="display:flex; gap:5px; flex-wrap:wrap;">
                    <button class="btn-icon btn-ver" onclick="abrirDetalle('${p.ID}')" title="Ver Detalle"><i class="fa-solid fa-eye"></i></button>
                    <button class="btn-icon btn-editar" onclick="abrirFormProspecto('${p.ID}')" title="Editar"><i class="fa-solid fa-pen"></i></button>
                    <button class="btn-icon btn-mapa" onclick="abrirMapa('${p.ID}')" title="Ver Mapa"><i class="fa-solid fa-map-location-dot"></i></button>
                    <button class="btn-icon" onclick="abrirBitacora('${p.ID}')" title="Bit√°cora" style="background:#e0f2fe; color:#0369a1;"><i class="fa-solid fa-clock-rotate-left"></i></button>
                    ${btnCotizar}
                    ${btnCliente}
                    <button class="btn-icon btn-eliminar" onclick="eliminarProspecto('${p.ID}')" title="Eliminar"><i class="fa-solid fa-trash"></i></button>
                </div>
              </td>
            </tr>`;
        }).join("");
      }

      function setTipo(tipo) {
        document.getElementById("prosTipoNegocio").value = tipo;
        document
          .getElementById("btnTipoAdmin")
          .classList.toggle("active", tipo === "Administracion");
        document
          .getElementById("btnTipoCorretaje")
          .classList.toggle("active", tipo === "Corretaje");

        if (tipo === "Administracion") {
          document.getElementById("camposAdmin").classList.remove("hidden");
          document.getElementById("camposCorretaje").classList.add("hidden");
        } else {
          document.getElementById("camposAdmin").classList.add("hidden");
          document.getElementById("camposCorretaje").classList.remove("hidden");
        }
      }

      function abrirFormProspecto(id) {
        const form = document.getElementById("formProspecto");
        form.reset();
        document.getElementById("prospectoID").value = "";
        document.getElementById("prosTablaOriginal").value = "";

        if (id) {
          const p = PROS.find((item) => String(item.ID) === String(id));
          if (!p) return;

          document.getElementById("prospectoID").value = p.ID;
          document.getElementById("prosTablaOriginal").value = p._tabla;

          // Regla: Si es LEAD, sugerir Admin. Si es WEB, sugerir Corretaje.
          let tipoFinal = p._tipo;
          if (String(p.ID).startsWith("LEAD_")) tipoFinal = "Administracion";
          if (String(p.ID).startsWith("WEB_")) tipoFinal = "Corretaje";

          setTipo(tipoFinal);

          document.getElementById("prosNombre").value = p.Nombre || "";
          document.getElementById("prosEstado").value = p.Estado || "Nuevo";
          document.getElementById("prosTelefono").value = p.Telefono || "";
          document.getElementById("prosEmail").value = p.Email || "";
          document.getElementById("prosDireccion").value = p.Direccion || "";
          document.getElementById("prosComuna").value = p.Comuna || "";
          document.getElementById("prosNotas").value = p.Observaciones || "";
          document.getElementById("prosAgente").value =
            p.Agente || "Sin Asignar";

          if (tipoFinal === "Administracion") {
            document.getElementById("prosUnidades").value = p.Unidades || "";
            document.getElementById("prosRUT").value = p.RUT || "";
          } else {
            // Cargar datos corretaje si existen
            document.getElementById("prosOperacion").value =
              p["Tipo Operacion"] || "Venta";
            document.getElementById("prosTipoProp").value =
              p["Tipo Propiedad"] || "";
            document.getElementById("prosPresupuesto").value =
              p["Presupuesto"] || "";
          }
        } else {
          setTipo("Administracion");
        }
        document.getElementById("modalProspecto").classList.add("active");
      }

      /* =========================================
         L√ìGICA DE GUARDADO DEFINITIVA Y CORREGIDA
         ========================================= */
      document.getElementById("formProspecto").onsubmit = async (e) => {
        e.preventDefault();

        const idActual = document.getElementById("prospectoID").value;
        const tablaOriginal =
          document.getElementById("prosTablaOriginal").value;
        const tipoSeleccionado =
          document.getElementById("prosTipoNegocio").value;

        let tablaDestino = "";
        if (tipoSeleccionado === "Administracion")
          tablaDestino = "ProspectosCopro";
        else tablaDestino = "ProspectosCorretaje";

        const esMigracion =
          idActual && tablaOriginal && tablaOriginal !== tablaDestino;

        // Generar ID si es nuevo o migraci√≥n
        let finalID = idActual;
        if (esMigracion || !idActual) {
          const prefijo =
            tipoSeleccionado === "Administracion" ? "PROS_" : "PCOR_";
          finalID = prefijo + Date.now();
        }

        // 1. Datos Base (Campos comunes)
        const basePayload = {
          ID: finalID,
          Nombre: document.getElementById("prosNombre").value,
          Telefono: document.getElementById("prosTelefono").value,
          Email: document.getElementById("prosEmail").value,
          Direccion: document.getElementById("prosDireccion").value,
          Comuna: document.getElementById("prosComuna").value,
          Observaciones: document.getElementById("prosNotas").value,
          Estado: document.getElementById("prosEstado").value,
          Agente: document.getElementById("prosAgente").value,
          "Fecha Registro": new Date().toISOString().split("T")[0],
        };

        // 2. Payload Espec√≠fico seg√∫n Tabla Destino
        let payload = {};
        if (tipoSeleccionado === "Administracion") {
          const u = document.getElementById("prosUnidades").value;
          payload = {
            ...basePayload,
            Tipo: "Administracion",
            Unidades: u ? parseInt(u) : 0,
            RUT: document.getElementById("prosRUT").value || "",
            Contacto: basePayload.Nombre, // Importante: Campo Contacto requerido en Admin
            Presupuesto: 0, // Campo existente en la tabla, lo mandamos en 0
          };
        } else {
          payload = {
            ...basePayload,
            "Tipo Operacion": document.getElementById("prosOperacion").value,
            "Tipo Propiedad": document.getElementById("prosTipoProp").value,
            Presupuesto: document.getElementById("prosPresupuesto").value,
            Canal: "CRM", // Corretaje tiene Canal
          };
        }

        // Georreferencia
        const geo = document.getElementById("prosLatLong").value;
        if (geo) payload["LatLong"] = geo;

        try {
          showSpinner("Guardando...");

          if (esMigracion) {
            // 1. Crear en Destino
            console.log(`Promoviendo a ${tablaDestino}...`);
            await appSheetCRUD(tablaDestino, "Add", [payload]);

            // 2. Actualizar Origen
            if (tablaOriginal === "contactos") {
              await appSheetCRUD("contactos", "Edit", [
                { ID: idActual, Estado: "Procesado" },
              ]);
            } else {
              await appSheetCRUD(tablaOriginal, "Delete", [{ ID: idActual }]);
            }
            alert(`Registro asignado a ${tipoSeleccionado} exitosamente.`);
          } else {
            // Edici√≥n Normal
            const action = idActual ? "Edit" : "Add";
            await appSheetCRUD(tablaDestino, action, [payload]);
            alert("Guardado exitoso");
          }

          document.getElementById("modalProspecto").classList.remove("active");
          await cargarTodo();
        } catch (err) {
          console.error(err);
          alert("Error al guardar: " + (err.message || err));
        } finally {
          hideSpinner();
        }
      };

      async function intentarGeocodificar() {
        const dir = document.getElementById("prosDireccion").value;
        const com = document.getElementById("prosComuna").value;
        const msg = document.getElementById("msgGeo");
        if (dir.length < 5) return;
        try {
          const res = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(dir + ", " + com + ", Chile")}`,
          );
          const data = await res.json();
          if (data && data.length > 0) {
            document.getElementById("prosLatLong").value =
              `${data[0].lat}, ${data[0].lon}`;
            msg.style.display = "block";
            msg.innerHTML = `<i class="fa-solid fa-check"></i> Ubicaci√≥n OK`;
          }
        } catch (e) {}
      }

      function abrirMapa(id) {
        const p = PROS.find((x) => String(x.ID) === String(id));
        if (!p) return;
        const lat = p.LatLong || "";
        if (lat && lat.includes(","))
          window.open(
            `https://www.google.com/maps/search/?api=1&query=${lat.replace(/\s/g, "")}`,
            "_blank",
          );
        else if (p.Direccion)
          window.open(
            `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p.Direccion + ", " + p.Comuna)}`,
            "_blank",
          );
        else alert("Sin direcci√≥n.");
      }

      function abrirDetalle(id) {
        const p = PROS.find((i) => String(i.ID) === String(id));
        if (!p) return;
        document.getElementById("detalleContenido").innerHTML = `
            <p><b>ID:</b> ${p.ID}</p><p><b>Nombre:</b> ${p.Nombre}</p><p><b>Tipo:</b> ${p._tipo}</p>
            <p><b>Agente:</b> ${p.Agente}</p><p><b>Email:</b> ${p.Email}</p><p><b>Tel:</b> ${p.Telefono}</p>
            <p><b>Direcci√≥n:</b> ${p.Direccion} (${p.Comuna})</p><p><b>Notas:</b> ${p.Observaciones}</p>
        `;
        document.getElementById("modalDetalle").classList.add("active");
      }

      async function abrirBitacora(id) {
        CURRENT_PROS_ID = id;
        document.getElementById("modalBitacora").classList.add("active");
        document.getElementById("bitFecha").valueAsDate = new Date();
        const allBits = await fetchData("Bitacora").catch(() => []);
        const history = allBits
          .filter((h) => String(h.ProspectoID) === String(id))
          .sort((a, b) => new Date(b.Fecha) - new Date(a.Fecha));
        const container = document.getElementById("timelineContainer");
        if (!history.length)
          container.innerHTML =
            '<p class="muted" style="text-align:center; padding:20px;">Sin registros</p>';
        else
          container.innerHTML =
            `<div class="timeline">` +
            history
              .map(
                (h) => `
            <div class="timeline-item">
                <div class="timeline-dot ${h.Tipo}"></div>
                <div class="timeline-date">${h.Fecha}</div>
                <div class="timeline-content"><span class="timeline-type">${h.Tipo}</span> ${h.Nota}</div>
            </div>`,
              )
              .join("") +
            `</div>`;
      }

      async function guardarBitacora() {
        const nota = document.getElementById("bitNota").value;
        if (!nota) return alert("Escribe nota");
        let user = "Admin";
        try {
          const u = getAuthUser();
          if (u) user = u.Nombre;
        } catch (e) {}
        const pl = {
          ID: "BIT_" + Date.now(),
          ProspectoID: CURRENT_PROS_ID,
          Fecha: document.getElementById("bitFecha").value,
          Tipo: document.getElementById("bitTipo").value,
          Nota: nota,
          Usuario: user,
        };
        try {
          await appSheetCRUD("Bitacora", "Add", [pl]);
          abrirBitacora(CURRENT_PROS_ID);
          document.getElementById("bitNota").value = "";
        } catch (e) {
          alert("Error al guardar");
        }
      }

      window.abrirCotizacion = async function (id) {
        const p = PROS.find((i) => String(i.ID) === String(id));
        if (!p) return alert("Prospecto no encontrado");
        let factorComuna = 0;
        const tarifa = TARIFAS.find((t) => norm(t.Comuna) === norm(p.Comuna));
        if (tarifa)
          factorComuna = Number(tarifa.Factor || tarifa.FactorComuna || 0);
        let utmValor = 65000;
        try {
          const res = await fetch("https://mindicador.cl/api/utm");
          const data = await res.json();
          utmValor = Number(data?.serie?.[0]?.valor || 65000);
        } catch (e) {}
        const params = new URLSearchParams({
          prospectoId: p.ID,
          nombre: p.Nombre || "",
          direccion: p.Direccion || "",
          comuna: p.Comuna || "",
          unidades: p.Unidades || 0,
          factorComuna,
          utm: utmValor,
        });
        window.location.href = `cotizacion-admin-condominio.html?${params}`;
      };

      window.agregarAClientes = function (id) {
        if (!confirm("¬øConvertir a Cliente Activo? Se crear√° la comunidad."))
          return;
        alert(
          "Funcionalidad en desarrollo: Conectar con m√≥dulo de Copropiedades.",
        );
      };
    </script>
  </body>
</html>
