<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>CRM - Prospectos</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <script src="assets/js/app.js"></script>
    <script>
      requireAuth();
    </script>
    <style>
      /* ESTILOS BASE */
      body { max-width: 1200px; margin: 0 auto; color: #1a2b48; }
      main { padding: 40px; }
      .page-title { font-size: 28px; font-weight: 700; margin-bottom: 16px; }
      
      /* TABLAS */
      table { width: 100%; border-collapse: collapse; }
      th, td { padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: left; }
      th { background: #fafafa; }
      
      /* FORMULARIOS */
      .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; }
      .row > * { flex: 1 1 220px; }
      .label { display: block; font-weight: 600; margin-bottom: 4px; }
      input, select, textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; }
      
      /* SELECTOR TIPO DE NEGOCIO */
      .tipo-selector { display: flex; gap: 10px; margin-bottom: 15px; }
      .tipo-btn {
          flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;
          text-align: center; cursor: pointer; font-weight: 600; color: #64748b;
          background: #f9fafb; transition: all 0.2s;
      }
      .tipo-btn:hover { background: #f3f4f6; }
      .tipo-btn.active { background: #eff6ff; color: #3b82f6; border-color: #3b82f6; }
      .tipo-btn i { margin-right: 5px; }
      
      .hidden { display: none; }

      /* MODAL */
      .modal { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.35); z-index: 10000; align-items: center; justify-content: center; }
      .modal.active { display: flex; }
      .modal-content { width: 100%; max-width: 680px; background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 18px; box-shadow: 0 12px 30px rgba(0, 0, 0, 0.18); max-height: 90vh; overflow-y: auto; }

      /* SPINNER */
      .spinner-backdrop { position: fixed; inset: 0; background: rgba(255, 255, 255, 0.85); display: none; place-items: center; z-index: 12000; }
      .spinner-card { background: #fff; padding: 18px 22px; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08); text-align: center; min-width: 260px; color: #1a2b48; font-weight: 600; }
      .spinner { width: 28px; height: 28px; border-radius: 50%; border: 3px solid #eee; border-top-color: #b46a55; margin: 0 auto 10px; animation: spin 0.9s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg); } }

      .mono { font-family: ui-monospace, monospace; }
      .muted { color: #666; }

      /* BADGES */
      .badge-status { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; white-space: nowrap; }
      .st-nuevo { background: #e0f2fe; color: #0369a1; }
      .st-contactado { background: #fef3c7; color: #b45309; }
      .st-propuesta { background: #f3e8ff; color: #7e22ce; }
      .st-negociacion { background: #ffedd5; color: #c2410c; }
      .st-ganado { background: #dcfce7; color: #15803d; }
      .st-perdido { background: #fee2e2; color: #b91c1c; }
      
      .badge-type { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-right: 5px; text-transform: uppercase; font-weight: bold; }
      .type-admin { background: #e0e7ff; color: #3730a3; border: 1px solid #c7d2fe; }
      .type-corretaje { background: #ffedd5; color: #9a3412; border: 1px solid #fed7aa; }

      /* BIT√ÅCORA */
      .timeline { position: relative; border-left: 2px solid #e2e8f0; margin-left: 10px; padding-left: 20px; margin-top: 15px; }
      .timeline-item { margin-bottom: 20px; position: relative; }
      .timeline-dot { width: 12px; height: 12px; background: #fff; border: 2px solid #3b82f6; border-radius: 50%; position: absolute; left: -27px; top: 5px; }
      .timeline-dot.Llamada { border-color: #3b82f6; }
      .timeline-dot.Correo { border-color: #f59e0b; }
      .timeline-dot.Reunion { border-color: #10b981; }
      .timeline-date { font-size: 11px; color: #94a3b8; font-weight: 600; margin-bottom: 2px; }
      .timeline-content { background: #f8fafc; padding: 10px; border-radius: 6px; border: 1px solid #f1f5f9; font-size: 13px; color: #334155; }
      .timeline-type { font-weight: 700; font-size: 11px; text-transform: uppercase; margin-bottom: 4px; display: block; }
    </style>
  </head>
  <body>
    <div id="header"></div>

    <main>
      <div class="dashboard-header no-print">
        <div class="header-top">
          <h1 class="page-title">Gesti√≥n de Prospectos</h1>

          <div class="header-actions">
            <button class="btn-head btn-secundario" id="btnReload" title="Recargar"><i class="fa-solid fa-rotate-right"></i></button>
            <button class="btn-head btn-secundario" onclick="window.print()" title="Imprimir"><i class="fa-solid fa-print"></i></button>
            <button class="btn-head btn-nuevo" id="btnNew"><i class="fa-solid fa-plus"></i> <span>Nuevo Prospecto</span></button>
          </div>
        </div>

        <div class="header-filters">
          <div class="filter-item" style="flex-grow: 2">
            <label class="label">Buscar</label>
            <input id="inpBuscar" class="input-modern" placeholder="Nombre, comuna, email..." style="width: 95%; height: 40px" />
          </div>
          <div class="filter-item">
            <label class="label">Tipo</label>
            <select id="selTipo" class="input-modern" style="height: 42px">
                <option value="">(Todos)</option>
                <option value="Administracion">Administraci√≥n</option>
                <option value="Corretaje">Corretaje</option>
            </select>
          </div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Nombre / Estado</th>
            <th>Tipo</th>
            <th>Comuna</th>
            <th>Contacto</th>
            <th class="no-print">Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaProspectos">
          <tr><td colspan="5" class="muted">Cargando‚Ä¶</td></tr>
        </tbody>
      </table>
    </main>

    <div id="modalProspecto" class="modal" aria-hidden="true">
      <div class="modal-content">
        <h2 id="modalTitleProspecto">Nuevo Prospecto</h2>
        
        <form id="formProspecto">
          <input type="hidden" id="prospectoID" />
          <input type="hidden" id="prosLatLong" /> 

          <label class="label">Tipo de Negocio</label>
          <div class="tipo-selector">
              <div class="tipo-btn active" onclick="setTipo('Administracion')" id="btnTipoAdmin"><i class="fa-solid fa-building"></i> Administraci√≥n</div>
              <div class="tipo-btn" onclick="setTipo('Corretaje')" id="btnTipoCorretaje"><i class="fa-solid fa-house-user"></i> Corretaje</div>
          </div>
          <input type="hidden" id="prosTipoNegocio" value="Administracion">

          <div class="row">
              <div style="flex: 2;">
                  <label class="label">Nombre</label>
                  <input id="prosNombre" required placeholder="Ej: Edificio Los Andes o Juan P√©rez" />
              </div>
              <div>
                  <label class="label">Estado</label>
                  <select id="prosEstado">
                    <option value="Nuevo">Nuevo</option>
                    <option value="Contactado">Contactado</option>
                    <option value="Propuesta Enviada">Propuesta Enviada</option>
                    <option value="En Negociaci√≥n">En Negociaci√≥n</option>
                    <option value="Cerrado Ganado">Cerrado Ganado</option>
                    <option value="Cerrado Perdido">Cerrado Perdido</option>
                  </select>
              </div>
          </div>

          <div class="row" style="margin-top: 10px;">
              <div style="flex: 1;"><label class="label">Tel√©fono</label><input id="prosTelefono" /></div>
              <div style="flex: 1.5;"><label class="label">Email</label><input id="prosEmail" type="email" /></div>
          </div>

          <div class="row" style="margin-top: 10px;">
              <div style="flex: 2;">
                  <label class="label">Direcci√≥n</label>
                  <input id="prosDireccion" placeholder="Calle y N√∫mero" onchange="intentarGeocodificar()" />
              </div>
              <div style="flex: 1;">
                  <label class="label">Comuna</label>
                  <input id="prosComuna" list="dlComunas" onchange="intentarGeocodificar()" />
                  <datalist id="dlComunas"></datalist>
              </div>
          </div>
          <div id="msgGeo" style="font-size: 11px; color: #10b981; margin-top: 2px; display: none;">
              <i class="fa-solid fa-location-dot"></i> Ubicaci√≥n detectada
          </div>

          <div id="camposAdmin" style="margin-top: 10px;">
              <div class="row">
                  <div><label class="label">Unidades</label><input id="prosUnidades" type="number" /></div>
                  <div><label class="label">RUT Comunidad</label><input id="prosRUT" /></div>
              </div>
          </div>

          <div id="camposCorretaje" class="hidden" style="margin-top: 10px;">
              <div class="row">
                  <div>
                      <label class="label">Inter√©s</label>
                      <select id="prosOperacion">
                          <option value="Venta">Comprar</option>
                          <option value="Arriendo">Arrendar</option>
                          <option value="Vender">Vender</option>
                      </select>
                  </div>
                  <div>
                      <label class="label">Tipo Propiedad</label>
                      <select id="prosTipoProp">
                          <option value="Departamento">Departamento</option>
                          <option value="Casa">Casa</option>
                          <option value="Terreno">Terreno</option>
                          <option value="Parcela">Parcela</option>
                          <option value="Oficina">Oficina</option>
                      </select>
                  </div>
              </div>
              <div class="row" style="margin-top: 10px;">
                  <div><label class="label">Presupuesto</label><input id="prosPresupuesto" placeholder="$" /></div>
              </div>
          </div>

          <label class="label" style="margin-top: 10px;">Notas</label>
          <textarea id="prosNotas" rows="2"></textarea>

          <div style="text-align: right; margin-top: 20px">
            <button type="button" class="btn-head btn-secundario" onclick="cerrarModalProspecto()">Cancelar</button>
            <button type="submit" class="btn-head btn-nuevo">Guardar</button>
          </div>
        </form>
      </div>
    </div>

    <div id="modalDetalle" class="modal" aria-hidden="true">
      <div class="modal-content">
        <h2>Detalle Prospecto</h2>
        <div id="detalleContenido"></div>
        <div style="text-align: right; margin-top: 10px">
          <button class="btn-head btn-secundario" type="button" onclick="document.getElementById('modalDetalle').classList.remove('active')">Cerrar</button>
        </div>
      </div>
    </div>

    <div id="modalBitacora" class="modal" aria-hidden="true">
        <div class="modal-content" style="max-width: 500px; max-height: 85vh; display: flex; flex-direction: column;">
            <h2 style="margin-top: 0">Bit√°cora</h2>
            <p class="muted" id="bitacoraSubtitle" style="font-size: 13px">Prospecto: ...</p>
            <div id="timelineContainer" style="flex-grow: 1; overflow-y: auto; min-height: 200px; margin-bottom: 15px;"></div>
            <div style="background: #f1f5f9; padding: 15px; border-radius: 8px;">
                <div style="display: flex; gap: 10px; margin-bottom: 8px">
                    <select id="bitTipo" style="width: 120px">
                        <option value="Nota">Nota üìù</option>
                        <option value="Llamada">Llamada üìû</option>
                        <option value="Correo">Correo üìß</option>
                        <option value="Reunion">Reuni√≥n ü§ù</option>
                    </select>
                    <input type="date" id="bitFecha" style="margin: 0" />
                </div>
                <textarea id="bitNota" rows="2" placeholder="Detalles..." style="width: 100%;"></textarea>
                <div style="text-align: right; margin-top: 8px">
                    <button class="btn-head btn-nuevo" onclick="guardarBitacora()" style="font-size: 12px">Agregar</button>
                </div>
            </div>
            <div style="text-align: right; margin-top: 10px">
                <button type="button" class="btn-head btn-secundario" onclick="document.getElementById('modalBitacora').classList.remove('active')">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="pageSpinner" class="spinner-backdrop" aria-hidden="true">
      <div class="spinner-card"><div class="spinner"></div><div id="spinnerText">Cargando...</div></div>
    </div>
    <div id="footer"></div>

    <script>
      /* UTILS */
      function showSpinner(msg) { const sp = document.getElementById("pageSpinner"); if (msg) document.getElementById("spinnerText").textContent = msg; sp.style.display = "grid"; }
      function hideSpinner() { document.getElementById("pageSpinner").style.display = "none"; }
      function norm(s) { return (s || "").toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim(); }
      function getKeyVal(o) { return o.ID || o.id || ""; }

      /* ESTADO GLOBAL */
      let PROS = [], VIEW = [], TARIFAS = [], CURRENT_PROS_ID = null;

      /* BOOT */
      document.addEventListener("DOMContentLoaded", async () => {
        try { document.getElementById("header").innerHTML = await (await fetch("header.html")).text(); if(typeof initHeader==='function') initHeader(); } catch (e) {}
        try { document.getElementById("footer").innerHTML = await (await fetch("footer.html")).text(); } catch (e) {}
        
        bindUI();
        await cargarTodo();
      });

      function bindUI() {
        document.getElementById("btnNew").addEventListener("click", () => abrirFormProspecto());
        document.getElementById("btnReload").addEventListener("click", cargarTodo);
        document.getElementById("inpBuscar").addEventListener("input", aplicarFiltros);
        document.getElementById("selTipo").addEventListener("change", aplicarFiltros);
      }

      /* CARGA DE DATOS */
      async function cargarTodo() {
        showSpinner("Cargando datos...");
        try {
            const [adminData, corretajeData, tarifas] = await Promise.all([
                fetchData("ProspectosCopro").catch(()=>[]),
                fetchData("ProspectosCorretaje").catch(()=>[]),
                fetchData("TablaTarifas").catch(()=>[])
            ]);

            TARIFAS = tarifas || [];

            const listA = adminData.map(p => ({
                ...p, _tipo: 'Administracion', _tabla: 'ProspectosCopro',
                Contacto: p.Contacto || p.Email || "" 
            }));
            const listB = corretajeData.map(p => ({
                ...p, _tipo: 'Corretaje', _tabla: 'ProspectosCorretaje',
                Contacto: p.Email || p.Telefono || ""
            }));

            PROS = [...listA, ...listB];
            
            // Cargar comunas en datalist
            const comunas = [...new Set(TARIFAS.map(t => t.Comuna))].sort();
            document.getElementById("dlComunas").innerHTML = comunas.map(c => `<option value="${c}">`).join("");

            aplicarFiltros();
        } catch(e) { console.error(e); } finally { hideSpinner(); }
      }

      /* RENDER TABLA (CON BOTONES RESTAURADOS) */
      function aplicarFiltros() {
        const q = norm(document.getElementById("inpBuscar").value);
        const tipoFilter = document.getElementById("selTipo").value;
        VIEW = PROS.filter(p => {
            if (tipoFilter && p._tipo !== tipoFilter) return false;
            if (!q) return true;
            return [p.Nombre, p.Comuna, p.Estado, p.Direccion, p.Email].some(v => norm(v).includes(q));
        });
        renderTabla();
      }

      function renderTabla() {
        const tbody = document.getElementById("tablaProspectos");
        if (VIEW.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="muted">Sin resultados.</td></tr>'; return; }
        
        tbody.innerHTML = VIEW.map(p => {
            let badgeClass = "st-nuevo";
            const est = (p.Estado||"").toLowerCase();
            if (est.includes("ganado") || est.includes("firmado")) badgeClass = "st-ganado";
            else if (est.includes("negociaci√≥n")) badgeClass = "st-negociacion";
            else if (est.includes("propuesta")) badgeClass = "st-propuesta";
            else if (est.includes("perdido")) badgeClass = "st-perdido";

            const tipoBadge = p._tipo === 'Administracion' 
                ? '<span class="badge-type type-admin"><i class="fa-solid fa-building"></i> Admin</span>' 
                : '<span class="badge-type type-corretaje"><i class="fa-solid fa-house-user"></i> Corretaje</span>';

            const esAdmin = p._tipo === 'Administracion';

            return `<tr>
                    <td>
                        <div style="font-weight:600;">${p.Nombre || "Sin Nombre"}</div>
                        <span class="badge-status ${badgeClass}">${p.Estado || "Nuevo"}</span>
                    </td>
                    <td>${tipoBadge}</td>
                    <td>${p.Comuna || "‚Äî"}</td>
                    <td>${p.Email || p.Telefono || "‚Äî"}</td>
                    <td class="no-print">
                        <div style="display:flex; gap:5px;">
                            <button class="btn-icon btn-ver" onclick="abrirDetalle('${p.ID}')" title="Ver"><i class="fa-solid fa-eye"></i></button>
                            <button class="btn-icon btn-editar" onclick="abrirFormProspecto('${p.ID}', '${p._tipo}')" title="Editar"><i class="fa-solid fa-pen"></i></button>
                            <button class="btn-icon btn-mapa" onclick="abrirMapa('${p.ID}')" title="Mapa" style="background:#f1f5f9;"><i class="fa-solid fa-map-location-dot"></i></button>
                            <button class="btn-icon" onclick="abrirBitacora('${p.ID}')" title="Bit√°cora" style="background:#e0f2fe; color:#0369a1;"><i class="fa-solid fa-clock-rotate-left"></i></button>
                            ${esAdmin ? `<button class="btn-icon btn-cotizar" onclick="abrirCotizacion('${p.ID}')" title="Cotizar"><i class="fa-solid fa-file-invoice-dollar"></i></button>` : ''}
                            <button class="btn-icon btn-eliminar" onclick="eliminarProspecto('${p.ID}')" title="Eliminar"><i class="fa-solid fa-trash"></i></button>
                            ${esAdmin ? `<button class="btn-icon btn-cliente" onclick="agregarAClientes('${p.ID}')" title="Convertir a Cliente"><i class="fa-solid fa-check-double"></i></button>` : ''}
                        </div>
                    </td>
                </tr>`;
        }).join("");
      }

      /* MODAL FORMULARIO */
      function setTipo(tipo) {
          document.getElementById('prosTipoNegocio').value = tipo;
          document.getElementById('btnTipoAdmin').classList.toggle('active', tipo === 'Administracion');
          document.getElementById('btnTipoCorretaje').classList.toggle('active', tipo === 'Corretaje');
          document.getElementById('camposAdmin').className = tipo === 'Administracion' ? '' : 'hidden';
          document.getElementById('camposCorretaje').className = tipo === 'Corretaje' ? '' : 'hidden';
      }

      function abrirFormProspecto(id, tipoExistente) {
          document.getElementById("formProspecto").reset();
          document.getElementById("prospectoID").value = "";
          if(id) {
              const p = PROS.find(item => String(item.ID) === String(id));
              if(!p) return;
              document.getElementById("prospectoID").value = p.ID;
              setTipo(tipoExistente || p._tipo);
              document.getElementById("prosNombre").value = p.Nombre || "";
              document.getElementById("prosEstado").value = p.Estado || "Nuevo";
              document.getElementById("prosTelefono").value = p.Telefono || "";
              document.getElementById("prosEmail").value = p.Email || "";
              document.getElementById("prosDireccion").value = p.Direccion || "";
              document.getElementById("prosComuna").value = p.Comuna || "";
              document.getElementById("prosNotas").value = p.Observaciones || "";
              
              if(p._tipo === 'Administracion') {
                  document.getElementById("prosUnidades").value = p.Unidades || "";
                  document.getElementById("prosRUT").value = p.RUT || "";
              } else {
                  document.getElementById("prosOperacion").value = p["Tipo Operacion"] || "Venta";
                  document.getElementById("prosTipoProp").value = p["Tipo Propiedad"] || "";
                  document.getElementById("prosPresupuesto").value = p["Presupuesto"] || "";
              }
          } else { setTipo('Administracion'); }
          document.getElementById("modalProspecto").classList.add("active");
      }
      function cerrarModalProspecto() { document.getElementById("modalProspecto").classList.remove("active"); }

      /* GEOCODIFICACI√ìN */
      async function intentarGeocodificar() {
          const dir = document.getElementById('prosDireccion').value;
          const com = document.getElementById('prosComuna').value;
          const msg = document.getElementById('msgGeo');
          const latLongField = document.getElementById('prosLatLong');
          if(dir.length < 5) return;
          try {
              const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(dir + ", " + com + ", Chile")}`);
              const data = await res.json();
              if(data && data.length > 0) {
                  latLongField.value = `${data[0].lat}, ${data[0].lon}`;
                  msg.style.display = 'block'; msg.innerHTML = `<i class="fa-solid fa-check"></i> Ubicaci√≥n OK`;
              }
          } catch(e) {}
      }

      /* GUARDAR DATOS (SUBMIT) */
      document.getElementById('formProspecto').onsubmit = async (e) => {
          e.preventDefault();
          const id = document.getElementById("prospectoID").value;
          const tipo = document.getElementById("prosTipoNegocio").value;
          let tabla = "", payload = {};

          if(tipo === 'Administracion') {
              tabla = "ProspectosCopro";
              const newID = id || ("PROS_" + Date.now());
              payload = {
                  "ID": newID,
                  "Nombre": document.getElementById('prosNombre').value,
                  "Comuna": document.getElementById('prosComuna').value,
                  "Unidades": document.getElementById('prosUnidades').value,
                  "Direccion": document.getElementById('prosDireccion').value,
                  "RUT": document.getElementById('prosRUT').value,
                  "Contacto": document.getElementById('prosNombre').value, // Duplicamos nombre en contacto si no hay persona espec√≠fica
                  "Estado": document.getElementById('prosEstado').value,
                  "Telefono": document.getElementById('prosTelefono').value,
                  "Tipo": "Administracion",
                  "Email": document.getElementById('prosEmail').value,
                  "Observaciones": document.getElementById('prosNotas').value,
                  "Fecha Registro": new Date().toISOString().split('T')[0]
                  // Agente se puede agregar
              };
              const geo = document.getElementById('prosLatLong').value;
              if(geo) payload["LatLong"] = geo;

          } else {
              tabla = "ProspectosCorretaje";
              const newID = id || ("PCOR_" + Date.now());
              payload = {
                  "ID": newID,
                  "Estado": document.getElementById('prosEstado').value,
                  "Nombre": document.getElementById('prosNombre').value,
                  "Telefono": document.getElementById('prosTelefono').value,
                  "Email": document.getElementById('prosEmail').value,
                  "Tipo Operacion": document.getElementById('prosOperacion').value,
                  "Tipo Propiedad": document.getElementById('prosTipoProp').value,
                  "Presupuesto": document.getElementById('prosPresupuesto').value,
                  "Direccion": document.getElementById('prosDireccion').value,
                  "Comuna": document.getElementById('prosComuna').value,
                  "Observaciones": document.getElementById('prosNotas').value,
                  "Fecha Registro": new Date().toISOString().split('T')[0],
                  "Canal": "CRM Web"
              };
          }

          console.log("Guardando en:", tabla, payload);
          try {
              showSpinner("Guardando...");
              if(typeof appSheetCRUD === 'function') {
                  const action = id ? "Edit" : "Add";
                  await appSheetCRUD(tabla, action, [payload]);
              }
              cerrarModalProspecto();
              await cargarTodo();
              alert("Guardado exitoso");
          } catch(err) {
              alert("Error: " + err.message);
          } finally {
              hideSpinner();
          }
      };

      /* ELIMINAR */
      async function eliminarProspecto(id) {
          if(!confirm("¬øEliminar?")) return;
          const p = PROS.find(i => String(i.ID) === String(id));
          if(!p) return;
          
          try {
              showSpinner("Eliminando...");
              await appSheetCRUD(p._tabla, "Delete", [{ "ID": id }]);
              await cargarTodo();
          } catch(e) { alert("Error: " + e.message); } finally { hideSpinner(); }
      }

      /* MAPA */
      function abrirMapa(id) {
          const p = PROS.find(i => String(i.ID) === String(id));
          if(!p) return;
          // Prioridad: LatLong > Direcci√≥n
          const lat = p.LatLong || p.Coordenadas || "";
          if(lat && lat.includes(",")) {
              window.open(`https://www.google.com/maps/search/?api=1&query=$${lat.replace(/\s/g, "")}`, "_blank");
          } else if(p.Direccion) {
              window.open(`https://www.google.com/maps/search/?api=1&query=$${encodeURIComponent(p.Direccion + ", " + p.Comuna)}`, "_blank");
          } else {
              alert("Sin direcci√≥n ni coordenadas.");
          }
      }

      /* DETALLE */
      function abrirDetalle(id) {
          const p = PROS.find(i => String(i.ID) === String(id));
          if(!p) return;
          document.getElementById("detalleContenido").innerHTML = `
            <p><b>ID:</b> ${p.ID}</p>
            <p><b>Nombre:</b> ${p.Nombre}</p>
            <p><b>Tipo:</b> ${p._tipo}</p>
            <p><b>Email:</b> ${p.Email || "-"}</p>
            <p><b>Tel:</b> ${p.Telefono || "-"}</p>
            <p><b>Direcci√≥n:</b> ${p.Direccion || "-"} (${p.Comuna})</p>
            <p><b>Observaciones:</b> ${p.Observaciones || "-"}</p>
          `;
          document.getElementById("modalDetalle").classList.add("active");
      }

      /* BIT√ÅCORA */
      async function abrirBitacora(id) {
          CURRENT_PROS_ID = id;
          document.getElementById("modalBitacora").classList.add("active");
          document.getElementById("bitFecha").valueAsDate = new Date();
          
          // Cargar bit√°cora (suponiendo tabla 'Bitacora' unificada)
          const allBits = await fetchData("Bitacora").catch(()=>[]);
          const history = allBits.filter(h => String(h.ProspectoID) === String(id));
          history.sort((a,b) => new Date(b.Fecha) - new Date(a.Fecha));
          
          const container = document.getElementById("timelineContainer");
          if(!history.length) container.innerHTML = '<p class="muted" style="text-align:center; padding:20px;">Sin registros</p>';
          else container.innerHTML = `<div class="timeline">` + history.map(h => `
            <div class="timeline-item">
                <div class="timeline-dot ${h.Tipo}"></div>
                <div class="timeline-date">${h.Fecha}</div>
                <div class="timeline-content"><span class="timeline-type">${h.Tipo}</span> ${h.Nota}</div>
            </div>`).join("") + `</div>`;
      }

      async function guardarBitacora() {
          const nota = document.getElementById("bitNota").value;
          if(!nota) return alert("Escribe una nota");
          const payload = {
              "ID": "BIT_" + Date.now(),
              "ProspectoID": CURRENT_PROS_ID,
              "Fecha": document.getElementById("bitFecha").value,
              "Tipo": document.getElementById("bitTipo").value,
              "Nota": nota,
              "Usuario": "Admin"
          };
          await appSheetCRUD("Bitacora", "Add", [payload]);
          abrirBitacora(CURRENT_PROS_ID); // Recargar
          document.getElementById("bitNota").value = "";
      }

      /* CONVERTIR A CLIENTE (Admin) */
      async function agregarAClientes(id) {
          if(!confirm("¬øConvertir a Copropiedad (Cliente)?")) return;
          const p = PROS.find(i => String(i.ID) === String(id));
          
          // Logic to add to Copropiedades table...
          // (Mantener l√≥gica original de tu c√≥digo anterior o simplificar)
          alert("Funci√≥n disponible para Admin");
      }
      
      /* COTIZAR (Admin) */
      function abrirCotizacion(id) {
          const p = PROS.find(i => String(i.ID) === String(id));
          // Redirigir a cotizador...
          if(p) window.location.href = `cotizacion-admin-condominio.html?prospectoId=${p.ID}&unidades=${p.Unidades}&comuna=${p.Comuna}`;
      }
    </script>
  </body>
</html>