<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>CRM - Prospectos</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <script src="assets/js/app.js"></script>
    <script>
      requireAuth();
    </script>
    <style>
      /* ... Tus estilos anteriores (tablas, modales, etc) ... */
      body {
        max-width: 1200px;
        margin: 0 auto;
        color: #1a2b48;
      }
      main {
        padding: 40px;
      }
      .page-title {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 16px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 8px;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
      }
      th {
        background: #fafafa;
      }
      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: end;
      }
      .row > * {
        flex: 1 1 220px;
      }
      .label {
        display: block;
        font-weight: 600;
        margin-bottom: 4px;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        box-sizing: border-box;
      }

      .tipo-selector {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }
      .tipo-btn {
        flex: 1;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        text-align: center;
        cursor: pointer;
        font-weight: 600;
        color: #64748b;
        background: #f9fafb;
        transition: all 0.2s;
      }
      .tipo-btn:hover {
        background: #f3f4f6;
      }
      .tipo-btn.active {
        background: #eff6ff;
        color: #3b82f6;
        border-color: #3b82f6;
      }
      .hidden {
        display: none;
      }

      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        z-index: 10000;
        align-items: center;
        justify-content: center;
      }
      .modal.active {
        display: flex;
      }
      .modal-content {
        width: 100%;
        max-width: 680px;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 18px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.18);
        max-height: 90vh;
        overflow-y: auto;
      }

      .spinner-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.85);
        display: none;
        place-items: center;
        z-index: 12000;
      }
      .spinner-card {
        background: #fff;
        padding: 18px 22px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
        text-align: center;
        min-width: 260px;
        color: #1a2b48;
        font-weight: 600;
      }
      .spinner {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 3px solid #eee;
        border-top-color: #b46a55;
        margin: 0 auto 10px;
        animation: spin 0.9s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .badge-status {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        white-space: nowrap;
      }
      .st-nuevo {
        background: #e0f2fe;
        color: #0369a1;
      }
      .st-ganado {
        background: #dcfce7;
        color: #15803d;
      }
      .badge-type {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 4px;
        margin-right: 5px;
        text-transform: uppercase;
        font-weight: bold;
      }
      .type-admin {
        background: #e0e7ff;
        color: #3730a3;
        border: 1px solid #c7d2fe;
      }
      .type-corretaje {
        background: #ffedd5;
        color: #9a3412;
        border: 1px solid #fed7aa;
      }
      .muted {
        color: #666;
      }
    </style>
  </head>
  <body>
    <div id="header"></div>

    <main>
      <div class="dashboard-header no-print">
        <div class="header-top">
          <h1 class="page-title">Gestión de Prospectos</h1>
          <div class="header-actions">
            <button
              class="btn-head btn-secundario"
              id="btnReload"
              title="Recargar"
            >
              <i class="fa-solid fa-rotate-right"></i>
            </button>
            <button class="btn-head btn-nuevo" id="btnNew">
              <i class="fa-solid fa-plus"></i> <span>Nuevo Prospecto</span>
            </button>
          </div>
        </div>
        <div class="header-filters">
          <div class="filter-item" style="flex-grow: 2">
            <label class="label">Buscar</label>
            <input
              id="inpBuscar"
              class="input-modern"
              placeholder="Nombre, comuna..."
              style="width: 95%; height: 40px"
            />
          </div>
          <div class="filter-item">
            <label class="label">Tipo</label>
            <select id="selTipo" class="input-modern" style="height: 42px">
              <option value="">(Todos)</option>
              <option value="Administracion">Administración</option>
              <option value="Corretaje">Corretaje</option>
            </select>
          </div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Nombre / Estado</th>
            <th>Tipo</th>
            <th>Comuna</th>
            <th>Contacto</th>
            <th class="no-print">Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaProspectos">
          <tr>
            <td colspan="5" class="muted">Cargando…</td>
          </tr>
        </tbody>
      </table>
    </main>

    <div id="modalProspecto" class="modal" aria-hidden="true">
      <div class="modal-content">
        <h2 id="modalTitleProspecto">Nuevo Prospecto</h2>

        <form id="formProspecto">
          <input type="hidden" id="prospectoID" />
          <input type="hidden" id="prosLatLong" />

          <label class="label">Tipo de Negocio</label>
          <div class="tipo-selector">
            <div
              class="tipo-btn active"
              onclick="setTipo('Administracion')"
              id="btnTipoAdmin"
            >
              <i class="fa-solid fa-building"></i> Administración
            </div>
            <div
              class="tipo-btn"
              onclick="setTipo('Corretaje')"
              id="btnTipoCorretaje"
            >
              <i class="fa-solid fa-house-user"></i> Corretaje
            </div>
          </div>
          <input type="hidden" id="prosTipoNegocio" value="Administracion" />

          <div class="row">
            <div style="flex: 2">
              <label class="label">Nombre</label>
              <input
                id="prosNombre"
                required
                placeholder="Ej: Edificio Los Andes"
              />
            </div>
            <div>
              <label class="label">Estado</label>
              <select id="prosEstado">
                <option value="Nuevo">Nuevo</option>
                <option value="Contactado">Contactado</option>
                <option value="En Negociación">En Negociación</option>
                <option value="Cerrado Ganado">Cerrado Ganado</option>
                <option value="Cerrado Perdido">Cerrado Perdido</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top: 10px">
            <div style="flex: 1">
              <label class="label">Teléfono</label><input id="prosTelefono" />
            </div>
            <div style="flex: 1.5">
              <label class="label">Email</label
              ><input id="prosEmail" type="email" />
            </div>
          </div>

          <div class="row" style="margin-top: 10px">
            <div style="flex: 2">
              <label class="label">Dirección</label>
              <input id="prosDireccion" onchange="intentarGeocodificar()" />
            </div>
            <div style="flex: 1">
              <label class="label">Comuna</label>
              <input
                id="prosComuna"
                list="dlComunas"
                onchange="intentarGeocodificar()"
              />
              <datalist id="dlComunas"></datalist>
            </div>
          </div>
          <div
            id="msgGeo"
            style="
              font-size: 11px;
              color: #10b981;
              margin-top: 2px;
              display: none;
            "
          >
            <i class="fa-solid fa-location-dot"></i> Ubicación detectada
          </div>

          <div id="camposAdmin" style="margin-top: 10px">
            <div class="row">
              <div>
                <label class="label">Unidades</label
                ><input id="prosUnidades" type="number" />
              </div>
              <div>
                <label class="label">RUT Comunidad</label><input id="prosRUT" />
              </div>
            </div>
          </div>

          <div id="camposCorretaje" class="hidden" style="margin-top: 10px">
            <div class="row">
              <div>
                <label class="label">Interés</label>
                <select id="prosOperacion">
                  <option value="Venta">Comprar</option>
                  <option value="Arriendo">Arrendar</option>
                  <option value="Vender">Vender</option>
                </select>
              </div>
              <div>
                <label class="label">Tipo Propiedad</label>
                <select id="prosTipoProp">
                  <option value="Departamento">Departamento</option>
                  <option value="Casa">Casa</option>
                  <option value="Terreno">Terreno</option>
                </select>
              </div>
            </div>
            <div class="row" style="margin-top: 10px">
              <div>
                <label class="label">Presupuesto</label
                ><input id="prosPresupuesto" />
              </div>
            </div>
          </div>

          <label class="label" style="margin-top: 10px">Notas</label>
          <textarea id="prosNotas" rows="2"></textarea>

          <div style="text-align: right; margin-top: 20px">
            <button
              type="button"
              class="btn-head btn-secundario"
              onclick="cerrarModalProspecto()"
            >
              Cancelar
            </button>
            <button type="submit" class="btn-head btn-nuevo">Guardar</button>
          </div>
        </form>
      </div>
    </div>

    <div id="pageSpinner" class="spinner-backdrop" aria-hidden="true">
      <div class="spinner-card">
        <div class="spinner"></div>
        <div id="spinnerText">Cargando...</div>
      </div>
    </div>
    <div id="footer"></div>

    <script>
      function showSpinner(msg) {
        const sp = document.getElementById("pageSpinner");
        if (msg) document.getElementById("spinnerText").textContent = msg;
        sp.style.display = "grid";
      }
      function hideSpinner() {
        document.getElementById("pageSpinner").style.display = "none";
      }
      function norm(s) {
        return (s || "")
          .toString()
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .trim();
      }
      function getKeyVal(o) {
        return o.ID || o.id || "";
      }

      let PROS = [],
        VIEW = [];

      document.addEventListener("DOMContentLoaded", async () => {
        try {
          document.getElementById("header").innerHTML = await (
            await fetch("header.html")
          ).text();
          if (typeof initHeader === "function") initHeader();
        } catch (e) {}
        try {
          document.getElementById("footer").innerHTML = await (
            await fetch("footer.html")
          ).text();
        } catch (e) {}
        bindUI();
        await cargarTodo();
      });

      function bindUI() {
        document
          .getElementById("btnNew")
          .addEventListener("click", () => abrirFormProspecto());
        document
          .getElementById("btnReload")
          .addEventListener("click", cargarTodo);
        document
          .getElementById("inpBuscar")
          .addEventListener("input", aplicarFiltros);
        document
          .getElementById("selTipo")
          .addEventListener("change", aplicarFiltros);
      }

      async function cargarTodo() {
        showSpinner("Cargando datos...");
        try {
          const [adminData, corretajeData] = await Promise.all([
            fetchData("ProspectosCopro").catch(() => []),
            fetchData("ProspectosCorretaje").catch(() => []),
          ]);

          const listA = adminData.map((p) => ({
            ...p,
            _tipo: "Administracion",
            _tabla: "ProspectosCopro",
          }));
          const listB = corretajeData.map((p) => ({
            ...p,
            _tipo: "Corretaje",
            _tabla: "ProspectosCorretaje",
          }));

          PROS = [...listA, ...listB];
          aplicarFiltros();
        } catch (e) {
          console.error(e);
        } finally {
          hideSpinner();
        }
      }

      function aplicarFiltros() {
        const q = norm(document.getElementById("inpBuscar").value);
        const tipoFilter = document.getElementById("selTipo").value;
        VIEW = PROS.filter((p) => {
          if (tipoFilter && p._tipo !== tipoFilter) return false;
          if (!q) return true;
          return [p.Nombre, p.Comuna, p.Estado, p.Direccion].some((v) =>
            norm(v).includes(q)
          );
        });
        renderTabla();
      }

      function renderTabla() {
        const tbody = document.getElementById("tablaProspectos");
        if (VIEW.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="muted">Sin resultados.</td></tr>';
          return;
        }
        tbody.innerHTML = VIEW.map((p) => {
          let badgeClass = "st-nuevo";
          if ((p.Estado || "").includes("Ganado")) badgeClass = "st-ganado";
          const tipoBadge =
            p._tipo === "Administracion"
              ? '<span class="badge-type type-admin">Admin</span>'
              : '<span class="badge-type type-corretaje">Corretaje</span>';
          return `<tr>
                    <td><div style="font-weight:600;">${
                      p.Nombre || "Sin Nombre"
                    }</div><span class="badge-status ${badgeClass}">${
            p.Estado || "Nuevo"
          }</span></td>
                    <td>${tipoBadge}</td>
                    <td>${p.Comuna || "—"}</td>
                    <td>${p.Email || p.Telefono || "—"}</td>
                    <td><button class="btn-icon btn-editar" onclick="abrirFormProspecto('${
                      p.ID
                    }', '${
            p._tipo
          }')"><i class="fa-solid fa-pen"></i></button></td>
                </tr>`;
        }).join("");
      }

      function setTipo(tipo) {
        document.getElementById("prosTipoNegocio").value = tipo;
        document
          .getElementById("btnTipoAdmin")
          .classList.toggle("active", tipo === "Administracion");
        document
          .getElementById("btnTipoCorretaje")
          .classList.toggle("active", tipo === "Corretaje");
        document.getElementById("camposAdmin").className =
          tipo === "Administracion" ? "" : "hidden";
        document.getElementById("camposCorretaje").className =
          tipo === "Corretaje" ? "" : "hidden";
      }

      function abrirFormProspecto(id, tipoExistente) {
        document.getElementById("formProspecto").reset();
        document.getElementById("prospectoID").value = "";
        if (id) {
          const p = PROS.find((item) => String(item.ID) === String(id));
          if (!p) return;
          document.getElementById("prospectoID").value = p.ID;
          setTipo(tipoExistente || p._tipo);
          document.getElementById("prosNombre").value = p.Nombre || "";
          document.getElementById("prosEstado").value = p.Estado || "Nuevo";
          document.getElementById("prosTelefono").value = p.Telefono || "";
          document.getElementById("prosEmail").value = p.Email || "";
          document.getElementById("prosDireccion").value = p.Direccion || "";
          document.getElementById("prosComuna").value = p.Comuna || "";
          document.getElementById("prosNotas").value = p.Observaciones || "";
          if (p._tipo === "Administracion") {
            document.getElementById("prosUnidades").value = p.Unidades || "";
            document.getElementById("prosRUT").value = p.RUT || "";
          } else {
            document.getElementById("prosOperacion").value =
              p["Tipo Operacion"] || "Venta";
            document.getElementById("prosTipoProp").value =
              p["Tipo Propiedad"] || "";
            document.getElementById("prosPresupuesto").value =
              p["Presupuesto"] || "";
          }
        } else {
          setTipo("Administracion");
        }
        document.getElementById("modalProspecto").classList.add("active");
      }
      function cerrarModalProspecto() {
        document.getElementById("modalProspecto").classList.remove("active");
      }

      async function intentarGeocodificar() {
        const dir = document.getElementById("prosDireccion").value;
        const com = document.getElementById("prosComuna").value;
        const msg = document.getElementById("msgGeo");
        const latLongField = document.getElementById("prosLatLong");
        if (dir.length < 5) return;
        try {
          const res = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
              dir + ", " + com + ", Chile"
            )}`
          );
          const data = await res.json();
          if (data && data.length > 0) {
            latLongField.value = `${data[0].lat}, ${data[0].lon}`;
            msg.style.display = "block";
            msg.innerHTML = `<i class="fa-solid fa-check"></i> Ubicación OK`;
          }
        } catch (e) {}
      }

      /* SUBMIT FINAL CORREGIDO */
      document.getElementById("formProspecto").onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById("prospectoID").value;
        const tipo = document.getElementById("prosTipoNegocio").value;
        let tablaDestino = "",
          payload = {};

        if (tipo === "Administracion") {
          tablaDestino = "ProspectosCopro";
          const nuevoID = id || "PROS_" + Date.now();
          payload = {
            ID: nuevoID,
            Nombre: document.getElementById("prosNombre").value,
            Comuna: document.getElementById("prosComuna").value,
            Unidades: document.getElementById("prosUnidades").value,
            Direccion: document.getElementById("prosDireccion").value,
            RUT: document.getElementById("prosRUT").value,
            Contacto: document.getElementById("prosNombre").value, // Contacto = Nombre por defecto
            Estado: document.getElementById("prosEstado").value,
            Telefono: document.getElementById("prosTelefono").value,
            Tipo: "Administracion",
            Email: document.getElementById("prosEmail").value,
            Observaciones: document.getElementById("prosNotas").value,
            "Fecha Registro": new Date().toISOString().split("T")[0],
            // Agente se puede agregar si tienes la variable global
          };
          const geo = document.getElementById("prosLatLong").value;
          if (geo) payload["LatLong"] = geo; // Mapeo a nueva columna LatLong
        } else {
          tablaDestino = "ProspectosCorretaje";
          const nuevoID = id || "PCOR_" + Date.now();
          payload = {
            ID: nuevoID,
            Estado: document.getElementById("prosEstado").value,
            Nombre: document.getElementById("prosNombre").value,
            Telefono: document.getElementById("prosTelefono").value,
            Email: document.getElementById("prosEmail").value,
            "Tipo Operacion": document.getElementById("prosOperacion").value,
            "Tipo Propiedad": document.getElementById("prosTipoProp").value,
            Presupuesto: document.getElementById("prosPresupuesto").value,
            Direccion: document.getElementById("prosDireccion").value,
            Comuna: document.getElementById("prosComuna").value,
            Observaciones: document.getElementById("prosNotas").value,
            "Fecha Registro": new Date().toISOString().split("T")[0],
            Canal: "CRM Web",
          };
        }

        console.log("Enviando a:", tablaDestino, payload);
        try {
          showSpinner("Guardando...");
          if (typeof appSheetCRUD === "function") {
            const action = id ? "Edit" : "Add";
            await appSheetCRUD(tablaDestino, action, [payload]);
          }
          cerrarModalProspecto();
          await cargarTodo();
          alert("Guardado exitoso");
        } catch (err) {
          alert("Error: " + err.message);
        } finally {
          hideSpinner();
        }
      };
    </script>
  </body>
</html>
