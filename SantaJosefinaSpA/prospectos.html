<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>CRM - Prospectos</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/css/styles.css" />
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1a2b48">
<link rel="apple-touch-icon" href="assets/img/icon-192.png">

    <script src="assets/js/app.js"></script>
    <script>
      requireAuth();
    </script>
    
      <link rel="stylesheet" href="assets/css/pages/prospectos.inline.css">
</head>
  <body>
    <div id="header"></div>

    <main>
      <div class="dashboard-header no-print">
        <div class="header-top">
          <h1 class="page-title">Gesti√≥n de Prospectos</h1>

          <div class="header-actions">
            <button
              class="btn-head btn-secundario"
              id="btnReload"
              title="Recargar"
            >
              <i class="fa-solid fa-rotate-right"></i>
            </button>
            <button
              class="btn-head btn-secundario"
              onclick="window.print()"
              title="Imprimir"
            >
              <i class="fa-solid fa-print"></i>
            </button>
            <button class="btn-head btn-nuevo" id="btnNew">
              <i class="fa-solid fa-plus"></i>
              <span>Nuevo Prospecto</span>
            </button>
          </div>
        </div>

        <div class="header-filters">
          <div class="filter-item" style="flex-grow: 2">
            <label class="label">Buscar</label>
            <input
              id="inpBuscar"
              class="input-modern"
              placeholder="Nombre, comuna, email..."
              style="width: 95%; height: 40px"
            />
          </div>

          <div class="filter-item">
            <label class="label">Comuna</label>
            <select id="selComuna" class="input-modern" style="height: 42px">
              <option value="">(Todas)</option>
            </select>
          </div>

          <div class="filter-item">
            <label class="label">Tipo</label>
            <select id="selTipo" class="input-modern" style="height: 42px">
              <option value="">(Todos)</option>
              <option value="Administracion">Administraci√≥n</option>
              <option value="Corretaje">Corretaje</option>
            </select>
          </div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Nombre / Estado</th>
            <th>Tipo</th>
            <th>Direcci√≥n</th>
            <th>Comuna</th>
            <th>Contacto</th>
            <th class="no-print">Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaProspectos">
          <tr>
            <td colspan="6" class="muted">Cargando‚Ä¶</td>
          </tr>
        </tbody>
      </table>
    </main>

    <div id="modalProspecto" class="modal" aria-hidden="true">
      <div class="modal-content">
        <h2 id="modalTitleProspecto">Nuevo Prospecto</h2>

        <form id="formProspecto">
          <input type="hidden" id="prospectoID" />
          <input type="hidden" id="prosLatLong" />

          <label class="label">Tipo de Negocio</label>
          <div class="tipo-selector">
            <div
              class="tipo-btn active"
              onclick="setTipo('Administracion')"
              id="btnTipoAdmin"
            >
              <i class="fa-solid fa-building"></i> Administraci√≥n
            </div>
            <div
              class="tipo-btn"
              onclick="setTipo('Corretaje')"
              id="btnTipoCorretaje"
            >
              <i class="fa-solid fa-house-user"></i> Corretaje
            </div>
          </div>
          <input type="hidden" id="prosTipoNegocio" value="Administracion" />

          <div
            class="row"
            style="
              margin-top: 10px;
              background: #f0f9ff;
              padding: 10px;
              border-radius: 6px;
              border: 1px dashed #0284c7;
            "
          >
            <div style="flex: 2; display: flex; align-items: center; gap: 10px">
              <label class="label" style="margin: 0; min-width: 120px"
                >Asignar a:</label
              >
              <select
                id="prosAgente"
                style="margin: 0; font-weight: bold; color: #0284c7"
              >
                <option value="Sin Asignar">-- Sin Asignar --</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top: 10px">
            <div style="flex: 2">
              <label class="label">Nombre (Cliente / Condominio)</label>
              <input
                id="prosNombre"
                required
                placeholder="Ej: Edificio Los Andes o Juan P√©rez"
              />
            </div>
            <div>
              <label class="label">Estado</label>
              <select id="prosEstado">
                <option value="Nuevo">Nuevo</option>
                <option value="Contactado">Contactado</option>
                <option value="Volante Entregado">Volante Entregado</option>
                <option value="Propuesta Enviada">Propuesta Enviada</option>
                <option value="En Negociaci√≥n">En Negociaci√≥n</option>
                <option value="Cerrado Ganado">Cerrado Ganado</option>
                <option value="Cerrado Perdido">Cerrado Perdido</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top: 10px">
            <div style="flex: 1">
              <label class="label">Tel√©fono</label>
              <input id="prosTelefono" placeholder="+569..." />
            </div>
            <div style="flex: 1.5">
              <label class="label">Email</label>
              <input
                id="prosEmail"
                type="email"
                placeholder="contacto@mail.com"
              />
            </div>
          </div>

          <div class="row" style="margin-top: 10px">
            <div style="flex: 2">
              <label class="label">Direcci√≥n</label>
              <input
                id="prosDireccion"
                placeholder="Calle y N√∫mero"
                onchange="intentarGeocodificar()"
              />
            </div>
            <div style="flex: 1">
              <label class="label">Comuna</label>
              <input
                id="prosComuna"
                list="dlComunas"
                placeholder="Ej: Santiago"
                onchange="intentarGeocodificar()"
              />
              <datalist id="dlComunas"></datalist>
            </div>
          </div>
          <div
            id="msgGeo"
            style="
              font-size: 11px;
              color: #10b981;
              margin-top: 2px;
              display: none;
            "
          >
            <i class="fa-solid fa-location-dot"></i> Ubicaci√≥n detectada
          </div>

          <div id="camposAdmin" style="margin-top: 10px">
            <div class="row">
              <div>
                <label class="label">Cant. Unidades</label>
                <input
                  id="prosUnidades"
                  type="number"
                  min="0"
                  placeholder="Ej: 80"
                />
              </div>
              <div>
                <label class="label">RUT Comunidad (Opcional)</label>
                <input id="prosRUT" placeholder="12.345.678-9" />
              </div>
            </div>
          </div>

          <div id="camposCorretaje" class="hidden" style="margin-top: 10px">
            <div class="row">
              <div>
                <label class="label">Inter√©s</label>
                <select id="prosOperacion">
                  <option value="Venta">Comprar</option>
                  <option value="Arriendo">Arrendar</option>
                  <option value="Vender">Vender</option>
                </select>
              </div>
              <div>
                <label class="label">Tipo Propiedad</label>
                <select id="prosTipoProp">
                  <option value="Departamento">Departamento</option>
                  <option value="Casa">Casa</option>
                  <option value="Terreno">Terreno</option>
                  <option value="Parcela">Parcela</option>
                  <option value="Oficina">Oficina</option>
                </select>
              </div>
            </div>
            <div class="row" style="margin-top: 10px">
              <div>
                <label class="label">Presupuesto</label>
                <input id="prosPresupuesto" placeholder="$" />
              </div>
            </div>
          </div>

          <label class="label" style="margin-top: 10px"
            >Notas / Observaciones</label
          >
          <textarea id="prosNotas" rows="2"></textarea>

          <div style="text-align: right; margin-top: 20px">
            <button
              type="button"
              class="btn-head btn-secundario"
              onclick="cerrarModalProspecto()"
            >
              Cancelar
            </button>
            <button type="submit" class="btn-head btn-nuevo">Guardar</button>
          </div>
        </form>
      </div>
    </div>

    <div id="modalDetalle" class="modal" aria-hidden="true">
      <div class="modal-content">
        <h2>Detalle Prospecto</h2>
        <div id="detalleContenido"></div>
        <div style="text-align: right; margin-top: 10px">
          <button
            class="btn-head btn-secundario"
            type="button"
            onclick="document.getElementById('modalDetalle').classList.remove('active')"
          >
            Cerrar
          </button>
        </div>
      </div>
    </div>

    <div id="modalBitacora" class="modal" aria-hidden="true">
      <div
        class="modal-content"
        style="
          max-width: 500px;
          max-height: 85vh;
          display: flex;
          flex-direction: column;
        "
      >
        <h2 style="margin-top: 0">Bit√°cora</h2>
        <p class="muted" id="bitacoraSubtitle" style="font-size: 13px">
          Prospecto: ...
        </p>
        <div
          id="timelineContainer"
          style="
            flex-grow: 1;
            overflow-y: auto;
            min-height: 200px;
            margin-bottom: 15px;
          "
        ></div>
        <div style="background: #f1f5f9; padding: 15px; border-radius: 8px">
          <div style="display: flex; gap: 10px; margin-bottom: 8px">
            <select id="bitTipo" style="width: 120px">
              <option value="Nota">Nota üìù</option>
              <option value="Llamada">Llamada üìû</option>
              <option value="Correo">Correo üìß</option>
              <option value="Reunion">Reuni√≥n ü§ù</option>
            </select>
            <input type="date" id="bitFecha" style="margin: 0" />
          </div>
          <textarea
            id="bitNota"
            rows="2"
            placeholder="Detalles..."
            style="width: 100%"
          ></textarea>
          <div style="text-align: right; margin-top: 8px">
            <button
              class="btn-head btn-nuevo"
              onclick="guardarBitacora()"
              style="font-size: 12px"
            >
              Agregar
            </button>
          </div>
        </div>
        <div style="text-align: right; margin-top: 10px">
          <button
            type="button"
            class="btn-head btn-secundario"
            onclick="document.getElementById('modalBitacora').classList.remove('active')"
          >
            Cerrar
          </button>
        </div>
      </div>
    </div>

    <div id="modalContrato" class="modal" aria-hidden="true">
      <div class="modal-content" style="max-width: 450px">
        <h2><i class="fa-solid fa-file-contract"></i> Gesti√≥n de Contrato</h2>
        <p class="muted">
          Sube el contrato firmado a Drive/Dropbox y pega el enlace.
        </p>
        <input type="hidden" id="contratoProsID" />
        <label class="label">Enlace al Documento (URL)</label>
        <input
          id="inpContratoURL"
          placeholder="https://..."
          style="width: 100%"
        />
        <div
          style="
            margin-top: 20px;
            background: #fff7ed;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            color: #c2410c;
          "
        >
          <i class="fa-solid fa-triangle-exclamation"></i> Al guardar, el estado
          cambiar√° a <b>"Contrato Firmado"</b>.
        </div>
        <div
          style="
            text-align: right;
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
          "
        >
          <button
            type="button"
            class="btn-head btn-secundario"
            onclick="document.getElementById('modalContrato').classList.remove('active')"
          >
            Cancelar
          </button>
          <button
            type="button"
            class="btn-head btn-nuevo"
            onclick="guardarContrato()"
          >
            Guardar y Confirmar
          </button>
        </div>
      </div>
    </div>

    <div id="pageSpinner" class="spinner-backdrop" aria-hidden="true">
      <div class="spinner-card">
        <div class="spinner"></div>
        <div id="spinnerText">Cargando...</div>
      </div>
    </div>

    <div id="footer"></div>

    <script src="assets/js/pages/prospectos.inline.js"></script>
  </body>
</html>
