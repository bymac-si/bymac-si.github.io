<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mi Arriendo - Santa Josefina</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f766e"> <link rel="apple-touch-icon" href="assets/img/icon-192.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/styles.css">
    <script src="assets/js/app.js"></script>

    <style>
        /* Estilo específico para Arrendatarios (Teal / Verde Profesional) */
        body { background: #f0fdfa; padding-bottom: 90px; color: #134e4a; }
        
        .header-rent { 
            background: linear-gradient(135deg, #0f766e 0%, #115e59 100%); 
            color: white; 
            padding: 25px 20px 40px; 
            border-radius: 0 0 20px 20px; 
            box-shadow: 0 4px 15px rgba(15, 118, 110, 0.2);
        }

        .payment-card {
            background: white;
            width: 90%;
            margin: -30px auto 20px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            text-align: center;
            position: relative;
            border: 1px solid #ccfbf1;
        }

        .amount-display { font-size: 32px; font-weight: 800; color: #0f766e; margin: 10px 0; }
        .due-date { font-size: 13px; color: #e11d48; font-weight: 600; background: #ffe4e6; padding: 4px 10px; border-radius: 20px; display: inline-block; }
        .due-date.ok { color: #166534; background: #dcfce7; }

        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 0 20px;
        }
        .q-btn {
            background: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            cursor: pointer;
            border: 1px solid #e2e8f0;
            transition: transform 0.1s;
        }
        .q-btn:active { transform: scale(0.98); }
        .q-icon { font-size: 24px; margin-bottom: 8px; color: #0f766e; }
        .q-text { font-size: 13px; font-weight: 700; color: #334155; }

        .history-section { padding: 20px; }
        .h-title { font-size: 15px; font-weight: 700; color: #64748b; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .trx-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #cbd5e1;
        }
        .trx-ok { border-left-color: #10b981; }
        .trx-pending { border-left-color: #f59e0b; }

        /* Modals */
        .sheet-modal { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-radius: 20px 20px 0 0; padding: 25px; box-shadow: 0 -5px 40px rgba(0,0,0,0.2); transform: translateY(100%); transition: transform 0.3s; z-index: 2000; }
        .sheet-modal.open { transform: translateY(0); }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1999; display: none; }
        .overlay.open { display: block; }
        
        .btn-action { width: 100%; padding: 14px; background: #0f766e; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; margin-top: 15px; }
    </style>
</head>
<body>

    <div class="header-rent">
        <h2 style="margin:0; font-size: 18px;">Hola, <span id="lblInquilino">Arrendatario</span></h2>
        <p style="margin: 5px 0 0; opacity: 0.9; font-size: 13px;" id="lblDireccion">Cargando propiedad...</p>
    </div>

    <div class="payment-card">
        <div style="font-size: 12px; color: #64748b; text-transform: uppercase; font-weight: 700;">Próximo Vencimiento</div>
        <div class="amount-display" id="lblMonto">$0</div>
        <div id="lblEstadoPago" class="due-date">Vence el día 05</div>
        <button onclick="abrirModalPago()" style="display: block; width: 100%; margin-top: 15px; padding: 10px; background: #0f766e; color: white; border: none; border-radius: 8px; font-weight: bold;">
            <i class="fa-solid fa-paper-plane"></i> Reportar Pago
        </button>
    </div>

    <div class="quick-actions">
        <div class="q-btn" onclick="abrirModalMantencion()">
            <div class="q-icon"><i class="fa-solid fa-screwdriver-wrench"></i></div>
            <div class="q-text">Solicitar Mantención</div>
        </div>
        <div class="q-btn" onclick="verContrato()">
            <div class="q-icon"><i class="fa-solid fa-file-contract"></i></div>
            <div class="q-text">Ver Contrato</div>
        </div>
    </div>

    <div class="history-section">
        <div class="h-title">Historial de Pagos</div>
        <div id="listaPagos">
            <div style="text-align: center; color: #94a3b8; font-size: 13px;">Cargando...</div>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="cerrarModals()"></div>
    
    <div class="sheet-modal" id="modalPago">
        <h3 style="margin-top: 0; color: #134e4a;">Reportar Arriendo</h3>
        <p style="color:#64748b; font-size:13px; margin-bottom: 20px;">Adjunta el comprobante de transferencia.</p>
        
        <label class="label">Periodo</label>
        <input type="month" id="pagoPeriodo" class="input-modern" style="width: 100%; margin-bottom: 15px; padding: 12px; border:1px solid #ccc; border-radius:8px;">
        
        <label class="label">Monto Transferido</label>
        <input type="number" id="pagoMonto" class="input-modern" style="width: 100%; margin-bottom: 15px; padding: 12px; border:1px solid #ccc; border-radius:8px;">

        <button style="width: 100%; padding: 12px; background: #f0fdfa; border: 2px dashed #0f766e; border-radius: 8px; color: #0f766e; font-weight:600; text-align: center;">
            <i class="fa-solid fa-camera"></i> Subir Comprobante
        </button>

        <button class="btn-action" onclick="enviarReportePago()">Enviar Reporte</button>
    </div>

    <div class="sheet-modal" id="modalMantencion">
        <h3 style="margin-top: 0; color: #c2410c;">Solicitar Reparación</h3>
        <p style="color:#64748b; font-size:13px; margin-bottom: 20px;">Describe el problema en la propiedad.</p>
        
        <select id="manTipo" style="width: 100%; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ccc;">
            <option value="Gasfitería">Gasfitería / Agua</option>
            <option value="Electricidad">Electricidad</option>
            <option value="Estructural">Estructural (Paredes/Pisos)</option>
            <option value="Otro">Otro</option>
        </select>

        <textarea id="manDesc" rows="4" placeholder="Ej: Hay una filtración bajo el lavaplatos..." style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc;"></textarea>

        <button class="btn-action" style="background: #e74e35;" onclick="enviarSolicitud()">Crear Solicitud</button>
    </div>

    <script>
        // --- LÓGICA DEL PORTAL ---
        
        // 1. Obtener Sesión (Simulada para el ejemplo, usar localStorage real)
        // En producción: const SESION = JSON.parse(localStorage.getItem('sesion_arrendatario'));
        const SESION_DEMO = {
            RUT: "11.111.111-1",
            Nombre: "Juan Arrendatario",
            ContratoID: "CNT_001",
            Propiedad: "Av. Las Condes 1234, Depto 505",
            Monto: 450000,
            DiaPago: 5
        };

        document.addEventListener("DOMContentLoaded", () => {
            // Verificar Login
            // if(!localStorage.getItem('sesion_arrendatario')) window.location.href = 'login_residente.html';
            
            cargarInfo(SESION_DEMO);
            cargarHistorialDemo(); // Reemplazar por fetch a PagosArriendo
        });

        function cargarInfo(datos) {
            document.getElementById("lblInquilino").innerText = datos.Nombre.split(" ")[0];
            document.getElementById("lblDireccion").innerText = datos.Propiedad;
            
            // Formatear Monto
            const montoFmt = new Intl.NumberFormat('es-CL', {style: 'currency', currency: 'CLP'}).format(datos.Monto);
            document.getElementById("lblMonto").innerText = montoFmt;
            document.getElementById("pagoMonto").value = datos.Monto; // Prellenar modal

            // Calcular próximo vencimiento
            const hoy = new Date();
            let mes = hoy.getMonth();
            if (hoy.getDate() > datos.DiaPago) mes++; // Si ya pasó el día, es el otro mes
            
            // Asignar mes actual al input date
            const anioActual = hoy.getFullYear();
            const mesStr = (hoy.getMonth() + 1).toString().padStart(2, '0');
            document.getElementById("pagoPeriodo").value = `${anioActual}-${mesStr}`;

            document.getElementById("lblEstadoPago").innerHTML = `<i class="fa-regular fa-clock"></i> Próximo pago: <b>${datos.DiaPago}/${mes + 1}</b>`;
        }

        /* --- UX --- */
        function abrirModalPago() {
            document.getElementById("overlay").classList.add("open");
            document.getElementById("modalPago").classList.add("open");
        }
        function abrirModalMantencion() {
            document.getElementById("overlay").classList.add("open");
            document.getElementById("modalMantencion").classList.add("open");
        }
        function cerrarModals() {
            document.getElementById("overlay").classList.remove("open");
            document.querySelectorAll(".sheet-modal").forEach(e => e.classList.remove("open"));
        }

        /* --- ACCIONES --- */
        async function enviarReportePago() {
            const monto = document.getElementById("pagoMonto").value;
            const periodo = document.getElementById("pagoPeriodo").value;

            if(!monto || !periodo) return alert("Completa los datos");

            const payload = {
                "ID": "PAY_ARR_" + Date.now(),
                "ContratoID": SESION_DEMO.ContratoID,
                "Periodo": periodo,
                "Monto": monto,
                "Fecha Reporte": new Date().toISOString().split('T')[0],
                "Estado": "Pendiente"
                // Aquí iría el base64 de la imagen
            };

            // await appSheetCRUD("PagosArriendo", "Add", [payload]);
            alert("¡Reporte enviado! Lo validaremos a la brevedad.");
            cerrarModals();
        }

        async function enviarSolicitud() {
            const desc = document.getElementById("manDesc").value;
            if(!desc) return alert("Describe el problema");

            // Lógica de envío a Tickets
            alert("Solicitud enviada al equipo de Corretaje.");
            cerrarModals();
        }

        function verContrato() {
            alert("Descargando PDF del contrato...");
            // window.open(SESION_DEMO.ContratoURL);
        }

        function cargarHistorialDemo() {
            const lista = document.getElementById("listaPagos");
            // Mock de datos
            const historial = [
                { periodo: "2026-04", monto: 450000, estado: "Pendiente", fecha: "04-05-2026" },
                { periodo: "2026-03", monto: 450000, estado: "Validado", fecha: "05-03-2026" },
                { periodo: "2026-02", monto: 450000, estado: "Validado", fecha: "04-02-2026" }
            ];

            lista.innerHTML = historial.map(h => {
                const esOk = h.estado === 'Validado';
                return `
                <div class="trx-item ${esOk ? 'trx-ok' : 'trx-pending'}">
                    <div>
                        <div style="font-weight: bold; font-size: 14px;">Arriendo ${h.periodo}</div>
                        <div style="font-size: 12px; color: #64748b;">Reportado el ${h.fecha}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 800; color: #134e4a;">$${h.monto.toLocaleString()}</div>
                        <span style="font-size: 10px; text-transform: uppercase; font-weight: bold; color: ${esOk ? '#166534' : '#b45309'};">${h.estado}</span>
                    </div>
                </div>`;
            }).join("");
        }
    </script>
</body>
</html>