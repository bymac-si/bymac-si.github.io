<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <title>App Santa Josefina</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="manifest" href="manifest.json" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Ovo&display=swap"
      rel="stylesheet"
    />
    <meta name="theme-color" content="#1a2b48" />
    <link rel="apple-touch-icon" href="assets/img/icon-192.png" />

    <script src="assets/js/app.js"></script>

    <style>
      /* Estilos App Mobile */
      body {
        background-color: #f8fafc;
        padding-bottom: 40px;
        font-family: system-ui, -apple-system, sans-serif;
      }

      .app-header {
        background: #1a2b48;
        color: white;
        padding: 20px 20px 30px;
        border-bottom-left-radius: 25px;
        border-bottom-right-radius: 25px;
        box-shadow: 0 4px 15px rgba(26, 43, 72, 0.2);
      }
      .user-welcome {
        font-size: 14px;
        opacity: 0.9;
      }
      .unit-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        margin-top: 5px;
      }

      /* Accesos Rápidos */
      .quick-actions {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        margin: -25px 15px 20px;
        padding: 15px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
      }
      .qa-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        color: #64748b;
        font-size: 11px;
        font-weight: 600;
        text-align: center;
        cursor: pointer;
      }
      .qa-icon {
        width: 45px;
        height: 45px;
        background: #f1f5f9;
        border-radius: 12px;
        border: 1px solid #99b2d6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: #1a2b48;
        margin-bottom: 6px;
        transition: all 0.2s;
      }
      .qa-item:active .qa-icon {
        transform: scale(0.95);
        background: #e2e8f0;
      }

      /* Tarjeta Deuda */
      .debt-card {
        background: white;
        margin: 0 15px 20px;
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
        border: 1px solid #e2e8f0;
        text-align: center;
        position: relative;
        overflow: hidden;
        border-left: 5px solid #cbd5e1; /* Default */
      }
      .debt-card.clean {
        border-left-color: #10b981;
      }
      .debt-card.pending {
        border-left-color: #ef4444;
      }

      .debt-label {
        color: #64748b;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .debt-amount {
        font-size: 36px;
        font-weight: 800;
        color: #1e293b;
        margin: 10px 0;
      }
      .debt-period {
        font-size: 13px;
        color: #94a3b8;
        background: #f8fafc;
        padding: 4px 12px;
        border-radius: 20px;
        display: inline-block;
      }

      .btn-pay {
        background: #2563eb;
        color: white;
        width: 100%;
        padding: 14px;
        border: none;
        border-radius: 12px;
        font-weight: 700;
        font-size: 15px;
        margin-top: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);
        text-decoration: none;
      }

      /* Notificaciones */
      .notifications-board {
        margin: 0 15px;
      }
      .notif-card {
        background: white;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 10px;
        display: flex;
        gap: 15px;
        align-items: start;
        border: 1px solid #e2e8f0;
      }
      .notif-icon {
        min-width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
      }
      .icon-success {
        background: #dcfce7;
        color: #166534;
      }
      .icon-info {
        background: #e0f2fe;
        color: #075985;
      }
      .icon-warn {
        background: #fee2e2;
        color: #991b1b;
      }

      .notif-content h4 {
        margin: 0 0 4px;
        font-size: 14px;
        font-weight: 700;
        color: #334155;
      }
      .notif-content p {
        margin: 0;
        font-size: 12px;
        color: #64748b;
        line-height: 1.4;
      }
      .notif-time {
        font-size: 10px;
        color: #94a3b8;
        margin-top: 6px;
        display: block;
      }

      /* Spinner */
      .spinner-overlay {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }

      .ovo-regular {
        font-family: "Ovo", serif;
        font-weight: 400;
        font-style: normal;
      }

      .biz-udpmincho-regular {
        font-family: "BIZ UDPMincho", serif;
        font-weight: 400;
        font-style: normal;
      }
    </style>
  </head>
  <body>
    <div class="app-header">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: start;
        "
      >
        <div>
          <div class="user-welcome" style="font-size: 18px">
            Hola, <b id="residenteNombre">...</b>
          </div>
          <div class="unit-badge" style="font-size: 14px">
            <i class="fa-solid fa-building"></i>
            <span id="nombreEdificio" style="text-align: center"
              >Cargando...</span
            >
            <span style="margin: 0 5px">|</span>
            <span style="font-size: 12px">Unid.:</span>
            <span
              id="residenteUnidad"
              class="ovo-regular"
              style="font-size: 40px; font-weight: 550; line-height: 1"
              >...</span
            >
          </div>
        </div>
        <button
          onclick="logoutResidente()"
          style="
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
          "
        >
          <i class="fa-solid fa-power-off" style="font-size: 14px"></i>
        </button>
      </div>
    </div>

    <div class="quick-actions">
      <a href="reservas.html" class="qa-item">
        <div class="qa-icon"><i class="fa-regular fa-calendar-check"></i></div>
        Reservas
      </a>
      <a href="reclamos.html" class="qa-item">
        <div class="qa-icon">
          <i class="fa-solid fa-triangle-exclamation"></i>
        </div>
        Reclamos
      </a>
      <a href="#historial" class="qa-item">
        <div class="qa-icon"><i class="fa-solid fa-clock-rotate-left"></i></div>
        Historial
      </a>
      <div class="qa-item" onclick="logoutResidente()">
        <div
          class="qa-icon"
          style="background: #fee2e2; color: #991b1b; border-color: #fecaca"
        >
          <i class="fa-solid fa-right-from-bracket"></i>
        </div>
        Salir
      </div>
    </div>

    <div class="debt-card" id="cardDeudaContainer">
      <div class="debt-label">Total a Pagar</div>
      <div
        class="debt-amount biz-udpmincho-regular"
        id="montoTotal"
        style="font-size: 60px; font-weight: 500; line-height: 1"
      >
        ...
      </div>
      <div class="debt-period" id="textoEstadoDeuda">Consultando...</div>

      <br /><br />
      <a
        href="detalle_gastos.html"
        style="
          display: block;
          margin-top: 12px;
          font-size: 13px;
          color: #3b82f6;
          text-decoration: none;
          font-weight: 600;
        "
      >
        Ver detalle Gastos Comunes
        <i class="fa-solid fa-chevron-right" style="font-size: 10px"></i>
      </a>

      <div id="btnPagarContainer" style="display: none">
        <br />
        <a
          href="reportar_pago.html"
          class="btn-pay"
          style="width: 98%; margin: auto"
        >
          <i class="fa-solid fa-paper-plane"></i> Reportar Pago
        </a>
      </div>
    </div>

    <h3
      style="
        font-size: 15px;
        font-weight: 700;
        color: #334155;
        margin: 25px 15px 15px;
      "
    >
      Tablero de Avisos
    </h3>
    <div class="notifications-board" id="notifBoard">
      <div
        style="
          text-align: center;
          padding: 20px;
          color: #94a3b8;
          font-size: 13px;
        "
      >
        No hay notificaciones recientes.
      </div>
    </div>

    <div id="loader" class="spinner-overlay">
      <div
        style="
          width: 40px;
          height: 40px;
          border-radius: 50%;
          border: 4px solid #eee;
          border-top-color: #1a2b48;
          animation: spin 1s linear infinite;
        "
      ></div>
      <div
        style="
          margin-top: 15px;
          font-size: 13px;
          font-weight: 600;
          color: #1a2b48;
        "
      >
        Sincronizando...
      </div>
    </div>

    <script>
      let USUARIO = null;
      let DATOS_COMUNIDAD = null;
      let DATOS_UNIDAD = null;

      // --- INICIO SEGURO ---
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          // 1. Obtener Sesión
          const sesionStr = localStorage.getItem("sesion_externa");
          if (!sesionStr) throw new Error("No session");

          const sesionObj = JSON.parse(sesionStr);
          USUARIO = sesionObj.datos; // Datos crudos del login

          // Render Básico
          const nombre = (USUARIO.Nombre || "Usuario").split(" ")[0];
          safeUpdate("residenteNombre", nombre);
          safeUpdate("residenteUnidad", "...");

          // 2. Cargar Datos
          await cargarTodo();
        } catch (e) {
          console.error("Error crítico de sesión:", e);
          window.location.href = "login_residente.html";
        } finally {
          document.getElementById("loader").style.display = "none";
        }
      });

      async function cargarTodo() {
        try {
          const [
            copropiedades,
            unidades,
            gastosComunes,
            gastos,
            cobros,
            pagos,
            reservas,
          ] = await Promise.all([
            fetchData("Copropiedades"),
            fetchData("Unidades"),
            fetchData("GastosComunes").catch(() => []),
            fetchData("Gastos").catch(() => []),
            fetchData("Cobros").catch(() => []),
            fetchData("Pagos").catch(() => []),
            fetchData("Reservas").catch(() => []),
          ]);

          // 3. Vincular Unidad y Comunidad
          // Usamos comparaciones flexibles (String y trim)
          const myUnidadID = String(USUARIO.UnidadID).trim();

          DATOS_UNIDAD = unidades.find(
            (u) => String(getKeyVal(u)) === myUnidadID
          );

          // Si encontramos la unidad, obtenemos el ID de la comunidad desde ahí (más seguro)
          // Si no, tratamos de usar el que viene en el usuario
          let coproID = DATOS_UNIDAD
            ? String(DATOS_UNIDAD.CopropiedadID)
            : String(USUARIO.CopropiedadID);

          DATOS_COMUNIDAD = copropiedades.find(
            (c) => String(getKeyVal(c)) === coproID
          );

          // Render Header
          if (DATOS_COMUNIDAD)
            safeUpdate("nombreEdificio", DATOS_COMUNIDAD.Nombre);
          if (DATOS_UNIDAD) {
            const nombreReal =
              DATOS_UNIDAD.Unidad ||
              DATOS_UNIDAD.Numero ||
              DATOS_UNIDAD.Nombre ||
              myUnidadID;
            safeUpdate("residenteUnidad", nombreReal);
          } else {
            safeUpdate("residenteUnidad", "Unidad no encontrada");
          }

          // 4. Procesar Datos
          await procesarDeudaDelMes(gastosComunes, gastos, cobros);
          renderNotificaciones(pagos, reservas);
        } catch (err) {
          console.error("Error cargando datos:", err);
          // No redirigimos al login aquí para evitar loop, solo mostramos error visual
          safeUpdate("montoTotal", "--");
          safeUpdate("textoEstadoDeuda", "Error de conexión");
        }
      }

      async function procesarDeudaDelMes(
        gastosComunes,
        gastos,
        cobrosExistentes
      ) {
        try {
          if (!DATOS_UNIDAD) return; // No podemos calcular sin unidad

          const fechaHoy = new Date();
          // Formato MM-YYYY (Ej: 01-2026)
          const mesStr = `${String(fechaHoy.getMonth() + 1).padStart(
            2,
            "0"
          )}-${fechaHoy.getFullYear()}`;

          // Buscar cobro YA generado para este mes
          const cobroRegistrado = cobrosExistentes.find(
            (c) =>
              String(c.UnidadID) === String(USUARIO.UnidadID) &&
              c.Mes === mesStr
          );

          let totalVisual = 0;
          let estadoTexto = "Calculando...";
          let estadoClase = "";

          if (cobroRegistrado) {
            // Ya existe cobro oficial
            if (cobroRegistrado.Estado === "Pagado") {
              // Buscar deudas anteriores
              const deudasViejas = cobrosExistentes.filter(
                (c) =>
                  String(c.UnidadID) === String(USUARIO.UnidadID) &&
                  c.Estado === "Pendiente"
              );
              totalVisual = deudasViejas.reduce(
                (sum, c) => sum + parseMonto(c.TotalAPagar),
                0
              );

              if (totalVisual > 0) {
                estadoTexto = "Deuda Anterior";
                estadoClase = "pending";
              } else {
                estadoTexto = "¡Estás al día!";
                estadoClase = "clean";
              }
            } else {
              // Mes actual pendiente
              totalVisual = parseMonto(cobroRegistrado.TotalAPagar);
              estadoTexto = "Por Pagar";
              estadoClase = "pending";
            }
          } else {
            // No hay cobro oficial aun -> Mostrar proyección o $0
            // Para evitar confusiones, mostraremos deudas previas si hay
            const deudasViejas = cobrosExistentes.filter(
              (c) =>
                String(c.UnidadID) === String(USUARIO.UnidadID) &&
                c.Estado === "Pendiente"
            );
            totalVisual = deudasViejas.reduce(
              (sum, c) => sum + parseMonto(c.TotalAPagar),
              0
            );

            if (totalVisual > 0) {
              estadoTexto = "Deuda Acumulada";
              estadoClase = "pending";
            } else {
              estadoTexto = "Sin cobros pendientes";
              estadoClase = "clean";
            }
          }

          // Render UI
          safeUpdate("montoTotal", clp(totalVisual));
          safeUpdate("textoEstadoDeuda", estadoTexto);

          const card = document.getElementById("cardDeudaContainer");
          const btn = document.getElementById("btnPagarContainer");

          // Aplicar estilos
          card.className = "debt-card " + estadoClase; // clean o pending
          document.getElementById("textoEstadoDeuda").style.color =
            estadoClase === "pending" ? "#ef4444" : "#10b981";

          // Botón Pagar: Mostrar siempre que haya deuda, o permitir reportar aunque sea 0 (opcional)
          // Aquí lo mostramos siempre para facilitar el reporte
          btn.style.display = "block";
        } catch (e) {
          console.error("Error cálculo deuda:", e);
        }
      }

      function renderNotificaciones(pagos, reservas) {
        const board = document.getElementById("notifBoard");
        if (!board) return;

        const items = [];
        // Filtramos por UnidadID
        const myID = String(USUARIO.UnidadID);

        pagos.forEach((p) => {
          if (String(p.UnidadID) === myID) {
            if (p.Estado === "Aprobado")
              items.push({
                type: "success",
                title: "Pago Aprobado",
                desc: `Monto: ${clp(parseMonto(p.Monto))}`,
                date: p.FechaRegistro,
              });
            if (p.Estado === "Rechazado")
              items.push({
                type: "error",
                title: "Pago Rechazado",
                desc: p.Observaciones || "Revisa el comprobante",
                date: p.FechaRegistro,
              });
          }
        });

        reservas.forEach((r) => {
          if (String(r.UnidadID) === myID) {
            if (r.Estado === "Confirmada")
              items.push({
                type: "info",
                title: "Reserva Confirmada",
                desc: `${r.EspacioNombre || "Espacio"} - ${r.Fecha}`,
                date: r.FechaCreacion,
              });
          }
        });

        items.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
        const ultimos = items.slice(0, 5);

        if (ultimos.length === 0) {
          board.innerHTML =
            '<div style="text-align:center; padding:20px; color:#94a3b8; font-size:13px;">No hay notificaciones recientes.</div>';
          return;
        }

        board.innerHTML = ultimos
          .map((it) => {
            let icon = "fa-check",
              color = "icon-success";
            if (it.type === "error") {
              icon = "fa-xmark";
              color = "icon-warn";
            }
            if (it.type === "info") {
              icon = "fa-calendar-check";
              color = "icon-info";
            }

            const fechaObj = it.date ? new Date(it.date) : new Date();
            const fechaStr = fechaObj.toLocaleDateString("es-CL");

            return `<div class="notif-card"><div class="notif-icon ${color}"><i class="fa-solid ${icon}"></i></div><div class="notif-content"><h4>${it.title}</h4><p>${it.desc}</p><span class="notif-time">${fechaStr}</span></div></div>`;
          })
          .join("");
      }

      function logoutResidente() {
        localStorage.removeItem("sesion_externa");
        window.location.href = "login_residente.html";
      }

      /* UTILS */
      function safeUpdate(id, valor) {
        const el = document.getElementById(id);
        if (el) el.textContent = valor;
      }
      function parseMonto(valor) {
        if (!valor) return 0;
        const limpio = String(valor)
          .replace(/[^0-9,-]/g, "")
          .replace(",", "."); // Limpieza robusta
        return parseFloat(limpio) || 0;
      }
      function parsePorcentaje(valor) {
        if (!valor) return 0;
        const limpio = String(valor).replace(",", ".");
        return parseFloat(limpio) || 0;
      }
      function clp(v) {
        return "$" + new Intl.NumberFormat("es-CL").format(v);
      }
      function getKeyVal(o) {
        return o.ID || o.id || "";
      }
    </script>
  </body>
</html>
