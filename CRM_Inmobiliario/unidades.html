<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>CRM - Unidades</title>
  <link rel="stylesheet" href="css/styles.css">
  <script src="js/app.js"></script>
  <script>requireAuth();</script>
  <script>
    document.addEventListener("DOMContentLoaded", async ()=>{
      // Header y Footer
      document.getElementById("header").innerHTML = await (await fetch("header.html")).text();
      document.getElementById("footer").innerHTML = await (await fetch("footer.html")).text();
    });
  </script>
</head>
<body>
<div id="header"></div>

<main style="padding:40px;">
  <h1 class="page-title">Unidades</h1>

  <div style="display:flex; gap:12px; align-items:center; margin:12px 0;">
    <label>Copropiedad</label>
    <select id="filtroCopro"></select>
    <button class="btn-primary" onclick="abrirFormUnidad()">+ Nueva Unidad</button>
  </div>

  <!-- Aviso suma de alícuotas -->
  <div id="infoAlicuota" class="alert" style="display:none; margin-bottom:12px;"></div>

  <table>
    <thead>
      <tr>
        <th>Copropiedad</th>
        <th>Número</th>
        <th>Tipo</th>
        <th>Metros</th>
        <th>Alicuota (%)</th>
        <th>Propietario</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tablaUnidades"></tbody>
  </table>
</main>

<!-- MODAL FORM -->
<div id="modalUnidad" class="modal">
  <div class="modal-content">
    <h2 id="modalTitleUnidad">Nueva Unidad</h2>
    <form id="formUnidad">
      <input type="hidden" id="unidadID">

      <label>Copropiedad</label>
      <select id="unidadCopro" required></select>

      <label>Número</label>
      <input id="unidadNumero" required placeholder="Ej: 1203">

      <label>Tipo</label>
      <input id="unidadTipo" placeholder="Depto/Casa/Local">

      <label>Metros (m²)</label>
      <input id="unidadMetros" type="number" step="0.01">

      <label>Alicuota (%)</label>
      <input id="unidadAlicuota" type="number" step="0.0001" required>

      <label>Propietario</label>
      <select id="unidadPropietario"></select>

      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:12px;">
        <button type="button" class="btn-outline" onclick="cerrarModalUnidad()">Cancelar</button>
        <button type="submit" class="btn-primary">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL DETALLE -->
<div id="modalDetalle" class="modal">
  <div class="modal-content">
    <h2>Detalle Unidad</h2>
    <div id="detalleContenido"></div>
    <div style="text-align:right; margin-top:12px;">
      <button class="btn-primary" onclick="cerrarModalDetalle()">Cerrar</button>
    </div>
  </div>
</div>

<div id="footer"></div>

<script>
let copros=[], coprops=[], unidades=[];
let KEY_NAME="ID";

function nombreCopro(id){
  const c = copros.find(x=> String(getKeyVal(x))===String(id));
  return c?.Nombre||"—";
}
function nombrePropietario(id){
  const p = coprops.find(x=> String(getKeyVal(x))===String(id));
  return p?.Nombre||"—";
}
function n(x){ return parseFloat(x)||0; }

async function cargar(){
  [copros, coprops, unidades] = await Promise.all([
    fetchData("Copropiedades"),
    fetchData("Copropietarios"),
    fetchData("Unidades")
  ]);
  if(unidades.length) KEY_NAME = getKeyName(unidades[0]);

  // combos
  const opts = copros.map(c=>`<option value="${getKeyVal(c)}">${c.Nombre}</option>`).join("");
  filtroCopro.innerHTML = opts;
  unidadCopro.innerHTML = opts;

  renderTabla();
  filtroCopro.addEventListener("change", renderTabla);
}

function renderTabla(){
  const sel=filtroCopro.value;
  const lista = sel ? unidades.filter(u=> String(u.CopropiedadID)===String(sel)) : unidades.slice();

  // suma alícuotas
  const suma = lista.reduce((acc,u)=> acc+(parseFloat(u.Alicuota)||0),0);
  if(lista.length){
    infoAlicuota.style.display="block";
    if(Math.abs(suma-100)<0.001){
      infoAlicuota.style.color="#185c37";
      infoAlicuota.textContent=`✅ La suma de alícuotas es 100% (actual: ${suma}).`;
    }else{
      infoAlicuota.style.color="#b54708";
      infoAlicuota.textContent=`⚠️ La suma de alícuotas es ${suma}. Debe ser 100%.`;
    }
  } else infoAlicuota.style.display="none";

  tablaUnidades.innerHTML = lista.map(u=>{
    const key=getKeyVal(u);
    return `
      <tr>
        <td>${nombreCopro(u.CopropiedadID)}</td>
        <td>${u.Numero||""}</td>
        <td>${u.Tipo||""}</td>
        <td>${u.Metros||0}</td>
        <td>${u.Alicuota||0}</td>
        <td>${nombrePropietario(u.PropietarioID)}</td>
        <td>
          <button class="btn-outline btn-ver" data-id="${key}">Ver</button>
          <button class="btn-outline btn-edit" data-id="${key}">Editar</button>
          <button class="btn-primary" onclick="eliminarUnidad('${key}')">Eliminar</button>
        </td>
      </tr>
    `;
  }).join("");

  tablaUnidades.onclick = (e)=>{
    const ver=e.target.closest(".btn-ver");
    const edit=e.target.closest(".btn-edit");
    if(ver) abrirDetalleUnidad(ver.dataset.id);
    if(edit) abrirFormUnidad(edit.dataset.id);
  };
}

// --- Modal Form ---
const modal=document.getElementById("modalUnidad");
const form=document.getElementById("formUnidad");

function renderProps(coproID){
  const props=coprops.filter(p=> String(p.CopropiedadID)===String(coproID));
  unidadPropietario.innerHTML = props.map(p=>`<option value="${getKeyVal(p)}">${p.Nombre}</option>`).join("");
}
unidadCopro.addEventListener("change", ()=>renderProps(unidadCopro.value));

function abrirFormUnidad(id){
  document.getElementById("modalTitleUnidad").textContent=id?"Editar Unidad":"Nueva Unidad";
  if(id){
    const u=unidades.find(x=> String(getKeyVal(x))===String(id));
    if(!u) return alert("No encontrada");
    unidadID.value=id;
    unidadCopro.value=u.CopropiedadID;
    renderProps(unidadCopro.value);
    unidadPropietario.value=u.PropietarioID||"";
    unidadNumero.value=u.Numero||"";
    unidadTipo.value=u.Tipo||"";
    unidadMetros.value=u.Metros||0;
    unidadAlicuota.value=u.Alicuota||0;
  }else{
    form.reset(); unidadID.value="";
    const sel=filtroCopro.value; if(sel) unidadCopro.value=sel;
    renderProps(unidadCopro.value);
  }
  modal.classList.add("active");
}
function cerrarModalUnidad(){ modal.classList.remove("active"); }

form.onsubmit=async e=>{
  e.preventDefault();
  const id=unidadID.value||undefined;
  const payload={
    ...(id?{[KEY_NAME]:id}:{}),
    CopropiedadID:unidadCopro.value,
    Numero:unidadNumero.value.trim(),
    Tipo:unidadTipo.value.trim(),
    Metros:n(unidadMetros.value),
    Alicuota:n(unidadAlicuota.value),
    PropietarioID:unidadPropietario.value||null
  };
  try{
    if(id) await appSheetCRUD("Unidades","Edit",[payload]);
    else   await appSheetCRUD("Unidades","Add",[payload]);
    cerrarModalUnidad(); location.reload();
  }catch(err){ alert("Error: "+(err.message||err)); }
};

async function eliminarUnidad(id){
  if(!confirm("¿Eliminar esta unidad?")) return;
  await appSheetCRUD("Unidades","Delete",[{[KEY_NAME]:id}]);
  location.reload();
}

// --- Modal Detalle ---
const modalDetalle=document.getElementById("modalDetalle");
const detalleContenido=document.getElementById("detalleContenido");

function abrirDetalleUnidad(id){
  const u=unidades.find(x=> String(getKeyVal(x))===String(id));
  if(!u) return alert("No encontrada");
  detalleContenido.innerHTML=`
    <p><b>Copropiedad:</b> ${nombreCopro(u.CopropiedadID)}</p>
    <p><b>Número:</b> ${u.Numero||""}</p>
    <p><b>Tipo:</b> ${u.Tipo||""}</p>
    <p><b>Metros:</b> ${u.Metros||0}</p>
    <p><b>Alicuota:</b> ${u.Alicuota||0}%</p>
    <p><b>Propietario:</b> ${nombrePropietario(u.PropietarioID)}</p>
  `;
  modalDetalle.classList.add("active");
}
function cerrarModalDetalle(){ modalDetalle.classList.remove("active"); }

// init
cargar();
</script>
</body>
</html>