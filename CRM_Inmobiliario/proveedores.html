<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>CRM - Proveedores</title>
  <link rel="stylesheet" href="css/styles.css">
  <script src="js/app.js"></script>
  <script>requireAuth();</script>
  <script>
    document.addEventListener("DOMContentLoaded", async ()=>{
      document.getElementById("header").innerHTML = await (await fetch("header.html")).text();
      document.getElementById("footer").innerHTML = await (await fetch("footer.html")).text();
    });
  </script>
</head>
<body>
<div id="header"></div>

<main style="padding:40px;">
  <h1 class="page-title">Gestión de Proveedores</h1>

  <button class="btn-primary" onclick="abrirFormProveedor()">+ Nuevo Proveedor</button>

  <table>
    <thead>
      <tr>
        <th>Copropiedad</th>
        <th>Nombre</th>
        <th>RUT</th>
        <th>Giro</th>
        <th>Email</th>
        <th>Teléfono</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tablaProveedores"></tbody>
  </table>
</main>

<!-- MODAL FORM -->
<div id="modalProveedor" class="modal">
  <div class="modal-content">
    <h2 id="modalTitleProveedor">Nuevo Proveedor</h2>
    <form id="formProveedor">
      <input type="hidden" id="proveedorID">

      <label>Copropiedad</label>
      <select id="proveedorCopro" required></select>

      <label>Nombre</label>
      <input type="text" id="proveedorNombre" required>

      <label>RUT</label>
      <input type="text" id="proveedorRUT">

      <label>Giro</label>
      <input type="text" id="proveedorGiro">

      <label>Email</label>
      <input type="email" id="proveedorEmail">

      <label>Teléfono</label>
      <input type="text" id="proveedorTelefono">

      <div style="text-align:right; margin-top:12px;">
        <button type="button" onclick="cerrarModalProveedor()" class="btn-outline">Cancelar</button>
        <button type="submit" class="btn-primary">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL DETALLE -->
<div id="modalDetalle" class="modal">
  <div class="modal-content">
    <h2>Detalle Proveedor</h2>
    <div id="detalleContenido"></div>
    <div style="margin-top:15px; text-align:right;">
      <button type="button" onclick="cerrarModalDetalle()" class="btn-primary">Cerrar</button>
    </div>
  </div>
</div>

<div id="footer"></div>

<script>
let proveedores=[], copros=[], KEY_NAME="ID";

async function cargarProveedores(){
  [copros, proveedores] = await Promise.all([
    fetchData("Copropiedades"),
    fetchData("Proveedores")
  ]);
  if(proveedores.length) KEY_NAME=getKeyName(proveedores[0]);

  const coprosMap={};
  copros.forEach(c=>coprosMap[getKeyVal(c)] = c.Nombre);

  tablaProveedores.innerHTML = proveedores.map(p=>{
    const key=getKeyVal(p);
    return `
      <tr>
        <td>${coprosMap[p.CopropiedadID] || "—"}</td>
        <td>${p.Nombre||""}</td>
        <td>${p.RUT||""}</td>
        <td>${p.Giro||""}</td>
        <td>${p.Email||""}</td>
        <td>${p.Telefono||""}</td>
        <td>
          <button class="btn-outline" onclick="abrirDetalleProveedor('${key}')">Ver</button>
          <button class="btn-outline" onclick="abrirFormProveedor('${key}')">Editar</button>
          <button class="btn-primary" onclick="eliminarProveedor('${key}')">Eliminar</button>
        </td>
      </tr>
    `;
  }).join("");

  // dropdown copropiedades en modal
  proveedorCopro.innerHTML = copros.map(c=>`<option value="${getKeyVal(c)}">${c.Nombre}</option>`).join("");
}

function abrirFormProveedor(id){
  modalTitleProveedor.textContent = id ? "Editar Proveedor" : "Nuevo Proveedor";
  if(id){
    const p = proveedores.find(x=>String(getKeyVal(x))===String(id));
    if(!p) return;
    proveedorID.value=id;
    proveedorCopro.value=p.CopropiedadID||"";
    proveedorNombre.value=p.Nombre||"";
    proveedorRUT.value=p.RUT||"";
    proveedorGiro.value=p.Giro||"";
    proveedorEmail.value=p.Email||"";
    proveedorTelefono.value=p.Telefono||"";
  } else formProveedor.reset();
  modalProveedor.classList.add("active");
}
function cerrarModalProveedor(){ modalProveedor.classList.remove("active"); }

formProveedor.onsubmit=async e=>{
  e.preventDefault();
  const id=proveedorID.value||undefined;
  const payload={
    ...(id?{[KEY_NAME]:id}:{}),
    CopropiedadID:proveedorCopro.value,
    Nombre:proveedorNombre.value.trim(),
    RUT:proveedorRUT.value.trim(),
    Giro:proveedorGiro.value.trim(),
    Email:proveedorEmail.value.trim(),
    Telefono:proveedorTelefono.value.trim()
  };
  if(id) await appSheetCRUD("Proveedores","Edit",[payload]);
  else   await appSheetCRUD("Proveedores","Add",[payload]);
  cerrarModalProveedor(); location.reload();
};

async function eliminarProveedor(id){
  if(!confirm("¿Eliminar este proveedor?")) return;
  await appSheetCRUD("Proveedores","Delete",[{[KEY_NAME]:id}]);
  location.reload();
}

function abrirDetalleProveedor(id){
  const p=proveedores.find(x=>String(getKeyVal(x))===String(id));
  if(!p) return;
  const copro = copros.find(c=>String(getKeyVal(c))===String(p.CopropiedadID));
  detalleContenido.innerHTML=`
    <p><b>Copropiedad:</b> ${copro?.Nombre||"—"}</p>
    <p><b>Nombre:</b> ${p.Nombre||""}</p>
    <p><b>RUT:</b> ${p.RUT||""}</p>
    <p><b>Giro:</b> ${p.Giro||""}</p>
    <p><b>Email:</b> ${p.Email||""}</p>
    <p><b>Teléfono:</b> ${p.Telefono||""}</p>
  `;
  modalDetalle.classList.add("active");
}
function cerrarModalDetalle(){ modalDetalle.classList.remove("active"); }

cargarProveedores();
</script>
</body>
</html>