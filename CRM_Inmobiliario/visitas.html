<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>CRM Inmobiliario - Visitas</title>
  <link rel="stylesheet" href="css/styles.css">
  <script src="js/app.js"></script>
  <script>
    requireAuth();
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", async ()=>{
      // Cargar Header
      const headerResp = await fetch("header.html");
      document.getElementById("header").innerHTML = await headerResp.text();

      // Cargar Footer
      const footerResp = await fetch("footer.html");
      document.getElementById("footer").innerHTML = await footerResp.text();
    });
  </script>
</head>
<body>

<!-- NAV -->
<div id="header"></div>

<!-- CONTENIDO -->
<main style="padding:40px;">
  <h1 style="font-size:28px; font-weight:600; color:#1A2B48; margin-bottom:20px;">
    Gestión de Visitas
  </h1>

  <button onclick="abrirFormVisita()" class="btn-primary" style="margin-bottom:20px;">
    + Nueva Visita
  </button>

  <table>
    <thead>
      <tr>
        <th>Cliente</th>
        <th>Propiedad</th>
        <th>Fecha</th>
        <th>Agente</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tablaVisitas"></tbody>
  </table>
</main>

<!-- MODAL FORM -->
<div id="modalVisita" class="modal">
  <div class="modal-content">
    <h2 id="modalTitleVisita">Nueva Visita</h2>
    <form id="formVisita">
      <input type="hidden" id="visitaID">
      <label for="visitaCliente">Cliente</label>
      <select id="visitaCliente" required></select>
      <label for="visitaPropiedad">Propiedad</label>
      <select id="visitaPropiedad" required></select>
      <label for="visitaFecha">Fecha</label>
      <input type="date" id="visitaFecha" required>
      <label for="visitaAgente">Agente</label>
      <input type="text" id="visitaAgente" placeholder="Agente">
      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:12px;">
        <button type="button" onclick="cerrarModalVisita()" class="btn-outline">Cancelar</button>
        <button type="submit" class="btn-primary">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL DETALLE -->
<div id="modalDetalle" class="modal">
  <div class="modal-content">
    <h2>Detalle Visita</h2>
    <div id="detalleContenido"></div>
    <div style="margin-top:15px; text-align:right;">
      <button type="button" onclick="cerrarModalDetalle()" class="btn-primary">Cerrar</button>
    </div>
  </div>
</div>

<div id="footer"></div>

<script>
let visitasGlobal=[], clientesGlobal=[], propiedadesGlobal=[];
let KEY_NAME="ID";

// Helpers
function formatearFecha(iso){
  if(!iso) return "";
  const d=new Date(iso);
  return d.toLocaleDateString("es-CL");
}

async function cargarVisitas(){
  visitasGlobal = await fetchData("Visitas");
  clientesGlobal = await fetchData("Clientes");
  propiedadesGlobal = await fetchData("Propiedades");
  if(visitasGlobal.length) KEY_NAME = getKeyName(visitasGlobal[0]);

  const clientesMap={}, propiedadesMap={};
  clientesGlobal.forEach(c=>clientesMap[getKeyVal(c)] = c.Nombre);
  propiedadesGlobal.forEach(p=>propiedadesMap[getKeyVal(p)] = p["Dirección"] ?? p.Direccion ?? "");

  const tbody=document.getElementById("tablaVisitas");
  tbody.innerHTML = visitasGlobal.map(v=>{
    const key=getKeyVal(v);
    return `
      <tr>
        <td>${clientesMap[v.Cliente]||"—"}</td>
        <td>${propiedadesMap[v.Propiedad]||"—"}</td>
        <td>${formatearFecha(v["Fecha"] ?? v["Fecha Visita"])}</td>
        <td>${v.Agente ?? ""}</td>
        <td>
          <button class="btn-outline btn-ver" data-id="${key}">Ver</button>
          <button class="btn-outline btn-edit" data-id="${key}">Editar</button>
          <button class="btn-primary" onclick="eliminarVisita('${key}')">Eliminar</button>
        </td>
      </tr>
    `;
  }).join("");

  // Dropdowns
  document.getElementById("visitaCliente").innerHTML = clientesGlobal.map(c=>`<option value="${getKeyVal(c)}">${c.Nombre}</option>`).join("");
  document.getElementById("visitaPropiedad").innerHTML = propiedadesGlobal.map(p=>`<option value="${getKeyVal(p)}">${p["Dirección"] ?? ""}</option>`).join("");

  // Delegación
  tbody.onclick = (e)=>{
    const ver=e.target.closest(".btn-ver");
    const edit=e.target.closest(".btn-edit");
    if(ver) abrirDetalleVisita(ver.dataset.id);
    if(edit) abrirFormVisita(edit.dataset.id);
  };
}

// --- Modal Form ---
const modal=document.getElementById("modalVisita");
const form=document.getElementById("formVisita");

function abrirFormVisita(id){
  document.getElementById("modalTitleVisita").textContent = id ? "Editar Visita":"Nueva Visita";
  if(id){
    const v=visitasGlobal.find(x=>String(getKeyVal(x))===String(id));
    if(!v){alert("No encontrada");return;}
    document.getElementById("visitaID").value=id;
    document.getElementById("visitaCliente").value=v.Cliente;
    document.getElementById("visitaPropiedad").value=v.Propiedad;
    document.getElementById("visitaFecha").value=v["Fecha"] ?? v["Fecha Visita"];
    document.getElementById("visitaAgente").value=v.Agente ?? "";
  }else{
    form.reset();
    document.getElementById("visitaID").value="";
  }
  modal.classList.add("active");
}
function cerrarModalVisita(){modal.classList.remove("active");}

form.onsubmit=async(e)=>{
  e.preventDefault();
  const id=document.getElementById("visitaID").value||undefined;
  const payload={
    ...(id?{[KEY_NAME]:id}:{}),
    Cliente:document.getElementById("visitaCliente").value,
    Propiedad:document.getElementById("visitaPropiedad").value,
    "Fecha":document.getElementById("visitaFecha").value,
    Agente:document.getElementById("visitaAgente").value
  };
  try{
    if(id) await appSheetCRUD("Visitas","Edit",[payload]);
    else await appSheetCRUD("Visitas","Add",[payload]);
    cerrarModalVisita();
    location.reload();
  }catch(err){alert("Error: "+(err.message||err));}
};

async function eliminarVisita(id){
  if(!confirm("¿Eliminar esta visita?")) return;
  await appSheetCRUD("Visitas","Delete",[{[KEY_NAME]:id}]);
  location.reload();
}

// --- Modal Detalle ---
const modalDetalle=document.getElementById("modalDetalle");
const detalleContenido=document.getElementById("detalleContenido");

function abrirDetalleVisita(id){
  const v=visitasGlobal.find(x=>String(getKeyVal(x))===String(id));
  if(!v){alert("No encontrada");return;}
  detalleContenido.innerHTML=`
    <p><b>Cliente:</b> ${clientesGlobal.find(c=>getKeyVal(c)===v.Cliente)?.Nombre || "—"}</p>
    <p><b>Propiedad:</b> ${propiedadesGlobal.find(p=>getKeyVal(p)===v.Propiedad)?.["Dirección"] || "—"}</p>
    <p><b>Fecha:</b> ${formatearFecha(v["Fecha"] ?? v["Fecha Visita"])}</p>
    <p><b>Agente:</b> ${v.Agente ?? ""}</p>
  `;
  modalDetalle.classList.add("active");
}
function cerrarModalDetalle(){modalDetalle.classList.remove("active");}

cargarVisitas();
</script>
</body>
</html>