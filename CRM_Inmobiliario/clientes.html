<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>CRM - Clientes</title>
  <link rel="stylesheet" href="css/styles.css">
  <script src="js/app.js"></script>
  <style>
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5) }
    .modal .modal-content{ background:#fff; padding:20px; border-radius:6px; max-width:520px; width:100% }
    .modal.active{ display:flex }
  </style>
  <script>requireAuth();</script>
</head>
<body>

<header>
  <a href="index.html" style="font-weight:700;"><img width="150" src="img/logo_santajosefina.png" alt=""></a>
  <a href="dashboard.html">Dashboard</a>
  <a href="clientes.html" class="font-bold">Clientes</a>
  <a href="propiedades.html">Propiedades</a>
  <a href="visitas.html">Visitas</a>
  <a href="marketing.html">Marketing</a>
  <a href="index.html#contacto" class="btn-outline">Habla con un especialista</a>
</header>

<main style="padding:40px;">
  <h1 style="font-size:28px; font-weight:600; color:#1A2B48; margin-bottom:20px;">
    Gestión de Clientes
  </h1>

  <button onclick="abrirFormCliente()" class="btn-primary" style="margin-bottom:20px;">
    + Nuevo Cliente
  </button>

  <table>
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Email</th>
        <th>Teléfono</th>
        <th>Canal</th>
        <th>Segmento</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tablaClientes"></tbody>
  </table>
</main>

<!-- MODAL -->
<div id="modalCliente" class="modal">
  <div class="modal-content">
    <h2 id="modalTitleCliente">Nuevo Cliente</h2>
    <form id="formCliente">
      <input type="hidden" id="clienteID">

      <label for="clienteNombre">Nombre</label>
      <input type="text" id="clienteNombre" placeholder="Nombre" required>

      <label for="clienteEmail">Email</label>
      <input type="email" id="clienteEmail" placeholder="Email">

      <label for="clienteTelefono">Teléfono</label>
      <input type="text" id="clienteTelefono" placeholder="Teléfono">

      <label for="clienteCanal">Canal</label>
      <input type="text" id="clienteCanal" placeholder="Canal">

      <label for="clienteSegmento">Segmento</label>
      <input type="text" id="clienteSegmento" placeholder="Segmento">

      <label for="clienteEstado">Estado</label>
      <input type="text" id="clienteEstado" placeholder="Estado">

      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:12px;">
        <button type="button" onclick="cerrarModalCliente()" class="btn-outline">Cancelar</button>
        <button type="submit" class="btn-primary">Guardar</button>
      </div>
    </form>
  </div>
</div>

<script>
function getKeyName(obj){
  const cands = ["ID","Id","Key","Row ID","RowID","_ComputedKey","_RowNumber"];
  return cands.find(k => Object.prototype.hasOwnProperty.call(obj, k)) || "ID";
}
function getKeyVal(row){ return row[getKeyName(row)]; }

let clientesGlobal=[];
let KEY_NAME="ID";

async function cargarClientes(){
  clientesGlobal = await fetchData("Clientes");
  if (clientesGlobal.length) KEY_NAME = getKeyName(clientesGlobal[0]);

  const tbody = document.getElementById("tablaClientes");
  tbody.innerHTML = clientesGlobal.map(c=>{
    const key = getKeyVal(c);
    const tel = c.Telefono ?? c.Teléfono ?? "";
    return `
      <tr>
        <td class="font-medium">${c.Nombre ?? ""}</td>
        <td>${c.Email ?? ""}</td>
        <td>${tel}</td>
        <td>${c.Canal ?? ""}</td>
        <td>${c.Segmento ?? ""}</td>
        <td>${c.Estado ?? ""}</td>
        <td>
          <button type="button" class="btn-outline btn-edit" data-id="${key}">Editar</button>
          <button type="button" class="btn-primary" onclick="eliminarCliente('${key}')">Eliminar</button>
        </td>
      </tr>
    `;
  }).join("");

  tbody.onclick = (e)=>{
    const btn = e.target.closest(".btn-edit");
    if(!btn) return;
    abrirFormCliente(btn.dataset.id);
  };
}

const modal = document.getElementById("modalCliente");
const form  = document.getElementById("formCliente");

function abrirFormCliente(id){
  document.getElementById("modalTitleCliente").textContent = id ? "Editar Cliente" : "Nuevo Cliente";

  if(id){
    const c = clientesGlobal.find(x => String(getKeyVal(x)) === String(id));
    if(!c){ alert("No se encontró el cliente"); return; }

    document.getElementById("clienteID").value = id;
    document.getElementById("clienteNombre").value   = c.Nombre ?? "";
    document.getElementById("clienteEmail").value    = c.Email ?? "";
    document.getElementById("clienteTelefono").value = c.Telefono ?? c.Teléfono ?? "";
    document.getElementById("clienteCanal").value    = c.Canal ?? "Web";
    document.getElementById("clienteSegmento").value = c.Segmento ?? "Departamento";
    document.getElementById("clienteEstado").value   = c.Estado ?? "Nuevo";
  } else {
    form.reset();
    document.getElementById("clienteID").value = "";
  }
  modal.classList.add("active");
}
function cerrarModalCliente(){ modal.classList.remove("active"); }

form.onsubmit = async (e)=>{
  e.preventDefault();
  const id = document.getElementById("clienteID").value || undefined;
  const payload = {
    ...(id ? { [KEY_NAME]: id } : {}),
    Nombre:   document.getElementById("clienteNombre").value.trim(),
    Email:    document.getElementById("clienteEmail").value.trim().toLowerCase(),
    Telefono: document.getElementById("clienteTelefono").value.trim(),
    Canal:    document.getElementById("clienteCanal").value.trim(),
    Segmento: document.getElementById("clienteSegmento").value.trim(),
    Estado:   document.getElementById("clienteEstado").value.trim()
  };
  try{
    if(id) await appSheetCRUD("Clientes","Edit",[payload]);
    else   await appSheetCRUD("Clientes","Add",[payload]);
    cerrarModalCliente();
    location.reload();
  }catch(err){
    alert("Error: " + (err.message || err));
    console.error(err);
  }
};

async function eliminarCliente(id){
  if(!confirm("¿Eliminar este cliente?")) return;
  try{
    await appSheetCRUD("Clientes","Delete",[{[KEY_NAME]:id}]);
    location.reload();
  }catch(err){
    alert("Error: " + (err.message || err));
    console.error(err);
  }
}

cargarClientes();
</script>
</body>
</html>