<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>CRM - Clientes</title>
  <link rel="stylesheet" href="css/styles.css">
  <script src="js/app.js"></script>
</head>
<body>

<!-- NAV -->
<header>
  <a href="index.html" style="font-weight:700;"><img fetchpriority="high" width="150" src="https://santajosefinaspa.cl/wp-content/uploads/2025/03/cropped-propuesta-logo-santa-josefina-Photoroom.png" alt=" "></a>
  <a href="dashboard.html">Dashboard</a>
  <a href="clientes.html">Clientes</a>
  <a href="propiedades.html" class="font-bold">Propiedades</a>
  <a href="visitas.html">Visitas</a>
  <a href="marketing.html">Marketing</a>
  <a href="index.html#contacto" class="btn-outline">Habla con un especialista</a>
</header>

<!-- CONTENIDO -->
<main style="padding:40px;">
  <h1 style="font-size:28px; font-weight:600; color:#1A2B48; margin-bottom:20px;">
    Gestión de Clientes
  </h1>

  <button onclick="abrirFormCliente()" class="btn-primary" style="margin-bottom:20px;">
    + Nuevo Cliente
  </button>

  <table>
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Email</th>
        <th>Teléfono</th>
        <th>Canal</th>
        <th>Segmento</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tablaClientes"></tbody>
  </table>
</main>

<!-- MODAL -->
<div id="modalCliente" class="modal">
  <div class="modal-content">
    <h2 id="modalTitleCliente">Nuevo Cliente</h2>
    <form id="formCliente">
      <input type="hidden" id="clienteID">
      <input type="text" id="clienteNombre" placeholder="Nombre" required>
      <input type="email" id="clienteEmail" placeholder="Email">
      <input type="text" id="clienteTelefono" placeholder="Teléfono">
      <input type="text" id="clienteCanal" placeholder="Canal">
      <input type="text" id="clienteSegmento" placeholder="Segmento">
      <input type="text" id="clienteEstado" placeholder="Estado">
      <div style="display:flex; justify-content:flex-end; gap:10px;">
        <button type="button" onclick="cerrarModalCliente()" class="btn-outline">Cancelar</button>
        <button type="submit" class="btn-primary">Guardar</button>
      </div>
    </form>
  </div>
</div>

<script>
let clientesGlobal=[];

async function cargarClientes(){
  clientesGlobal = await fetchData("Clientes");
  document.getElementById("tablaClientes").innerHTML = clientesGlobal.map(c=>`
    <tr>
      <td>${c.Nombre}</td>
      <td>${c.Email}</td>
      <td>${c.Telefono}</td>
      <td>${c.Canal}</td>
      <td>${c.Segmento}</td>
      <td>${c.Estado}</td>
      <td>
        <button onclick="abrirFormCliente('${c.ID}')" class="btn-outline">Editar</button>
        <button onclick="eliminarCliente('${c.ID}')" class="btn-primary">Eliminar</button>
      </td>
    </tr>
  `).join("");
}

const modalCliente = document.getElementById("modalCliente");
const formCliente = document.getElementById("formCliente");

function abrirFormCliente(id){
  document.getElementById("modalTitleCliente").textContent = id?"Editar Cliente":"Nuevo Cliente";
  if(id){
    const c = clientesGlobal.find(x=>x.ID===id);
    document.getElementById("clienteID").value = c.ID;
    document.getElementById("clienteNombre").value = c.Nombre;
    document.getElementById("clienteEmail").value = c.Email;
    document.getElementById("clienteTelefono").value = c.Telefono;
    document.getElementById("clienteCanal").value = c.Canal;
    document.getElementById("clienteSegmento").value = c.Segmento;
    document.getElementById("clienteEstado").value = c.Estado;
  } else formCliente.reset();
  modalCliente.classList.add("active");
}

function cerrarModalCliente(){ modalCliente.classList.remove("active"); }

formCliente.onsubmit = async function(e){
  e.preventDefault();
  const id = document.getElementById("clienteID").value;
  const data = {
    ID: id || undefined,
    Nombre: document.getElementById("clienteNombre").value,
    Email: document.getElementById("clienteEmail").value,
    Telefono: document.getElementById("clienteTelefono").value,
    Canal: document.getElementById("clienteCanal").value,
    Segmento: document.getElementById("clienteSegmento").value,
    Estado: document.getElementById("clienteEstado").value
  };
  try {
    if(id) await appSheetCRUD("Clientes","Edit",[data]);
    else await appSheetCRUD("Clientes","Add",[data]);
    cerrarModalCliente();
    location.reload();
  } catch(err){ alert("Error: "+err.message); }
}

async function eliminarCliente(id){
  if(!confirm("¿Eliminar este cliente?")) return;
  await appSheetCRUD("Clientes","Delete",[{"ID":id}]);
  location.reload();
}

cargarClientes();
</script>
</body>
</html>