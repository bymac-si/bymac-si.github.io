<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>CRM - Gastos</title>
  <link rel="stylesheet" href="css/styles.css">
  <script src="js/app.js"></script>
  <script>requireAuth();</script>
  <script>
    document.addEventListener("DOMContentLoaded", async ()=>{
      document.getElementById("header").innerHTML = await (await fetch("header.html")).text();
      document.getElementById("footer").innerHTML = await (await fetch("footer.html")).text();
    });
  </script>
</head>
<body>
<div id="header"></div>

<main style="padding:40px;">
  <h1 class="page-title">Gastos Comunes</h1>

  <button class="btn-primary" onclick="abrirFormGasto()">+ Nuevo Gasto</button>

  <table>
    <thead>
      <tr>
        <th>Copropiedad</th>
        <th>Proveedor</th>
        <th>Tipo de Gasto</th>
        <th>Monto</th>
        <th>Fecha</th>
        <th>Documento</th>
        <th>Observaciones</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tablaGastos"></tbody>
  </table>
</main>

<!-- Modal Gasto -->
<div id="modalGasto" class="modal">
  <div class="modal-content">
    <h2 id="modalTitleGasto">Nuevo Gasto</h2>
    <form id="formGasto">
      <input type="hidden" id="gastoID">

      <label>Copropiedad</label>
      <select id="gastoCopro" required></select>

      <label>Proveedor</label>
      <select id="gastoProveedor" required></select>

      <label>Tipo de Gasto</label>
      <input id="gastoTipo" required>

      <label>Monto</label>
      <input type="number" id="gastoMonto" required>

      <label>Fecha</label>
      <input type="date" id="gastoFecha" required>

      <label>Documento</label>
      <input type="text" id="gastoDocumento" placeholder="N° Factura, Boleta, etc.">

      <label>Observaciones</label>
      <textarea id="gastoNotas"></textarea>

      <div style="text-align:right; margin-top:12px;">
        <button type="button" onclick="cerrarModalGasto()" class="btn-outline">Cancelar</button>
        <button type="submit" class="btn-primary">Guardar</button>
      </div>
    </form>
  </div>
</div>

<div id="footer"></div>

<script>
let gastos=[], copros=[], proveed=[], KEY_NAME="ID";

async function cargarGastos(){
  [copros, gastos, proveed] = await Promise.all([
    fetchData("Copropiedades"),
    fetchData("Gastos"),
    fetchData("Proveedores")
  ]);
  if(gastos.length) KEY_NAME = getKeyName(gastos[0]);

  gastoCopro.innerHTML = copros.map(c=>`<option value="${getKeyVal(c)}">${c.Nombre}</option>`).join("");
  gastoProveedor.innerHTML = proveed.map(p=>`<option value="${getKeyVal(p)}">${p.Nombre}</option>`).join("");

  tablaGastos.innerHTML = gastos.map(g=>{
    const key=getKeyVal(g);
    return `
      <tr>
        <td>${copros.find(c=>getKeyVal(c)===g.CopropiedadID)?.Nombre||"—"}</td>
        <td>${proveed.find(p=>getKeyVal(p)===g.ProveedorID)?.Nombre||"—"}</td>
        <td>${g.TipoGasto||""}</td>
        <td>${formatoPrecio(g.Monto)}</td>
        <td>${formatearFecha(g.Fecha)}</td>
        <td>${g.Documento||"—"}</td>
        <td>${g.Observaciones||""}</td>
        <td>
          <button class="btn-outline" onclick="abrirFormGasto('${key}')">Editar</button>
          <button class="btn-primary" onclick="eliminarGasto('${key}')">Eliminar</button>
        </td>
      </tr>
    `;
  }).join("");
}

function abrirFormGasto(id){
  modalTitleGasto.textContent = id ? "Editar Gasto" : "Nuevo Gasto";
  if(id){
    const g=gastos.find(x=>String(getKeyVal(x))===String(id));
    gastoID.value=id;
    gastoCopro.value=g.CopropiedadID;
    gastoProveedor.value=g.ProveedorID;
    gastoTipo.value=g.TipoGasto||"";
    gastoMonto.value=g.Monto||0;
    gastoFecha.value=g.Fecha||"";
    gastoDocumento.value=g.Documento||"";
    gastoNotas.value=g.Observaciones||"";
  } else formGasto.reset();
  modalGasto.classList.add("active");
}
function cerrarModalGasto(){ modalGasto.classList.remove("active"); }

formGasto.onsubmit=async e=>{
  e.preventDefault();
  const id=gastoID.value||undefined;
  const payload={
    ...(id?{[KEY_NAME]:id}:{}),
    CopropiedadID:gastoCopro.value,
    ProveedorID:gastoProveedor.value,
    Fecha:gastoFecha.value,
    TipoGasto:gastoTipo.value,
    Monto:parseFloat(gastoMonto.value)||0,
    Documento:gastoDocumento.value,
    Observaciones:gastoNotas.value
  };

  console.log("Payload enviado:", payload);

  try{
    if(id) await appSheetCRUD("Gastos","Edit",[payload]);
    else   await appSheetCRUD("Gastos","Add",[payload]);
    cerrarModalGasto(); 
    location.reload();
  }catch(err){
    alert("Error al guardar: " + (err.message||err));
    console.error("Error:", err);
  }
};

async function eliminarGasto(id){
  if(!confirm("¿Eliminar gasto?")) return;
  await appSheetCRUD("Gastos","Delete",[{[KEY_NAME]:id}]);
  location.reload();
}

cargarGastos();
</script>
</body>
</html>