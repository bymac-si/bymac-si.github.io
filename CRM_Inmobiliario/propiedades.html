<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>CRM Inmobiliario - Propiedades</title>
<link rel="stylesheet" href="css/styles.css">
<script src="js/app.js"></script>
<script>
  requireAuth();
</script>
<script>
  document.addEventListener("DOMContentLoaded", async ()=>{
    const headerResp = await fetch("header.html");
    document.getElementById("header").innerHTML = await headerResp.text();
    const footerResp = await fetch("footer.html");
    document.getElementById("footer").innerHTML = await footerResp.text();
  });
</script>
</head>
<body>

<div id="header"></div>

<main style="padding:40px;">
  <h1 style="font-size:28px; font-weight:600; color:#1A2B48; margin-bottom:20px;">
    Gestión de Propiedades
  </h1>

  <button onclick="abrirFormPropiedad()" class="btn-primary" style="margin-bottom:20px;">
    + Nueva Propiedad
  </button>

  <table>
    <thead>
      <tr>
        <th>Título</th>
        <th>Dirección</th>
        <th>Tipo</th>
        <th>Precio</th>
        <th>Estado</th>
        <th>Propietario</th>
        <th>Agente</th>
        <th>Imagen</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tablaPropiedades"></tbody>
  </table>
</main>

<!-- MODAL FORM -->
<div id="modalPropiedad" class="modal">
  <div class="modal-content">
    <h2 id="modalTitlePropiedad">Nueva Propiedad</h2>
    <form id="formPropiedad">
      <input type="hidden" id="propiedadID">
      <label for="propiedadTitulo">Título</label>
      <input type="text" id="propiedadTitulo" required>
      <label for="propiedadDireccion">Dirección</label>
      <input type="text" id="propiedadDireccion" required>
      <label for="propiedadTipo">Tipo</label>
      <input type="text" id="propiedadTipo">
      <label for="propiedadPrecio">Precio</label>
      <input type="number" id="propiedadPrecio">
      <label for="propiedadEstado">Estado</label>
      <input type="text" id="propiedadEstado">
      <label for="propiedadPropietario">Propietario</label>
      <input type="text" id="propiedadPropietario">
      <label for="propiedadAgente">Agente</label>
      <input type="text" id="propiedadAgente">
      <label for="propiedadImagen">URL Imagen</label>
      <input type="text" id="propiedadImagen">
      <div style="margin-top:12px; text-align:right;">
        <button type="button" onclick="cerrarModalPropiedad()" class="btn-outline">Cancelar</button>
        <button type="submit" class="btn-primary">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL DETALLE -->
<div id="modalDetalle" class="modal">
  <div class="modal-content">
    <h2>Detalle Propiedad</h2>
    <div id="detalleContenido"></div>
    <div style="margin-top:15px; text-align:right;">
      <button type="button" onclick="cerrarModalDetalle()" class="btn-primary">Cerrar</button>
    </div>
  </div>
</div>

<div id="footer"></div>

<script>
let propiedadesGlobal = [];
let KEY_NAME = "ID";

function formatoCLP(v){ return "$" + new Intl.NumberFormat("es-CL").format(Number(v||0)); }
// Fecha en formato ISO (YYYY-MM-DD)
function hoyISO(){ return new Date().toISOString().split("T")[0]; }

async function cargarPropiedades(){
  propiedadesGlobal = await fetchData("Propiedades");
  if (propiedadesGlobal.length) KEY_NAME = getKeyName(propiedadesGlobal[0]);

  const tbody = document.getElementById("tablaPropiedades");
  tbody.innerHTML = propiedadesGlobal.map(p=>{
    const key = getKeyVal(p);
    return `
      <tr>
        <td>${p.Titulo ?? ""}</td>
        <td>${p.Direccion ?? ""}</td>
        <td>${p.Tipo ?? ""}</td>
        <td>${formatoCLP(p.Precio)}</td>
        <td>${p.Estado ?? ""}</td>
        <td>${p.Propietario ?? ""}</td>
        <td>${p.Agente ?? ""}</td>
        <td>${p.ImagenURL ? `<img src="${p.ImagenURL}" style="width:80px;border-radius:4px;">` : "—"}</td>
        <td>
          <button type="button" class="btn-outline btn-ver" data-id="${key}">Ver</button>
          <button type="button" class="btn-outline btn-edit" data-id="${key}">Editar</button>
          <button type="button" class="btn-primary" onclick="eliminarPropiedad('${key}')">Eliminar</button>
        </td>
      </tr>
    `;
  }).join("");

  tbody.onclick = (e)=>{
    const btnVer = e.target.closest(".btn-ver");
    const btnEdit = e.target.closest(".btn-edit");
    if(btnVer) abrirDetallePropiedad(btnVer.dataset.id);
    if(btnEdit) abrirFormPropiedad(btnEdit.dataset.id);
  };
}

// --- Modal Form ---
function abrirFormPropiedad(id){
  document.getElementById("modalTitlePropiedad").textContent = id ? "Editar Propiedad" : "Nueva Propiedad";
  if(id){
    const p = propiedadesGlobal.find(x => String(getKeyVal(x)) === String(id));
    if(!p){ alert("No se encontró la propiedad"); return; }
    propiedadID.value = id;
    propiedadTitulo.value = p.Titulo ?? "";
    propiedadDireccion.value = p.Direccion ?? "";
    propiedadTipo.value = p.Tipo ?? "";
    propiedadPrecio.value = p.Precio ?? 0;
    propiedadEstado.value = p.Estado ?? "";
    propiedadPropietario.value = p.Propietario ?? "";
    propiedadAgente.value = p.Agente ?? "";
    propiedadImagen.value = p.ImagenURL ?? "";
  } else {
    formPropiedad.reset();
    propiedadID.value = "";
  }
  modalPropiedad.classList.add("active");
}
function cerrarModalPropiedad(){ modalPropiedad.classList.remove("active"); }

formPropiedad.onsubmit = async function(e){
  e.preventDefault();
  const id = propiedadID.value || undefined;

  const payload = {
    ...(id ? { [KEY_NAME]: id } : {}),
    Direccion: propiedadDireccion.value.trim(),
    Titulo: propiedadTitulo.value.trim(),
    Tipo: propiedadTipo.value.trim(),
    Precio: parseFloat(propiedadPrecio.value) || 0,
    Estado: propiedadEstado.value.trim(),
    Propietario: propiedadPropietario.value.trim(),
    Agente: propiedadAgente.value.trim(),
    "Fecha Captacion": id 
    ? (propiedadesGlobal.find(x => String(getKeyVal(x)) === String(id))?.["Fecha Captacion"] || hoyISO()) 
    : hoyISO(),
    ImagenURL: propiedadImagen.value.trim() || null
  };

  try {
    if(id) await appSheetCRUD("Propiedades","Edit",[payload]);
    else   await appSheetCRUD("Propiedades","Add",[payload]);
    cerrarModalPropiedad();
    location.reload();
  } catch(err){ 
    alert("Error: " + (err.message || err)); 
    console.error(err);
  }
}

// --- Eliminar ---
async function eliminarPropiedad(id){
  if(!confirm("¿Eliminar esta propiedad?")) return;
  await appSheetCRUD("Propiedades","Delete",[{[KEY_NAME]:id}]);
  location.reload();
}

// --- Modal Detalle ---
function abrirDetallePropiedad(id){
  const p = propiedadesGlobal.find(x => String(getKeyVal(x)) === String(id));
  if(!p){ alert("No se encontró la propiedad"); return; }
  detalleContenido.innerHTML = `
    <p><b>Título:</b> ${p.Titulo ?? ""}</p>
    <p><b>Dirección:</b> ${p.Direccion ?? ""}</p>
    <p><b>Tipo:</b> ${p.Tipo ?? ""}</p>
    <p><b>Precio:</b> ${formatoCLP(p.Precio)}</p>
    <p><b>Estado:</b> ${p.Estado ?? ""}</p>
    <p><b>Propietario:</b> ${p.Propietario ?? ""}</p>
    <p><b>Agente:</b> ${p.Agente ?? ""}</p>
    <p><b>Fecha Captación:</b> ${p.FechaCaptacion ?? ""}</p>
    <p><b>Imagen:</b><br>${p.ImagenURL ? `<img src="${p.ImagenURL}" style="width:200px;border-radius:8px;">` : "—"}</p>
  `;
  modalDetalle.classList.add("active");
}
function cerrarModalDetalle(){ modalDetalle.classList.remove("active"); }

// Inicializar
cargarPropiedades();
</script>
</body>
</html>