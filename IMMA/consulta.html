<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Consulta Spools · IMMA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />

    <style>
      :root {
        --bymac-primary: #1a2b48;
        --bymac-bg: #f5f7fb;
      }
      body {
        font-family: system-ui, sans-serif;
        background-color: var(--bymac-bg);
        padding: 20px;
      }
      .card {
        border-radius: 10px;
        border: 1px solid #e1e4ee;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      }
      .ficha-header {
        background-color: var(--bymac-primary);
        color: white;
        padding: 12px 20px;
        border-radius: 8px 8px 0 0;
      }
      .ficha-body {
        background-color: white;
        border: 1px solid #dee2e6;
        border-top: none;
        border-radius: 0 0 8px 8px;
        padding: 25px;
      }
      .ficha-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
        margin-bottom: 4px;
      }
      .ficha-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: #212529;
        margin-bottom: 18px;
        border-bottom: 1px solid #f0f0f0;
        padding-bottom: 5px;
      }
    </style>
  </head>

  <body>
    <main class="container">
      <div class="card mb-3 shadow-sm" style="background: linear-gradient(90deg, #a0c0f6, #3c475a); color: white;">
        <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-center py-2">
          <h1 class="m-0 fs-4">
            <img src="https://bymac-si.github.io/img/logo_imma.png" alt="IMMA" style="width: 80px; margin-right: 10px" />Soluciones en Piping
          </h1>
          <div class="text-end small fs-5">Panel MasterBI Fluor</div>
        </div>
      </div>
      
      <div class="text-center mb-5">
        <h2 class="fw-bold" style="color: var(--bymac-primary);">
            <i class="bi bi-search"></i> Consulta de Spools
        </h2>
        <p class="text-muted">Visualización de estado y planos en tiempo real</p>
      </div>

      <div class="row justify-content-center mb-4">
        <div class="col-12 col-md-8">
            <div class="input-group input-group-lg shadow-sm">
                <span class="input-group-text bg-white border-0"><i class="bi bi-search text-muted"></i></span>
                <input type="text" id="txtBuscar" class="form-control border-0" placeholder="Ingrese TAG (Ej: 29044-005)..." onkeyup="if(event.key==='Enter') buscarTags()">
                <button class="btn btn-primary px-4" onclick="buscarTags()">Consultar</button>
            </div>
            <div id="resFicha" class="list-group mt-2 shadow-sm" style="display:none;"></div>
        </div>
      </div>

      <div id="contenedorFicha" class="d-none animate__animated animate__fadeIn">
        <div class="row g-4">
            
            <div class="col-12 col-lg-4">
                <div class="ficha-header">
                    <h5 class="m-0"><i class="bi bi-info-circle"></i> Datos del Spool</h5>
                </div>
                <div class="ficha-body h-100">
                    <div class="mb-4 text-center">
                        <h2 id="ficha-tag" class="text-primary fw-bold mb-0">-</h2>
                        <span id="ficha-status-badge" class="badge bg-secondary mt-1">Consultando...</span>
                    </div>

                    <div class="ficha-label">Última Etapa Registrada</div>
                    <div id="ficha-etapa" class="ficha-value">-</div>

                    <div class="ficha-label">Fecha de Movimiento</div>
                    <div id="ficha-fecha" class="ficha-value">-</div>

                    <div class="ficha-label">Estado General</div>
                    <div id="ficha-estado-texto" class="ficha-value">-</div>

                    <div class="alert alert-info border mt-4 small">
                        <i class="bi bi-shield-lock"></i> Vista de solo lectura.
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-8">
                <div class="ficha-header d-flex justify-content-between align-items-center">
                    <h5 class="m-0"><i class="bi bi-file-earmark-pdf"></i> Plano</h5>
                    <a id="ficha-btn-abrir" href="#" target="_blank" class="btn btn-sm btn-outline-light d-none">
                        <i class="bi bi-box-arrow-up-right"></i> Expandir
                    </a>
                </div>
                <div class="ficha-body p-0" style="height: 600px; background: #eee; position: relative;">
                    
                    <div id="ficha-plano-loading" class="d-flex flex-column justify-content-center align-items-center h-100 text-muted">
                        <i class="bi bi-file-pdf fs-1 mb-2"></i>
                        <span>Seleccione un TAG para visualizar</span>
                    </div>
                    
                    <iframe id="ficha-iframe" class="w-100 h-100 d-none" style="border:none;"></iframe>
                    
                    <img id="ficha-img-fallback" src="https://bymac-si.github.io/img/not-found.png" class="d-none w-100 h-100" style="object-fit: contain;">
                </div>
            </div>
        </div>
      </div>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // ⚠️ URL ORIGINAL MANTENIDA
      const API_URL = "https://script.google.com/macros/s/AKfycbz9W1UPXquuIB0DIV2fGJS8nnKsj5tRAHaBh-3ufNMXPE-5aE9P6NmyY7O3aCrz6vuP/exec";

      function callApi(accion, data = {}) {
        const p = new URLSearchParams();
        p.append("accion", accion);
        Object.keys(data).forEach((k) => {
          if (data[k]) p.append(k, typeof data[k] === "object" ? JSON.stringify(data[k]) : String(data[k]));
        });
        return fetch(API_URL, { method: "POST", body: p }).then((r) => {
          if (!r.ok) throw new Error(r.status);
          return r.json();
        });
      }

      function buscarTags() {
          const txt = document.getElementById("txtBuscar").value.trim();
          const resDiv = document.getElementById("resFicha");
          
          if (!txt) { resDiv.style.display = 'none'; return; }
          
          resDiv.innerHTML = '<div class="list-group-item">Buscando...</div>';
          resDiv.style.display = 'block';

          callApi("buscarTag", { texto: txt }).then(r => {
             if (!r.ok || !r.data.length) {
                 resDiv.innerHTML = '<div class="list-group-item text-danger">No se encontraron coincidencias.</div>';
                 return;
             }
             let h = '';
             r.data.forEach(i => {
                 h += `<a href="#" class="list-group-item list-group-item-action py-3" onclick="verFicha('${i.fila}', '${i.tag}'); return false;">
                         <div class="d-flex w-100 justify-content-between align-items-center">
                           <h6 class="mb-0 fw-bold text-primary"><i class="bi bi-tag-fill"></i> ${i.tag}</h6>
                           <small class="text-muted"><i class="bi bi-chevron-right"></i></small>
                         </div>
                       </a>`;
             });
             resDiv.innerHTML = h;
          }).catch(e => {
              resDiv.innerHTML = '<div class="list-group-item text-danger">Error de conexión.</div>';
          });
      }

      function verFicha(fila, tag) {
    // 1. UI RESET (Igual que antes)
    document.getElementById("resFicha").style.display = 'none';
    document.getElementById("txtBuscar").value = tag;
    document.getElementById("contenedorFicha").classList.remove("d-none");
    document.getElementById("ficha-tag").textContent = tag;

    // Resetear visuales a "Cargando..." independiente para cada elemento
    const spinner = '<div class="spinner-border spinner-border-sm text-secondary" role="status"></div>';
    
    // Elementos del DOM
    const elBadge = document.getElementById("ficha-status-badge");
    const elEstadoTxt = document.getElementById("ficha-estado-texto");
    const elEtapa = document.getElementById("ficha-etapa");
    const elFecha = document.getElementById("ficha-fecha");
    
    // Poner todo en estado de carga inicial
    elBadge.textContent = "Consultando...";
    elBadge.className = "badge bg-secondary mt-2";
    elEstadoTxt.innerHTML = spinner;
    elEtapa.innerHTML = spinner;
    elFecha.innerHTML = spinner;

    // Resetear Plano
    const iframe = document.getElementById("ficha-iframe");
    const loader = document.getElementById("ficha-plano-loading");
    const fallback = document.getElementById("ficha-img-fallback");
    const btnAbrir = document.getElementById("ficha-btn-abrir");

    iframe.classList.add("d-none");
    iframe.src = ""; 
    fallback.classList.add("d-none");
    btnAbrir.classList.add("d-none");
    loader.classList.remove("d-none");
    loader.innerHTML = '<div class="spinner-border text-primary" role="status"></div><div class="mt-2">Buscando plano...</div>';

    // 2. DISPARAR PETICIONES INDEPENDIENTES (Sin Promise.all)

    // A. Obtener ESTADO (Suele ser rápido)
    callApi("estadoTag", { fila: fila }).then(res => {
        const d = res.data || {};
        let colorClass = "bg-secondary";
        if(d.color === 'green') colorClass = "bg-success";
        if(d.color === 'blue') colorClass = "bg-primary";
        if(d.color === 'red') colorClass = "bg-danger";
        
        elBadge.textContent = d.estado || "SIN DATOS";
        elBadge.className = `badge ${colorClass} mt-2`;
        elEstadoTxt.textContent = d.estado || "-";
    }).catch(e => elEstadoTxt.textContent = "Error");

    // B. Obtener ETAPA (Suele ser rápido)
    callApi("ultimaEtapa", { fila: fila }).then(res => {
        const d = res.data || {};
        let ft = d.fechaTexto;
        if (ft) ft = ft.split("-").reverse().join("/");
        
        elEtapa.textContent = d.ultimaColumna || "Sin registros";
        elFecha.textContent = ft || "-";
    }).catch(e => elEtapa.textContent = "Error");

    // C. Obtener PLANO (Suele ser lento, no bloqueará lo anterior)
    callApi("vistaPlano", { tag: tag }).then(res => {
        const d = res.data || res;
        if (d.ok && d.url) {
            iframe.src = d.url;
            iframe.onload = () => {
                loader.classList.add("d-none");
                iframe.classList.remove("d-none");
            };
            const fullUrl = d.url.replace("/preview", "/view");
            btnAbrir.href = fullUrl;
            btnAbrir.classList.remove("d-none");
        } else {
            loader.classList.add("d-none");
            fallback.classList.remove("d-none");
        }
    }).catch(e => {
        loader.innerHTML = '<span class="text-danger">Plano no disponible</span>';
    });
}
    </script>
  </body>
</html>