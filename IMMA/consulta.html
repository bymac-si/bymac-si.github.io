<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <meta name="theme-color" content="#ffffff" />

    <link rel="manifest" href="manifest.json" />

    <meta name="apple-mobile-web-app-capable" content="yes" />

    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent" />

    <meta name="apple-mobile-web-app-title" content="IMMA" />

    <link rel="apple-touch-icon" href="icon-192.png" />
    <title>Consulta Spools · IMMA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />

    <style>
      :root {
        --bymac-primary: #1a2b48;
        --bymac-bg: #f5f7fb;
      }
      body {
        font-family: system-ui, sans-serif;
        background-color: var(--bymac-bg);
        padding: 20px;
      }
      .card {
        border-radius: 10px;
        border: 1px solid #e1e4ee;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
      /* FICHA ESTILOS */
      .ficha-header {
        background-color: var(--bymac-primary);
        color: white;
        padding: 12px 20px;
        border-radius: 8px 8px 0 0;
      }
      .ficha-body {
        background-color: white;
        border: 1px solid #dee2e6;
        border-top: none;
        border-radius: 0 0 8px 8px;
        padding: 25px;
      }
      .ficha-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
        margin-bottom: 2px;
        font-weight: 600;
      }
      .ficha-value {
        font-size: 1rem;
        font-weight: 600;
        color: #212529;
        margin-bottom: 0;
        padding-bottom: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* TIMELINE STYLES */
      .timeline {
        position: relative;
        padding-left: 20px;
        border-left: 2px solid #e9ecef;
        margin-top: 20px;
        margin-bottom: 20px;
      }
      .timeline-item {
        position: relative;
        margin-bottom: 15px;
      }
      .timeline-dot {
        position: absolute;
        left: -27px;
        top: 2px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #fff;
        border: 3px solid #1a2b48;
      }
      .timeline-date {
        font-size: 0.8rem;
        color: #6c757d;
        font-weight: 600;
      }
      .timeline-content {
        font-size: 0.95rem;
        font-weight: bold;
        color: #212529;
      }
      .timeline-empty {
        font-style: italic;
        color: #adb5bd;
        font-size: 0.9rem;
        padding-left: 10px;
      }
    </style>
  </head>

  <body class="d-flex flex-column min-vh-100">
    <main class="container">
      <div
        class="card mb-3 shadow-sm"
        style="
          background: linear-gradient(90deg, #a0c0f6, #3c475a);
          color: white;
        ">
        <div
          class="card-body d-flex flex-column flex-md-row justify-content-between align-items-center py-2">
          <h1 class="m-0 fs-4">
            <img
              src="https://bymac-si.github.io/img/logo_imma.png"
              alt="IMMA"
              style="width: 80px; margin-right: 10px" />Soluciones en Piping
          </h1>
          <div class="text-end small fs-5">Panel MasterBI Fluor</div>
        </div>
      </div>

      <div class="text-center mb-5">
        <h2 class="fw-bold" style="color: var(--bymac-primary)">
          <i class="bi bi-search"></i> Consulta de Spools
        </h2>
        <p class="text-muted">
          Visualización de estado y planos en tiempo real
        </p>
      </div>

      <div class="row justify-content-center mb-4">
        <div class="col-12 col-md-8">
          <div class="input-group input-group-lg shadow-sm">
            <button
              class="btn btn-outline-secondary bg-white border-0 border-end"
              type="button"
              data-bs-toggle="modal"
              data-bs-target="#modalCamara">
              <i class="bi bi-qr-code-scan text-primary"
                style="font-size: 1.2rem;"></i>
            </button>

            <span class="input-group-text bg-white border-0">
              <i class="bi bi-search text-muted"></i>
            </span>

            <input
              type="text"
              id="txtBuscar"
              class="form-control border-0"
              placeholder="Escanee o ingrese TAG..."
              onkeyup="if(event.key==='Enter') buscarTags()" />

            <button class="btn bg-danger px-4" type="button"
              onclick="limpiarBusqueda()" title="Limpiar">
              <i class="bi bi-x-lg text-light"></i>
            </button>
            <button class="btn btn-primary px-4" onclick="buscarTags()">
              <i class="bi bi-search"></i>
            </button>
          </div>
          <div
            id="resFicha"
            class="list-group mt-2 shadow-sm"
            style="display: none"></div>
        </div>
      </div>

      <div
        id="contenedorFicha"
        class="d-none animate__animated animate__fadeIn">
        <div class="row g-4 align-items-stretch">
          <div class="col-12 col-lg-4 d-flex flex-column">
            <div class="ficha-header flex-shrink-0">
              <h5 class="m-0">
                <i class="bi bi-info-circle"></i> Datos del Spool
              </h5>
            </div>
            <div class="ficha-body h-100 d-flex flex-column">
              <div class="flex-shrink-0">
                <div class="mb-4 text-center">
                  <h2 id="ficha-tag" class="text-primary fw-bold mb-0">-</h2>
                  <span id="ficha-status-badge"
                    class="badge bg-secondary mt-1">Consultando...</span>
                </div>

                <div class="row g-2 mb-3 border-bottom pb-3">
                  <div class="col-6">
                    <div class="ficha-label">Status Spool</div>
                    <div id="ficha-estado-texto" class="ficha-value small">
                      -
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="ficha-label">Status Fluor</div>
                    <div id="ficha-fluor" class="ficha-value small text-info">
                      -
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="ficha-label">RETIRA FLUOR</div>
                    <div id="ficha-pfluor" class="ficha-value small">-</div>
                  </div>
                  <div class="col-6">
                    <div class="ficha-label">Diámetro</div>
                    <div id="ficha-diametro" class="ficha-value small">-</div>
                  </div>
                  <div class="col-6">
                    <div class="ficha-label">Proveedor Caucho</div>
                    <div id="ficha-proveedor" class="ficha-value small">-</div>
                  </div>
                  <div class="col-6">
                    <div class="ficha-label">Espesor Caucho</div>
                    <div id="ficha-mmcaucho" class="ficha-value small">-</div>
                  </div>
                  <div class="col-6">
                    <div class="ficha-label">RAL</div>
                    <div id="ficha-color-ral" class="ficha-value small">-</div>
                  </div>
                  <div class="col-6">
                    <div class="ficha-label"># Liberación</div>
                    <div id="ficha-liberado" class="ficha-value small">-</div>
                  </div>
                </div>

                <div class="ficha-label">Última Etapa Registrada</div>
                <div id="ficha-etapa" class="ficha-value">-</div>

                <div class="ficha-label mt-3 border-bottom pb-2">
                  Historial de Movimientos
                </div>
              </div>

              <div
                id="timeline-container"
                class="flex-grow-1"
                style="overflow-y: auto; min-height: 150px; max-height: 400px">
                <small class="text-muted">Cargando historial...</small>
              </div>
            </div>
          </div>

          <div class="col-12 col-lg-8 d-flex flex-column">
            <div
              class="ficha-header d-flex justify-content-between align-items-center flex-shrink-0">
              <h5 class="m-0"><i class="bi bi-file-earmark-pdf"></i> Plano</h5>
              <a
                id="ficha-btn-abrir"
                href="#"
                target="_blank"
                class="btn btn-sm btn-outline-light d-none">
                <i class="bi bi-box-arrow-up-right"></i> Expandir
              </a>
            </div>
            <div
              class="ficha-body p-0 position-relative"
              style="min-height: 600px; flex-grow: 1">
              <div
                id="ficha-plano-loading"
                class="d-flex flex-column justify-content-center align-items-center h-100 text-muted"
                style="position: absolute; width: 100%">
                <div
                  class="spinner-border text-primary d-none"
                  id="spinner-plano"
                  role="status"></div>
                <span id="msg-plano">Seleccione un TAG para visualizar</span>
              </div>
              <iframe
                id="ficha-iframe"
                class="w-100 h-100 d-none"
                style="border: none"></iframe>
            </div>
          </div>
        </div>
      </div>
      <footer
        class="card shadow-sm fixed-bottom d-flex flex-column flex-sm-row"
        style="
          background: linear-gradient(90deg, #a0c0f6, #3c475a);
          color: white;
        ">
        <div>
          <p class="text-center py-1" style="font-size: 0.7em">
            &nbsp; &nbsp; Desarrollado por Marcos Castro Abarca
          </p>
        </div>
      </footer>
      <div class="modal fade" id="modalCamara" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Escanear Código</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"
                onclick="cerrarCamara()"></button>
            </div>
            <div class="modal-body p-0">
              <div id="reader" style="width: 100%;"></div>
            </div>
            <div class="modal-footer justify-content-center">
              <small class="text-muted">Apunte la cámara al código QR o de
                Barras</small>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"
      type="text/javascript"></script>

    <script>
      // --- 1. CONFIGURACIÓN ---
      const APP_ID = "59c4aa7f-9e37-4e66-af20-52250f9c4c07";
      const APP_KEY = "V2-157Vx-ltOIu-kTlqv-TYrU7-Gsowd-355md-nWdkC-k7s1N";
      const TABLE_NAME = "MasterBI";

      // Nombres de Columnas
      const COL_PLANO = "ID_PLANO";
      const COL_FLUOR = "STATUS FLUOR";
      const COL_474 = "RETIRA FLUOR";
      const COL_EX474 = "P. ATTEX";
      const COL_PROVEEDOR = "PROVEEDOR";
      const COL_DIAMETRO = "Ø";
      const COL_MMCAUCHO = "Espesor Caucho";
      const COL_COLOR = "RAL";
      const COL_NLIBERA ="N° LIB.";

// cache en memoria
let RAL_MAP = null;

async function loadRalJson(url = "./ral-colors.json") {
  if (RAL_MAP) return RAL_MAP;
  const res = await fetch(url, { cache: "force-cache" });
  if (!res.ok) throw new Error(`No se pudo cargar ${url} (${res.status})`);
  RAL_MAP = await res.json();
  return RAL_MAP;
}

function normalizeRal(value) {
  if (value == null) return null;

  const s = String(value).trim().toUpperCase();

  // caso especial
  if (s === "INOX") return "INOX";

  const m = s.match(/(\d{4})/);
  if (!m) return null;

  return `RAL ${m[1]}`;
}

function bestTextColor(hex) {
  // decide blanco/negro para legibilidad (simple, sin librerías)
  const h = hex.replace("#", "");
  if (h.length !== 6) return "#000";
  const r = parseInt(h.slice(0, 2), 16);
  const g = parseInt(h.slice(2, 4), 16);
  const b = parseInt(h.slice(4, 6), 16);
  const luminance = (0.299 * r + 0.587 * g + 0.114 * b);
  return luminance < 140 ? "#fff" : "#000";
}

function renderRalPill(containerEl, ralCode, data) {
  if (!ralCode) {
    containerEl.textContent = "-";
    return;
  }

  const hex = data?.hex || "#e9ecef";
  const name = data?.name || "RAL no encontrado";

  const badgeStyle = data?.css
    ? `
      background:${data.css};
      color:#111;
      border:1px solid rgba(0,0,0,.25);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.7);
    `
    : `
      background:${hex};
      color:${bestTextColor(hex)};
      border:1px solid rgba(0,0,0,.15);
    `;

  containerEl.innerHTML = `
    <span class="badge rounded-pill position-relative overflow-hidden"
          title="${ralCode} · ${name} · ${hex}"
          style="${badgeStyle}">
      ${ralCode}
    </span>
  `;
}

async function paintRalFromRow(row) {
  const el = document.getElementById("ficha-color-ral");
  if (!el) return;

  const ral = normalizeRal(row?.[COL_COLOR]); // "RAL 6029" o null
  if (!ral) {
    el.textContent = row?.[COL_COLOR] || "-";
    return;
  }

  try {
    const map = await loadRalJson("./ral-colors.json");
    const data = map[ral]; // {hex,rgb,name} o undefined
    renderRalPill(el, ral, data);
  } catch (err) {
    console.error(err);
    // si falla el JSON, al menos muestra el código
    el.textContent = ral;
  }
}


      // Lista SIN FECHA TRN
      const COLUMNAS_FECHAS_ALL = [
        "F.Emision Plano",
        "F.Aprobacion Plano",
        "F. Entrada Taller",
        "F.Salida Taller",
        "F.Ingreso Granallado",
        "F.Salida Granallado",
        "F.Ingreso Caucho",
        "F.Salida Caucho",
        "F.Salida Engomado",
        "F.Ingreso Vulcanizado",
        "F.Salida Vulcanizado",
        "F.Ingreso Term. Caucho",
        "F.Salida Term. Caucho",
        "F.Envio a Pint",
        "F.Salida Pintura",
        "F.Liberado",
        "F.Despacho",
        "F. ELIMINADO",
        "F. HOLD",
      ];

      let resultadosGlobales = [];

      // --- 2. UTILIDADES DE FECHA ROBUSTA (CORREGIDO PARA ENTRADA US) ---
      function parseDateFlexible(val) {
        if (!val) return null;
        if (typeof val === "number") return new Date(1899, 11, 30 + val);

        let str = String(val).trim();
        if (str.includes("T")) str = str.split("T")[0];
        if (str.includes(" ")) str = str.split(" ")[0];

        // Caso ISO YYYY-MM-DD
        if (/^\d{4}-\d{2}-\d{2}$/.test(str)) {
          const [y, m, d] = str.split("-").map(Number);
          return new Date(y, m - 1, d);
        }

        // Caso Ambiguo MM/DD/YYYY vs DD/MM/YYYY
        // Como AppSheet está enviando formato US (causando años 2026/2027), invertimos la lógica:
        // Asumimos: 1er numero = MES, 2do numero = DIA
        const partes = str.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
        if (partes) {
          const p1 = Number(partes[1]);
          const p2 = Number(partes[2]);
          const anio = Number(partes[3]);

          // Si el primer número > 12, es imposible que sea mes -> Entonces es DD/MM/YYYY (Latino)
          if (p1 > 12) {
            return new Date(anio, p2 - 1, p1);
          }

          // En caso contrario, asumimos formato US (MM/DD/YYYY) para corregir el error del año 2026/27
          return new Date(anio, p1 - 1, p2);
        }

        return null;
      }

      // Formateador visual seguro (siempre muestra DD-MM-YYYY)
      function formatDateManual(date) {
        if (!date) return "-";
        const d = String(date.getDate()).padStart(2, "0");
        const m = String(date.getMonth() + 1).padStart(2, "0");
        const y = date.getFullYear();
        return `${d}-${m}-${y}`;
      }

      // --- 3. CONEXIÓN API ---
      async function callAppSheet(selectorStr) {
        const url = `https://api.appsheet.com/api/v2/apps/${APP_ID}/tables/${TABLE_NAME}/Action`;
        const body = {
          Action: "Find",
          Properties: {
            Locale: "es-CL",
            Timezone: "America/Santiago",
            Selector: selectorStr,
          },
          Rows: [],
        };

        const response = await fetch(url, {
          method: "POST",
          headers: {
            ApplicationAccessKey: APP_KEY,
            "Content-Type": "application/json",
          },
          body: JSON.stringify(body),
        });

        if (!response.ok) throw new Error(`Error API: ${response.status}`);
        return await response.json();
      }

      // --- 4. BUSQUEDA (CON LIMPIEZA AUTOMÁTICA) ---
      function buscarTags() {
        const txt = document
          .getElementById("txtBuscar")
          .value.trim()
          .toUpperCase();
        const resDiv = document.getElementById("resFicha");
        const contenedor = document.getElementById("contenedorFicha");

        // 1. LIMPIEZA INMEDIATA: Ocultar ficha anterior
        contenedor.classList.add("d-none");

        // Limpiar campos visuales por si acaso se muestra antes de cargar
        document.getElementById("ficha-tag").textContent = "-";
        document.getElementById("ficha-status-badge").textContent = "...";
        document.getElementById("ficha-status-badge").className =
          "badge bg-secondary mt-1";

        if (!txt) {
          resDiv.style.display = "none";
          return;
        }

        resDiv.innerHTML =
          '<div class="list-group-item">Buscando en BBDD...</div>';
        resDiv.style.display = "block";

        const selector = `Filter(${TABLE_NAME}, CONTAINS([TAG SPOOL], '${txt}'))`;

        callAppSheet(selector)
          .then((rows) => {
            if (!rows || rows.length === 0) {
              resDiv.innerHTML =
                '<div class="list-group-item text-danger">No se encontraron coincidencias.</div>';
              return;
            }
            resultadosGlobales = rows;
            let h = "";
            rows.slice(0, 75).forEach((row, index) => {
              const tag = row["TAG SPOOL"] || "S/N";
              h += `<a href="#" class="list-group-item list-group-item-action py-2" onclick="verFichaAppSheet(${index}); return false;">
                <div class="d-flex w-100 justify-content-between align-items-center">
                  <h6 class="mb-0 fw-bold text-primary"><i class="bi bi-tag-fill"></i> ${tag}</h6>
                  <small class="text-muted"><i class="bi bi-chevron-right"></i></small>
                </div>
              </a>`;
            });
            resDiv.innerHTML = h;
          })
          .catch((e) => {
            console.error(e);
            resDiv.innerHTML = `<div class="list-group-item text-danger small">Error de conexión.</div>`;
          });
      }

      // --- 5. RENDERIZADO FICHA ---
      function verFichaAppSheet(index) {
        const row = resultadosGlobales[index];
        if (!row) return;

        document.getElementById("resFicha").style.display = "none";
        document.getElementById("txtBuscar").value = row["TAG SPOOL"];
        document.getElementById("contenedorFicha").classList.remove("d-none");

        document.getElementById("ficha-tag").textContent = row["TAG SPOOL"];

        const estado = row["STATUS SPOOL"] || "SIN STATUS";
        const stUpper = estado.toUpperCase();
        const badge = document.getElementById("ficha-status-badge");
        let colorClass = "bg-secondary";

        if (stUpper.includes("LIBERADO") || stUpper.includes("DESPACHADO"))
          colorClass = "bg-success";
        else if (stUpper.includes("PINTURA") || stUpper.includes("FABRICACION"))
          colorClass = "bg-primary";
        else if (stUpper.includes("HOLD") || stUpper.includes("ELIMINADO"))
          colorClass = "bg-danger";
        else if (stUpper.includes("PENDIENTE"))
          colorClass = "bg-warning text-dark";

        badge.textContent = estado;
        badge.className = `badge ${colorClass} mt-1`;
        document.getElementById("ficha-estado-texto").textContent = estado;
        document.getElementById("ficha-fluor").textContent =
          row[COL_FLUOR] || "-";

        document.getElementById("ficha-pfluor").textContent =
          row[COL_474] || "-";
        //document.getElementById("ficha-pattex").textContent =
        //  row[COL_EX474] || "-";
        document.getElementById("ficha-proveedor").textContent =
          row[COL_PROVEEDOR] || "-";
        document.getElementById("ficha-diametro").textContent =
          row[COL_DIAMETRO] || "-";  
         document.getElementById("ficha-mmcaucho").textContent =
          row[COL_MMCAUCHO] || "-";    
          document.getElementById("ficha-liberado").textContent =
          row[COL_NLIBERA] || "-";
          paintRalFromRow(row);


        renderTimeline(row);
        renderPlano(row[COL_PLANO]);
      }

      // --- 6. TIMELINE LOGIC ---
      function renderTimeline(row) {
        const container = document.getElementById("timeline-container");
        container.innerHTML = "";

        let events = [];
        COLUMNAS_FECHAS_ALL.forEach((col) => {
          const val = row[col];
          const d = parseDateFlexible(val);
          if (d) {
            events.push({ date: d, name: col });
          }
        });

        // Ordenar cronológicamente
        events.sort((a, b) => a.date - b.date);

        if (events.length === 0) {
          container.innerHTML =
            '<div class="timeline-empty">Sin movimientos registrados.</div>';
          document.getElementById("ficha-etapa").textContent =
            "Sin movimientos";
          return;
        }

        let html = '<div class="timeline">';
        events.forEach((ev) => {
          const dateStr = formatDateManual(ev.date);
          html += `
              <div class="timeline-item">
                  <div class="timeline-dot"></div>
                  <div class="timeline-date">${dateStr}</div>
                  <div class="timeline-content">${ev.name}</div>
              </div>
          `;
        });
        html += "</div>";
        container.innerHTML = html;

        const last = events[events.length - 1];
        const lastDateStr = formatDateManual(last.date);
        document.getElementById(
          "ficha-etapa"
        ).innerHTML = `${last.name} <br> <small class='text-muted'>${lastDateStr}</small>`;
      }

      // --- 7. PLANO LOGIC ---
      function renderPlano(archivoVal) {
        const iframe = document.getElementById("ficha-iframe");
        const loader = document.getElementById("ficha-plano-loading");
        const spinner = document.getElementById("spinner-plano");
        const msg = document.getElementById("msg-plano");
        const btnAbrir = document.getElementById("ficha-btn-abrir");

        iframe.classList.add("d-none");
        btnAbrir.classList.add("d-none");
        if (spinner) spinner.classList.add("d-none");

        if (archivoVal) {
          msg.textContent = "Cargando visualización...";
          if (spinner) spinner.classList.remove("d-none");

          let urlFinal = archivoVal;
          if (!archivoVal.startsWith("http")) {
            urlFinal = `https://drive.google.com/file/d/${archivoVal}/preview`;
          } else if (urlFinal.includes("/view")) {
            urlFinal = urlFinal.replace("/view", "/preview");
          }

          iframe.src = urlFinal;
          iframe.onload = () => {
            if (spinner) spinner.classList.add("d-none");
            loader.classList.add("d-none");
            iframe.classList.remove("d-none");
          };

          const urlView = urlFinal.replace("/preview", "/view");
          btnAbrir.href = urlView;
          btnAbrir.classList.remove("d-none");
        } else {
          msg.textContent = "Plano no disponible";
          loader.classList.remove("d-none");
        }
      }
      // --- FUNCIÓN PARA LIMPIAR BÚSQUEDA ---
      function limpiarBusqueda() {
        // 1. Borrar texto del input
        const input = document.getElementById("txtBuscar");
        input.value = "";
        
        // 2. Ocultar lista de resultados
        document.getElementById("resFicha").style.display = "none";
        
        // 3. Ocultar el contenedor de la ficha técnica
        document.getElementById("contenedorFicha").classList.add("d-none");
        
        // 4. Devolver el foco al input para escribir de nuevo
        input.focus();
      }
      // --- 8. AUTO-EJECTUAR SI VIENE DE QR ---
      document.addEventListener("DOMContentLoaded", function() {
          // Leer parámetros de la URL
          const params = new URLSearchParams(window.location.search);
          const tagUrl = params.get("tag"); // Busca ?tag=VALOR

          if (tagUrl) {
              // Si existe el tag en la URL, lo ponemos en el input y buscamos
              const input = document.getElementById("txtBuscar");
              input.value = tagUrl;
              buscarTags(); // Ejecutamos la búsqueda automáticamente
          } else {
              // Si no hay tag, ponemos el foco en el input para esperar escaneo manual o teclado
              document.getElementById("txtBuscar").focus();
          }
      });
      
      // --- LÓGICA DE CÁMARA ROBUSTA PARA IPHONE ---
    let html5QrcodeScanner = null;
    const modalElement = document.getElementById('modalCamara');

    // 1. EVENTO: Cuando el modal termina de abrirse (SHOWN)
    modalElement.addEventListener('shown.bs.modal', function () {
        // Crear instancia nueva cada vez para asegurar limpieza
        if (html5QrcodeScanner === null) {
            html5QrcodeScanner = new Html5Qrcode("reader");
        }

        const config = {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0,
            formatsToSupport: [ 
                Html5QrcodeSupportedFormats.QR_CODE, 
                Html5QrcodeSupportedFormats.CODE_128 
            ]
        };

        // Iniciar cámara trasera
        html5QrcodeScanner.start(
            { facingMode: "environment" },
            config,
            onScanSuccess,
            (errorMessage) => { 
                // Error de lectura (no detecta código), ignorar para no saturar log
            }
        ).catch(err => {
            console.error("Error crítico al iniciar cámara:", err);
            document.getElementById('reader').innerHTML = 
                '<div class="alert alert-danger">Error: Permiso de cámara denegado o no disponible.</div>';
        });
    });

    // 2. EVENTO: Cuando el modal se va a cerrar (HIDE)
    modalElement.addEventListener('hide.bs.modal', function () {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                html5QrcodeScanner.clear();
                html5QrcodeScanner = null; // Destruir instancia para liberar memoria iPhone
            }).catch(err => {
                console.error("Error al detener cámara:", err);
                // Forzar limpieza aunque falle el stop
                html5QrcodeScanner = null;
                document.getElementById('reader').innerHTML = ""; 
            });
        }
    });

    // 3. EXITO DE ESCANEO
    function onScanSuccess(decodedText, decodedResult) {
        console.log(`Código escaneado: ${decodedText}`);
        
        // Poner valor en input
        const input = document.getElementById('txtBuscar');
        input.value = decodedText;

        // Cerrar modal (esto disparará automáticamente el evento 'hide.bs.modal' de arriba)
        const modalInstance = bootstrap.Modal.getInstance(modalElement);
        modalInstance.hide();

        // Ejecutar búsqueda (pequeño delay para dar tiempo a la UI)
        setTimeout(() => {
            buscarTags();
        }, 300);
    }

    </script>
  </body>
</html>
