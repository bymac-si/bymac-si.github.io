<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Consulta Spools · IMMA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />

    <style>
      :root {
        --bymac-primary: #1a2b48;
        --bymac-bg: #f5f7fb;
      }
      body {
        font-family: system-ui, sans-serif;
        background-color: var(--bymac-bg);
        padding: 20px;
      }
      .card {
        border-radius: 10px;
        border: 1px solid #e1e4ee;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      }
      .ficha-header {
        background-color: var(--bymac-primary);
        color: white;
        padding: 12px 20px;
        border-radius: 8px 8px 0 0;
      }
      .ficha-body {
        background-color: white;
        border: 1px solid #dee2e6;
        border-top: none;
        border-radius: 0 0 8px 8px;
        padding: 25px;
      }
      .ficha-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
        margin-bottom: 4px;
      }
      .ficha-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: #212529;
        margin-bottom: 18px;
        border-bottom: 1px solid #f0f0f0;
        padding-bottom: 5px;
      }
    </style>
  </head>

  <body>
    <main class="container">
      <div class="card mb-3 shadow-sm" style="background: linear-gradient(90deg, #a0c0f6, #3c475a); color: white;">
        <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-center py-2">
          <h1 class="m-0 fs-4">
            <img src="https://bymac-si.github.io/img/logo_imma.png" alt="IMMA" style="width: 80px; margin-right: 10px" />Soluciones en Piping
          </h1>
          <div class="text-end small fs-5">Panel MasterBI Fluor</div>
        </div>
      </div>
      
      <div class="text-center mb-5">
        <h2 class="fw-bold" style="color: var(--bymac-primary);">
            <i class="bi bi-search"></i> Consulta de Spools
        </h2>
        <p class="text-muted">Visualización de estado y planos en tiempo real</p>
      </div>

      <div class="row justify-content-center mb-4">
        <div class="col-12 col-md-8">
            <div class="input-group input-group-lg shadow-sm">
                <span class="input-group-text bg-white border-0"><i class="bi bi-search text-muted"></i></span>
                <input type="text" id="txtBuscar" class="form-control border-0" placeholder="Ingrese TAG (Ej: 29044-005)..." onkeyup="if(event.key==='Enter') buscarTags()">
                <button class="btn btn-primary px-4" onclick="buscarTags()">Consultar</button>
            </div>
            <div id="resFicha" class="list-group mt-2 shadow-sm" style="display:none;"></div>
        </div>
      </div>

      <div id="contenedorFicha" class="d-none animate__animated animate__fadeIn">
        <div class="row g-4">
            
            <div class="col-12 col-lg-4">
                <div class="ficha-header">
                    <h5 class="m-0"><i class="bi bi-info-circle"></i> Datos del Spool</h5>
                </div>
                <div class="ficha-body h-100">
                    <div class="mb-4 text-center">
                        <h2 id="ficha-tag" class="text-primary fw-bold mb-0">-</h2>
                        <span id="ficha-status-badge" class="badge bg-secondary mt-1">Consultando...</span>
                    </div>

                    <div class="ficha-label">Última Etapa Registrada</div>
                    <div id="ficha-etapa" class="ficha-value">-</div>

                    <div class="ficha-label">Fecha de Movimiento</div>
                    <div id="ficha-fecha" class="ficha-value">-</div>

                    <div class="ficha-label">Estado General</div>
                    <div id="ficha-estado-texto" class="ficha-value">-</div>

                    <div class="alert alert-info border mt-4 small">
                        <i class="bi bi-shield-lock"></i> Vista de solo lectura.
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-8">
                <div class="ficha-header d-flex justify-content-between align-items-center">
                    <h5 class="m-0"><i class="bi bi-file-earmark-pdf"></i> Plano</h5>
                    <a id="ficha-btn-abrir" href="#" target="_blank" class="btn btn-sm btn-outline-light d-none">
                        <i class="bi bi-box-arrow-up-right"></i> Expandir
                    </a>
                </div>
                <div class="ficha-body p-0" style="height: 600px; background: #eee; position: relative;">
                    
                    <div id="ficha-plano-loading" class="d-flex flex-column justify-content-center align-items-center h-100 text-muted">
                        <i class="bi bi-file-pdf fs-1 mb-2"></i>
                        <span>Seleccione un TAG para visualizar</span>
                    </div>
                    
                    <iframe id="ficha-iframe" class="w-100 h-100 d-none" style="border:none;"></iframe>
                    
                    <img id="ficha-img-fallback" src="https://bymac-si.github.io/img/not-found.png" class="d-none w-100 h-100" style="object-fit: contain;">
                </div>
            </div>
        </div>
      </div>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
  // --- 1. CONFIGURACIÓN ---
  const APP_ID = "59c4aa7f-9e37-4e66-af20-52250f9c4c07";
  const APP_KEY = "V2-157Vx-ltOIu-kTlqv-TYrU7-Gsowd-355md-nWdkC-k7s1N";
  const TABLE_NAME = "MasterBI"; 
  const COL_PLANO = "ID_PLANO"; // O "ID_PLANO" si ya hiciste la indexación

  // Variable para guardar los datos temporalmente
  let resultadosGlobales = [];

  // --- 2. FUNCIÓN DE CONEXIÓN API ---
  async function callAppSheet(selectorStr) {
    const url = `https://api.appsheet.com/api/v2/apps/${APP_ID}/tables/${TABLE_NAME}/Action`;
    const body = {
      "Action": "Find",
      "Properties": {
        "Locale": "es-CL",
        "Timezone": "America/Santiago",
        "Selector": selectorStr
      },
      "Rows": []
    };

    const response = await fetch(url, {
      method: "POST",
      headers: {
        "ApplicationAccessKey": APP_KEY,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(body)
    });

    if (!response.ok) throw new Error(`Error API: ${response.status}`);
    return await response.json();
  }

  // --- 3. LÓGICA DE BÚSQUEDA ---
  function buscarTags() {
    const txt = document.getElementById("txtBuscar").value.trim().toUpperCase();
    const resDiv = document.getElementById("resFicha");

    if (!txt) { resDiv.style.display = 'none'; return; }

    resDiv.innerHTML = '<div class="list-group-item">Buscando en AppSheet...</div>';
    resDiv.style.display = 'block';

    const selector = `Filter(${TABLE_NAME}, CONTAINS([TAG SPOOL], '${txt}'))`;

    callAppSheet(selector).then(rows => {
      if (!rows || rows.length === 0) {
        resDiv.innerHTML = '<div class="list-group-item text-danger">No se encontraron coincidencias.</div>';
        return;
      }

      // GUARDAMOS LOS RESULTADOS EN LA VARIABLE GLOBAL
      resultadosGlobales = rows;

      let h = '';
      // Limitamos a 10 resultados
      rows.slice(0, 10).forEach((row, index) => {
        const tag = row['TAG SPOOL'] || "S/N";
        
        // CORRECCIÓN: Ahora pasamos solo el ÍNDICE (0, 1, 2...) en lugar de todo el objeto
        h += `<a href="#" class="list-group-item list-group-item-action py-3" onclick="verFichaAppSheet(${index}); return false;">
                <div class="d-flex w-100 justify-content-between align-items-center">
                  <h6 class="mb-0 fw-bold text-primary"><i class="bi bi-tag-fill"></i> ${tag}</h6>
                  <small class="text-muted"><i class="bi bi-chevron-right"></i></small>
                </div>
              </a>`;
      });
      resDiv.innerHTML = h;

    }).catch(e => {
      console.error(e);
      let msg = "Error de conexión.";
      if(e.message && e.message.includes("Failed to fetch")) msg = "Error CORS: Bloqueo de seguridad del navegador.";
      resDiv.innerHTML = `<div class="list-group-item text-danger small">${msg}</div>`;
    });
  }

  // --- 4. VISUALIZACIÓN ---
  function verFichaAppSheet(index) {
    // RECUPERAMOS EL DATO USANDO EL ÍNDICE
    const row = resultadosGlobales[index];

    if (!row) {
        console.error("Error: No se encontró la fila en memoria");
        return;
    }
    
    // UI Setup
    document.getElementById("resFicha").style.display = 'none';
    document.getElementById("txtBuscar").value = row['TAG SPOOL'];
    document.getElementById("contenedorFicha").classList.remove("d-none");

    // -- A. DATOS PRINCIPALES --
    document.getElementById("ficha-tag").textContent = row['TAG SPOOL'];

    const estado = row['STATUS SPOOL'] || "SIN STATUS";
    const badge = document.getElementById("ficha-status-badge");
    let colorClass = "bg-secondary";

    const stUpper = estado.toUpperCase();
    if(stUpper.includes("LIBERADO") || stUpper.includes("DESPACHADO")) colorClass = "bg-success";
    else if(stUpper.includes("PINTURA") || stUpper.includes("FABRICACION")) colorClass = "bg-primary";
    else if(stUpper.includes("HOLD") || stUpper.includes("ELIMINADO")) colorClass = "bg-danger";
    else if(stUpper.includes("PENDIENTE")) colorClass = "bg-warning text-dark";

    badge.textContent = estado;
    badge.className = `badge ${colorClass} mt-2`;
    document.getElementById("ficha-estado-texto").textContent = estado;

    document.getElementById("ficha-etapa").textContent = row['OBSERVACIONES'] || row['Area'] || "Sin observaciones";

    let fecha = row['Fecha Terminado'] || row['F.Liberado'] || row['Fecha Flúor'] || "-";
    if(fecha && fecha.includes("T")) fecha = fecha.split("T")[0]; 
    document.getElementById("ficha-fecha").textContent = fecha;

    // -- B. PLANO --
    const archivoVal = row[COL_PLANO] || ""; 
    const iframe = document.getElementById("ficha-iframe");
    const loader = document.getElementById("ficha-plano-loading");
    const fallback = document.getElementById("ficha-img-fallback");
    const btnAbrir = document.getElementById("ficha-btn-abrir");

    iframe.classList.add("d-none");
    loader.classList.remove("d-none");
    fallback.classList.add("d-none");
    btnAbrir.classList.add("d-none");

    if (archivoVal) {
      let urlFinal = archivoVal;
      // Si es ID de Drive (formato corto sin http)
      if (!archivoVal.startsWith("http")) {
         // Asumimos que es un ID de Drive si no tiene http
         urlFinal = `https://drive.google.com/file/d/${archivoVal}/preview`;
      } else if(urlFinal.includes("drive.google.com/file/d/")) {
          urlFinal = urlFinal.replace("/view", "/preview");
      }

      iframe.src = urlFinal;
      iframe.onload = () => {
          loader.classList.add("d-none");
          iframe.classList.remove("d-none");
      };
      
      const urlView = urlFinal.replace("/preview", "/view");
      btnAbrir.href = urlView;
      btnAbrir.classList.remove("d-none");
      
    } else {
      loader.classList.add("d-none");
      fallback.classList.remove("d-none");
    }
  }
</script>
  </body>
</html>