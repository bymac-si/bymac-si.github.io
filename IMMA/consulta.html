<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Consulta Spools · IMMA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />

    <style>
      :root {
        --bymac-primary: #1a2b48;
        --bymac-bg: #f5f7fb;
      }
      body {
        font-family: system-ui, sans-serif;
        background-color: var(--bymac-bg);
        padding: 20px;
      }
      .card {
        border-radius: 10px;
        border: 1px solid #e1e4ee;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      }
      .ficha-header {
        background-color: var(--bymac-primary);
        color: white;
        padding: 12px 20px;
        border-radius: 8px 8px 0 0;
      }
      .ficha-body {
        background-color: white;
        border: 1px solid #dee2e6;
        border-top: none;
        border-radius: 0 0 8px 8px;
        padding: 25px;
      }
      .ficha-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
        margin-bottom: 4px;
      }
      .ficha-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: #212529;
        margin-bottom: 18px;
        border-bottom: 1px solid #f0f0f0;
        padding-bottom: 5px;
      }
    </style>
  </head>

  <body>
    <main class="container">
      <div class="card mb-3 shadow-sm" style="background: linear-gradient(90deg, #a0c0f6, #3c475a); color: white;">
        <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-center py-2">
          <h1 class="m-0 fs-4">
            <img src="https://bymac-si.github.io/img/logo_imma.png" alt="IMMA" style="width: 80px; margin-right: 10px" />Soluciones en Piping
          </h1>
          <div class="text-end small fs-5">Panel MasterBI Fluor</div>
        </div>
      </div>
      
      <div class="text-center mb-5">
        <h2 class="fw-bold" style="color: var(--bymac-primary);">
            <i class="bi bi-search"></i> Consulta de Spools
        </h2>
        <p class="text-muted">Visualización de estado y planos en tiempo real</p>
      </div>

      <div class="row justify-content-center mb-4">
        <div class="col-12 col-md-8">
            <div class="input-group input-group-lg shadow-sm">
                <span class="input-group-text bg-white border-0"><i class="bi bi-search text-muted"></i></span>
                <input type="text" id="txtBuscar" class="form-control border-0" placeholder="Ingrese TAG (Ej: 29044-005)..." onkeyup="if(event.key==='Enter') buscarTags()">
                <button class="btn btn-primary px-4" onclick="buscarTags()">Consultar</button>
            </div>
            <div id="resFicha" class="list-group mt-2 shadow-sm" style="display:none;"></div>
        </div>
      </div>

      <div id="contenedorFicha" class="d-none animate__animated animate__fadeIn">
        <div class="row g-4">
            
            <div class="col-12 col-lg-4">
                <div class="ficha-header">
                    <h5 class="m-0"><i class="bi bi-info-circle"></i> Datos del Spool</h5>
                </div>
                <div class="ficha-body h-100">
                    <div class="mb-4 text-center">
                        <h2 id="ficha-tag" class="text-primary fw-bold mb-0">-</h2>
                        <span id="ficha-status-badge" class="badge bg-secondary mt-2">Cargando...</span>
                    </div>

                    <div class="ficha-label">Última Etapa Registrada</div>
                    <div id="ficha-etapa" class="ficha-value">-</div>

                    <div class="ficha-label">Fecha de Movimiento</div>
                    <div id="ficha-fecha" class="ficha-value">-</div>

                    <div class="ficha-label">Estado General</div>
                    <div id="ficha-estado-texto" class="ficha-value">-</div>

                    <div class="alert alert-info border mt-4 small">
                        <i class="bi bi-shield-lock"></i> Vista de solo lectura.
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-8">
                <div class="ficha-header d-flex justify-content-between align-items-center">
                    <h5 class="m-0"><i class="bi bi-file-earmark-pdf"></i> Plano</h5>
                    <a id="ficha-btn-abrir" href="#" target="_blank" class="btn btn-sm btn-outline-light d-none">
                        <i class="bi bi-box-arrow-up-right"></i> Expandir
                    </a>
                </div>
                <div class="ficha-body p-0" style="height: 600px; background: #eee; position: relative;">
                    
                    <div id="ficha-plano-loading" class="d-flex flex-column justify-content-center align-items-center h-100 text-muted">
                        <i class="bi bi-file-pdf fs-1 mb-2"></i>
                        <span>Seleccione un TAG para visualizar</span>
                    </div>
                    
                    <iframe id="ficha-iframe" class="w-100 h-100 d-none" style="border:none;"></iframe>
                    
                    <img id="ficha-img-fallback" src="https://bymac-si.github.io/img/not-found.png" class="d-none w-100 h-100" style="object-fit: contain;">
                </div>
            </div>
        </div>
      </div>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // ⚠️ URL ORIGINAL MANTENIDA
      const API_URL = "https://script.google.com/macros/s/AKfycbz9W1UPXquuIB0DIV2fGJS8nnKsj5tRAHaBh-3ufNMXPE-5aE9P6NmyY7O3aCrz6vuP/exec";

      function callApi(accion, data = {}) {
        const p = new URLSearchParams();
        p.append("accion", accion);
        Object.keys(data).forEach((k) => {
          if (data[k]) p.append(k, typeof data[k] === "object" ? JSON.stringify(data[k]) : String(data[k]));
        });
        return fetch(API_URL, { method: "POST", body: p }).then((r) => {
          if (!r.ok) throw new Error(r.status);
          return r.json();
        });
      }

      function buscarTags() {
          const txt = document.getElementById("txtBuscar").value.trim();
          const resDiv = document.getElementById("resFicha");
          
          if (!txt) { resDiv.style.display = 'none'; return; }
          
          resDiv.innerHTML = '<div class="list-group-item">Buscando...</div>';
          resDiv.style.display = 'block';

          callApi("buscarTag", { texto: txt }).then(r => {
             if (!r.ok || !r.data.length) {
                 resDiv.innerHTML = '<div class="list-group-item text-danger">No se encontraron coincidencias.</div>';
                 return;
             }
             let h = '';
             r.data.forEach(i => {
                 h += `<a href="#" class="list-group-item list-group-item-action py-3" onclick="verFicha('${i.fila}', '${i.tag}'); return false;">
                         <div class="d-flex w-100 justify-content-between align-items-center">
                           <h6 class="mb-0 fw-bold text-primary"><i class="bi bi-tag-fill"></i> ${i.tag}</h6>
                           <small class="text-muted"><i class="bi bi-chevron-right"></i></small>
                         </div>
                       </a>`;
             });
             resDiv.innerHTML = h;
          }).catch(e => {
              resDiv.innerHTML = '<div class="list-group-item text-danger">Error de conexión.</div>';
          });
      }

      function verFicha(fila, tag) {
          // 1. CONFIGURACIÓN INICIAL DE LA UI (RESET)
          document.getElementById("resFicha").style.display = 'none';
          document.getElementById("txtBuscar").value = tag;
          document.getElementById("contenedorFicha").classList.remove("d-none");
          
          // 2. LIMPIEZA DE DATOS (Previo a la carga)
          // Esto asegura que el usuario no vea datos del tag anterior
          document.getElementById("ficha-tag").textContent = tag;
          
          // Textos a spinners
          document.getElementById("ficha-etapa").innerHTML = 
        '<div class="spinner-border spinner-border-sm text-secondary" role="status"></div> <span class="text-muted fst-italic small">Consultando...</span>';
          document.getElementById("ficha-fecha").innerHTML = 
        '<div class="spinner-border spinner-border-sm text-secondary" role="status"></div> <span class="text-muted fst-italic small">Consultando...</span>';
          document.getElementById("ficha-estado-texto").innerHTML = 
        '<div class="spinner-border spinner-border-sm text-secondary" role="status"></div> <span class="text-muted fst-italic small">Consultando...</span>';
          
          // Badge a estado 'Cargando'
          const badge = document.getElementById("ficha-status-badge");
          badge.textContent = "Cargando...";
          badge.className = "badge bg-secondary mt-2";
          
          // 3. LIMPIEZA DE PLANO
          const iframe = document.getElementById("ficha-iframe");
          const loader = document.getElementById("ficha-plano-loading");
          const fallback = document.getElementById("ficha-img-fallback");
          const btnAbrir = document.getElementById("ficha-btn-abrir");
          
          iframe.classList.add("d-none");
          iframe.src = ""; // IMPORTANTE: Vaciar el source para evitar glitches visuales
          
          fallback.classList.add("d-none");
          btnAbrir.classList.add("d-none");
          
          // Mostrar loader
          loader.classList.remove("d-none");
          loader.innerHTML = '<div class="spinner-border text-primary" role="status"></div><div class="mt-2">Obteniendo datos...</div>';

          // 4. LLAMADAS API
          Promise.all([
              callApi("estadoTag", { fila: fila }),
              callApi("ultimaEtapa", { fila: fila }),
              callApi("vistaPlano", { tag: tag })
          ]).then(results => {
              const [resEstado, resEtapa, resPlano] = results;

              // A. Renderizar Estado
              const dEst = resEstado.data || {};
              let colorClass = "bg-secondary";
              if(dEst.color === 'green') colorClass = "bg-success";
              if(dEst.color === 'blue') colorClass = "bg-primary";
              if(dEst.color === 'red') colorClass = "bg-danger";
              
              badge.textContent = dEst.estado || "SIN INICIO";
              badge.className = `badge ${colorClass} mt-2`;
              document.getElementById("ficha-estado-texto").textContent = dEst.estado || "-";

              // B. Renderizar Etapa
              const dEtp = resEtapa.data || {};
              let ft = dEtp.fechaTexto;
              if (ft) ft = ft.split("-").reverse().join("/");
              document.getElementById("ficha-etapa").textContent = dEtp.ultimaColumna || "Sin registros";
              document.getElementById("ficha-fecha").textContent = ft || "-";

              // C. Renderizar Plano
              const dPlano = resPlano.data || resPlano;
              
              if (dPlano.ok && dPlano.url) {
                  // Asignamos URL
                  iframe.src = dPlano.url;
                  
                  // Manejamos la carga para ocultar el loader
                  iframe.onload = () => {
                      loader.classList.add("d-none");
                      iframe.classList.remove("d-none");
                  };
                  
                  // Botón externo
                  const fullUrl = dPlano.url.replace("/preview", "/view");
                  btnAbrir.href = fullUrl;
                  btnAbrir.classList.remove("d-none");
              } else {
                  // Si no hay plano
                  loader.classList.add("d-none");
                  fallback.classList.remove("d-none");
                  // Aseguramos que el iframe siga oculto
                  iframe.classList.add("d-none");
              }
          }).catch(error => {
              console.error("Error cargando ficha:", error);
              // Manejo de error visual
              loader.innerHTML = '<span class="text-danger">Error al cargar datos</span>';
          });
      }
    </script>
  </body>
</html>