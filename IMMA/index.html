<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Panel MasterBI · Tag Spool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bymac-primary: #1a2b48;
      --bymac-accent: #e74e35;
      --bymac-bg: #f5f7fb;
      --green-ok: #2ea043;
      --blue-proceso: #1a2b48;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 14px;
      padding: 8px;
      background-color: var(--bymac-bg);
    }

    @media (min-width: 768px) {
      body {
        padding: 16px;
      }
    }

    .bymac-header {
      background: linear-gradient(90deg, #a0c0f6, #3c475a);
      color: #fff;
      border-radius: 10px;
      padding: 14px 18px;
      margin-bottom: 12px;
      box-shadow: 0 12px 30px rgba(10, 20, 40, 0.18);
      text-shadow: 2px 2px 0px #555;
    }

    .bymac-header h1 {
      margin: 0;
      font-size: 22px;
    }

    .card {
      border-radius: 10px;
      border: 1px solid #e1e4ee;
    }

    .tag-seleccionado {
      font-weight: bold;
      color: #0b5394;
      word-break: break-word;
    }

    .plano-frame {
      width: 100%;
      min-height: clamp(200px, 40vh, 420px);
      border-radius: 8px;
      border: 1px solid #e1e4ee;
      background: #eee;
    }
    /* Tabs */

    .tab {
      font-size: 14px; color: #1a2b48; font-weight: 600;
    }
    /* KPI cards */
    .kpi-box {
      padding: 12px;
      border-radius: 8px;
      background: #fff;
      border: 1px solid #e1e4ee;
      text-align: center;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .kpi-title { font-size: 13px; color: #666; font-weight: 600; margin-bottom: 4px; }
    .kpi-value { font-size: 24px; font-weight: 800; }
    
    .kpi-green { color: var(--green-ok); }
    .kpi-blue { color: var(--blue-proceso); }
    .kpi-yellow { color: #b58900; }
    .kpi-red { color: #d93025; }
    .kpi-muted { color: #888; }

    /* Estados */
    .estado-green { color: var(--green-ok); font-weight: bold; }
    .estado-blue { color: var(--blue-proceso); font-weight: bold; }
    .estado-yellow { color: #b58900; font-weight: bold; }
    .estado-red { color: #d93025; font-weight: bold; }
    .estado-gray { color: #666; font-weight: bold; }

    /* Mensajes */
    .msg {
      font-size: 13px; padding: 4px 6px; border-radius: 6px; display: inline-block;
      margin-top: 4px; font-weight: 600;
    }
    .msg.ok { color: #0f5132; background-color: #d1e7dd; border: 1px solid #badbcc; }
    .msg.error { color: #842029; background-color: #f8d7da; border: 1px solid #f5c2c7; }
    .msg.loading { color: #856404; background-color: #fff3cd; border: 1px solid #ffeeba; }
  </style>
</head>

<body class="d-flex flex-column min-vh-100">

  <main class="container-fluid px-1 px-sm-2 flex-grow-1">

    <div class="bymac-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
      <h1>
        <img src="https://bymac-si.github.io/img/logo_imma.png" alt="IMMA" style="width: 100px;">
        Panel MasterBI · Tag Spool
      </h1>
      <div class="text-start text-md-end mt-2 mt-md-0">
        <div style="font-size:18px;font-weight:bold">IMMA · Soluciones en Piping</div>
        <div style="font-size:10px;opacity:.8">byMAC · Desarrollo Web & Integraciones</div>
      </div>
    </div>

    <div class="card shadow-sm">
      <ul class="nav nav-tabs mb-3" id="tabsPanel" role="tablist">
        <li class="nav-item">
          <button class="nav-link active tab" data-bs-toggle="tab" data-bs-target="#tab-fechas" type="button">Fechas por TAG</button>
        </li>
        <li class="nav-item">
          <button class="nav-link tab" data-bs-toggle="tab" data-bs-target="#tab-merge" type="button">Merge / Utilidades</button>
        </li>
        <li class="nav-item">
          <button class="nav-link tab" data-bs-toggle="tab" data-bs-target="#tab-log" type="button">ChangeLog</button>
        </li>
        <li class="nav-item">
          <button class="nav-link tab" data-bs-toggle="tab" data-bs-target="#tab-dashboard" type="button">Indicadores</button>
        </li>
      </ul>

      <div class="tab-content p-3">
        
        <div class="tab-pane fade show active" id="tab-fechas" role="tabpanel">
          <div class="row g-3">
            
            <div class="col-12">
              <div class="card shadow-sm">
                <div class="card-body">
                  <h5 class="card-title mb-2">Buscar TAG SPOOL</h5>
                  <div class="input-group input-group-sm mb-2">
                    <input type="text" id="txtBuscar" class="form-control" placeholder="Ej: 29044-005" onkeyup="if(event.key === 'Enter') buscarTags()">
                    <button class="btn btn-primary" onclick="buscarTags()" id="btnBuscar">Buscar</button>
                  </div>
                  <div id="contenedorCoincidencias" class="mt-2 border rounded p-1" style="max-height:230px; overflow:auto;">
                    <div class="text-muted small">Sin resultados aún.</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12 col-md-6">
              <div class="card shadow-sm mb-3">
                <div class="card-body">
                  <h5 class="card-title">Selección</h5>
                  <p>TAG: <span id="lblTagSel" class="tag-seleccionado">(ninguno)</span></p>
                  <p id="lblUltimaEtapa" class="small text-muted mb-1">Última etapa: -</p>
                  <p class="small mb-0">Estado: <span id="lblEstado" class="estado-gray">SIN INICIO</span></p>
                </div>
              </div>

              <div class="card shadow-sm">
                <div class="card-body">
                  <h5 class="card-title mb-2">Registrar fecha</h5>
                  <label class="form-label small">Etapa</label>
                  <select id="cmbEtapa" class="form-select form-select-sm mb-2"></select>

                  <label class="form-label small">Fecha</label>
                  <input type="date" id="dtFecha" class="form-control form-control-sm mb-2">

                  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                    <span id="msgEstado" class="msg"></span>
                    <div class="d-flex gap-1">
                      <button class="btn btn-secondary btn-sm" onclick="setHoy()">Hoy</button>
                      <button class="btn btn-primary btn-sm" id="btnGuardar" onclick="guardar(false)">Guardar</button>
                      <button class="btn btn-danger btn-sm" id="btnSobrescribir" onclick="guardar(true)">Sobrescribir</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12 col-md-6">
              <div class="card shadow-sm h-100">
                <div class="card-body d-flex flex-column">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="card-title mb-0">Plano asociado</h5>
                    <a id="btnAbrirPlano" href="#" target="_blank" class="btn btn-sm btn-outline-primary d-none">
                      <i class="bi bi-box-arrow-up-right"></i> Abrir fuera
                    </a>
                  </div>

                  <div class="flex-grow-1 d-flex flex-column justify-content-center bg-light border rounded">
                     <img id="imgPlanoFallback" class="plano-frame" src="https://bymac-si.github.io/img/not-found.png" style="object-fit:contain">
                     <iframe id="iframePlano" class="plano-frame d-none" allow="autoplay"></iframe>
                  </div>
                  <div id="msgPlano" class="small text-muted mt-1 text-center">Selecciona un TAG.</div>
                </div>
              </div>
            </div>

          </div>
        </div>

        <div class="tab-pane fade" id="tab-merge" role="tabpanel">
           <div class="alert alert-info">Funcionalidad en desarrollo para integración Local/Remoto.</div>
        </div>

        <div class="tab-pane fade" id="tab-log" role="tabpanel">
          <div class="card shadow-sm">
             <div class="card-body">
               <div class="d-flex justify-content-between mb-2">
                 <h5 class="card-title">ChangeLog Reciente</h5>
                 <button class="btn btn-outline-primary btn-sm" onclick="cargarLog()">Recargar</button>
               </div>
               <div class="table-responsive" style="max-height: 400px;">
                 <table class="table table-sm table-striped small">
                   <thead><tr><th>Fecha</th><th>Usuario</th><th>Columna</th><th>TAG</th><th>Ant.</th><th>Nuevo</th></tr></thead>
                   <tbody id="tbodyLog"><tr><td colspan="6">Cargando...</td></tr></tbody>
                 </table>
               </div>
             </div>
          </div>
        </div>

        <div class="tab-pane fade" id="tab-dashboard" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-3">
             <h5 class="mb-0">Indicadores de Gestión</h5>
             <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm btn-export-hide" onclick="exportKpiPDF()">PDF</button>
                <button class="btn btn-outline-secondary btn-sm btn-export-hide" onclick="exportKpiJPG()">JPG</button>
             </div>
          </div>

          <div class="row g-2 mb-3">
             <div class="col-6 col-md-3 col-lg-2"><div class="kpi-box"><div class="kpi-title">Total</div><div id="kpi-total" class="kpi-value">-</div></div></div>
             <div class="col-6 col-md-3 col-lg-2"><div class="kpi-box"><div class="kpi-title">Liberado/Desp</div><div id="kpi-ok" class="kpi-value kpi-green">-</div></div></div>
             <div class="col-6 col-md-3 col-lg-2"><div class="kpi-box"><div class="kpi-title">Activos</div><div id="kpi-activos" class="kpi-value kpi-blue">-</div></div></div>
             <div class="col-6 col-md-3 col-lg-2"><div class="kpi-box"><div class="kpi-title">0 - 30 días</div><div id="kpi-proceso" class="kpi-value kpi-blue">-</div></div></div>
             <div class="col-6 col-md-3 col-lg-2"><div class="kpi-box"><div class="kpi-title">31 - 60 Días</div><div id="kpi-pend" class="kpi-value kpi-yellow">-</div></div></div>
             <div class="col-6 col-md-3 col-lg-2"><div class="kpi-box"><div class="kpi-title">> 61+ días</div><div id="kpi-atr" class="kpi-value kpi-red">-</div></div></div>
          </div>

          <div class="row g-3 mb-3">
             <div class="col-12 col-md-4">
               <div class="card p-3 h-100">
                 <h6>Status Fluor</h6>
                 <canvas id="chartLiberados" height="150"></canvas>
               </div>
             </div>
             <div class="col-12 col-md-4">
               <div class="card p-3 h-100">
                 <h6>Embudo por proceso</h6>
                 <canvas id="chartFunnel" height="150"></canvas>
               </div>
             </div>
             <div class="col-12 col-md-4">
               <div class="card p-3 h-100">
                 <h6>Días Proceso</h6>
                 <canvas id="chartAtraso" height="150"></canvas>
               </div>
             </div>
          </div>

          <div class="row g-3">
             <div class="col-12 col-lg-6">
                <div class="card p-3 h-100">
                   <h6>Tags Registrados Hoy</h6>
                   <div class="table-responsive">
                      <table class="table table-sm small mb-0 table-hover">
                         <thead><tr class="table-light"><th>Etapa</th><th>Hoy</th><th>Anterior</th></tr></thead>
                         <tbody id="tbodyReporteHoy"></tbody>
                      </table>
                   </div>
                   <canvas id="chartReporteHoy" height="100" class="mt-3"></canvas>
                </div>
             </div>

             <div class="col-12 col-lg-6">
                <div class="card p-3 h-100">
                   <h6>Situación por última etapa Tag</h6>
                   <div class="row">
                      <div class="col-6">
                         <div class="table-responsive">
                            <table class="table table-sm small mb-0 table-hover">
                               <tbody id="tbodyPendEtapa"></tbody>
                            </table>
                         </div>
                      </div>
                      <div class="col-6">
                         <div style="max-height: 300px; display: flex; align-items: center;">
                            <canvas id="chartPendEtapa"></canvas>
                         </div>
                      </div>
                   </div>
                </div>
             </div>
             
             <div class="col-12">
                <div class="card p-3">
                   <h6>Tiempos promedio entre etapas</h6>
                   <div class="table-responsive">
                      <table class="table table-sm small table-striped text-center">
                         <thead><tr><th>Desde</th><th>Hasta</th><th>Promedio (Días)</th><th>Casos</th></tr></thead>
                         <tbody id="tbodyPromEtapas"></tbody>
                      </table>
                   </div>
                </div>
             </div>
          </div>

        </div> </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /*************************************************
     * CONFIG
     *************************************************/
    const API_URL = 'https://script.google.com/macros/s/AKfycbz7vKo14sL3ebsvLpls-rNT3JzhBjAV7zyDiibU2H0WBWhiIYkPfnfmJ6sDmN484Nw3/exec';

    function callApi(accion, data = {}) {
      const params = new URLSearchParams();
      params.append('accion', accion);
      Object.keys(data).forEach(k => {
        const v = data[k];
        if (v !== undefined && v !== null) {
          params.append(k, typeof v === 'object' ? JSON.stringify(v) : String(v));
        }
      });

      return fetch(API_URL, { method: 'POST', body: params })
        .then(res => {
          if (!res.ok) throw new Error('HTTP ' + res.status);
          return res.json();
        });
    }

    function onApiError(err) {
      console.error(err);
      alert('Error de conexión o servidor:\n' + err.message);
    }

    let filaSeleccionada = null;
    let tagSeleccionado = "";

    /*************************************************
     * INIT & HELPERS
     *************************************************/
    document.addEventListener("DOMContentLoaded", () => {
      setHoy();
      cargarColumnas();
      cargarLog();
      
      let dashLoaded = false;
      document.addEventListener("shown.bs.tab", (ev) => {
         if(ev.target.dataset.bsTarget === "#tab-dashboard" && !dashLoaded){
            dashLoaded = true;
            cargarDashboard();
         }
      });
    });

    function setHoy() {
      const d = new Date();
      const offset = d.getTimezoneOffset() * 60000;
      const local = new Date(d.getTime() - offset);
      document.getElementById("dtFecha").value = local.toISOString().slice(0, 10);
    }

    function cargarColumnas() {
      const cmb = document.getElementById("cmbEtapa");
      cmb.innerHTML = '<option value="">Cargando...</option>';
      callApi('getColumnasFechas').then(lista => {
         cmb.innerHTML = '<option value="">-- seleccionar --</option>';
         lista.forEach(et => {
            const opt = document.createElement("option");
            opt.value = et; opt.textContent = et;
            cmb.appendChild(opt);
         });
      }).catch(onApiError);
    }

    /*************************************************
     * BUSQUEDA
     *************************************************/
    function buscarTags() {
      const txt = document.getElementById("txtBuscar").value.trim();
      const cont = document.getElementById("contenedorCoincidencias");
      const btn = document.getElementById("btnBuscar");
      
      cont.innerHTML = '<div class="small text-muted">Buscando...</div>';
      btn.disabled = true;
      filaSeleccionada = null;
      tagSeleccionado = "";
      
      // Limpiar UI
      document.getElementById("lblTagSel").textContent = "(ninguno)";
      document.getElementById("lblUltimaEtapa").textContent = "-";
      document.getElementById("msgEstado").textContent = "";
      limpiarPlano();

      callApi('buscarTag', { texto: txt }).then(res => {
         btn.disabled = false;
         if (!res || res.length === 0) {
            cont.innerHTML = '<div class="text-danger small">No encontrado.</div>';
            return;
         }
         let html = `<table class="table table-sm table-hover mb-0"><tbody>`;
         res.forEach(item => {
            html += `
              <tr style="cursor:pointer" onclick="seleccionarTag(${item.fila}, '${item.tag}')">
                <td width="30"><input type="radio" name="selTag" ${filaSeleccionada===item.fila?'checked':''}></td>
                <td><span class="badge bg-light text-dark border">${item.tag}</span></td>
              </tr>`;
         });
         html += "</tbody></table>";
         cont.innerHTML = html;
      }).catch(e => {
         btn.disabled = false;
         onApiError(e);
      });
    }

    function seleccionarTag(fila, tag) {
       filaSeleccionada = fila;
       tagSeleccionado = tag;
       const radios = document.getElementsByName("selTag");
       radios.forEach(r => r.checked = true); 
       document.getElementById("lblTagSel").textContent = tag;
       
       callApi('ultimaEtapa', { fila }).then(res => {
          let txt = (res && res.ultimaColumna) ? `${res.ultimaColumna} (${res.fechaTexto})` : "Sin datos";
          document.getElementById("lblUltimaEtapa").textContent = txt;
       });

       callApi('estadoTag', { fila }).then(res => {
          const lbl = document.getElementById("lblEstado");
          lbl.textContent = res.estado || "SIN INICIO";
          lbl.className = `estado-${res.color || 'gray'}`;
       });
       cargarPlano(tag);
    }

    /*************************************************
     * PLANOS
     *************************************************/
    function limpiarPlano(){
       document.getElementById("imgPlanoFallback").classList.remove("d-none");
       document.getElementById("iframePlano").classList.add("d-none");
       document.getElementById("btnAbrirPlano").classList.add("d-none");
       document.getElementById("msgPlano").textContent = "Selecciona un TAG";
    }

    function cargarPlano(tag) {
       limpiarPlano();
       const msg = document.getElementById("msgPlano");
       msg.textContent = "Buscando plano...";
       
       callApi('vistaPlano', { tag }).then(res => {
          if(res.ok && res.url) {
             const iframe = document.getElementById("iframePlano");
             iframe.src = res.url;
             iframe.classList.remove("d-none");
             document.getElementById("imgPlanoFallback").classList.add("d-none");
             msg.textContent = res.mensaje;
             
             const btn = document.getElementById("btnAbrirPlano");
             btn.href = res.url.replace('/preview', '/view');
             btn.classList.remove("d-none");
          } else {
             msg.textContent = res.mensaje || "No encontrado";
          }
       }).catch(e => msg.textContent = "Error al buscar");
    }

    /*************************************************
     * GUARDAR
     *************************************************/
    function guardar(overwrite) {
       if(!filaSeleccionada) return alert("Seleccione un TAG");
       const etapa = document.getElementById("cmbEtapa").value;
       const fechaISO = document.getElementById("dtFecha").value;
       if(!etapa || !fechaISO) return alert("Complete etapa y fecha");

       const msg = document.getElementById("msgEstado");
       msg.textContent = "Guardando..."; msg.className = "msg loading";
       
       const btnG = document.getElementById("btnGuardar");
       const btnS = document.getElementById("btnSobrescribir");
       btnG.disabled = true; btnS.disabled = true;

       callApi('registrarFecha', { fila: filaSeleccionada, etapa, fechaISO, overwrite })
         .then(res => {
            btnG.disabled = false; btnS.disabled = false;
            msg.textContent = res.msg;
            msg.className = res.ok ? "msg ok" : "msg error";
            if(res.ok) cargarLog(); 
         })
         .catch(e => {
            btnG.disabled = false; btnS.disabled = false;
            msg.textContent = "Error de red"; msg.className = "msg error";
         });
    }

    /*************************************************
     * LOG
     *************************************************/
    function cargarLog(){
       const tbody = document.getElementById("tbodyLog");
       callApi('getChangeLogUltimos', {n:30}).then(rows => {
          if(!rows.length) { tbody.innerHTML = "<tr><td colspan='6'>Vacío</td></tr>"; return; }
          let h = "";
          rows.forEach(r => {
             let f = r.FechaHora;
             try { f = new Date(r.FechaHora).toLocaleString(); } catch(e){}
             h += `<tr>
                <td>${f}</td>
                <td>${(r.Usuario||'').split('@')[0]}</td>
                <td>${r.CabeceraColumna}</td>
                <td>${r.TagSpool}</td>
                <td class="text-muted">${formatVal(r.ValorAnterior)}</td>
                <td>${formatVal(r.ValorNuevo)}</td>
             </tr>`;
          });
          tbody.innerHTML = h;
       });
    }
    function formatVal(v){
       if(!v) return "";
       if(String(v).indexOf("T") > 0) return String(v).split("T")[0];
       return v;
    }

    /*************************************************
     * DASHBOARD
     *************************************************/
    let chartFunnel=null, chartStat=null, chartAtr=null, chartRep=null, chartPend=null;

    function cargarDashboard() {
       callApi('dashboardKPIs').then(k => {
          document.getElementById("kpi-total").textContent = k.total;
          document.getElementById("kpi-ok").textContent = k.ok;
          document.getElementById("kpi-activos").textContent = k.activos;
          document.getElementById("kpi-proceso").textContent = k.proceso;
          document.getElementById("kpi-pend").textContent = k.pend;
          document.getElementById("kpi-atr").textContent = k.atr;
          
          dibujarFunnel(k);
       });

       callApi('graficoStatusFluor').then(d => dibujarBarra(d, 'chartLiberados', 'Status', '#1a2b48'));
       callApi('graficoAtrasos').then(d => dibujarBarra(d, 'chartAtraso', 'Spools', '#d93025'));
       
       cargarReporteHoy();
       cargarPendientes();
       cargarPromedios();
    }

    function dibujarFunnel(k) {
       const ctx = document.getElementById("chartFunnel");
       if(chartFunnel) chartFunnel.destroy();
       
       chartFunnel = new Chart(ctx, {
          type: 'bar',
          data: {
             labels: ['Total', 'Activos', '0-30 días', '31-60 días', '61+ días'],
             datasets: [{
                label: 'Spools',
                data: [k.total, k.activos, k.proceso, k.pend, k.atr],
                backgroundColor: ['#e0e0e0', '#1a2b48', '#3b82f6', '#f59e0b', '#d93025']
             }]
          },
          options: {
             indexAxis: 'y',
             plugins: { legend: {display:false} }
          }
       });
    }

    function dibujarBarra(data, idCanvas, label, color) {
       const ctx = document.getElementById(idCanvas);
       const chartExistente = Chart.getChart(idCanvas);
       if(chartExistente) chartExistente.destroy();

       new Chart(ctx, {
          type: 'bar',
          data: {
             labels: data.labels,
             datasets: [{
                label: label,
                data: data.valores,
                backgroundColor: color
             }]
          },
          options: { plugins: { legend: {display:false} } }
       });
    }

    function cargarReporteHoy() {
       callApi('reporteChangeLogHoy').then(rows => {
          const tbody = document.getElementById("tbodyReporteHoy");
          let h = "";
          let labels=[], dHoy=[], dAnt=[];
          rows.forEach(r => {
             h += `<tr><td>${r.columna}</td><td>${r.hoy}</td><td>${r.anteriores}</td></tr>`;
             labels.push(r.columna);
             dHoy.push(r.hoy);
             dAnt.push(r.anteriores);
          });
          tbody.innerHTML = h || "<tr><td colspan='3'>Sin datos</td></tr>";

          const ctx = document.getElementById("chartReporteHoy");
          if(Chart.getChart("chartReporteHoy")) Chart.getChart("chartReporteHoy").destroy();
          new Chart(ctx, {
             type: 'bar',
             data: {
                labels: labels,
                datasets: [
                   { label: 'Hoy', data: dHoy, backgroundColor: '#2ea043' },
                   { label: 'Anterior', data: dAnt, backgroundColor: '#ffc107' }
                ]
             },
             options: {
                scales: { x: {stacked:true}, y:{stacked:true} }
             }
          });
       });
    }

    function cargarPendientes() {
       callApi('pendientesPorEtapa').then(rows => {
          const tbody = document.getElementById("tbodyPendEtapa");
          let h = "";
          let labels=[], vals=[];
          rows.forEach(r => {
             h += `<tr><td>${r.etapa}</td><td class="text-end fw-bold">${r.cantidad}</td></tr>`;
             labels.push(r.etapa);
             vals.push(r.cantidad);
          });
          tbody.innerHTML = h || "<tr><td colspan='2'>Sin pendientes</td></tr>";
          
          const ctx = document.getElementById("chartPendEtapa");
          if(Chart.getChart("chartPendEtapa")) Chart.getChart("chartPendEtapa").destroy();
          new Chart(ctx, {
             type: 'doughnut',
             data: {
                labels: labels,
                datasets: [{ data: vals, borderWidth:1 }]
             },
             options: { plugins: { legend: {display:false} } }
          });
       });
    }

    function cargarPromedios() {
       callApi('promedioTiemposEtapas').then(rows => {
          const tbody = document.getElementById("tbodyPromEtapas");
          let h = "";
          rows.forEach(r => {
             h += `<tr>
                <td>${r.desde}</td><td>${r.hasta}</td>
                <td class="fw-bold text-primary">${r.promedioDias}</td>
                <td>${r.muestras}</td>
             </tr>`;
          });
          tbody.innerHTML = h || "<tr><td colspan='4'>Sin datos</td></tr>";
       });
    }

    /*************************************************
     * EXPORTAR PDF (Multipage + Margen 5mm + Carta)
     *************************************************/
    async function exportKpiPDF() {
       const { jsPDF } = window.jspdf; 
       const el = document.getElementById("tab-dashboard");
       const btns = document.querySelectorAll(".btn-export-hide");
       
       // Ocultar botones temporalmente
       btns.forEach(b => b.style.visibility = "hidden");

       try {
          // 1. Capturar el dashboard completo
          // scale: 2 asegura buena calidad (retina)
          const canvas = await html2canvas(el, { scale: 2, useCORS: true });
          const imgData = canvas.toDataURL("image/jpeg", 0.95);

          // 2. Configuración de dimensiones (mm)
          // Carta (Letter): 215.9 x 279.4 mm
          const pdf = new jsPDF('p', 'mm', 'letter');
          const pageWidth = 215.9;
          const pageHeight = 279.4;
          const margin = 5; // 5mm de margen

          // Área útil para imprimir
          const contentWidth = pageWidth - (2 * margin);
          const contentHeight = pageHeight - (2 * margin);

          // 3. Calcular dimensiones de la imagen en el PDF
          const imgWidth = contentWidth; 
          const imgHeight = (canvas.height * imgWidth) / canvas.width;

          let heightLeft = imgHeight;
          let position = margin; // Posición Y inicial

          // 4. Primera página
          pdf.addImage(imgData, 'JPEG', margin, position, imgWidth, imgHeight);
          heightLeft -= contentHeight;

          // 5. Ciclo para páginas adicionales si el contenido es largo
          while (heightLeft > 0) {
             position = position - pageHeight + (2 * margin); // Ajuste para solapar márgenes visualmente
             // Opción alternativa matemática exacta: position -= contentHeight; 
             // Pero jsPDF maneja coordenadas, así que movemos la imagen hacia arriba
             position = -contentHeight + margin; // Reiniciamos posición relativa para la nueva pág
             
             // Como es un loop y la posición Y es acumulativa negativa, ajustamos:
             // La lógica estándar para "slice" en jsPDF es mover la imagen hacia arriba (Y negativo)
             
             pdf.addPage();
             // Recalculamos la posición Y para la nueva página basada en lo que falta
             // Truco: Imprimimos la MISMA imagen, pero desplazada hacia arriba
             // El desplazamiento debe ser: (altura_ya_impresa) * -1 + margen
             const offset = (imgHeight - heightLeft) * -1 + margin; 
             
             // Simplificación robusta para multipage continuous:
             pdf.addImage(imgData, 'JPEG', margin, margin - (imgHeight - heightLeft), imgWidth, imgHeight);
             
             heightLeft -= contentHeight;
          }

          // 6. Pie de página (opcional, fecha)
          const totalPages = pdf.internal.getNumberOfPages();
          const fecha = new Date().toLocaleDateString();
          for (let i = 1; i <= totalPages; i++) {
             pdf.setPage(i);
             pdf.setFontSize(8);
             pdf.setTextColor(150);
             pdf.text(`Página ${i} de ${totalPages} - Generado: ${fecha}`, margin, pageHeight - 2);
          }

          pdf.save("Dashboard_MasterBI.pdf");

       } catch(e) {
          console.error(e);
          alert("Error generando PDF: " + e.message);
       } finally {
          btns.forEach(b => b.style.visibility = "visible");
       }
    }

    /*************************************************
     * EXPORTAR JPG (Imagen completa con margen blanco)
     *************************************************/
    async function exportKpiJPG() {
       const el = document.getElementById("tab-dashboard");
       const btns = document.querySelectorAll(".btn-export-hide");
       btns.forEach(b => b.style.visibility = "hidden");

       try {
          // 1. Capturar original
          const originalCanvas = await html2canvas(el, { scale: 2, useCORS: true });
          
          // 2. Crear un nuevo canvas para agregar el margen blanco
          // Definimos el margen en pixeles (aprox 5mm a 96dpi ~ 19px, a escala 2 ~ 40px)
          const marginPx = 40; 
          
          const newCanvas = document.createElement("canvas");
          newCanvas.width = originalCanvas.width + (marginPx * 2);
          newCanvas.height = originalCanvas.height + (marginPx * 2);
          
          const ctx = newCanvas.getContext("2d");

          // 3. Rellenar fondo blanco
          ctx.fillStyle = "#ffffff";
          ctx.fillRect(0, 0, newCanvas.width, newCanvas.height);

          // 4. Dibujar el dashboard centrado
          ctx.drawImage(originalCanvas, marginPx, marginPx);

          // 5. Agregar firma o fecha abajo (opcional)
          ctx.font = "20px Arial";
          ctx.fillStyle = "#888888";
          ctx.fillText("Generado por Marcos Castr Abarca  - " + new Date().toLocaleDateString(), marginPx, newCanvas.height - 10);

          // 6. Descargar
          const a = document.createElement("a");
          a.href = newCanvas.toDataURL("image/jpeg", 0.95); // Calidad alta
          a.download = "Dashboard_MasterBI.jpg";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);

       } catch (e) {
          console.error(e);
          alert("Error generando JPG: " + e.message);
       } finally {
          btns.forEach(b => b.style.visibility = "visible");
       }
    }
  </script>
</body>
</html>