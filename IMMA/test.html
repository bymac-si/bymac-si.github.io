<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Panel MasterBI 췅 Tag Spool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <style>
    :root {
      --bymac-primary: #1a2b48;
      --bymac-accent: #e74e35;
      --bymac-bg: #f5f7fb;
      --green-ok: #2ea043;
      --blue-proceso: #1a2b48;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 14px;
      padding: 8px;
      background-color: var(--bymac-bg);
    }

    .tab { font-weight: 600; color: #1a2b48; }
    
    @media (min-width: 768px) {
      body { padding: 16px; }
    }

    .bymac-header {
      background: linear-gradient(90deg, #a0c0f6, #3c475a);
      color: #fff;
      border-radius: 10px;
      padding: 14px 18px;
      margin-bottom: 12px;
      box-shadow: 0 12px 30px rgba(10, 20, 40, 0.18);
      text-shadow: 2px 2px 0px #555;
    }

    .bymac-header h1 { margin: 0; font-size: 22px; }
    .card { border-radius: 10px; border: 1px solid #e1e4ee; }
    .tag-seleccionado { font-weight: bold; color: #0b5394; word-break: break-word; }
    
    .plano-frame {
      width: 100%;
      min-height: clamp(200px, 40vh, 420px);
      border-radius: 8px;
      border: 1px solid #e1e4ee;
      background: #eee;
    }

    /* KPI BOXES */
    .kpi-box {
      padding: 12px;
      border-radius: 8px;
      background: #fff;
      border: 1px solid #e1e4ee;
      text-align: center;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .kpi-title { font-size: 13px; color: #666; font-weight: 600; margin-bottom: 4px; }
    .kpi-value { font-size: 24px; font-weight: 800; }
    
    .kpi-green { color: var(--green-ok); }
    .kpi-blue { color: var(--blue-proceso); }
    .kpi-yellow { color: #b58900; }
    .kpi-red { color: #d93025; }
    .kpi-muted { color: #888; }

    /* ESTADOS */
    .estado-green { color: var(--green-ok); font-weight: bold; }
    .estado-blue { color: var(--blue-proceso); font-weight: bold; }
    .estado-yellow { color: #b58900; font-weight: bold; }
    .estado-red { color: #d93025; font-weight: bold; }
    .estado-gray { color: #666; font-weight: bold; }

    /* UTILIDADES */
    .msg {
      font-size: 13px; padding: 4px 6px; border-radius: 6px; display: inline-block;
      margin-top: 4px; font-weight: 600;
    }
    .msg.ok { color: #0f5132; background-color: #d1e7dd; border: 1px solid #badbcc; }
    .msg.error { color: #842029; background-color: #f8d7da; border: 1px solid #f5c2c7; }
    .msg.loading { color: #856404; background-color: #fff3cd; border: 1px solid #ffeeba; }
  </style>
</head>

<body class="d-flex flex-column min-vh-100">

  <main class="container-fluid px-1 px-sm-2 flex-grow-1">

    <div class="bymac-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
      <h1>
        <img src="https://bymac-si.github.io/img/logo_imma.png" alt="IMMA" style="width: 100px;">
        Panel MasterBI 췅 Tag Spool
      </h1>
      <div class="text-start text-md-end mt-2 mt-md-0">
        <div style="font-size:18px;font-weight:bold">IMMA 췅 Soluciones en Piping</div>
        <div style="font-size:10px;opacity:.8">byMAC 췅 Desarrollo Web & Integraciones</div>
      </div>
    </div>

    <div class="card shadow-sm">
      <ul class="nav nav-tabs mb-3" id="tabsPanel" role="tablist">
        <li class="nav-item">
          <button class="nav-link active tab" data-bs-toggle="tab" data-bs-target="#tab-fechas" type="button">Fechas por TAG</button>
        </li>
        <li class="nav-item">
          <button class="nav-link tab" data-bs-toggle="tab" data-bs-target="#tab-merge" type="button">Merge / Utilidades</button>
        </li>
        <li class="nav-item">
          <button class="nav-link tab" data-bs-toggle="tab" data-bs-target="#tab-log" type="button">ChangeLog</button>
        </li>
        <li class="nav-item">
          <button class="nav-link tab" data-bs-toggle="tab" data-bs-target="#tab-dashboard" type="button">Dashboard KPI</button>
        </li>
      </ul>

      <div class="tab-content p-3">
        
        <div class="tab-pane fade show active" id="tab-fechas" role="tabpanel">
          <div class="row g-3">
            <div class="col-12">
              <div class="card shadow-sm">
                <div class="card-body">
                  <h5 class="card-title mb-2">Buscar TAG SPOOL</h5>
                  <div class="input-group input-group-sm mb-2">
                    <input type="text" id="txtBuscar" class="form-control" placeholder="Ej: 29044-005" onkeyup="if(event.key === 'Enter') buscarTags()">
                    <button class="btn btn-primary" onclick="buscarTags()" id="btnBuscar">Buscar</button>
                  </div>
                  <div id="contenedorCoincidencias" class="mt-2 border rounded p-1" style="max-height:230px; overflow:auto;">
                    <div class="text-muted small">Sin resultados a칰n.</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12 col-md-6">
              <div class="card shadow-sm mb-3">
                <div class="card-body">
                  <h5 class="card-title">Selecci칩n</h5>
                  <p>TAG: <span id="lblTagSel" class="tag-seleccionado">(ninguno)</span></p>
                  <p id="lblUltimaEtapa" class="small text-muted mb-1">칔ltima etapa: -</p>
                  <p class="small mb-0">Estado: <span id="lblEstado" class="estado-gray">SIN INICIO</span></p>
                </div>
              </div>

              <div class="card shadow-sm">
                <div class="card-body">
                  <h5 class="card-title mb-2">Registrar fecha</h5>
                  <label class="form-label small">Etapa</label>
                  <select id="cmbEtapa" class="form-select form-select-sm mb-2"></select>

                  <label class="form-label small">Fecha</label>
                  <input type="date" id="dtFecha" class="form-control form-control-sm mb-2">

                  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                    <span id="msgEstado" class="msg"></span>
                    <div class="d-flex gap-1">
                      <button class="btn btn-secondary btn-sm" onclick="setHoy()">Hoy</button>
                      <button class="btn btn-primary btn-sm" id="btnGuardar" onclick="guardar(false)">Guardar</button>
                      <button class="btn btn-danger btn-sm" id="btnSobrescribir" onclick="guardar(true)">Sobrescribir</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12 col-md-6">
              <div class="card shadow-sm h-100">
                <div class="card-body d-flex flex-column">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="card-title mb-0">Plano asociado</h5>
                    <a id="btnAbrirPlano" href="#" target="_blank" class="btn btn-sm btn-outline-primary d-none">
                      <i class="bi bi-box-arrow-up-right"></i> Abrir fuera
                    </a>
                  </div>

                  <div class="flex-grow-1 d-flex flex-column justify-content-center bg-light border rounded">
                     <img id="imgPlanoFallback" class="plano-frame" src="https://bymac-si.github.io/img/not-found.png" style="object-fit:contain">
                     <iframe id="iframePlano" class="plano-frame d-none" allow="autoplay"></iframe>
                  </div>
                  <div id="msgPlano" class="small text-muted mt-1 text-center">Selecciona un TAG.</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="tab-merge" role="tabpanel">
          <div class="row g-3">
            <div class="col-12 col-md-7">
              <div class="card shadow-sm h-100">
                <div class="card-body">
                  <h5 class="card-title mb-2 text-primary"><i class="bi bi-arrow-repeat"></i> Merge Local + Nube</h5>
                  <p class="small text-muted mb-3">Sincroniza MasterBI con la nube. Prioriza la fecha m치s reciente.</p>
                  <label class="form-label small fw-bold">ID o URL Nube</label>
                  <div class="input-group mb-3">
                    <span class="input-group-text"><i class="bi bi-cloud"></i></span>
                    <input id="txtRemote" type="text" class="form-control" placeholder="Ej: 1ih2lTVmf...">
                  </div>
                  <button id="btnMerge" class="btn btn-primary w-100" onclick="doMerge()">
                    <i class="bi bi-play-fill"></i> Ejecutar Merge
                  </button>
                  <div id="msgMerge" class="msg mt-2 d-none"></div>
                </div>
              </div>
            </div>

            <div class="col-12 col-md-5">
              <div class="card shadow-sm h-100">
                <div class="card-body d-flex flex-column gap-3">
                  <div>
                    <h5 class="card-title mb-2 text-success"><i class="bi bi-file-earmark-excel"></i> Exportar Excel</h5>
                    <p class="small text-muted mb-2">Descarga solo MasterBI.</p>
                    <button id="btnExcel" class="btn btn-success w-100" onclick="doExportExcel()">Descargar .xlsx</button>
                    <div id="msgExcel" class="msg mt-1 d-none"></div>
                  </div>
                  <hr class="my-1">
                  <div>
                    <h5 class="card-title mb-2 text-danger"><i class="bi bi-file-earmark-pdf"></i> Importar PDF (OCR)</h5>
                    <div class="alert alert-light border small mb-0">
                      <i class="bi bi-info-circle"></i> Usa el men칰 <b>"游 Herramientas MasterBI"</b> en la hoja de c치lculo.
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="tab-log" role="tabpanel">
          <div class="card shadow-sm">
             <div class="card-body">
               <div class="d-flex justify-content-between mb-2">
                 <h5 class="card-title">ChangeLog Reciente</h5>
                 <button class="btn btn-outline-primary btn-sm" onclick="cargarLog()">Recargar</button>
               </div>
               <div class="table-responsive" style="max-height: 400px;">
                 <table class="table table-sm table-striped small">
                   <thead><tr><th>Fecha</th><th>Usuario</th><th>Columna</th><th>TAG</th><th>Ant.</th><th>Nuevo</th></tr></thead>
                   <tbody id="tbodyLog"><tr><td colspan="6">Cargando...</td></tr></tbody>
                 </table>
               </div>
             </div>
          </div>
        </div>

        <div class="tab-pane fade" id="tab-dashboard" role="tabpanel" style="padding-bottom: 20px;">
          <div class="d-flex justify-content-between align-items-center mb-3" >
             <div class="d-flex align-items-center gap-2">
                <h5 class="mb-0">Dashboard KPI</h5>
                <span id="lblLastUpdate" class="badge bg-light text-dark border fw-normal" style="font-size:0.75em;">
                  <i class="bi bi-clock-history"></i> Esperando datos...
                </span>
             </div>
             <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm btn-export-hide" onclick="exportKpiPDF()">PDF</button>
                <button class="btn btn-outline-secondary btn-sm btn-export-hide" onclick="exportKpiJPG()">JPG</button>
             </div>
          </div>

          <div class="row g-2 mb-3">
             <div class="col-6 col-md-3 col-lg-2"><div class="kpi-box"><div class="kpi-title">Total</div><div id="kpi-total" class="kpi-value">-</div></div></div>
             <div class="col-6 col-md-3 col-lg-2"><div class="kpi-box"><div class="kpi-title">Liberado/Desp</div><div id="kpi-ok" class="kpi-value kpi-green">-</div></div></div>
             <div class="col-6 col-md-3 col-lg-2"><div class="kpi-box"><div class="kpi-title">Activos</div><div id="kpi-activos" class="kpi-value kpi-blue">-</div></div></div>
             <div class="col-6 col-md-3 col-lg-2"><div class="kpi-box"><div class="kpi-title">Proceso</div><div id="kpi-proceso" class="kpi-value kpi-blue">-</div></div></div>
             <div class="col-6 col-md-3 col-lg-2"><div class="kpi-box"><div class="kpi-title">Pendientes</div><div id="kpi-pend" class="kpi-value kpi-yellow">-</div></div></div>
             <div class="col-6 col-md-3 col-lg-2"><div class="kpi-box"><div class="kpi-title">Atrasados</div><div id="kpi-atr" class="kpi-value kpi-red">-</div></div></div>
          </div>

          <div class="row g-3 mb-3">
             <div class="col-12 col-md-4">
               <div class="card p-3 h-100"><h6>Status Fluor</h6><canvas id="chartLiberados" height="150"></canvas></div>
             </div>
             <div class="col-12 col-md-4">
               <div class="card p-3 h-100"><h6>Embudo por proceso</h6><canvas id="chartFunnel" height="150"></canvas></div>
             </div>
             <div class="col-12 col-md-4">
               <div class="card p-3 h-100"><h6>D칤as Atraso</h6><canvas id="chartAtraso" height="150"></canvas></div>
             </div>
          </div>

          <div class="row mb-3">
             <div class="col-12">
               <div class="card p-3">
                 <h6>Evoluci칩n de Despachos (Por Mes)</h6>
                 <div style="height: 250px;"><canvas id="chartDespachosMes"></canvas></div>
               </div>
             </div>
          </div>

          <div class="row g-3">
             <div class="col-12 col-lg-6">
                <div class="card p-3 h-100">
                   <h6>Registros Hoy (ChangeLog)</h6>
                   <div class="table-responsive">
                      <table class="table table-sm small mb-0 table-hover">
                         <thead><tr class="table-light"><th>Etapa</th><th>Hoy</th><th>Regul.</th></tr></thead>
                         <tbody id="tbodyReporteHoy"></tbody>
                      </table>
                   </div>
                   <canvas id="chartReporteHoy" height="100" class="mt-3"></canvas>
                </div>
             </div>

             <div class="col-12 col-lg-6">
                <div class="card p-3 h-100">
                   <h6>Estatus Tags por 칰ltima etapa</h6>
                   <div class="d-flex justify-content-center align-items-center" style="height: 350px;">
                      <canvas id="chartPendEtapa"></canvas>
                   </div>
                </div>
             </div>
             
             <div class="col-12">
                <div class="card p-3">
                   <h6>Tiempos promedio entre etapas</h6>
                   <div class="table-responsive">
                      <table class="table table-sm small table-striped text-center">
                         <thead><tr><th>Desde</th><th>Hasta</th><th>Promedio (D칤as)</th><th>Casos</th></tr></thead>
                         <tbody id="tbodyPromEtapas"></tbody>
                      </table>
                   </div>
                </div>
             </div>
          </div>
        </div> 
      
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

  <script>
    /*************************************************
     * CONFIGURACI칍N DEL SCRIPT
     *************************************************/
    // IMPORTANTE: Aseg칰rate de que esta URL es la de TU Web App implementada
    const API_URL = 'https://script.google.com/macros/s/AKfycbwZG33mcdFrzbp91w-mEbQYq2m6ori8SvZRQV_jXDMQYk-Yo2sdXsFsyE2-nthpI5tG/exec';

    function callApi(accion, data = {}) {
      const params = new URLSearchParams();
      params.append('accion', accion);
      Object.keys(data).forEach(k => {
        const v = data[k];
        if (v !== undefined && v !== null) {
          params.append(k, typeof v === 'object' ? JSON.stringify(v) : String(v));
        }
      });

      return fetch(API_URL, { method: 'POST', body: params })
        .then(res => {
          if (!res.ok) throw new Error('HTTP ' + res.status);
          return res.json();
        });
    }

    let filaSeleccionada = null;
    let tagSeleccionado = "";

    // === INICIO ===
    document.addEventListener("DOMContentLoaded", () => {
      setHoy();
      cargarColumnas();
      cargarLog();
      startAutoRefresh(); 
      
      let dashLoaded = false;
      document.addEventListener("shown.bs.tab", (ev) => {
         if(ev.target.dataset.bsTarget === "#tab-dashboard" && !dashLoaded){
            dashLoaded = true;
            cargarDashboard();
         }
      });
    });

    function setHoy() {
      const d = new Date();
      const offset = d.getTimezoneOffset() * 60000;
      const local = new Date(d.getTime() - offset);
      document.getElementById("dtFecha").value = local.toISOString().slice(0, 10);
    }

    function cargarColumnas() {
      const cmb = document.getElementById("cmbEtapa");
      cmb.innerHTML = '<option value="">Cargando...</option>';
      callApi('getColumnasFechas').then(res => {
         if (res.ok && Array.isArray(res.data)) {
             cmb.innerHTML = '<option value="">-- seleccionar --</option>';
             res.data.forEach(et => {
                const opt = document.createElement("option");
                opt.value = et; opt.textContent = et;
                cmb.appendChild(opt);
             });
         } else {
             cmb.innerHTML = '<option value="">Error</option>';
         }
      }).catch(() => cmb.innerHTML = '<option value="">Error red</option>');
    }

    function startAutoRefresh() {
       setInterval(() => {
          const activeTab = document.querySelector('#tabsPanel button.active');
          if (activeTab && activeTab.getAttribute('data-bs-target') === '#tab-dashboard') {
             console.log("Auto-refresh...");
             cargarDashboard();
          }
       }, 60000);
    }

    function updateLastRefreshTime() {
       const now = new Date();
       const lbl = document.getElementById("lblLastUpdate");
       if(lbl) lbl.innerHTML = `<i class="bi bi-check-circle-fill text-success"></i> Act: ${now.toLocaleTimeString()}`;
    }

    // === BUSQUEDA ===
    function buscarTags() {
      const txt = document.getElementById("txtBuscar").value.trim();
      const cont = document.getElementById("contenedorCoincidencias");
      const btn = document.getElementById("btnBuscar");
      
      if (!txt) { cont.innerHTML = '<div class="text-muted small">Escribe para buscar.</div>'; return; }

      cont.innerHTML = '<div class="small text-primary"><span class="spinner-border spinner-border-sm"></span> Buscando...</div>';
      btn.disabled = true;
      filaSeleccionada = null; tagSeleccionado = "";
      document.getElementById("lblTagSel").textContent = "(ninguno)";
      document.getElementById("lblUltimaEtapa").textContent = "-";
      document.getElementById("msgEstado").textContent = "";
      limpiarPlano();

      callApi('buscarTag', { texto: txt }).then(res => {
         btn.disabled = false;
         if (!res.ok) { cont.innerHTML = `<div class="text-danger small">Error: ${res.error}</div>`; return; }
         
         const lista = res.data;
         if (!Array.isArray(lista) || lista.length === 0) {
            cont.innerHTML = '<div class="text-muted small text-danger">No encontrado.</div>';
            return;
         }

         let html = `<table class="table table-sm table-hover mb-0"><tbody>`;
         lista.forEach(item => {
            const safeTag = String(item.tag).replace(/'/g, "&apos;").replace(/"/g, "&quot;");
            html += `<tr style="cursor:pointer" onclick="seleccionarTag(${item.fila}, '${safeTag}')">
                <td width="30"><input type="radio" name="selTag" value="${item.fila}" style="pointer-events:none;"></td>
                <td><span class="badge bg-light text-dark border">${item.tag}</span></td>
              </tr>`;
         });
         html += "</tbody></table>";
         cont.innerHTML = html;
      }).catch(e => {
         console.error(e);
         btn.disabled = false;
         cont.innerHTML = '<div class="text-danger small">Error de red.</div>';
      });
    }

    function seleccionarTag(fila, tag) {
       filaSeleccionada = fila; tagSeleccionado = tag;
       const radios = document.getElementsByName("selTag");
       radios.forEach(r => r.checked = true); 
       document.getElementById("lblTagSel").textContent = tag;
       
       callApi('ultimaEtapa', { fila }).then(res => {
          const data = res.data || {};
          let fl = data.fechaTexto; 
          if(fl && fl.includes('-')) fl = fl.split('-').reverse().join('/');
          let txt = (data.ultimaColumna) ? `${data.ultimaColumna} (${fl})` : "Sin datos";
          document.getElementById("lblUltimaEtapa").textContent = txt;
       });

       callApi('estadoTag', { fila }).then(res => {
          const data = res.data || {};
          const lbl = document.getElementById("lblEstado");
          lbl.textContent = data.estado || "SIN INICIO";
          lbl.className = `estado-${data.color || 'gray'}`;
       });
       cargarPlano(tag);
    }

    function limpiarPlano(){
       document.getElementById("imgPlanoFallback").classList.remove("d-none");
       document.getElementById("iframePlano").classList.add("d-none");
       document.getElementById("btnAbrirPlano").classList.add("d-none");
       document.getElementById("msgPlano").textContent = "Selecciona un TAG";
    }

    function cargarPlano(tag) {
       limpiarPlano();
       const msg = document.getElementById("msgPlano");
       msg.textContent = "Buscando plano...";
       
       callApi('vistaPlano', { tag }).then(res => {
          const data = (res.ok && res.data) ? res.data : res;
          if(data.ok && data.url) {
             const iframe = document.getElementById("iframePlano");
             iframe.src = data.url;
             iframe.classList.remove("d-none");
             document.getElementById("imgPlanoFallback").classList.add("d-none");
             msg.textContent = data.mensaje;
             const btn = document.getElementById("btnAbrirPlano");
             btn.href = data.url.replace('/preview', '/view');
             btn.classList.remove("d-none");
          } else {
             msg.textContent = data.mensaje || "No encontrado";
          }
       }).catch(() => msg.textContent = "Error al buscar");
    }

    function guardar(overwrite) {
       if(!filaSeleccionada) return alert("Selecciona un TAG.");
       const etapa = document.getElementById("cmbEtapa").value;
       const fechaISO = document.getElementById("dtFecha").value;
       if(!etapa || !fechaISO) return alert("Falta etapa o fecha.");

       const msg = document.getElementById("msgEstado");
       const btnG = document.getElementById("btnGuardar");
       const btnS = document.getElementById("btnSobrescribir");
       
       msg.textContent = "Guardando..."; msg.className = "msg loading";
       btnG.disabled = true; btnS.disabled = true;

       callApi('registrarFecha', { fila: filaSeleccionada, etapa, fechaISO, overwrite })
         .then(res => {
            btnG.disabled = false; btnS.disabled = false;
            const data = res.data || {};
            if (res.ok && data.ok) {
               msg.textContent = data.msg || "OK";
               msg.className = "msg ok";
               cargarLog(); 
               const fl = fechaISO.split('-').reverse().join('/');
               document.getElementById("lblUltimaEtapa").textContent = `${etapa} (${fl})`;
            } else {
               msg.textContent = data.msg || res.error || "Error";
               msg.className = "msg error";
            }
         })
         .catch(() => {
            btnG.disabled = false; btnS.disabled = false;
            msg.textContent = "Error red"; msg.className = "msg error";
         });
    }

    function cargarLog(){
       const tbody = document.getElementById("tbodyLog");
       callApi('getChangeLogUltimos', {n:30}).then(res => {
          if(!res.ok) return;
          const rows = res.data;
          if(!rows.length) { tbody.innerHTML = "<tr><td colspan='6'>Vac칤o</td></tr>"; return; }
          let h = "";
          rows.forEach(r => {
             let f = r.FechaHora; try { f = new Date(r.FechaHora).toLocaleString(); } catch(e){}
             h += `<tr><td>${f}</td><td>${(r.Usuario||'').split('@')[0]}</td><td>${r.CabeceraColumna}</td><td>${r.TagSpool}</td><td class="text-muted">${r.ValorAnterior||''}</td><td>${r.ValorNuevo||''}</td></tr>`;
          });
          tbody.innerHTML = h;
       });
    }

    // === UTILIDADES ===
    function doMerge() {
       const txtId = document.getElementById("txtRemote").value.trim();
       const msg = document.getElementById("msgMerge");
       const btn = document.getElementById("btnMerge");
       if (!txtId) { alert("Ingresa ID."); return; }
       if(!confirm("쯀niciar Merge?")) return;
       btn.disabled = true; msg.textContent = "Procesando..."; msg.className = "msg loading d-block";
       callApi('merge', { nubeId: txtId }).then(res => {
          btn.disabled = false;
          const data = res.data || {};
          msg.textContent = res.ok ? ("칄xito: " + data.msg) : ("Error: " + (data.msg || res.error));
          msg.className = res.ok ? "msg ok d-block" : "msg error d-block";
          if(res.ok) cargarDashboard();
       }).catch(() => { btn.disabled=false; msg.textContent="Error red"; msg.className="msg error d-block"; });
    }

    function doExportExcel() {
       const msg = document.getElementById("msgExcel");
       const btn = document.getElementById("btnExcel");
       btn.disabled = true; msg.textContent = "Generando..."; msg.className = "msg loading d-block";
       callApi('exportExcel').then(res => {
          const data = res.data || {};
          if (res.ok && data.ok && data.url) {
             msg.textContent = "Descargando...";
             fetch(data.url, { headers: { 'Authorization': 'Bearer ' + data.token } })
               .then(r => r.blob()).then(blob => {
                  const url = window.URL.createObjectURL(blob);
                  const a = document.createElement('a'); a.href = url; a.download = data.filename;
                  document.body.appendChild(a); a.click(); a.remove();
                  msg.textContent = "Listo."; msg.className = "msg ok d-block"; btn.disabled = false;
               });
          } else {
             msg.textContent = "Error"; msg.className = "msg error d-block"; btn.disabled = false;
          }
       });
    }

    // === DASHBOARD ===
    function cargarDashboard() {
       callApi('dashboardKPIs').then(res => {
          if (res.ok && res.data) {
             const k = res.data;
             document.getElementById("kpi-total").textContent = k.total;
             document.getElementById("kpi-ok").textContent = k.cant_ok;
             document.getElementById("kpi-activos").textContent = k.activos;
             document.getElementById("kpi-proceso").textContent = k.proceso;
             document.getElementById("kpi-pend").textContent = k.pend;
             document.getElementById("kpi-atr").textContent = k.atr;
             dibujarFunnel(k);
             updateLastRefreshTime();
          }
       });
       callApi('graficoStatusFluor').then(res => { if(res.ok && res.data) dibujarBarra(res.data, 'chartLiberados', 'Status', '#1a2b48'); });
       callApi('graficoAtrasos').then(res => { if(res.ok && res.data) dibujarBarra(res.data, 'chartAtraso', 'Spools', '#d93025'); });
       // Nuevo grafico despachos
       callApi('graficoDespachosMes').then(res => {
          if(res.ok && res.data) dibujarBarra(res.data, 'chartDespachosMes', 'Cant. Despachada', '#2ea043');
       });
       cargarReporteHoy();
       cargarPendientes();
       cargarPromedios();
    }

    function dibujarFunnel(k) {
       const ctx = document.getElementById("chartFunnel");
       if(Chart.getChart("chartFunnel")) Chart.getChart("chartFunnel").destroy();
       new Chart(ctx, { type: 'bar', data: { labels: ['Total', 'Activos', 'Proceso', 'Pendiente', 'Atrasado'], datasets: [{ label: 'Spools', data: [k.total, k.activos, k.proceso, k.pend, k.atr], backgroundColor: ['#e0e0e0', '#1a2b48', '#3b82f6', '#f59e0b', '#d93025'] }] }, options: { indexAxis: 'y', plugins: { legend: {display:false} } } });
    }

    function dibujarBarra(data, idCanvas, label, color) {
       const ctx = document.getElementById(idCanvas);
       if(!ctx) return;
       if(Chart.getChart(idCanvas)) Chart.getChart(idCanvas).destroy();
       new Chart(ctx, { type: 'bar', data: { labels: data.labels, datasets: [{ label: label, data: data.valores, backgroundColor: color }] }, options: { plugins: { legend: {display:false} } } });
    }

    function cargarReporteHoy() {
       callApi('reporteChangeLogHoy').then(res => {
          if(!res.ok) return;
          const rows = res.data;
          const tbody = document.getElementById("tbodyReporteHoy");
          let h = "", labels=[], dHoy=[], dAnt=[];
          rows.forEach(r => { h += `<tr><td>${r.columna}</td><td>${r.hoy}</td><td>${r.anteriores}</td></tr>`; labels.push(r.columna); dHoy.push(r.hoy); dAnt.push(r.anteriores); });
          tbody.innerHTML = h || "<tr><td colspan='3'>Sin datos</td></tr>";
          const ctx = document.getElementById("chartReporteHoy");
          if(Chart.getChart("chartReporteHoy")) Chart.getChart("chartReporteHoy").destroy();
          new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [ { label: 'Hoy', data: dHoy, backgroundColor: '#2ea043' }, { label: 'Regul.', data: dAnt, backgroundColor: '#ffc107' } ] }, options: { scales: { x: {stacked:true}, y:{stacked:true} } } });
       });
    }

    function cargarPendientes() {
       callApi('pendientesPorEtapa').then(res => {
          if(!res.ok) return;
          const rows = res.data;
          let labels=[], vals=[];
          rows.forEach(r => { labels.push(r.etapa); vals.push(r.cantidad); });
          const ctx = document.getElementById("chartPendEtapa");
          if(Chart.getChart("chartPendEtapa")) Chart.getChart("chartPendEtapa").destroy();
          Chart.register(ChartDataLabels); // Plugin activado
          new Chart(ctx, { 
             type: 'doughnut', 
             data: { labels: labels, datasets: [{ data: vals, backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40','#71B37C'], borderWidth:1 }] },
             options: { 
                responsive:true, maintainAspectRatio:false, layout:{padding:20},
                plugins: { 
                   legend: {display:false},
                   datalabels: {
                      color:'#000', anchor:'end', align:'start', offset:10, font:{weight:'bold'},
                      formatter: (val, ctx) => {
                         let sum=0; ctx.chart.data.datasets[0].data.map(d=>sum+=d);
                         if((val*100/sum)<3) return val; // Solo n칰mero si es peque침o
                         return `${ctx.chart.data.labels[ctx.dataIndex]}\n${val} (${(val*100/sum).toFixed(1)}%)`;
                      }
                   }
                }
             }
          });
       });
    }

    function cargarPromedios() {
       callApi('promedioTiemposEtapas').then(res => {
          if(!res.ok) return;
          const rows = res.data;
          const tbody = document.getElementById("tbodyPromEtapas");
          let h = "";
          rows.forEach(r => { h += `<tr><td>${r.desde}</td><td>${r.hasta}</td><td class="fw-bold text-primary">${r.promedioDias}</td><td>${r.muestras}</td></tr>`; });
          tbody.innerHTML = h || "<tr><td colspan='4'>Sin datos</td></tr>";
       });
    }

    async function exportKpiPDF() {
       const { jsPDF } = window.jspdf; const el = document.getElementById("tab-dashboard"); const btns = document.querySelectorAll(".btn-export-hide");
       btns.forEach(b => b.style.visibility = "hidden");
       try {
          const canvas = await html2canvas(el, { scale: 2, useCORS: true });
          const imgData = canvas.toDataURL("image/jpeg", 0.95);
          const pdf = new jsPDF('p', 'mm', 'letter');
          const pageHeight = 279.4; const imgHeight = (canvas.height * 205.9) / canvas.width;
          let heightLeft = imgHeight; let position = 5;
          pdf.addImage(imgData, 'JPEG', 5, position, 205.9, imgHeight);
          heightLeft -= (pageHeight - 10);
          while (heightLeft > 0) { position = -pageHeight + 5; pdf.addPage(); pdf.addImage(imgData, 'JPEG', 5, 5 - (imgHeight - heightLeft), 205.9, imgHeight); heightLeft -= (pageHeight - 10); }
          pdf.save("Dashboard.pdf");
       } catch(e){alert("Error PDF")} finally { btns.forEach(b => b.style.visibility = "visible"); }
    }

    async function exportKpiJPG() {
       const el = document.getElementById("tab-dashboard"); const btns = document.querySelectorAll(".btn-export-hide");
       btns.forEach(b => b.style.visibility = "hidden");
       try {
          const c = await html2canvas(el, { scale: 2, useCORS: true });
          const a = document.createElement("a"); a.href = c.toDataURL("image/jpeg", 0.95); a.download = "Dashboard.jpg";
          document.body.appendChild(a); a.click(); a.remove();
       } catch(e){alert("Error JPG")} finally { btns.forEach(b => b.style.visibility = "visible"); }
    }
  </script>
</body>
</html>